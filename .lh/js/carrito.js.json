{
    "sourceFile": "js/carrito.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 146,
            "patches": [
                {
                    "date": 1756771257432,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1756773012783,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,176 +1,4 @@\n-// Recuperamos carrito de localStorage o inicializamos vac√≠o\r\n-let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-\r\n-// Constante: monto m√≠nimo para aplicar env√≠o gratis\r\n-const ENVIO_GRATIS_MINIMO = 65;\r\n-\r\n-// ==== Funci√≥n para guardar el carrito en localStorage ====\r\n-function guardarCarrito() {\r\n-  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-}\r\n-\r\n-// ==== Funci√≥n para actualizar la barra de progreso ====\r\n-function actualizarBarraEnvio() {\r\n-  // Recalcular el subtotal desde el carrito\r\n-  let subtotal = carrito.reduce((acc, producto) => acc + (producto.precio * producto.cantidad), 0);\r\n-\r\n-  // Seleccionamos la barra de progreso\r\n-  const barraProgreso = document.getElementById('barra-progreso');\r\n-  if (!barraProgreso) {\r\n-    console.error(\"El elemento de la barra de progreso no se encuentra.\");\r\n-    return;  // Asegurarnos de que el elemento existe\r\n-  }\r\n-\r\n-  // Calcular el porcentaje de progreso\r\n-  const porcentaje = Math.min((subtotal / ENVIO_GRATIS_MINIMO) * 100, 100);\r\n-  barraProgreso.style.width = porcentaje + '%'; // Actualiza el ancho de la barra con el porcentaje\r\n-\r\n-  // Actualizamos el texto de la barra\r\n-  const mensajeBarra = document.querySelector('.progress-bar span');\r\n-  mensajeBarra.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO - subtotal} en productos y obt√©n env√≠o gratis`;\r\n-}\r\n-\r\n-// ==== Funci√≥n para renderizar el carrito en la p√°gina ====\r\n-function renderCarrito() {\r\n-  const tabla = document.getElementById(\"tabla-carrito\");\r\n-  const vacio = document.getElementById(\"carrito-vacio\");\r\n-  const items = document.getElementById(\"carrito-items\");\r\n-  const contador = document.querySelectorAll(\"#contador-carrito\");\r\n-  const subtotalEl = document.getElementById(\"subtotal\");\r\n-  const totalEl = document.getElementById(\"total\");\r\n-  const envioGratis = document.getElementById(\"envio-gratis\");\r\n-  const faltanteEl = document.getElementById(\"faltante-envio\");\r\n-  const barra = document.getElementById(\"barra-progreso\");\r\n-\r\n-  if (items) items.innerHTML = \"\";\r\n-  let subtotal = 0;\r\n-\r\n-  // ==== Carrito vac√≠o ====\r\n-  if (carrito.length === 0) {\r\n-    if (tabla) tabla.classList.add(\"oculto\");\r\n-    if (vacio) vacio.classList.remove(\"oculto\");\r\n-    contador.forEach(c => c.innerText = \"0\");\r\n-    if (subtotalEl) subtotalEl.innerText = \"S/ 0.00\";\r\n-    if (totalEl) totalEl.innerText = \"S/ 0.00\";\r\n-    if (envioGratis) envioGratis.classList.add(\"oculto\");\r\n-    if (items) items.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n-    localStorage.removeItem(\"carrito\");\r\n-    actualizarBarraEnvio(); // Asegura que la barra se actualice cuando el carrito est√° vac√≠o\r\n-    return;\r\n-  }\r\n-\r\n-  // ==== Carrito con productos ====\r\n-  carrito.forEach((p, i) => {\r\n-    subtotal += p.precio * p.cantidad;\r\n-\r\n-    if (items && items.tagName === \"TBODY\") {\r\n-      // Vista completa en tabla\r\n-      items.innerHTML += `\r\n-        <tr>\r\n-          <td><img src=\"${p.img}\" alt=\"${p.nombre}\" width=\"50\"> ${p.nombre}</td>\r\n-          <td>\r\n-            <button onclick=\"cambiarCantidad(${i}, -1)\">-</button>\r\n-            ${p.cantidad}\r\n-            <button onclick=\"cambiarCantidad(${i}, 1)\">+</button>\r\n-          </td>\r\n-          <td>S/ ${(p.precio * p.cantidad).toFixed(2)}</td>\r\n-          <td><button onclick=\"eliminarProducto(${i})\">üóëÔ∏è</button></td>\r\n-        </tr>\r\n-      `;\r\n-    } else if (items) {\r\n-      // Vista r√°pida en sidebar\r\n-      items.innerHTML += `\r\n-        <div class=\"item\">\r\n-          <img src=\"${p.img}\" width=\"40\">\r\n-          <span>${p.nombre} x${p.cantidad}</span>\r\n-          <span>S/ ${(p.precio * p.cantidad).toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    }\r\n-  });\r\n-\r\n-  // ==== Actualizar contadores y totales ====\r\n-  if (tabla) tabla.classList.remove(\"oculto\");\r\n-  if (vacio) vacio.classList.add(\"oculto\");\r\n-  contador.forEach(c => c.innerText = carrito.reduce((acc, p) => acc + p.cantidad, 0));\r\n-  if (subtotalEl) subtotalEl.innerText = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (totalEl) totalEl.innerText = `S/ ${subtotal.toFixed(2)}`;\r\n-\r\n-  // ==== Aviso de env√≠o gratis ====\r\n-  if (subtotal >= ENVIO_GRATIS_MINIMO) {\r\n-    if (envioGratis) {\r\n-      envioGratis.querySelector(\"p\").innerHTML = `<b>¬°Felicidades! Obtienes env√≠o gratis üöö</b>`;\r\n-      if (barra) barra.style.width = \"100%\";\r\n-      envioGratis.classList.remove(\"oculto\");\r\n-    }\r\n-  } else {\r\n-    let faltante = ENVIO_GRATIS_MINIMO - subtotal;\r\n-    if (faltanteEl) faltanteEl.innerText = `S/ ${faltante.toFixed(2)}`;\r\n-    if (barra) barra.style.width = `${(subtotal / ENVIO_GRATIS_MINIMO) * 100}%`;\r\n-    if (envioGratis) envioGratis.classList.remove(\"oculto\");\r\n-  }\r\n-\r\n-  guardarCarrito();\r\n-  actualizarBarraEnvio(); // Llamamos a la funci√≥n para actualizar la barra despu√©s de renderizar el carrito\r\n-}\r\n-\r\n-// ==== Cambiar cantidad de un producto ====\r\n-function cambiarCantidad(index, cambio) {\r\n-  carrito[index].cantidad += cambio;\r\n-  if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n-  renderCarrito();\r\n-}\r\n-\r\n-// ==== Eliminar producto del carrito ====\r\n-function eliminarProducto(index) {\r\n-  carrito.splice(index, 1);\r\n-  renderCarrito();\r\n-}\r\n-\r\n-// ==== Agregar producto al carrito con mensaje flotante ====\r\n-function agregarAlCarrito(producto) {\r\n-  let item = carrito.find(p => p.id === producto.id);\r\n-  if (item) {\r\n-    item.cantidad++;\r\n-  } else {\r\n-    carrito.push({ ...producto, cantidad: 1 });\r\n-  }\r\n-\r\n-  guardarCarrito();\r\n-  renderCarrito();\r\n-\r\n-  // ==== Mensaje flotante moderno ====\r\n-  const mensaje = document.getElementById(\"mensajeCarrito\");\r\n-  mensaje.innerText = `${producto.nombre} agregado al carrito ‚úÖ`;\r\n-  mensaje.style.display = \"block\";\r\n-\r\n-  setTimeout(() => {\r\n-    mensaje.style.opacity = \"1\";\r\n-    mensaje.style.transform = \"translateY(0)\";\r\n-  }, 50);\r\n-\r\n-  setTimeout(() => {\r\n-    mensaje.style.opacity = \"0\";\r\n-    mensaje.style.transform = \"translateY(20px)\";\r\n-  }, 2000);\r\n-\r\n-  setTimeout(() => {\r\n-    mensaje.style.display = \"none\";\r\n-  }, 2300);\r\n-}\r\n-\r\n-// ==== Inicializar al cargar la p√°gina ====\r\n-document.addEventListener(\"DOMContentLoaded\", () => {\r\n-  renderCarrito();\r\n-  actualizarBarraEnvio(); // Aseguramos que la barra se pinte correctamente al recargar la p√°gina\r\n-});\r\n-\r\n-// ===============================\r\n-// üéõÔ∏è PANEL LATERAL DEL CARRITO\r\n-// ===============================\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n-const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n const carritoSidebar = document.getElementById(\"carrito-sidebar\");\r\n \r\n // Abrir el carrito lateral al hacer clic en el √≠cono del carrito\r\n if (abrirCarrito) {\r\n@@ -197,96 +25,114 @@\n \r\n /* ======================\r\n    PAGO CON YAPE - QR MANUAL (sin pasarela)\r\n ====================== */\r\n-// === PAGO MANUAL CON YAPE (QR generado) ===\r\n-\r\n-// Referencias a los elementos de la interfaz\r\n-const btnYape = document.getElementById(\"btn-yape\");\r\n-const modalYape = document.getElementById(\"modal-yape\");\r\n-const montoYapeEl = document.getElementById(\"monto-yape\");\r\n-const btnYapeOk = document.getElementById(\"btn-yape-ok\");\r\n+const btnYape       = document.getElementById(\"btn-yape\");\r\n+const modalYape     = document.getElementById(\"modal-yape\");\r\n+const montoYapeEl   = document.getElementById(\"monto-yape\");\r\n+const btnYapeOk     = document.getElementById(\"btn-yape-ok\");\r\n const btnYapeCerrar = document.getElementById(\"btn-yape-cerrar\");\r\n \r\n-// Funci√≥n para abrir el modal de Yape\r\n-function abrirModalYape() {\r\n-  if (!modalYape) return;  // Si el modal no existe, no hacemos nada\r\n-\r\n-  // Obtener el monto total del carrito\r\n+function abrirModalYape(){\r\n+  if (!modalYape) return;\r\n   const monto = subtotalCarrito();\r\n-\r\n-  // Mostrar el monto en el modal\r\n-  if (montoYapeEl) montoYapeEl.textContent = fmtSoles(monto); // Funci√≥n fmtSoles() para dar formato a los soles\r\n-\r\n-  // Mostrar el modal de Yape\r\n+  if (montoYapeEl) montoYapeEl.textContent = fmtSoles(monto);\r\n   modalYape.classList.remove(\"oculto\");\r\n   modalYape.style.display = \"flex\";\r\n }\r\n-\r\n-// Funci√≥n para cerrar el modal de Yape\r\n-function cerrarModalYape() {\r\n-  if (!modalYape) return;  // Si el modal no existe, no hacemos nada\r\n-\r\n-  // Ocultar el modal\r\n+function cerrarModalYape(){\r\n+  if (!modalYape) return;\r\n   modalYape.classList.add(\"oculto\");\r\n   modalYape.style.display = \"none\";\r\n }\r\n \r\n-// Al hacer clic en el bot√≥n de Yape, se abre el modal\r\n-btnYape?.addEventListener(\"click\", (e) => {\r\n-  e.preventDefault();  // Evitar la acci√≥n predeterminada del enlace\r\n-\r\n-  // Verificar que el carrito no est√© vac√≠o\r\n-  if (subtotalCarrito() <= 0) return toast(\"Tu carrito est√° vac√≠o\");  // Funci√≥n toast() para mostrar mensajes\r\n-\r\n-  abrirModalYape();  // Llamar a la funci√≥n para abrir el modal\r\n+btnYape?.addEventListener(\"click\", (e)=>{\r\n+  e.preventDefault();\r\n+  if (subtotalCarrito() <= 0) return toast(\"Tu carrito est√° vac√≠o\");\r\n+  abrirModalYape();\r\n });\r\n-\r\n-// Al hacer clic en el bot√≥n de cerrar del modal, lo cerramos\r\n btnYapeCerrar?.addEventListener(\"click\", cerrarModalYape);\r\n \r\n-// Al hacer clic en el bot√≥n de \"Confirmar pago manual\", se procesa el pago\r\n+// Confirmaci√≥n manual del cliente\r\n btnYapeOk?.addEventListener(\"click\", async () => {\r\n-  // Cerrar el modal de Yape\r\n   cerrarModalYape();\r\n-\r\n-  // Mostrar mensaje de agradecimiento\r\n   toast(\"Gracias. Verificaremos tu pago en Yape üëå\");\r\n-\r\n-  // Aqu√≠ se puede integrar la l√≥gica para guardar el pago o generar un pedido en tu sistema\r\n-\r\n+  // Opcional: crea orden pendiente en tu backend\r\n   try {\r\n-    // Enviar la informaci√≥n del pedido al servidor (opcional: creamos una orden pendiente en tu backend)\r\n     await fetch(\"/api/orders/manual\", {\r\n-      method: \"POST\",\r\n-      headers: { \"Content-Type\": \"application/json\" },\r\n-      body: JSON.stringify({ items: carrito, amount: subtotalCarrito(), method: \"yape_manual\" })\r\n+      method:\"POST\",\r\n+      headers:{ \"Content-Type\":\"application/json\" },\r\n+      body: JSON.stringify({ items: carrito, amount: subtotalCarrito(), method:\"yape_manual\" })\r\n     });\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar la orden:\", e);\r\n-  }\r\n+  } catch(e){}\r\n });\r\n \r\n-// === FUNCIONES AUXILIARES ===\r\n+/* ======================\r\n+   PAGO CON YAPE - CHECKOUT (pasarela: Culqi)\r\n+====================== */\r\n+const btnYapeCheckout = document.getElementById(\"btn-yape-checkout\");\r\n \r\n-// Esta funci√≥n calcula el subtotal del carrito\r\n-function subtotalCarrito() {\r\n-  return carrito.reduce((total, producto) => total + (producto.precio * producto.cantidad), 0);\r\n-}\r\n+// ‚ö†Ô∏è Reemplaza con tu PUBLIC KEY (pk_test_... o pk_live_...)\r\n+if (window.Culqi) Culqi.publicKey = \"pk_test_reemplaza_con_tu_public_key\";\r\n \r\n-// Funci√≥n para dar formato a los soles (puedes modificar esto si necesitas otro formato)\r\n-function fmtSoles(monto) {\r\n-  return `S/ ${monto.toFixed(2)}`;\r\n+async function pagarConYapeCheckout() {\r\n+  if (!window.Culqi) {\r\n+    toast(\"Checkout no disponible. ¬øCargaste el script de Culqi?\");\r\n+    return;\r\n+  }\r\n+  const amount = Math.round(subtotalCarrito() * 100);\r\n+  if (!amount) return toast(\"Tu carrito est√° vac√≠o\");\r\n+\r\n+  // 1) Crear orden en tu backend\r\n+  const r = await fetch(\"/api/orders\", {\r\n+    method:\"POST\",\r\n+    headers:{ \"Content-Type\":\"application/json\" },\r\n+    body: JSON.stringify({\r\n+      amount, currency_code:\"PEN\",\r\n+      items: carrito\r\n+    })\r\n+  });\r\n+  const { order_id, description } = await r.json();\r\n+\r\n+  // 2) Configurar Checkout (solo Yape)\r\n+  Culqi.options({\r\n+    lang: \"es\",\r\n+    style: { logo: \"/assets/logo.png\" },\r\n+    paymentMethods: { yape: true, tarjeta: false, banca_movil: false },\r\n+  });\r\n+\r\n+  Culqi.settings({\r\n+    title: \"Avifarma\",\r\n+    currency: \"PEN\",\r\n+    amount,\r\n+    order: order_id, // lo usar√°s para enlazar la confirmaci√≥n en el webhook\r\n+    description: description || `Pedido ${order_id}`,\r\n+  });\r\n+\r\n+  Culqi.open();\r\n }\r\n \r\n-// Funci√≥n para mostrar un mensaje de toast (mensaje flotante)\r\n-function toast(mensaje) {\r\n-  const toast = document.createElement(\"div\");\r\n-  toast.className = \"toast\";\r\n-  toast.innerText = mensaje;\r\n-  document.body.appendChild(toast);\r\n+btnYapeCheckout?.addEventListener(\"click\", (e)=>{\r\n+  e.preventDefault();\r\n+  pagarConYapeCheckout();\r\n+});\r\n \r\n-  // Desaparecer el mensaje despu√©s de unos segundos\r\n-  setTimeout(() => {\r\n-    toast.remove();\r\n-  }, 3000);\r\n-}\r\n+// 3) Callback del modal Culqi\r\n+window.culqi = async function() {\r\n+  if (Culqi?.error) {\r\n+    return toast(Culqi.error.user_message || \"No se pudo iniciar el pago.\");\r\n+  }\r\n+  const payload = {};\r\n+  if (Culqi?.token) payload.token = Culqi.token.id;\r\n+  if (Culqi?.order) payload.culqi_order_id = Culqi.order.id;\r\n+\r\n+  try {\r\n+    await fetch(\"/api/pay/culqi/yape\", {\r\n+      method:\"POST\",\r\n+      headers:{ \"Content-Type\":\"application/json\" },\r\n+      body: JSON.stringify(payload)\r\n+    });\r\n+    toast(\"Procesando pago con Yape‚Ä¶\");\r\n+  } catch(e){\r\n+    toast(\"No se pudo enviar el pago al servidor.\");\r\n+  }\r\n+};\r\n"
                },
                {
                    "date": 1756836181926,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,28 +1,20 @@\n+// Seleccionamos elementos del carrito\r\n const carritoSidebar = document.getElementById(\"carrito-sidebar\");\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n+const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n \r\n // Abrir el carrito lateral al hacer clic en el √≠cono del carrito\r\n-if (abrirCarrito) {\r\n-  abrirCarrito.addEventListener(\"click\", (e) => {\r\n-    e.preventDefault(); // Evita la acci√≥n predeterminada del enlace\r\n-    carritoSidebar.classList.add(\"activo\");  // Agrega la clase 'activo' al carrito lateral\r\n-  });\r\n-}\r\n+abrirCarrito?.addEventListener(\"click\", (e) => {\r\n+  e.preventDefault(); // Evita la acci√≥n predeterminada del enlace\r\n+  carritoSidebar.classList.add(\"activo\");\r\n+});\r\n \r\n // Cerrar el carrito lateral al hacer clic en la X\r\n-if (cerrarCarrito) {\r\n-  cerrarCarrito.addEventListener(\"click\", () => {\r\n-    carritoSidebar.classList.remove(\"activo\");  // Elimina la clase 'activo' para ocultar el carrito lateral\r\n-  });\r\n-}\r\n+cerrarCarrito?.addEventListener(\"click\", () => {\r\n+  carritoSidebar.classList.remove(\"activo\");\r\n+});\r\n \r\n-// Cerrar el carrito lateral al hacer clic en el overlay\r\n-if (overlay) {\r\n-  overlay.addEventListener(\"click\", () => {\r\n-    carritoSidebar.classList.remove(\"activo\");  // Elimina la clase 'activo' para ocultar el carrito lateral\r\n-    overlay.classList.remove(\"activo\");         // Oculta el overlay\r\n-  });\r\n-}\r\n \r\n /* ======================\r\n    PAGO CON YAPE - QR MANUAL (sin pasarela)\r\n ====================== */\r\n@@ -115,24 +107,4 @@\n   e.preventDefault();\r\n   pagarConYapeCheckout();\r\n });\r\n \r\n-// 3) Callback del modal Culqi\r\n-window.culqi = async function() {\r\n-  if (Culqi?.error) {\r\n-    return toast(Culqi.error.user_message || \"No se pudo iniciar el pago.\");\r\n-  }\r\n-  const payload = {};\r\n-  if (Culqi?.token) payload.token = Culqi.token.id;\r\n-  if (Culqi?.order) payload.culqi_order_id = Culqi.order.id;\r\n-\r\n-  try {\r\n-    await fetch(\"/api/pay/culqi/yape\", {\r\n-      method:\"POST\",\r\n-      headers:{ \"Content-Type\":\"application/json\" },\r\n-      body: JSON.stringify(payload)\r\n-    });\r\n-    toast(\"Procesando pago con Yape‚Ä¶\");\r\n-  } catch(e){\r\n-    toast(\"No se pudo enviar el pago al servidor.\");\r\n-  }\r\n-};\r\n"
                },
                {
                    "date": 1756836658497,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,110 +1,52 @@\n-// Seleccionamos elementos del carrito\r\n-const carritoSidebar = document.getElementById(\"carrito-sidebar\");\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n-const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n+// =======================\r\n+// MENU RESPONSIVE\r\n+// =======================\r\n+const menuToggle = document.getElementById(\"menu-toggle\"); // Bot√≥n hamburguesa\r\n+const nav = document.querySelector(\"nav ul\"); // Lista del men√∫\r\n \r\n-// Abrir el carrito lateral al hacer clic en el √≠cono del carrito\r\n-abrirCarrito?.addEventListener(\"click\", (e) => {\r\n-  e.preventDefault(); // Evita la acci√≥n predeterminada del enlace\r\n-  carritoSidebar.classList.add(\"activo\");\r\n-});\r\n+if (menuToggle) {\r\n+  menuToggle.addEventListener(\"click\", () => {\r\n+    nav.classList.toggle(\"show\"); // Agrega / quita la clase \"show\"\r\n \r\n-// Cerrar el carrito lateral al hacer clic en la X\r\n-cerrarCarrito?.addEventListener(\"click\", () => {\r\n-  carritoSidebar.classList.remove(\"activo\");\r\n-});\r\n-\r\n-\r\n-/* ======================\r\n-   PAGO CON YAPE - QR MANUAL (sin pasarela)\r\n-====================== */\r\n-const btnYape       = document.getElementById(\"btn-yape\");\r\n-const modalYape     = document.getElementById(\"modal-yape\");\r\n-const montoYapeEl   = document.getElementById(\"monto-yape\");\r\n-const btnYapeOk     = document.getElementById(\"btn-yape-ok\");\r\n-const btnYapeCerrar = document.getElementById(\"btn-yape-cerrar\");\r\n-\r\n-function abrirModalYape(){\r\n-  if (!modalYape) return;\r\n-  const monto = subtotalCarrito();\r\n-  if (montoYapeEl) montoYapeEl.textContent = fmtSoles(monto);\r\n-  modalYape.classList.remove(\"oculto\");\r\n-  modalYape.style.display = \"flex\";\r\n+    // Cambiar el icono de ‚ò∞ a ‚úñ\r\n+    if (nav.classList.contains(\"show\")) {\r\n+      menuToggle.textContent = \"‚úñ\";\r\n+    } else {\r\n+      menuToggle.textContent = \"‚ò∞\";\r\n+    }\r\n+  });\r\n }\r\n-function cerrarModalYape(){\r\n-  if (!modalYape) return;\r\n-  modalYape.classList.add(\"oculto\");\r\n-  modalYape.style.display = \"none\";\r\n-}\r\n \r\n-btnYape?.addEventListener(\"click\", (e)=>{\r\n-  e.preventDefault();\r\n-  if (subtotalCarrito() <= 0) return toast(\"Tu carrito est√° vac√≠o\");\r\n-  abrirModalYape();\r\n-});\r\n-btnYapeCerrar?.addEventListener(\"click\", cerrarModalYape);\r\n+// =======================\r\n+// SIDEBAR CARRITO\r\n+// =======================\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\"); // Bot√≥n carrito en header\r\n+const sidebarCarrito = document.getElementById(\"carrito-sidebar\"); // Sidebar\r\n+const cerrarCarrito = document.getElementById(\"cerrar-carrito\"); // Bot√≥n cerrar (X)\r\n \r\n-// Confirmaci√≥n manual del cliente\r\n-btnYapeOk?.addEventListener(\"click\", async () => {\r\n-  cerrarModalYape();\r\n-  toast(\"Gracias. Verificaremos tu pago en Yape üëå\");\r\n-  // Opcional: crea orden pendiente en tu backend\r\n-  try {\r\n-    await fetch(\"/api/orders/manual\", {\r\n-      method:\"POST\",\r\n-      headers:{ \"Content-Type\":\"application/json\" },\r\n-      body: JSON.stringify({ items: carrito, amount: subtotalCarrito(), method:\"yape_manual\" })\r\n-    });\r\n-  } catch(e){}\r\n-});\r\n-\r\n-/* ======================\r\n-   PAGO CON YAPE - CHECKOUT (pasarela: Culqi)\r\n-====================== */\r\n-const btnYapeCheckout = document.getElementById(\"btn-yape-checkout\");\r\n-\r\n-// ‚ö†Ô∏è Reemplaza con tu PUBLIC KEY (pk_test_... o pk_live_...)\r\n-if (window.Culqi) Culqi.publicKey = \"pk_test_reemplaza_con_tu_public_key\";\r\n-\r\n-async function pagarConYapeCheckout() {\r\n-  if (!window.Culqi) {\r\n-    toast(\"Checkout no disponible. ¬øCargaste el script de Culqi?\");\r\n-    return;\r\n-  }\r\n-  const amount = Math.round(subtotalCarrito() * 100);\r\n-  if (!amount) return toast(\"Tu carrito est√° vac√≠o\");\r\n-\r\n-  // 1) Crear orden en tu backend\r\n-  const r = await fetch(\"/api/orders\", {\r\n-    method:\"POST\",\r\n-    headers:{ \"Content-Type\":\"application/json\" },\r\n-    body: JSON.stringify({\r\n-      amount, currency_code:\"PEN\",\r\n-      items: carrito\r\n-    })\r\n+// Abrir carrito\r\n+if (abrirCarrito && sidebarCarrito) {\r\n+  abrirCarrito.addEventListener(\"click\", (e) => {\r\n+    e.preventDefault(); // Evita que el link recargue la p√°gina\r\n+    sidebarCarrito.classList.add(\"activo\"); // Muestra el carrito\r\n   });\r\n-  const { order_id, description } = await r.json();\r\n+}\r\n \r\n-  // 2) Configurar Checkout (solo Yape)\r\n-  Culqi.options({\r\n-    lang: \"es\",\r\n-    style: { logo: \"/assets/logo.png\" },\r\n-    paymentMethods: { yape: true, tarjeta: false, banca_movil: false },\r\n+// Cerrar carrito\r\n+if (cerrarCarrito && sidebarCarrito) {\r\n+  cerrarCarrito.addEventListener(\"click\", () => {\r\n+    sidebarCarrito.classList.remove(\"activo\");\r\n   });\r\n-\r\n-  Culqi.settings({\r\n-    title: \"Avifarma\",\r\n-    currency: \"PEN\",\r\n-    amount,\r\n-    order: order_id, // lo usar√°s para enlazar la confirmaci√≥n en el webhook\r\n-    description: description || `Pedido ${order_id}`,\r\n-  });\r\n-\r\n-  Culqi.open();\r\n }\r\n \r\n-btnYapeCheckout?.addEventListener(\"click\", (e)=>{\r\n-  e.preventDefault();\r\n-  pagarConYapeCheckout();\r\n+// Cerrar carrito al hacer clic fuera del sidebar\r\n+document.addEventListener(\"click\", (e) => {\r\n+  if (\r\n+    sidebarCarrito &&\r\n+    sidebarCarrito.classList.contains(\"activo\") &&\r\n+    !sidebarCarrito.contains(e.target) &&\r\n+    e.target !== abrirCarrito\r\n+  ) {\r\n+    sidebarCarrito.classList.remove(\"activo\");\r\n+  }\r\n });\r\n-\r\n"
                },
                {
                    "date": 1756837263534,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,52 +1,82 @@\n-// =======================\r\n-// MENU RESPONSIVE\r\n-// =======================\r\n-const menuToggle = document.getElementById(\"menu-toggle\"); // Bot√≥n hamburguesa\r\n-const nav = document.querySelector(\"nav ul\"); // Lista del men√∫\r\n+// ===== VARIABLES GLOBALES =====\r\n+const LIMITE_ENVIO = 65; // monto para env√≠o gratis\r\n+const carritoIcono = document.getElementById(\"abrir-carrito\");\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n+const carritoContenedor = document.getElementById(\"carrito\");\r\n+const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n+const carritoItems = document.getElementById(\"carrito-items\");\r\n+const tablaCarrito = document.getElementById(\"tabla-carrito\");\r\n+const carritoVacio = document.getElementById(\"carrito-vacio\");\r\n+const envioGratis = document.getElementById(\"envio-gratis\");\r\n \r\n-if (menuToggle) {\r\n-  menuToggle.addEventListener(\"click\", () => {\r\n-    nav.classList.toggle(\"show\"); // Agrega / quita la clase \"show\"\r\n+// ===== VARIABLES PARA MEN√ö HAMBURGUESA =====\r\n+const menuToggle = document.getElementById(\"menu-toggle\");\r\n+const nav = document.getElementById(\"nav\");\r\n \r\n-    // Cambiar el icono de ‚ò∞ a ‚úñ\r\n-    if (nav.classList.contains(\"show\")) {\r\n-      menuToggle.textContent = \"‚úñ\";\r\n-    } else {\r\n-      menuToggle.textContent = \"‚ò∞\";\r\n-    }\r\n-  });\r\n-}\r\n+// ===== FUNCIONES DEL CARRITO =====\r\n+function mostrarCarrito() {\r\n+  const carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+  carritoItems.innerHTML = \"\";\r\n \r\n-// =======================\r\n-// SIDEBAR CARRITO\r\n-// =======================\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\"); // Bot√≥n carrito en header\r\n-const sidebarCarrito = document.getElementById(\"carrito-sidebar\"); // Sidebar\r\n-const cerrarCarrito = document.getElementById(\"cerrar-carrito\"); // Bot√≥n cerrar (X)\r\n+  if (carrito.length === 0) {\r\n+    carritoVacio.style.display = \"block\";\r\n+    tablaCarrito.style.display = \"none\";\r\n+    envioGratis.textContent = \"\";\r\n+  } else {\r\n+    carritoVacio.style.display = \"none\";\r\n+    tablaCarrito.style.display = \"block\";\r\n \r\n-// Abrir carrito\r\n-if (abrirCarrito && sidebarCarrito) {\r\n-  abrirCarrito.addEventListener(\"click\", (e) => {\r\n-    e.preventDefault(); // Evita que el link recargue la p√°gina\r\n-    sidebarCarrito.classList.add(\"activo\"); // Muestra el carrito\r\n-  });\r\n+    carrito.forEach((producto, index) => {\r\n+      const row = document.createElement(\"tr\");\r\n+      row.innerHTML = `\r\n+        <td>${producto.nombre}</td>\r\n+        <td>${producto.precio}</td>\r\n+        <td>${producto.cantidad}</td>\r\n+        <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n+        <td><button onclick=\"eliminarProducto(${index})\">‚ùå</button></td>\r\n+      `;\r\n+      carritoItems.appendChild(row);\r\n+    });\r\n+\r\n+    const total = carrito.reduce((acc, prod) => acc + prod.precio * prod.cantidad, 0);\r\n+    envioGratis.textContent =\r\n+      total >= LIMITE_ENVIO\r\n+        ? \"üéâ ¬°Tienes env√≠o gratis!\"\r\n+        : `Agrega S/ ${(LIMITE_ENVIO - total).toFixed(2)} m√°s para env√≠o gratis.`;\r\n+  }\r\n+\r\n+  contadorCarrito.textContent = carrito.reduce((acc, prod) => acc + prod.cantidad, 0);\r\n }\r\n \r\n-// Cerrar carrito\r\n-if (cerrarCarrito && sidebarCarrito) {\r\n-  cerrarCarrito.addEventListener(\"click\", () => {\r\n-    sidebarCarrito.classList.remove(\"activo\");\r\n-  });\r\n+function eliminarProducto(index) {\r\n+  let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+  carrito.splice(index, 1);\r\n+  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  mostrarCarrito();\r\n }\r\n \r\n-// Cerrar carrito al hacer clic fuera del sidebar\r\n-document.addEventListener(\"click\", (e) => {\r\n-  if (\r\n-    sidebarCarrito &&\r\n-    sidebarCarrito.classList.contains(\"activo\") &&\r\n-    !sidebarCarrito.contains(e.target) &&\r\n-    e.target !== abrirCarrito\r\n-  ) {\r\n-    sidebarCarrito.classList.remove(\"activo\");\r\n+// ===== EVENTOS DEL CARRITO =====\r\n+carritoIcono.addEventListener(\"click\", (e) => {\r\n+  e.preventDefault();\r\n+  carritoContenedor.classList.add(\"activo\");\r\n+  mostrarCarrito();\r\n+});\r\n+\r\n+cerrarCarrito.addEventListener(\"click\", () => {\r\n+  carritoContenedor.classList.remove(\"activo\");\r\n+});\r\n+\r\n+// ===== EVENTOS DEL MEN√ö HAMBURGUESA =====\r\n+menuToggle.addEventListener(\"click\", () => {\r\n+  nav.classList.toggle(\"show\");\r\n+\r\n+  // Cambiar icono ‚ò∞ ‚Üî ‚úñ\r\n+  if (nav.classList.contains(\"show\")) {\r\n+    menuToggle.textContent = \"‚úñ\";\r\n+  } else {\r\n+    menuToggle.textContent = \"‚ò∞\";\r\n   }\r\n });\r\n+\r\n+// ===== MOSTRAR CARRITO AL CARGAR =====\r\n+document.addEventListener(\"DOMContentLoaded\", mostrarCarrito);\r\n"
                },
                {
                    "date": 1756837504727,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,82 +1,90 @@\n-// ===== VARIABLES GLOBALES =====\r\n-const LIMITE_ENVIO = 65; // monto para env√≠o gratis\r\n-const carritoIcono = document.getElementById(\"abrir-carrito\");\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n-const carritoContenedor = document.getElementById(\"carrito\");\r\n-const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n-const carritoItems = document.getElementById(\"carrito-items\");\r\n-const tablaCarrito = document.getElementById(\"tabla-carrito\");\r\n-const carritoVacio = document.getElementById(\"carrito-vacio\");\r\n-const envioGratis = document.getElementById(\"envio-gratis\");\r\n+// ===== VARIABLES =====\r\n+const menuToggle = document.getElementById(\"menu-toggle\"); // Bot√≥n men√∫ hamburguesa\r\n+const nav = document.getElementById(\"nav\"); // Men√∫ principal\r\n \r\n-// ===== VARIABLES PARA MEN√ö HAMBURGUESA =====\r\n-const menuToggle = document.getElementById(\"menu-toggle\");\r\n-const nav = document.getElementById(\"nav\");\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\"); // Icono carrito\r\n+const modalCarrito = document.getElementById(\"modal-carrito\"); // Modal carrito\r\n+const cerrarCarrito = document.getElementById(\"cerrar-carrito\"); // Bot√≥n cerrar modal\r\n \r\n-// ===== FUNCIONES DEL CARRITO =====\r\n+const carritoItems = document.getElementById(\"carrito-items\"); // Lista de productos en carrito\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\"); // Contador en el icono carrito\r\n+const totalCarrito = document.getElementById(\"total-carrito\"); // Total de la compra\r\n+const vacio = document.getElementById(\"carrito-vacio\"); // Texto de carrito vac√≠o\r\n+const tablaCarrito = document.getElementById(\"tabla-carrito\"); // Tabla productos\r\n+\r\n+// ===== VARIABLES DE L√ìGICA =====\r\n+let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+const LIMITE_ENVIO = 65; // Monto para env√≠o gratis\r\n+\r\n+// ===== FUNCIONES =====\r\n+\r\n+// Mostrar men√∫ hamburguesa\r\n+menuToggle.addEventListener(\"click\", () => {\r\n+  nav.classList.toggle(\"show\");\r\n+\r\n+  // Cambiar icono ‚ò∞ ‚Üî ‚úñ\r\n+  if (nav.classList.contains(\"show\")) {\r\n+    menuToggle.textContent = \"‚úñ\";\r\n+  } else {\r\n+    menuToggle.textContent = \"‚ò∞\";\r\n+  }\r\n+});\r\n+\r\n+// Abrir carrito\r\n+abrirCarrito.addEventListener(\"click\", (e) => {\r\n+  e.preventDefault();\r\n+  modalCarrito.style.display = \"flex\";\r\n+  mostrarCarrito();\r\n+});\r\n+\r\n+// Cerrar carrito\r\n+cerrarCarrito.addEventListener(\"click\", () => {\r\n+  modalCarrito.style.display = \"none\";\r\n+});\r\n+\r\n+// Renderizar carrito\r\n function mostrarCarrito() {\r\n-  const carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n   carritoItems.innerHTML = \"\";\r\n-\r\n+  \r\n   if (carrito.length === 0) {\r\n-    carritoVacio.style.display = \"block\";\r\n+    vacio.style.display = \"block\";\r\n     tablaCarrito.style.display = \"none\";\r\n-    envioGratis.textContent = \"\";\r\n   } else {\r\n-    carritoVacio.style.display = \"none\";\r\n-    tablaCarrito.style.display = \"block\";\r\n+    vacio.style.display = \"none\";\r\n+    tablaCarrito.style.display = \"table\";\r\n \r\n     carrito.forEach((producto, index) => {\r\n-      const row = document.createElement(\"tr\");\r\n-      row.innerHTML = `\r\n+      const fila = document.createElement(\"tr\");\r\n+      fila.innerHTML = `\r\n         <td>${producto.nombre}</td>\r\n-        <td>${producto.precio}</td>\r\n+        <td>${producto.precio.toFixed(2)}</td>\r\n         <td>${producto.cantidad}</td>\r\n-        <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n-        <td><button onclick=\"eliminarProducto(${index})\">‚ùå</button></td>\r\n+        <td><button class=\"eliminar\" data-index=\"${index}\">‚ùå</button></td>\r\n       `;\r\n-      carritoItems.appendChild(row);\r\n+      carritoItems.appendChild(fila);\r\n     });\r\n \r\n-    const total = carrito.reduce((acc, prod) => acc + prod.precio * prod.cantidad, 0);\r\n-    envioGratis.textContent =\r\n-      total >= LIMITE_ENVIO\r\n-        ? \"üéâ ¬°Tienes env√≠o gratis!\"\r\n-        : `Agrega S/ ${(LIMITE_ENVIO - total).toFixed(2)} m√°s para env√≠o gratis.`;\r\n+    actualizarTotal();\r\n   }\r\n \r\n-  contadorCarrito.textContent = carrito.reduce((acc, prod) => acc + prod.cantidad, 0);\r\n+  contadorCarrito.textContent = carrito.length;\r\n+  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n }\r\n \r\n-function eliminarProducto(index) {\r\n-  let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-  carrito.splice(index, 1);\r\n-  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  mostrarCarrito();\r\n+// Actualizar total\r\n+function actualizarTotal() {\r\n+  const total = carrito.reduce((acc, prod) => acc + prod.precio * prod.cantidad, 0);\r\n+  totalCarrito.textContent = `S/ ${total.toFixed(2)}`;\r\n }\r\n \r\n-// ===== EVENTOS DEL CARRITO =====\r\n-carritoIcono.addEventListener(\"click\", (e) => {\r\n-  e.preventDefault();\r\n-  carritoContenedor.classList.add(\"activo\");\r\n-  mostrarCarrito();\r\n-});\r\n-\r\n-cerrarCarrito.addEventListener(\"click\", () => {\r\n-  carritoContenedor.classList.remove(\"activo\");\r\n-});\r\n-\r\n-// ===== EVENTOS DEL MEN√ö HAMBURGUESA =====\r\n-menuToggle.addEventListener(\"click\", () => {\r\n-  nav.classList.toggle(\"show\");\r\n-\r\n-  // Cambiar icono ‚ò∞ ‚Üî ‚úñ\r\n-  if (nav.classList.contains(\"show\")) {\r\n-    menuToggle.textContent = \"‚úñ\";\r\n-  } else {\r\n-    menuToggle.textContent = \"‚ò∞\";\r\n+// Eliminar producto\r\n+carritoItems.addEventListener(\"click\", (e) => {\r\n+  if (e.target.classList.contains(\"eliminar\")) {\r\n+    const index = e.target.dataset.index;\r\n+    carrito.splice(index, 1);\r\n+    mostrarCarrito();\r\n   }\r\n });\r\n \r\n-// ===== MOSTRAR CARRITO AL CARGAR =====\r\n-document.addEventListener(\"DOMContentLoaded\", mostrarCarrito);\r\n+// Inicializar\r\n+mostrarCarrito();\r\n"
                },
                {
                    "date": 1756838193332,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,49 +1,30 @@\n // ===== VARIABLES =====\r\n-const menuToggle = document.getElementById(\"menu-toggle\"); // Bot√≥n men√∫ hamburguesa\r\n-const nav = document.getElementById(\"nav\"); // Men√∫ principal\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n+const modalCarrito = document.getElementById(\"modal-carrito\");\r\n+const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n \r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\"); // Icono carrito\r\n-const modalCarrito = document.getElementById(\"modal-carrito\"); // Modal carrito\r\n-const cerrarCarrito = document.getElementById(\"cerrar-carrito\"); // Bot√≥n cerrar modal\r\n+const carritoItems = document.getElementById(\"carrito-items\");\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n+const totalCarrito = document.getElementById(\"total-carrito\");\r\n+const vacio = document.getElementById(\"carrito-vacio\");\r\n+const tablaCarrito = document.getElementById(\"tabla-carrito\");\r\n \r\n-const carritoItems = document.getElementById(\"carrito-items\"); // Lista de productos en carrito\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\"); // Contador en el icono carrito\r\n-const totalCarrito = document.getElementById(\"total-carrito\"); // Total de la compra\r\n-const vacio = document.getElementById(\"carrito-vacio\"); // Texto de carrito vac√≠o\r\n-const tablaCarrito = document.getElementById(\"tabla-carrito\"); // Tabla productos\r\n-\r\n-// ===== VARIABLES DE L√ìGICA =====\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-const LIMITE_ENVIO = 65; // Monto para env√≠o gratis\r\n+const LIMITE_ENVIO = 65; // monto para env√≠o gratis\r\n \r\n-// ===== FUNCIONES =====\r\n-\r\n-// Mostrar men√∫ hamburguesa\r\n-menuToggle.addEventListener(\"click\", () => {\r\n-  nav.classList.toggle(\"show\");\r\n-\r\n-  // Cambiar icono ‚ò∞ ‚Üî ‚úñ\r\n-  if (nav.classList.contains(\"show\")) {\r\n-    menuToggle.textContent = \"‚úñ\";\r\n-  } else {\r\n-    menuToggle.textContent = \"‚ò∞\";\r\n-  }\r\n-});\r\n-\r\n-// Abrir carrito\r\n+// ===== ABRIR Y CERRAR =====\r\n abrirCarrito.addEventListener(\"click\", (e) => {\r\n   e.preventDefault();\r\n   modalCarrito.style.display = \"flex\";\r\n   mostrarCarrito();\r\n });\r\n \r\n-// Cerrar carrito\r\n cerrarCarrito.addEventListener(\"click\", () => {\r\n   modalCarrito.style.display = \"none\";\r\n });\r\n \r\n-// Renderizar carrito\r\n+// ===== RENDERIZAR CARRITO =====\r\n function mostrarCarrito() {\r\n   carritoItems.innerHTML = \"\";\r\n   \r\n   if (carrito.length === 0) {\r\n@@ -56,9 +37,9 @@\n     carrito.forEach((producto, index) => {\r\n       const fila = document.createElement(\"tr\");\r\n       fila.innerHTML = `\r\n         <td>${producto.nombre}</td>\r\n-        <td>${producto.precio.toFixed(2)}</td>\r\n+        <td>S/ ${Number(producto.precio).toFixed(2)}</td>\r\n         <td>${producto.cantidad}</td>\r\n         <td><button class=\"eliminar\" data-index=\"${index}\">‚ùå</button></td>\r\n       `;\r\n       carritoItems.appendChild(fila);\r\n@@ -70,21 +51,31 @@\n   contadorCarrito.textContent = carrito.length;\r\n   localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n }\r\n \r\n-// Actualizar total\r\n+// ===== ACTUALIZAR TOTAL =====\r\n function actualizarTotal() {\r\n-  const total = carrito.reduce((acc, prod) => acc + prod.precio * prod.cantidad, 0);\r\n+  const total = carrito.reduce(\r\n+    (acc, prod) => acc + Number(prod.precio) * prod.cantidad, \r\n+    0\r\n+  );\r\n   totalCarrito.textContent = `S/ ${total.toFixed(2)}`;\r\n+\r\n+  // Ejemplo: mensaje de env√≠o gratis\r\n+  if (total >= LIMITE_ENVIO) {\r\n+    console.log(\"‚úÖ Tienes env√≠o gratis\");\r\n+  } else {\r\n+    console.log(`üöö Te faltan S/ ${(LIMITE_ENVIO - total).toFixed(2)} para env√≠o gratis`);\r\n+  }\r\n }\r\n \r\n-// Eliminar producto\r\n+// ===== ELIMINAR PRODUCTO =====\r\n carritoItems.addEventListener(\"click\", (e) => {\r\n   if (e.target.classList.contains(\"eliminar\")) {\r\n     const index = e.target.dataset.index;\r\n     carrito.splice(index, 1);\r\n     mostrarCarrito();\r\n   }\r\n });\r\n \r\n-// Inicializar\r\n+// ===== INICIALIZAR =====\r\n mostrarCarrito();\r\n"
                },
                {
                    "date": 1756842234789,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,81 +1,90 @@\n // ===== VARIABLES =====\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n-const modalCarrito = document.getElementById(\"modal-carrito\");\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\"); \r\n+const sidebar = document.getElementById(\"carrito-sidebar\");\r\n const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n \r\n const carritoItems = document.getElementById(\"carrito-items\");\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n-const totalCarrito = document.getElementById(\"total-carrito\");\r\n+const subtotalEl = document.getElementById(\"subtotal\");\r\n+const descuentoEl = document.getElementById(\"descuento\");\r\n+const totalEl = document.getElementById(\"total\");\r\n+\r\n+// Elementos exclusivos de carrito.html\r\n const vacio = document.getElementById(\"carrito-vacio\");\r\n const tablaCarrito = document.getElementById(\"tabla-carrito\");\r\n \r\n+// ===== LOGICA =====\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-const LIMITE_ENVIO = 65; // monto para env√≠o gratis\r\n \r\n-// ===== ABRIR Y CERRAR =====\r\n-abrirCarrito.addEventListener(\"click\", (e) => {\r\n-  e.preventDefault();\r\n-  modalCarrito.style.display = \"flex\";\r\n-  mostrarCarrito();\r\n-});\r\n+// Abrir / cerrar sidebar\r\n+if (abrirCarrito) {\r\n+  abrirCarrito.addEventListener(\"click\", e => {\r\n+    e.preventDefault();\r\n+    sidebar.classList.add(\"activo\");\r\n+    mostrarCarrito();\r\n+  });\r\n+}\r\n+if (cerrarCarrito) {\r\n+  cerrarCarrito.addEventListener(\"click\", () => {\r\n+    sidebar.classList.remove(\"activo\");\r\n+  });\r\n+}\r\n \r\n-cerrarCarrito.addEventListener(\"click\", () => {\r\n-  modalCarrito.style.display = \"none\";\r\n-});\r\n-\r\n-// ===== RENDERIZAR CARRITO =====\r\n+// Mostrar carrito\r\n function mostrarCarrito() {\r\n   carritoItems.innerHTML = \"\";\r\n-  \r\n+\r\n   if (carrito.length === 0) {\r\n-    vacio.style.display = \"block\";\r\n-    tablaCarrito.style.display = \"none\";\r\n+    if (vacio) vacio.style.display = \"block\";\r\n+    if (tablaCarrito) tablaCarrito.style.display = \"none\";\r\n+    carritoItems.innerHTML = \"<p>Tu carrito est√° vac√≠o</p>\";\r\n   } else {\r\n-    vacio.style.display = \"none\";\r\n-    tablaCarrito.style.display = \"table\";\r\n+    if (vacio) vacio.style.display = \"none\";\r\n+    if (tablaCarrito) tablaCarrito.style.display = \"table\";\r\n \r\n     carrito.forEach((producto, index) => {\r\n-      const fila = document.createElement(\"tr\");\r\n-      fila.innerHTML = `\r\n-        <td>${producto.nombre}</td>\r\n-        <td>S/ ${Number(producto.precio).toFixed(2)}</td>\r\n-        <td>${producto.cantidad}</td>\r\n-        <td><button class=\"eliminar\" data-index=\"${index}\">‚ùå</button></td>\r\n-      `;\r\n+      const fila = document.createElement(tablaCarrito ? \"tr\" : \"div\");\r\n+      fila.innerHTML = tablaCarrito\r\n+        ? `\r\n+          <td>${producto.nombre}</td>\r\n+          <td>S/ ${producto.precio.toFixed(2)}</td>\r\n+          <td>${producto.cantidad}</td>\r\n+          <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n+          <td><button class=\"eliminar\" data-index=\"${index}\">‚ùå</button></td>\r\n+        `\r\n+        : `\r\n+          <div class=\"item\">\r\n+            <span>${producto.nombre} (${producto.cantidad})</span>\r\n+            <span>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</span>\r\n+            <button class=\"eliminar\" data-index=\"${index}\">‚ùå</button>\r\n+          </div>\r\n+        `;\r\n       carritoItems.appendChild(fila);\r\n     });\r\n-\r\n-    actualizarTotal();\r\n   }\r\n \r\n-  contadorCarrito.textContent = carrito.length;\r\n+  actualizarTotales();\r\n   localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n }\r\n \r\n-// ===== ACTUALIZAR TOTAL =====\r\n-function actualizarTotal() {\r\n-  const total = carrito.reduce(\r\n-    (acc, prod) => acc + Number(prod.precio) * prod.cantidad, \r\n-    0\r\n-  );\r\n-  totalCarrito.textContent = `S/ ${total.toFixed(2)}`;\r\n+// Actualizar totales\r\n+function actualizarTotales() {\r\n+  const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n+  const descuento = subtotal > 100 ? subtotal * 0.05 : 0; // ejemplo 5%\r\n+  const total = subtotal - descuento;\r\n \r\n-  // Ejemplo: mensaje de env√≠o gratis\r\n-  if (total >= LIMITE_ENVIO) {\r\n-    console.log(\"‚úÖ Tienes env√≠o gratis\");\r\n-  } else {\r\n-    console.log(`üöö Te faltan S/ ${(LIMITE_ENVIO - total).toFixed(2)} para env√≠o gratis`);\r\n-  }\r\n+  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n }\r\n \r\n-// ===== ELIMINAR PRODUCTO =====\r\n-carritoItems.addEventListener(\"click\", (e) => {\r\n+// Eliminar producto\r\n+carritoItems.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"eliminar\")) {\r\n     const index = e.target.dataset.index;\r\n     carrito.splice(index, 1);\r\n     mostrarCarrito();\r\n   }\r\n });\r\n \r\n-// ===== INICIALIZAR =====\r\n+// Inicializar\r\n mostrarCarrito();\r\n"
                },
                {
                    "date": 1756851679264,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,8 +7,32 @@\n const subtotalEl = document.getElementById(\"subtotal\");\r\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n \r\n+\r\n+// Funci√≥n para agregar un producto al carrito\r\n+function agregarAlCarrito(id, nombre, precio, img) {\r\n+    // Buscar si el producto ya existe en el carrito\r\n+    const productoExistente = carrito.find(p => p.id === id);\r\n+    \r\n+    if (productoExistente) {\r\n+        // Si el producto ya est√° en el carrito, incrementar su cantidad\r\n+        productoExistente.cantidad++;\r\n+    } else {\r\n+        // Si no existe, agregar el producto al carrito con cantidad 1\r\n+        carrito.push({\r\n+            id,\r\n+            nombre,\r\n+            precio,\r\n+            img,\r\n+            cantidad: 1\r\n+        });\r\n+    }\r\n+\r\n+    // Mostrar el carrito actualizado\r\n+    mostrarCarrito();\r\n+}\r\n+\r\n // Elementos exclusivos de carrito.html\r\n const vacio = document.getElementById(\"carrito-vacio\");\r\n const tablaCarrito = document.getElementById(\"tabla-carrito\");\r\n \r\n"
                },
                {
                    "date": 1756876521681,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,20 +1,22 @@\n-// ===== VARIABLES =====\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\"); \r\n+// Variables necesarias\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n const sidebar = document.getElementById(\"carrito-sidebar\");\r\n const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n \r\n const carritoItems = document.getElementById(\"carrito-items\");\r\n const subtotalEl = document.getElementById(\"subtotal\");\r\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n \r\n+// Obtener carrito de localStorage o crear uno vac√≠o\r\n+let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n \r\n // Funci√≥n para agregar un producto al carrito\r\n function agregarAlCarrito(id, nombre, precio, img) {\r\n     // Buscar si el producto ya existe en el carrito\r\n     const productoExistente = carrito.find(p => p.id === id);\r\n-    \r\n+\r\n     if (productoExistente) {\r\n         // Si el producto ya est√° en el carrito, incrementar su cantidad\r\n         productoExistente.cantidad++;\r\n     } else {\r\n@@ -31,84 +33,63 @@\n     // Mostrar el carrito actualizado\r\n     mostrarCarrito();\r\n }\r\n \r\n-// Elementos exclusivos de carrito.html\r\n-const vacio = document.getElementById(\"carrito-vacio\");\r\n-const tablaCarrito = document.getElementById(\"tabla-carrito\");\r\n-\r\n-// ===== LOGICA =====\r\n-let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-\r\n-// Abrir / cerrar sidebar\r\n-if (abrirCarrito) {\r\n-  abrirCarrito.addEventListener(\"click\", e => {\r\n-    e.preventDefault();\r\n-    sidebar.classList.add(\"activo\");\r\n-    mostrarCarrito();\r\n-  });\r\n-}\r\n-if (cerrarCarrito) {\r\n-  cerrarCarrito.addEventListener(\"click\", () => {\r\n-    sidebar.classList.remove(\"activo\");\r\n-  });\r\n-}\r\n-\r\n-// Mostrar carrito\r\n+// Mostrar el carrito\r\n function mostrarCarrito() {\r\n-  carritoItems.innerHTML = \"\";\r\n+    carritoItems.innerHTML = \"\";\r\n \r\n-  if (carrito.length === 0) {\r\n-    if (vacio) vacio.style.display = \"block\";\r\n-    if (tablaCarrito) tablaCarrito.style.display = \"none\";\r\n-    carritoItems.innerHTML = \"<p>Tu carrito est√° vac√≠o</p>\";\r\n-  } else {\r\n-    if (vacio) vacio.style.display = \"none\";\r\n-    if (tablaCarrito) tablaCarrito.style.display = \"table\";\r\n+    if (carrito.length === 0) {\r\n+        carritoItems.innerHTML = \"<p>Tu carrito est√° vac√≠o</p>\";\r\n+    } else {\r\n+        carrito.forEach((producto, index) => {\r\n+            const fila = document.createElement('div');  // Usamos div si no usas tablas\r\n+            fila.innerHTML = `\r\n+                <span>${producto.nombre} (${producto.cantidad})</span>\r\n+                <span>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</span>\r\n+                <button class=\"eliminar\" data-index=\"${index}\">‚ùå</button>\r\n+            `;\r\n+            carritoItems.appendChild(fila);\r\n+        });\r\n+    }\r\n \r\n-    carrito.forEach((producto, index) => {\r\n-      const fila = document.createElement(tablaCarrito ? \"tr\" : \"div\");\r\n-      fila.innerHTML = tablaCarrito\r\n-        ? `\r\n-          <td>${producto.nombre}</td>\r\n-          <td>S/ ${producto.precio.toFixed(2)}</td>\r\n-          <td>${producto.cantidad}</td>\r\n-          <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n-          <td><button class=\"eliminar\" data-index=\"${index}\">‚ùå</button></td>\r\n-        `\r\n-        : `\r\n-          <div class=\"item\">\r\n-            <span>${producto.nombre} (${producto.cantidad})</span>\r\n-            <span>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</span>\r\n-            <button class=\"eliminar\" data-index=\"${index}\">‚ùå</button>\r\n-          </div>\r\n-        `;\r\n-      carritoItems.appendChild(fila);\r\n-    });\r\n-  }\r\n-\r\n-  actualizarTotales();\r\n-  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+    actualizarTotales();\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n }\r\n \r\n-// Actualizar totales\r\n+// Actualizar totales del carrito\r\n function actualizarTotales() {\r\n-  const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n-  const descuento = subtotal > 100 ? subtotal * 0.05 : 0; // ejemplo 5%\r\n-  const total = subtotal - descuento;\r\n+    const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n+    const descuento = subtotal > 100 ? subtotal * 0.05 : 0; // Ejemplo: 5% de descuento\r\n+    const total = subtotal - descuento;\r\n \r\n-  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+    if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+    if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+    if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n }\r\n \r\n-// Eliminar producto\r\n+// Eliminar un producto del carrito\r\n carritoItems.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"eliminar\")) {\r\n-    const index = e.target.dataset.index;\r\n-    carrito.splice(index, 1);\r\n-    mostrarCarrito();\r\n-  }\r\n+    if (e.target.classList.contains(\"eliminar\")) {\r\n+        const index = e.target.dataset.index;\r\n+        carrito.splice(index, 1);\r\n+        mostrarCarrito();\r\n+    }\r\n });\r\n \r\n-// Inicializar\r\n+// Abrir y cerrar el carrito\r\n+if (abrirCarrito) {\r\n+    abrirCarrito.addEventListener(\"click\", e => {\r\n+        e.preventDefault();\r\n+        sidebar.classList.add(\"activo\");\r\n+        mostrarCarrito();\r\n+    });\r\n+}\r\n+\r\n+if (cerrarCarrito) {\r\n+    cerrarCarrito.addEventListener(\"click\", () => {\r\n+        sidebar.classList.remove(\"activo\");\r\n+    });\r\n+}\r\n+\r\n+// Inicializar la interfaz\r\n mostrarCarrito();\r\n"
                },
                {
                    "date": 1756885247287,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,95 @@\n+// Variables necesarias\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n+const sidebar = document.getElementById(\"carrito-sidebar\");\r\n+const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n+\r\n+const carritoItems = document.getElementById(\"carrito-items\");\r\n+const subtotalEl = document.getElementById(\"subtotal\");\r\n+const descuentoEl = document.getElementById(\"descuento\");\r\n+const totalEl = document.getElementById(\"total\");\r\n+\r\n+// Obtener carrito de localStorage o crear uno vac√≠o\r\n+let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+\r\n+// Funci√≥n para agregar un producto al carrito\r\n+function agregarAlCarrito(id, nombre, precio, img) {\r\n+    // Buscar si el producto ya existe en el carrito\r\n+    const productoExistente = carrito.find(p => p.id === id);\r\n+\r\n+    if (productoExistente) {\r\n+        // Si el producto ya est√° en el carrito, incrementar su cantidad\r\n+        productoExistente.cantidad++;\r\n+    } else {\r\n+        // Si no existe, agregar el producto al carrito con cantidad 1\r\n+        carrito.push({\r\n+            id,\r\n+            nombre,\r\n+            precio,\r\n+            img,\r\n+            cantidad: 1\r\n+        });\r\n+    }\r\n+\r\n+    // Mostrar el carrito actualizado\r\n+    mostrarCarrito();\r\n+}\r\n+\r\n+// Mostrar el carrito\r\n+function mostrarCarrito() {\r\n+    carritoItems.innerHTML = \"\";\r\n+\r\n+    if (carrito.length === 0) {\r\n+        carritoItems.innerHTML = \"<p>Tu carrito est√° vac√≠o</p>\";\r\n+    } else {\r\n+        carrito.forEach((producto, index) => {\r\n+            const fila = document.createElement('div');  // Usamos div si no usas tablas\r\n+            fila.innerHTML = `\r\n+                <span>${producto.nombre} (${producto.cantidad})</span>\r\n+                <span>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</span>\r\n+                <button class=\"eliminar\" data-index=\"${index}\">‚ùå</button>\r\n+            `;\r\n+            carritoItems.appendChild(fila);\r\n+        });\r\n+    }\r\n+\r\n+    actualizarTotales();\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+}\r\n+\r\n+// Actualizar totales del carrito\r\n+function actualizarTotales() {\r\n+    const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n+    const descuento = subtotal > 100 ? subtotal * 0.05 : 0; // Ejemplo: 5% de descuento\r\n+    const total = subtotal - descuento;\r\n+\r\n+    if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+    if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+    if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+}\r\n+\r\n+// Eliminar un producto del carrito\r\n+carritoItems.addEventListener(\"click\", e => {\r\n+    if (e.target.classList.contains(\"eliminar\")) {\r\n+        const index = e.target.dataset.index;\r\n+        carrito.splice(index, 1);\r\n+        mostrarCarrito();\r\n+    }\r\n+});\r\n+\r\n+// Abrir y cerrar el carrito\r\n+if (abrirCarrito) {\r\n+    abrirCarrito.addEventListener(\"click\", e => {\r\n+        e.preventDefault();\r\n+        sidebar.classList.add(\"activo\");\r\n+        mostrarCarrito();\r\n+    });\r\n+}\r\n+\r\n+if (cerrarCarrito) {\r\n+    cerrarCarrito.addEventListener(\"click\", () => {\r\n+        sidebar.classList.remove(\"activo\");\r\n+    });\r\n+}\r\n+\r\n+// Inicializar la interfaz\r\n+mostrarCarrito();\r\n"
                },
                {
                    "date": 1756928643599,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -92,99 +92,4 @@\n }\r\n \r\n // Inicializar la interfaz\r\n mostrarCarrito();\r\n-// Variables necesarias\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n-const sidebar = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n-\r\n-const carritoItems = document.getElementById(\"carrito-items\");\r\n-const subtotalEl = document.getElementById(\"subtotal\");\r\n-const descuentoEl = document.getElementById(\"descuento\");\r\n-const totalEl = document.getElementById(\"total\");\r\n-\r\n-// Obtener carrito de localStorage o crear uno vac√≠o\r\n-let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-\r\n-// Funci√≥n para agregar un producto al carrito\r\n-function agregarAlCarrito(id, nombre, precio, img) {\r\n-    // Buscar si el producto ya existe en el carrito\r\n-    const productoExistente = carrito.find(p => p.id === id);\r\n-\r\n-    if (productoExistente) {\r\n-        // Si el producto ya est√° en el carrito, incrementar su cantidad\r\n-        productoExistente.cantidad++;\r\n-    } else {\r\n-        // Si no existe, agregar el producto al carrito con cantidad 1\r\n-        carrito.push({\r\n-            id,\r\n-            nombre,\r\n-            precio,\r\n-            img,\r\n-            cantidad: 1\r\n-        });\r\n-    }\r\n-\r\n-    // Mostrar el carrito actualizado\r\n-    mostrarCarrito();\r\n-}\r\n-\r\n-// Mostrar el carrito\r\n-function mostrarCarrito() {\r\n-    carritoItems.innerHTML = \"\";\r\n-\r\n-    if (carrito.length === 0) {\r\n-        carritoItems.innerHTML = \"<p>Tu carrito est√° vac√≠o</p>\";\r\n-    } else {\r\n-        carrito.forEach((producto, index) => {\r\n-            const fila = document.createElement('div');  // Usamos div si no usas tablas\r\n-            fila.innerHTML = `\r\n-                <span>${producto.nombre} (${producto.cantidad})</span>\r\n-                <span>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</span>\r\n-                <button class=\"eliminar\" data-index=\"${index}\">‚ùå</button>\r\n-            `;\r\n-            carritoItems.appendChild(fila);\r\n-        });\r\n-    }\r\n-\r\n-    actualizarTotales();\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-}\r\n-\r\n-// Actualizar totales del carrito\r\n-function actualizarTotales() {\r\n-    const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n-    const descuento = subtotal > 100 ? subtotal * 0.05 : 0; // Ejemplo: 5% de descuento\r\n-    const total = subtotal - descuento;\r\n-\r\n-    if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-    if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-    if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n-}\r\n-\r\n-// Eliminar un producto del carrito\r\n-carritoItems.addEventListener(\"click\", e => {\r\n-    if (e.target.classList.contains(\"eliminar\")) {\r\n-        const index = e.target.dataset.index;\r\n-        carrito.splice(index, 1);\r\n-        mostrarCarrito();\r\n-    }\r\n-});\r\n-\r\n-// Abrir y cerrar el carrito\r\n-if (abrirCarrito) {\r\n-    abrirCarrito.addEventListener(\"click\", e => {\r\n-        e.preventDefault();\r\n-        sidebar.classList.add(\"activo\");\r\n-        mostrarCarrito();\r\n-    });\r\n-}\r\n-\r\n-if (cerrarCarrito) {\r\n-    cerrarCarrito.addEventListener(\"click\", () => {\r\n-        sidebar.classList.remove(\"activo\");\r\n-    });\r\n-}\r\n-\r\n-// Inicializar la interfaz\r\n-mostrarCarrito();\r\n"
                },
                {
                    "date": 1757452223660,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,95 +1,300 @@\n-// Variables necesarias\r\n+// =========================\r\n+// VARIABLES PRINCIPALES\r\n+// =========================\r\n const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n const sidebar = document.getElementById(\"carrito-sidebar\");\r\n const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n-\r\n const carritoItems = document.getElementById(\"carrito-items\");\r\n const subtotalEl = document.getElementById(\"subtotal\");\r\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n-// Obtener carrito de localStorage o crear uno vac√≠o\r\n+let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+let catalogo = [];\r\n \r\n-// Funci√≥n para agregar un producto al carrito\r\n-function agregarAlCarrito(id, nombre, precio, img) {\r\n-    // Buscar si el producto ya existe en el carrito\r\n-    const productoExistente = carrito.find(p => p.id === id);\r\n+// Overlay din√°mico\r\n+let overlay = document.getElementById(\"overlay-carrito\");\r\n+if (!overlay) {\r\n+  overlay = document.createElement(\"div\");\r\n+  overlay.id = \"overlay-carrito\";\r\n+  document.body.appendChild(overlay);\r\n+}\r\n \r\n-    if (productoExistente) {\r\n-        // Si el producto ya est√° en el carrito, incrementar su cantidad\r\n-        productoExistente.cantidad++;\r\n-    } else {\r\n-        // Si no existe, agregar el producto al carrito con cantidad 1\r\n-        carrito.push({\r\n-            id,\r\n-            nombre,\r\n-            precio,\r\n-            img,\r\n-            cantidad: 1\r\n-        });\r\n-    }\r\n+// =========================\r\n+// CARGAR JSON DE PRODUCTOS\r\n+// =========================\r\n+fetch(\"productos.json\")\r\n+  .then(res => res.json())\r\n+  .then(data => {\r\n+    catalogo = [...data.productos, ...(data.ofertas || [])];\r\n+    renderProductos(catalogo); // Renderizar productos cargados\r\n+  })\r\n+  .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n-    // Mostrar el carrito actualizado\r\n-    mostrarCarrito();\r\n+// =========================\r\n+// RENDERIZAR PRODUCTOS EN LA TIENDA\r\n+// =========================\r\n+const contenedorProductos = document.getElementById(\"productos-container\");\r\n+\r\n+function renderProductos(lista) {\r\n+  if (!contenedorProductos) return;\r\n+  contenedorProductos.innerHTML = \"\";\r\n+  lista.forEach(producto => {\r\n+    const div = document.createElement(\"div\");\r\n+    div.classList.add(\"producto\");\r\n+    div.innerHTML = `\r\n+      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n+      <h4>${producto.nombre}</h4>\r\n+      <p>${producto.descripcion || \"\"}</p>\r\n+      <span>S/ ${producto.precio.toFixed(2)}</span>\r\n+      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n+    `;\r\n+    contenedorProductos.appendChild(div);\r\n+  });\r\n }\r\n \r\n-// Mostrar el carrito\r\n-function mostrarCarrito() {\r\n-    carritoItems.innerHTML = \"\";\r\n+// =========================\r\n+// ABRIR / CERRAR SIDEBAR\r\n+// =========================\r\n+function abrirSidebar() {\r\n+  sidebar.classList.add(\"activo\");\r\n+  overlay.classList.add(\"activo\");\r\n+  document.body.style.overflow = \"hidden\";\r\n+  mostrarCarrito();\r\n+}\r\n \r\n-    if (carrito.length === 0) {\r\n-        carritoItems.innerHTML = \"<p>Tu carrito est√° vac√≠o</p>\";\r\n-    } else {\r\n-        carrito.forEach((producto, index) => {\r\n-            const fila = document.createElement('div');  // Usamos div si no usas tablas\r\n-            fila.innerHTML = `\r\n-                <span>${producto.nombre} (${producto.cantidad})</span>\r\n-                <span>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</span>\r\n-                <button class=\"eliminar\" data-index=\"${index}\">‚ùå</button>\r\n-            `;\r\n-            carritoItems.appendChild(fila);\r\n-        });\r\n-    }\r\n+function cerrarSidebar() {\r\n+  sidebar.classList.remove(\"activo\");\r\n+  overlay.classList.remove(\"activo\");\r\n+  document.body.style.overflow = \"auto\";\r\n+}\r\n \r\n-    actualizarTotales();\r\n+// =========================\r\n+// AGREGAR PRODUCTO AL CARRITO\r\n+// =========================\r\n+function agregarAlCarrito(idProducto) {\r\n+  const producto = catalogo.find(p => p.id == idProducto);\r\n+  if (!producto) return;\r\n+\r\n+  // Verificamos si el producto ya existe en el carrito\r\n+  const existe = carrito.find(p => p.id == idProducto);\r\n+  if (existe) {\r\n+    existe.cantidad++; // Si ya existe, solo incrementamos la cantidad\r\n+  } else {\r\n+    carrito.push({ ...producto, cantidad: 1 }); // Si no existe, lo agregamos\r\n+  }\r\n+\r\n+  // Guardamos el carrito actualizado en localStorage\r\n+  try {\r\n     localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  } catch (e) {\r\n+    console.error(\"Error al guardar el carrito en localStorage\", e);\r\n+  }\r\n+  mostrarCarrito();\r\n+  actualizarContador();  // Actualizamos el contador cuando se agrega un producto\r\n+\r\n+  // Mostrar el mensaje de confirmaci√≥n (toast)\r\n+  mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n-// Actualizar totales del carrito\r\n+// =========================\r\n+// MOSTRAR CARRITO\r\n+// =========================\r\n+function mostrarCarrito() {\r\n+  if (!carritoItems) return;\r\n+  carritoItems.innerHTML = \"\"; // Limpiamos el contenido previo\r\n+\r\n+  // Si el carrito est√° vac√≠o, mostramos un mensaje\r\n+  if (carrito.length === 0) {\r\n+    const p = document.createElement(\"p\");\r\n+    p.textContent = \"Tu carrito est√° vac√≠o\";\r\n+    carritoItems.appendChild(p);\r\n+    return;\r\n+  }\r\n+\r\n+  // Crear la tabla de productos\r\n+  const tabla = document.createElement(\"table\");\r\n+  tabla.classList.add(\"tabla-carrito\");\r\n+\r\n+  // Crear encabezado de la tabla\r\n+  const encabezado = document.createElement(\"thead\");\r\n+  encabezado.innerHTML = `\r\n+    <tr>\r\n+      <th>Producto</th>\r\n+      <th>Cantidad</th>\r\n+      <th>Precio</th>\r\n+      <th>Acci√≥n</th>\r\n+    </tr>\r\n+  `;\r\n+  tabla.appendChild(encabezado);\r\n+\r\n+  // Crear el cuerpo de la tabla\r\n+  const cuerpo = document.createElement(\"tbody\");\r\n+\r\n+  // Agregar los productos al cuerpo de la tabla\r\n+  carrito.forEach((producto, index) => {\r\n+    const fila = document.createElement(\"tr\");\r\n+\r\n+    // Columna Producto: Nombre e Imagen\r\n+    const colProducto = document.createElement(\"td\");\r\n+    colProducto.innerHTML = `\r\n+      <div class=\"carrito-item-info\">\r\n+        <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width: 60px; height: 60px; object-fit: contain;\">\r\n+        <div>\r\n+          <strong>${producto.nombre}</strong>\r\n+          <p>${producto.descripcion || \"\"}</p>\r\n+        </div>\r\n+      </div>\r\n+    `;\r\n+    fila.appendChild(colProducto);\r\n+\r\n+    // Columna Cantidad: Botones para aumentar o reducir\r\n+    const colCantidad = document.createElement(\"td\");\r\n+    colCantidad.innerHTML = ` \r\n+      <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+      <span>${producto.cantidad}</span>\r\n+      <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+    `;\r\n+    fila.appendChild(colCantidad);\r\n+\r\n+    // Columna Precio: Precio del producto\r\n+    const colPrecio = document.createElement(\"td\");\r\n+    colPrecio.textContent = `S/ ${(producto.precio * producto.cantidad).toFixed(2)}`;\r\n+    fila.appendChild(colPrecio);\r\n+\r\n+    // Columna Acci√≥n: Bot√≥n para eliminar el producto\r\n+    const colAccion = document.createElement(\"td\");\r\n+    colAccion.innerHTML = `<button class=\"carrito-item-close\" data-index=\"${index}\">X</button>`;\r\n+    fila.appendChild(colAccion);\r\n+\r\n+    // A√±adir la fila a la tabla\r\n+    cuerpo.appendChild(fila);\r\n+  });\r\n+\r\n+  // A√±adir el cuerpo a la tabla y la tabla al carrito\r\n+  tabla.appendChild(cuerpo);\r\n+  carritoItems.appendChild(tabla);\r\n+\r\n+  // Actualizar los totales y la barra de progreso\r\n+  actualizarTotales();\r\n+  try {\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito)); // Guardar carrito actualizado\r\n+  } catch (e) {\r\n+    console.error(\"Error al guardar el carrito en localStorage\", e);\r\n+  }\r\n+}\r\n+\r\n+// =========================\r\n+// ACTUALIZAR TOTALES\r\n+// =========================\r\n function actualizarTotales() {\r\n-    const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n-    const descuento = subtotal > 100 ? subtotal * 0.05 : 0; // Ejemplo: 5% de descuento\r\n-    const total = subtotal - descuento;\r\n+  const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n+  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n+  const total = subtotal - descuento;\r\n \r\n-    if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-    if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-    if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+\r\n+  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n+  if (barraProgreso) {\r\n+    const progreso = (subtotal / 65) * 100; // Seg√∫n la cantidad que se agrega\r\n+    barraProgreso.style.width = `${Math.min(progreso, 100)}%`; // L√≠mite del 100%\r\n+  }\r\n }\r\n \r\n-// Eliminar un producto del carrito\r\n-carritoItems.addEventListener(\"click\", e => {\r\n-    if (e.target.classList.contains(\"eliminar\")) {\r\n-        const index = e.target.dataset.index;\r\n-        carrito.splice(index, 1);\r\n-        mostrarCarrito();\r\n-    }\r\n-});\r\n+// =========================\r\n+// ACTUALIZAR CONTADOR\r\n+// =========================\r\n+function actualizarContador() {\r\n+  const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+}\r\n \r\n-// Abrir y cerrar el carrito\r\n-if (abrirCarrito) {\r\n-    abrirCarrito.addEventListener(\"click\", e => {\r\n-        e.preventDefault();\r\n-        sidebar.classList.add(\"activo\");\r\n-        mostrarCarrito();\r\n-    });\r\n+// =========================\r\n+// TOAST\r\n+// =========================\r\n+function mostrarToast(mensaje) {\r\n+  let toast = document.getElementById(\"mensajeCarrito\");\r\n+  if (!toast) {\r\n+    toast = document.createElement(\"div\");\r\n+    toast.id = \"mensajeCarrito\";\r\n+    document.body.appendChild(toast);\r\n+  }\r\n+\r\n+  toast.textContent = mensaje;\r\n+  toast.classList.add(\"mostrar\");\r\n+\r\n+  clearTimeout(toastTimeout);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n-if (cerrarCarrito) {\r\n-    cerrarCarrito.addEventListener(\"click\", () => {\r\n-        sidebar.classList.remove(\"activo\");\r\n-    });\r\n+// =========================\r\n+// FUNCIONALIDAD DE COMPRA POR WHATSAPP\r\n+// =========================\r\n+function comprarAhora() {\r\n+  const totalCompra = document.getElementById(\"total\").innerText;\r\n+\r\n+  let productos = carrito.map(producto => {\r\n+    return `${producto.nombre} (Cantidad: ${producto.cantidad}) - S/ ${(producto.precio * producto.cantidad).toFixed(2)}`;\r\n+  }).join(\", \");\r\n+\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nEl total es ${totalCompra}.`;\r\n+\r\n+  const telefono = '+51920165696'; // Cambia este n√∫mero por tu n√∫mero de WhatsApp real\r\n+  const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+\r\n+  window.open(url, '_blank');\r\n }\r\n \r\n-// Inicializar la interfaz\r\n+// =========================\r\n+// EVENTOS\r\n+// =========================\r\n+\r\n+abrirCarrito?.addEventListener(\"click\", abrirSidebar);\r\n+cerrarCarrito?.addEventListener(\"click\", cerrarSidebar);\r\n+overlay.addEventListener(\"click\", cerrarSidebar);\r\n+\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const index = e.target.dataset.index;\r\n+  if (index === undefined) return;\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);  // Eliminar el producto\r\n+    try {\r\n+      localStorage.setItem(\"carrito\", JSON.stringify(carrito)); // Guardar carrito actualizado\r\n+    } catch (e) {\r\n+      console.error(\"Error al guardar el carrito en localStorage\", e);\r\n+    }\r\n+    mostrarCarrito();  // Actualizar la vista\r\n+  } else if (e.target.textContent === \"+\") {\r\n+    carrito[index].cantidad++;\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+    mostrarCarrito();\r\n+  } else if (e.target.textContent === \"-\") {\r\n+    carrito[index].cantidad--;\r\n+    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+    mostrarCarrito();\r\n+  }\r\n+});\r\n+\r\n+document.addEventListener(\"click\", e => {\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n+    agregarAlCarrito(e.target.dataset.id);\r\n+  }\r\n+});\r\n+\r\n+document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+  window.location.href = \"carrito.html\";\r\n+});\r\n+\r\n+document.addEventListener(\"keydown\", e => {\r\n+  if (e.key === \"Escape\" && sidebar.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n+\r\n+// Inicializar la vista del carrito\r\n mostrarCarrito();\r\n"
                },
                {
                    "date": 1757533396144,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n // VARIABLES PRINCIPALES\r\n // =========================\r\n const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n const sidebar = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\n+const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n const carritoItems = document.getElementById(\"carrito-items\");\r\n const subtotalEl = document.getElementById(\"subtotal\");\r\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n@@ -13,9 +13,9 @@\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n-// Overlay din√°mico\r\n+// Overlay din√°mico (evitar crearlo m√∫ltiples veces)\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n   overlay.id = \"overlay-carrito\";\r\n@@ -57,21 +57,27 @@\n \r\n // =========================\r\n // ABRIR / CERRAR SIDEBAR\r\n // =========================\r\n+// Abrir el carrito (sidebar y overlay)\r\n function abrirSidebar() {\r\n-  sidebar.classList.add(\"activo\");\r\n-  overlay.classList.add(\"activo\");\r\n-  document.body.style.overflow = \"hidden\";\r\n-  mostrarCarrito();\r\n+  sidebar.classList.add(\"activo\");        // Muestra el carrito\r\n+  overlay.classList.add(\"activo\");        // Muestra el overlay\r\n+  document.body.style.overflow = \"hidden\"; // Bloquea el scroll\r\n+  mostrarCarrito();                       // Muestra el contenido del carrito\r\n }\r\n \r\n+// Cerrar el carrito (sidebar y overlay)\r\n function cerrarSidebar() {\r\n-  sidebar.classList.remove(\"activo\");\r\n-  overlay.classList.remove(\"activo\");\r\n-  document.body.style.overflow = \"auto\";\r\n+  sidebar.classList.remove(\"activo\");     // Oculta el carrito\r\n+  overlay.classList.remove(\"activo\");     // Oculta el overlay\r\n+  document.body.style.overflow = \"auto\";   // Restaura el scroll\r\n }\r\n \r\n+// Al hacer clic en el overlay, se cierra el carrito\r\n+overlay.addEventListener(\"click\", cerrarSidebar);\r\n+\r\n+\r\n // =========================\r\n // AGREGAR PRODUCTO AL CARRITO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n"
                },
                {
                    "date": 1757547010154,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,24 +60,23 @@\n // =========================\r\n // Abrir el carrito (sidebar y overlay)\r\n function abrirSidebar() {\r\n   sidebar.classList.add(\"activo\");        // Muestra el carrito\r\n-  overlay.classList.add(\"activo\");        // Muestra el overlay\r\n+  overlay.classList.add(\"show\");        // Muestra el overlay\r\n   document.body.style.overflow = \"hidden\"; // Bloquea el scroll\r\n   mostrarCarrito();                       // Muestra el contenido del carrito\r\n }\r\n \r\n // Cerrar el carrito (sidebar y overlay)\r\n function cerrarSidebar() {\r\n   sidebar.classList.remove(\"activo\");     // Oculta el carrito\r\n-  overlay.classList.remove(\"activo\");     // Oculta el overlay\r\n+  overlay.classList.remove(\"show\");     // Oculta el overlay\r\n   document.body.style.overflow = \"auto\";   // Restaura el scroll\r\n }\r\n \r\n // Al hacer clic en el overlay, se cierra el carrito\r\n overlay.addEventListener(\"click\", cerrarSidebar);\r\n \r\n-\r\n // =========================\r\n // AGREGAR PRODUCTO AL CARRITO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n"
                },
                {
                    "date": 1757573843513,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -57,74 +57,92 @@\n \r\n // =========================\r\n // ABRIR / CERRAR SIDEBAR\r\n // =========================\r\n-// Abrir el carrito (sidebar y overlay)\r\n function abrirSidebar() {\r\n-  sidebar.classList.add(\"activo\");        // Muestra el carrito\r\n-  overlay.classList.add(\"show\");        // Muestra el overlay\r\n-  document.body.style.overflow = \"hidden\"; // Bloquea el scroll\r\n-  mostrarCarrito();                       // Muestra el contenido del carrito\r\n+  sidebar.classList.add(\"activo\");\r\n+  overlay.classList.add(\"show\");\r\n+  document.body.style.overflow = \"hidden\";\r\n+  mostrarCarrito();\r\n }\r\n \r\n-// Cerrar el carrito (sidebar y overlay)\r\n function cerrarSidebar() {\r\n-  sidebar.classList.remove(\"activo\");     // Oculta el carrito\r\n-  overlay.classList.remove(\"show\");     // Oculta el overlay\r\n-  document.body.style.overflow = \"auto\";   // Restaura el scroll\r\n+  sidebar.classList.remove(\"activo\");\r\n+  overlay.classList.remove(\"show\");\r\n+  document.body.style.overflow = \"auto\";\r\n }\r\n \r\n-// Al hacer clic en el overlay, se cierra el carrito\r\n+// cerrar al clicar overlay\r\n overlay.addEventListener(\"click\", cerrarSidebar);\r\n \r\n+// Evitar que el click en el enlace <a href=\"#\"> cree un historial\r\n+// (si abrirCarrito es un <a>, con esto prevenimos el efecto \"back\" inesperado)\r\n+abrirCarrito?.addEventListener(\"click\", (e) => {\r\n+  if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n+  abrirSidebar();\r\n+});\r\n+\r\n+// cerrar con el bot√≥n X\r\n+cerrarCarrito?.addEventListener(\"click\", (e) => {\r\n+  if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n+  cerrarSidebar();\r\n+});\r\n+\r\n+// Si el usuario pulsa \"atr√°s\" y el sidebar est√° abierto, ci√©rralo\r\n+window.addEventListener(\"popstate\", () => {\r\n+  if (sidebar && sidebar.classList.contains(\"activo\")) {\r\n+    cerrarSidebar();\r\n+  }\r\n+});\r\n+\r\n // =========================\r\n // AGREGAR PRODUCTO AL CARRITO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n-  // Verificamos si el producto ya existe en el carrito\r\n   const existe = carrito.find(p => p.id == idProducto);\r\n   if (existe) {\r\n-    existe.cantidad++; // Si ya existe, solo incrementamos la cantidad\r\n+    existe.cantidad++;\r\n   } else {\r\n-    carrito.push({ ...producto, cantidad: 1 }); // Si no existe, lo agregamos\r\n+    carrito.push({ ...producto, cantidad: 1 });\r\n   }\r\n \r\n-  // Guardamos el carrito actualizado en localStorage\r\n   try {\r\n     localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n   } catch (e) {\r\n     console.error(\"Error al guardar el carrito en localStorage\", e);\r\n   }\r\n+\r\n   mostrarCarrito();\r\n-  actualizarContador();  // Actualizamos el contador cuando se agrega un producto\r\n-\r\n-  // Mostrar el mensaje de confirmaci√≥n (toast)\r\n+  actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n // MOSTRAR CARRITO\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n-  carritoItems.innerHTML = \"\"; // Limpiamos el contenido previo\r\n+  carritoItems.innerHTML = \"\";\r\n \r\n-  // Si el carrito est√° vac√≠o, mostramos un mensaje\r\n+  // Si el carrito est√° vac√≠o, mostramos un mensaje y actualizamos totales/progreso\r\n   if (carrito.length === 0) {\r\n     const p = document.createElement(\"p\");\r\n     p.textContent = \"Tu carrito est√° vac√≠o\";\r\n     carritoItems.appendChild(p);\r\n+\r\n+    // Actualizar totales y barra (asegura que vuelva a 0%)\r\n+    actualizarTotales();\r\n+    actualizarContador();\r\n     return;\r\n   }\r\n \r\n   // Crear la tabla de productos\r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n \r\n-  // Crear encabezado de la tabla\r\n   const encabezado = document.createElement(\"thead\");\r\n   encabezado.innerHTML = `\r\n     <tr>\r\n       <th>Producto</th>\r\n@@ -134,16 +152,13 @@\n     </tr>\r\n   `;\r\n   tabla.appendChild(encabezado);\r\n \r\n-  // Crear el cuerpo de la tabla\r\n   const cuerpo = document.createElement(\"tbody\");\r\n \r\n-  // Agregar los productos al cuerpo de la tabla\r\n   carrito.forEach((producto, index) => {\r\n     const fila = document.createElement(\"tr\");\r\n \r\n-    // Columna Producto: Nombre e Imagen\r\n     const colProducto = document.createElement(\"td\");\r\n     colProducto.innerHTML = `\r\n       <div class=\"carrito-item-info\">\r\n         <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width: 60px; height: 60px; object-fit: contain;\">\r\n@@ -154,45 +169,70 @@\n       </div>\r\n     `;\r\n     fila.appendChild(colProducto);\r\n \r\n-    // Columna Cantidad: Botones para aumentar o reducir\r\n     const colCantidad = document.createElement(\"td\");\r\n     colCantidad.innerHTML = ` \r\n       <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n       <span>${producto.cantidad}</span>\r\n       <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n     `;\r\n     fila.appendChild(colCantidad);\r\n \r\n-    // Columna Precio: Precio del producto\r\n     const colPrecio = document.createElement(\"td\");\r\n     colPrecio.textContent = `S/ ${(producto.precio * producto.cantidad).toFixed(2)}`;\r\n     fila.appendChild(colPrecio);\r\n \r\n-    // Columna Acci√≥n: Bot√≥n para eliminar el producto\r\n     const colAccion = document.createElement(\"td\");\r\n     colAccion.innerHTML = `<button class=\"carrito-item-close\" data-index=\"${index}\">X</button>`;\r\n     fila.appendChild(colAccion);\r\n \r\n-    // A√±adir la fila a la tabla\r\n     cuerpo.appendChild(fila);\r\n   });\r\n \r\n-  // A√±adir el cuerpo a la tabla y la tabla al carrito\r\n   tabla.appendChild(cuerpo);\r\n   carritoItems.appendChild(tabla);\r\n \r\n   // Actualizar los totales y la barra de progreso\r\n   actualizarTotales();\r\n+  actualizarContador();\r\n+\r\n   try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito)); // Guardar carrito actualizado\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n   } catch (e) {\r\n     console.error(\"Error al guardar el carrito en localStorage\", e);\r\n   }\r\n }\r\n \r\n // =========================\r\n+// ACTUALIZAR LA BARRA DE PROGRESO Y MENSAJE\r\n+// =========================\r\n+const ENVIO_GRATIS_MINIMO = 65;\r\n+\r\n+function actualizarBarra(totalCarrito) {\r\n+  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n+  // Buscamos el span del mensaje: preferimos #mensaje-envio si lo usas; si no, seleccionamos .progress-bar span\r\n+  const mensajeEl = document.getElementById(\"mensaje-envio\") || document.querySelector(\".progress-bar span\");\r\n+\r\n+  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n+  if (totalCarrito <= 0) porcentaje = 0;\r\n+  if (porcentaje > 100) porcentaje = 100;\r\n+\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+\r\n+  if (mensajeEl) {\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+    } else if (totalCarrito > 0) {\r\n+      const faltante = (ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2);\r\n+      mensajeEl.textContent = `Agrega S/ ${faltante} en productos y obt√©n env√≠o gratis`;\r\n+    } else {\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} en productos y obt√©n env√≠o gratis`;\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// =========================\r\n // ACTUALIZAR TOTALES\r\n // =========================\r\n function actualizarTotales() {\r\n   const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n@@ -202,13 +242,10 @@\n   if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n   if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n \r\n-  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  if (barraProgreso) {\r\n-    const progreso = (subtotal / 65) * 100; // Seg√∫n la cantidad que se agrega\r\n-    barraProgreso.style.width = `${Math.min(progreso, 100)}%`; // L√≠mite del 100%\r\n-  }\r\n+  // Actualiza la barra (ahora maneja el caso subtotal === 0)\r\n+  actualizarBarra(subtotal);\r\n }\r\n \r\n // =========================\r\n // ACTUALIZAR CONTADOR\r\n@@ -257,23 +294,19 @@\n // =========================\r\n // EVENTOS\r\n // =========================\r\n \r\n-abrirCarrito?.addEventListener(\"click\", abrirSidebar);\r\n-cerrarCarrito?.addEventListener(\"click\", cerrarSidebar);\r\n-overlay.addEventListener(\"click\", cerrarSidebar);\r\n-\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n   if (e.target.classList.contains(\"carrito-item-close\")) {\r\n     carrito.splice(index, 1);  // Eliminar el producto\r\n     try {\r\n-      localStorage.setItem(\"carrito\", JSON.stringify(carrito)); // Guardar carrito actualizado\r\n+      localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n     } catch (e) {\r\n       console.error(\"Error al guardar el carrito en localStorage\", e);\r\n     }\r\n-    mostrarCarrito();  // Actualizar la vista\r\n+    mostrarCarrito();\r\n   } else if (e.target.textContent === \"+\") {\r\n     carrito[index].cantidad++;\r\n     localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n     mostrarCarrito();\r\n@@ -302,4 +335,5 @@\n });\r\n \r\n // Inicializar la vista del carrito\r\n mostrarCarrito();\r\n+actualizarContador();\r\n"
                },
                {
                    "date": 1757575521965,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,9 +74,8 @@\n // cerrar al clicar overlay\r\n overlay.addEventListener(\"click\", cerrarSidebar);\r\n \r\n // Evitar que el click en el enlace <a href=\"#\"> cree un historial\r\n-// (si abrirCarrito es un <a>, con esto prevenimos el efecto \"back\" inesperado)\r\n abrirCarrito?.addEventListener(\"click\", (e) => {\r\n   if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n   abrirSidebar();\r\n });\r\n@@ -125,21 +124,18 @@\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n-  // Si el carrito est√° vac√≠o, mostramos un mensaje y actualizamos totales/progreso\r\n   if (carrito.length === 0) {\r\n     const p = document.createElement(\"p\");\r\n     p.textContent = \"Tu carrito est√° vac√≠o\";\r\n     carritoItems.appendChild(p);\r\n \r\n-    // Actualizar totales y barra (asegura que vuelva a 0%)\r\n     actualizarTotales();\r\n     actualizarContador();\r\n     return;\r\n   }\r\n \r\n-  // Crear la tabla de productos\r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n \r\n   const encabezado = document.createElement(\"thead\");\r\n@@ -191,9 +187,8 @@\n \r\n   tabla.appendChild(cuerpo);\r\n   carritoItems.appendChild(tabla);\r\n \r\n-  // Actualizar los totales y la barra de progreso\r\n   actualizarTotales();\r\n   actualizarContador();\r\n \r\n   try {\r\n@@ -209,9 +204,8 @@\n const ENVIO_GRATIS_MINIMO = 65;\r\n \r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  // Buscamos el span del mensaje: preferimos #mensaje-envio si lo usas; si no, seleccionamos .progress-bar span\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\") || document.querySelector(\".progress-bar span\");\r\n \r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   if (totalCarrito <= 0) porcentaje = 0;\r\n@@ -242,9 +236,8 @@\n   if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n   if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n \r\n-  // Actualiza la barra (ahora maneja el caso subtotal === 0)\r\n   actualizarBarra(subtotal);\r\n }\r\n \r\n // =========================\r\n@@ -284,23 +277,22 @@\n   }).join(\", \");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nEl total es ${totalCompra}.`;\r\n \r\n-  const telefono = '+51920165696'; // Cambia este n√∫mero por tu n√∫mero de WhatsApp real\r\n+  const telefono = '+51920165696';\r\n   const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n \r\n   window.open(url, '_blank');\r\n }\r\n \r\n // =========================\r\n // EVENTOS\r\n // =========================\r\n-\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n   if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);  // Eliminar el producto\r\n+    carrito.splice(index, 1);\r\n     try {\r\n       localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n     } catch (e) {\r\n       console.error(\"Error al guardar el carrito en localStorage\", e);\r\n@@ -333,7 +325,19 @@\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n-// Inicializar la vista del carrito\r\n+// =========================\r\n+// INICIALIZAR\r\n+// =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n+\r\n+// =========================\r\n+// FORZAR CERRAR SIDEBAR AL VOLVER DE carrito.html\r\n+// =========================\r\n+window.addEventListener(\"DOMContentLoaded\", () => {\r\n+  if (sessionStorage.getItem(\"forzarCerrarSidebar\") === \"true\") {\r\n+    cerrarSidebar();\r\n+    sessionStorage.removeItem(\"forzarCerrarSidebar\");\r\n+  }\r\n+});\r\n"
                },
                {
                    "date": 1757622101452,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,343 +1,72 @@\n-// =========================\r\n-// VARIABLES PRINCIPALES\r\n-// =========================\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n-const sidebar = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n-const carritoItems = document.getElementById(\"carrito-items\");\r\n-const subtotalEl = document.getElementById(\"subtotal\");\r\n-const descuentoEl = document.getElementById(\"descuento\");\r\n-const totalEl = document.getElementById(\"total\");\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n+<!DOCTYPE html>\r\n+<html lang=\"es\">\r\n+<head>\r\n+  <meta charset=\"UTF-8\">\r\n+  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+  <title>Carrito de Compras</title>\r\n+  <link rel=\"stylesheet\" href=\"css/estilos.css\">\r\n+</head>\r\n+<body>\r\n \r\n-let toastTimeout;\r\n-let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-let catalogo = [];\r\n+  <!-- HEADER -->\r\n+  <header class=\"header\">\r\n+    <div class=\"logo\">\r\n+      <a href=\"index.html\">Mi Tienda</a>\r\n+    </div>\r\n+    <nav>\r\n+      <a href=\"index.html\">Inicio</a>\r\n+      <a href=\"carrito.html\" class=\"activo\">Carrito</a>\r\n+    </nav>\r\n+  </header>\r\n \r\n-// Overlay din√°mico (evitar crearlo m√∫ltiples veces)\r\n-let overlay = document.getElementById(\"overlay-carrito\");\r\n-if (!overlay) {\r\n-  overlay = document.createElement(\"div\");\r\n-  overlay.id = \"overlay-carrito\";\r\n-  document.body.appendChild(overlay);\r\n-}\r\n+  <!-- SECCI√ìN CARRITO -->\r\n+  <main class=\"carrito-page\">\r\n+    <h1>üõí Tu Carrito</h1>\r\n \r\n-// =========================\r\n-// CARGAR JSON DE PRODUCTOS\r\n-// =========================\r\n-fetch(\"productos.json\")\r\n-  .then(res => res.json())\r\n-  .then(data => {\r\n-    catalogo = [...data.productos, ...(data.ofertas || [])];\r\n-    renderProductos(catalogo); // Renderizar productos cargados\r\n-  })\r\n-  .catch(err => console.error(\"Error cargando productos:\", err));\r\n+    <!-- Contenedor de items del carrito -->\r\n+    <div class=\"carrito-layout\">\r\n+      <div class=\"carrito-items\" id=\"carrito-items\">\r\n+        <!-- Aqu√≠ se inyectan din√°micamente los productos -->\r\n+      </div>\r\n \r\n-// =========================\r\n-// RENDERIZAR PRODUCTOS EN LA TIENDA\r\n-// =========================\r\n-const contenedorProductos = document.getElementById(\"productos-container\");\r\n+      <!-- Resumen del carrito -->\r\n+      <aside class=\"carrito-resumen\">\r\n+        <h2>Resumen</h2>\r\n \r\n-function renderProductos(lista) {\r\n-  if (!contenedorProductos) return;\r\n-  contenedorProductos.innerHTML = \"\";\r\n-  lista.forEach(producto => {\r\n-    const div = document.createElement(\"div\");\r\n-    div.classList.add(\"producto\");\r\n-    div.innerHTML = `\r\n-      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n-      <h4>${producto.nombre}</h4>\r\n-      <p>${producto.descripcion || \"\"}</p>\r\n-      <span>S/ ${producto.precio.toFixed(2)}</span>\r\n-      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n-    `;\r\n-    contenedorProductos.appendChild(div);\r\n-  });\r\n-}\r\n+        <!-- Totales -->\r\n+        <div class=\"resumen-totales\">\r\n+          <p>Subtotal: <span id=\"subtotal\">S/ 0.00</span></p>\r\n+          <p>Descuento: <span id=\"descuento\">S/ 0.00</span></p>\r\n+          <p class=\"total\">Total: <span id=\"total\">S/ 0.00</span></p>\r\n+        </div>\r\n \r\n-// =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n-// =========================\r\n-function abrirSidebar() {\r\n-  sidebar.classList.add(\"activo\");\r\n-  overlay.classList.add(\"show\");\r\n-  document.body.style.overflow = \"hidden\";\r\n-  mostrarCarrito();\r\n-}\r\n-\r\n-function cerrarSidebar() {\r\n-  sidebar.classList.remove(\"activo\");\r\n-  overlay.classList.remove(\"show\");\r\n-  document.body.style.overflow = \"auto\";\r\n-}\r\n-\r\n-// cerrar al clicar overlay\r\n-overlay.addEventListener(\"click\", cerrarSidebar);\r\n-\r\n-// Evitar que el click en el enlace <a href=\"#\"> cree un historial\r\n-abrirCarrito?.addEventListener(\"click\", (e) => {\r\n-  if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n-  abrirSidebar();\r\n-});\r\n-\r\n-// cerrar con el bot√≥n X\r\n-cerrarCarrito?.addEventListener(\"click\", (e) => {\r\n-  if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n-  cerrarSidebar();\r\n-});\r\n-\r\n-// Si el usuario pulsa \"atr√°s\" y el sidebar est√° abierto, ci√©rralo\r\n-window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar && sidebar.classList.contains(\"activo\")) {\r\n-    cerrarSidebar();\r\n-  }\r\n-});\r\n-\r\n-// =========================\r\n-// AGREGAR PRODUCTO AL CARRITO\r\n-// =========================\r\n-function agregarAlCarrito(idProducto) {\r\n-  const producto = catalogo.find(p => p.id == idProducto);\r\n-  if (!producto) return;\r\n-\r\n-  const existe = carrito.find(p => p.id == idProducto);\r\n-  if (existe) {\r\n-    existe.cantidad++;\r\n-  } else {\r\n-    carrito.push({ ...producto, cantidad: 1 });\r\n-  }\r\n-\r\n-  try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar el carrito en localStorage\", e);\r\n-  }\r\n-\r\n-  mostrarCarrito();\r\n-  actualizarContador();\r\n-  mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n-}\r\n-\r\n-// =========================\r\n-// MOSTRAR CARRITO\r\n-// =========================\r\n-function mostrarCarrito() {\r\n-  if (!carritoItems) return;\r\n-  carritoItems.innerHTML = \"\";\r\n-\r\n-  if (carrito.length === 0) {\r\n-    const p = document.createElement(\"p\");\r\n-    p.textContent = \"Tu carrito est√° vac√≠o\";\r\n-    carritoItems.appendChild(p);\r\n-\r\n-    actualizarTotales();\r\n-    actualizarContador();\r\n-    return;\r\n-  }\r\n-\r\n-  const tabla = document.createElement(\"table\");\r\n-  tabla.classList.add(\"tabla-carrito\");\r\n-\r\n-  const encabezado = document.createElement(\"thead\");\r\n-  encabezado.innerHTML = `\r\n-    <tr>\r\n-      <th>Producto</th>\r\n-      <th>Cantidad</th>\r\n-      <th>Precio</th>\r\n-      <th>Acci√≥n</th>\r\n-    </tr>\r\n-  `;\r\n-  tabla.appendChild(encabezado);\r\n-\r\n-  const cuerpo = document.createElement(\"tbody\");\r\n-\r\n-  carrito.forEach((producto, index) => {\r\n-    const fila = document.createElement(\"tr\");\r\n-\r\n-    const colProducto = document.createElement(\"td\");\r\n-    colProducto.innerHTML = `\r\n-      <div class=\"carrito-item-info\">\r\n-        <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width: 60px; height: 60px; object-fit: contain;\">\r\n-        <div>\r\n-          <strong>${producto.nombre}</strong>\r\n-          <p>${producto.descripcion || \"\"}</p>\r\n+        <!-- Barra de progreso env√≠o gratis -->\r\n+        <div class=\"progress-bar\">\r\n+          <div id=\"barra-progreso\"></div>\r\n+          <span id=\"mensaje-envio\">Agrega S/ 65.00 en productos y obt√©n env√≠o gratis</span>\r\n         </div>\r\n-      </div>\r\n-    `;\r\n-    fila.appendChild(colProducto);\r\n \r\n-    const colCantidad = document.createElement(\"td\");\r\n-    colCantidad.innerHTML = ` \r\n-      <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-      <span>${producto.cantidad}</span>\r\n-      <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-    `;\r\n-    fila.appendChild(colCantidad);\r\n+        <!-- Bot√≥n de compra por WhatsApp -->\r\n+        <button id=\"btn-whatsapp\" class=\"btn-whatsapp\" aria-label=\"Comprar ahora por WhatsApp\">\r\n+          <img src=\"img/logo/whatsapp.jpg\" alt=\"WhatsApp\" width=\"22\" height=\"22\">\r\n+          <span>Comprar ahora por WhatsApp</span>\r\n+        </button>\r\n+      </aside>\r\n+    </div>\r\n+  </main>\r\n \r\n-    const colPrecio = document.createElement(\"td\");\r\n-    colPrecio.textContent = `S/ ${(producto.precio * producto.cantidad).toFixed(2)}`;\r\n-    fila.appendChild(colPrecio);\r\n+  <!-- FOOTER -->\r\n+  <footer>\r\n+    <p>&copy; 2025 - Mi Tienda</p>\r\n+  </footer>\r\n \r\n-    const colAccion = document.createElement(\"td\");\r\n-    colAccion.innerHTML = `<button class=\"carrito-item-close\" data-index=\"${index}\">X</button>`;\r\n-    fila.appendChild(colAccion);\r\n+  <!-- Script del carrito -->\r\n+  <script src=\"js/carrito.js\"></script>\r\n \r\n-    cuerpo.appendChild(fila);\r\n-  });\r\n+  <!-- Marcar que al volver al index se cierre el sidebar -->\r\n+  <script>\r\n+    sessionStorage.setItem(\"forzarCerrarSidebar\", \"true\");\r\n+  </script>\r\n \r\n-  tabla.appendChild(cuerpo);\r\n-  carritoItems.appendChild(tabla);\r\n-\r\n-  actualizarTotales();\r\n-  actualizarContador();\r\n-\r\n-  try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar el carrito en localStorage\", e);\r\n-  }\r\n-}\r\n-\r\n-// =========================\r\n-// ACTUALIZAR LA BARRA DE PROGRESO Y MENSAJE\r\n-// =========================\r\n-const ENVIO_GRATIS_MINIMO = 65;\r\n-\r\n-function actualizarBarra(totalCarrito) {\r\n-  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  const mensajeEl = document.getElementById(\"mensaje-envio\") || document.querySelector(\".progress-bar span\");\r\n-\r\n-  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n-  if (totalCarrito <= 0) porcentaje = 0;\r\n-  if (porcentaje > 100) porcentaje = 100;\r\n-\r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n-\r\n-  if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n-    } else if (totalCarrito > 0) {\r\n-      const faltante = (ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2);\r\n-      mensajeEl.textContent = `Agrega S/ ${faltante} en productos y obt√©n env√≠o gratis`;\r\n-    } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} en productos y obt√©n env√≠o gratis`;\r\n-    }\r\n-  }\r\n-}\r\n-\r\n-// =========================\r\n-// ACTUALIZAR TOTALES\r\n-// =========================\r\n-function actualizarTotales() {\r\n-  const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n-  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n-  const total = subtotal - descuento;\r\n-\r\n-  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n-\r\n-  actualizarBarra(subtotal);\r\n-}\r\n-\r\n-// =========================\r\n-// ACTUALIZAR CONTADOR\r\n-// =========================\r\n-function actualizarContador() {\r\n-  const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n-}\r\n-\r\n-// =========================\r\n-// TOAST\r\n-// =========================\r\n-function mostrarToast(mensaje) {\r\n-  let toast = document.getElementById(\"mensajeCarrito\");\r\n-  if (!toast) {\r\n-    toast = document.createElement(\"div\");\r\n-    toast.id = \"mensajeCarrito\";\r\n-    document.body.appendChild(toast);\r\n-  }\r\n-\r\n-  toast.textContent = mensaje;\r\n-  toast.classList.add(\"mostrar\");\r\n-\r\n-  clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n-}\r\n-\r\n-// =========================\r\n-// FUNCIONALIDAD DE COMPRA POR WHATSAPP\r\n-// =========================\r\n-function comprarAhora() {\r\n-  const totalCompra = document.getElementById(\"total\").innerText;\r\n-\r\n-  let productos = carrito.map(producto => {\r\n-    return `${producto.nombre} (Cantidad: ${producto.cantidad}) - S/ ${(producto.precio * producto.cantidad).toFixed(2)}`;\r\n-  }).join(\", \");\r\n-\r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nEl total es ${totalCompra}.`;\r\n-\r\n-  const telefono = '+51920165696';\r\n-  const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-\r\n-  window.open(url, '_blank');\r\n-}\r\n-\r\n-// =========================\r\n-// EVENTOS\r\n-// =========================\r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const index = e.target.dataset.index;\r\n-  if (index === undefined) return;\r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-    try {\r\n-      localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-    } catch (e) {\r\n-      console.error(\"Error al guardar el carrito en localStorage\", e);\r\n-    }\r\n-    mostrarCarrito();\r\n-  } else if (e.target.textContent === \"+\") {\r\n-    carrito[index].cantidad++;\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-    mostrarCarrito();\r\n-  } else if (e.target.textContent === \"-\") {\r\n-    carrito[index].cantidad--;\r\n-    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-    mostrarCarrito();\r\n-  }\r\n-});\r\n-\r\n-document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n-    agregarAlCarrito(e.target.dataset.id);\r\n-  }\r\n-});\r\n-\r\n-document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-  window.location.href = \"carrito.html\";\r\n-});\r\n-\r\n-document.addEventListener(\"keydown\", e => {\r\n-  if (e.key === \"Escape\" && sidebar.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n-\r\n-// =========================\r\n-// INICIALIZAR\r\n-// =========================\r\n-mostrarCarrito();\r\n-actualizarContador();\r\n-\r\n-// =========================\r\n-// FORZAR CERRAR SIDEBAR AL VOLVER DE carrito.html\r\n-// =========================\r\n-window.addEventListener(\"DOMContentLoaded\", () => {\r\n-  if (sessionStorage.getItem(\"forzarCerrarSidebar\") === \"true\") {\r\n-    cerrarSidebar();\r\n-    sessionStorage.removeItem(\"forzarCerrarSidebar\");\r\n-  }\r\n-});\r\n+</body>\r\n+</html>\r\n"
                },
                {
                    "date": 1757622169879,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,72 +1,343 @@\n-<!DOCTYPE html>\r\n-<html lang=\"es\">\r\n-<head>\r\n-  <meta charset=\"UTF-8\">\r\n-  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-  <title>Carrito de Compras</title>\r\n-  <link rel=\"stylesheet\" href=\"css/estilos.css\">\r\n-</head>\r\n-<body>\r\n+// =========================\r\n+// VARIABLES PRINCIPALES\r\n+// =========================\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n+const sidebar = document.getElementById(\"carrito-sidebar\");\r\n+const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n+const carritoItems = document.getElementById(\"carrito-items\");\r\n+const subtotalEl = document.getElementById(\"subtotal\");\r\n+const descuentoEl = document.getElementById(\"descuento\");\r\n+const totalEl = document.getElementById(\"total\");\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n-  <!-- HEADER -->\r\n-  <header class=\"header\">\r\n-    <div class=\"logo\">\r\n-      <a href=\"index.html\">Mi Tienda</a>\r\n-    </div>\r\n-    <nav>\r\n-      <a href=\"index.html\">Inicio</a>\r\n-      <a href=\"carrito.html\" class=\"activo\">Carrito</a>\r\n-    </nav>\r\n-  </header>\r\n+let toastTimeout;\r\n+let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+let catalogo = [];\r\n \r\n-  <!-- SECCI√ìN CARRITO -->\r\n-  <main class=\"carrito-page\">\r\n-    <h1>üõí Tu Carrito</h1>\r\n+// Overlay din√°mico (evitar crearlo m√∫ltiples veces)\r\n+let overlay = document.getElementById(\"overlay-carrito\");\r\n+if (!overlay) {\r\n+  overlay = document.createElement(\"div\");\r\n+  overlay.id = \"overlay-carrito\";\r\n+  document.body.appendChild(overlay);\r\n+}\r\n \r\n-    <!-- Contenedor de items del carrito -->\r\n-    <div class=\"carrito-layout\">\r\n-      <div class=\"carrito-items\" id=\"carrito-items\">\r\n-        <!-- Aqu√≠ se inyectan din√°micamente los productos -->\r\n-      </div>\r\n+// =========================\r\n+// CARGAR JSON DE PRODUCTOS\r\n+// =========================\r\n+fetch(\"productos.json\")\r\n+  .then(res => res.json())\r\n+  .then(data => {\r\n+    catalogo = [...data.productos, ...(data.ofertas || [])];\r\n+    renderProductos(catalogo); // Renderizar productos cargados\r\n+  })\r\n+  .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n-      <!-- Resumen del carrito -->\r\n-      <aside class=\"carrito-resumen\">\r\n-        <h2>Resumen</h2>\r\n+// =========================\r\n+// RENDERIZAR PRODUCTOS EN LA TIENDA\r\n+// =========================\r\n+const contenedorProductos = document.getElementById(\"productos-container\");\r\n \r\n-        <!-- Totales -->\r\n-        <div class=\"resumen-totales\">\r\n-          <p>Subtotal: <span id=\"subtotal\">S/ 0.00</span></p>\r\n-          <p>Descuento: <span id=\"descuento\">S/ 0.00</span></p>\r\n-          <p class=\"total\">Total: <span id=\"total\">S/ 0.00</span></p>\r\n-        </div>\r\n+function renderProductos(lista) {\r\n+  if (!contenedorProductos) return;\r\n+  contenedorProductos.innerHTML = \"\";\r\n+  lista.forEach(producto => {\r\n+    const div = document.createElement(\"div\");\r\n+    div.classList.add(\"producto\");\r\n+    div.innerHTML = `\r\n+      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n+      <h4>${producto.nombre}</h4>\r\n+      <p>${producto.descripcion || \"\"}</p>\r\n+      <span>S/ ${producto.precio.toFixed(2)}</span>\r\n+      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n+    `;\r\n+    contenedorProductos.appendChild(div);\r\n+  });\r\n+}\r\n \r\n-        <!-- Barra de progreso env√≠o gratis -->\r\n-        <div class=\"progress-bar\">\r\n-          <div id=\"barra-progreso\"></div>\r\n-          <span id=\"mensaje-envio\">Agrega S/ 65.00 en productos y obt√©n env√≠o gratis</span>\r\n+// =========================\r\n+// ABRIR / CERRAR SIDEBAR\r\n+// =========================\r\n+function abrirSidebar() {\r\n+  sidebar.classList.add(\"activo\");\r\n+  overlay.classList.add(\"show\");\r\n+  document.body.style.overflow = \"hidden\";\r\n+  mostrarCarrito();\r\n+}\r\n+\r\n+function cerrarSidebar() {\r\n+  sidebar.classList.remove(\"activo\");\r\n+  overlay.classList.remove(\"show\");\r\n+  document.body.style.overflow = \"auto\";\r\n+}\r\n+\r\n+// cerrar al clicar overlay\r\n+overlay.addEventListener(\"click\", cerrarSidebar);\r\n+\r\n+// Evitar que el click en el enlace <a href=\"#\"> cree un historial\r\n+abrirCarrito?.addEventListener(\"click\", (e) => {\r\n+  if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n+  abrirSidebar();\r\n+});\r\n+\r\n+// cerrar con el bot√≥n X\r\n+cerrarCarrito?.addEventListener(\"click\", (e) => {\r\n+  if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n+  cerrarSidebar();\r\n+});\r\n+\r\n+// Si el usuario pulsa \"atr√°s\" y el sidebar est√° abierto, ci√©rralo\r\n+window.addEventListener(\"popstate\", () => {\r\n+  if (sidebar && sidebar.classList.contains(\"activo\")) {\r\n+    cerrarSidebar();\r\n+  }\r\n+});\r\n+\r\n+// =========================\r\n+// AGREGAR PRODUCTO AL CARRITO\r\n+// =========================\r\n+function agregarAlCarrito(idProducto) {\r\n+  const producto = catalogo.find(p => p.id == idProducto);\r\n+  if (!producto) return;\r\n+\r\n+  const existe = carrito.find(p => p.id == idProducto);\r\n+  if (existe) {\r\n+    existe.cantidad++;\r\n+  } else {\r\n+    carrito.push({ ...producto, cantidad: 1 });\r\n+  }\r\n+\r\n+  try {\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  } catch (e) {\r\n+    console.error(\"Error al guardar el carrito en localStorage\", e);\r\n+  }\r\n+\r\n+  mostrarCarrito();\r\n+  actualizarContador();\r\n+  mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n+}\r\n+\r\n+// =========================\r\n+// MOSTRAR CARRITO\r\n+// =========================\r\n+function mostrarCarrito() {\r\n+  if (!carritoItems) return;\r\n+  carritoItems.innerHTML = \"\";\r\n+\r\n+  if (carrito.length === 0) {\r\n+    const p = document.createElement(\"p\");\r\n+    p.textContent = \"Tu carrito est√° vac√≠o\";\r\n+    carritoItems.appendChild(p);\r\n+\r\n+    actualizarTotales();\r\n+    actualizarContador();\r\n+    return;\r\n+  }\r\n+\r\n+  const tabla = document.createElement(\"table\");\r\n+  tabla.classList.add(\"tabla-carrito\");\r\n+\r\n+  const encabezado = document.createElement(\"thead\");\r\n+  encabezado.innerHTML = `\r\n+    <tr>\r\n+      <th>Producto</th>\r\n+      <th>Cantidad</th>\r\n+      <th>Precio</th>\r\n+      <th>Acci√≥n</th>\r\n+    </tr>\r\n+  `;\r\n+  tabla.appendChild(encabezado);\r\n+\r\n+  const cuerpo = document.createElement(\"tbody\");\r\n+\r\n+  carrito.forEach((producto, index) => {\r\n+    const fila = document.createElement(\"tr\");\r\n+\r\n+    const colProducto = document.createElement(\"td\");\r\n+    colProducto.innerHTML = `\r\n+      <div class=\"carrito-item-info\">\r\n+        <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width: 60px; height: 60px; object-fit: contain;\">\r\n+        <div>\r\n+          <strong>${producto.nombre}</strong>\r\n+          <p>${producto.descripcion || \"\"}</p>\r\n         </div>\r\n+      </div>\r\n+    `;\r\n+    fila.appendChild(colProducto);\r\n \r\n-        <!-- Bot√≥n de compra por WhatsApp -->\r\n-        <button id=\"btn-whatsapp\" class=\"btn-whatsapp\" aria-label=\"Comprar ahora por WhatsApp\">\r\n-          <img src=\"img/logo/whatsapp.jpg\" alt=\"WhatsApp\" width=\"22\" height=\"22\">\r\n-          <span>Comprar ahora por WhatsApp</span>\r\n-        </button>\r\n-      </aside>\r\n-    </div>\r\n-  </main>\r\n+    const colCantidad = document.createElement(\"td\");\r\n+    colCantidad.innerHTML = ` \r\n+      <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+      <span>${producto.cantidad}</span>\r\n+      <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+    `;\r\n+    fila.appendChild(colCantidad);\r\n \r\n-  <!-- FOOTER -->\r\n-  <footer>\r\n-    <p>&copy; 2025 - Mi Tienda</p>\r\n-  </footer>\r\n+    const colPrecio = document.createElement(\"td\");\r\n+    colPrecio.textContent = `S/ ${(producto.precio * producto.cantidad).toFixed(2)}`;\r\n+    fila.appendChild(colPrecio);\r\n \r\n-  <!-- Script del carrito -->\r\n-  <script src=\"js/carrito.js\"></script>\r\n+    const colAccion = document.createElement(\"td\");\r\n+    colAccion.innerHTML = `<button class=\"carrito-item-close\" data-index=\"${index}\">X</button>`;\r\n+    fila.appendChild(colAccion);\r\n \r\n-  <!-- Marcar que al volver al index se cierre el sidebar -->\r\n-  <script>\r\n-    sessionStorage.setItem(\"forzarCerrarSidebar\", \"true\");\r\n-  </script>\r\n+    cuerpo.appendChild(fila);\r\n+  });\r\n \r\n-</body>\r\n-</html>\r\n+  tabla.appendChild(cuerpo);\r\n+  carritoItems.appendChild(tabla);\r\n+\r\n+  actualizarTotales();\r\n+  actualizarContador();\r\n+\r\n+  try {\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  } catch (e) {\r\n+    console.error(\"Error al guardar el carrito en localStorage\", e);\r\n+  }\r\n+}\r\n+\r\n+// =========================\r\n+// ACTUALIZAR LA BARRA DE PROGRESO Y MENSAJE\r\n+// =========================\r\n+const ENVIO_GRATIS_MINIMO = 65;\r\n+\r\n+function actualizarBarra(totalCarrito) {\r\n+  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n+  const mensajeEl = document.getElementById(\"mensaje-envio\") || document.querySelector(\".progress-bar span\");\r\n+\r\n+  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n+  if (totalCarrito <= 0) porcentaje = 0;\r\n+  if (porcentaje > 100) porcentaje = 100;\r\n+\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+\r\n+  if (mensajeEl) {\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+    } else if (totalCarrito > 0) {\r\n+      const faltante = (ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2);\r\n+      mensajeEl.textContent = `Agrega S/ ${faltante} en productos y obt√©n env√≠o gratis`;\r\n+    } else {\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} en productos y obt√©n env√≠o gratis`;\r\n+    }\r\n+  }\r\n+}\r\n+\r\n+// =========================\r\n+// ACTUALIZAR TOTALES\r\n+// =========================\r\n+function actualizarTotales() {\r\n+  const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n+  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n+  const total = subtotal - descuento;\r\n+\r\n+  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+\r\n+  actualizarBarra(subtotal);\r\n+}\r\n+\r\n+// =========================\r\n+// ACTUALIZAR CONTADOR\r\n+// =========================\r\n+function actualizarContador() {\r\n+  const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+}\r\n+\r\n+// =========================\r\n+// TOAST\r\n+// =========================\r\n+function mostrarToast(mensaje) {\r\n+  let toast = document.getElementById(\"mensajeCarrito\");\r\n+  if (!toast) {\r\n+    toast = document.createElement(\"div\");\r\n+    toast.id = \"mensajeCarrito\";\r\n+    document.body.appendChild(toast);\r\n+  }\r\n+\r\n+  toast.textContent = mensaje;\r\n+  toast.classList.add(\"mostrar\");\r\n+\r\n+  clearTimeout(toastTimeout);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n+}\r\n+\r\n+// =========================\r\n+// FUNCIONALIDAD DE COMPRA POR WHATSAPP\r\n+// =========================\r\n+function comprarAhora() {\r\n+  const totalCompra = document.getElementById(\"total\").innerText;\r\n+\r\n+  let productos = carrito.map(producto => {\r\n+    return `${producto.nombre} (Cantidad: ${producto.cantidad}) - S/ ${(producto.precio * producto.cantidad).toFixed(2)}`;\r\n+  }).join(\", \");\r\n+\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nEl total es ${totalCompra}.`;\r\n+\r\n+  const telefono = '+51920165696';\r\n+  const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+\r\n+  window.open(url, '_blank');\r\n+}\r\n+\r\n+// =========================\r\n+// EVENTOS\r\n+// =========================\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const index = e.target.dataset.index;\r\n+  if (index === undefined) return;\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+    try {\r\n+      localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+    } catch (e) {\r\n+      console.error(\"Error al guardar el carrito en localStorage\", e);\r\n+    }\r\n+    mostrarCarrito();\r\n+  } else if (e.target.textContent === \"+\") {\r\n+    carrito[index].cantidad++;\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+    mostrarCarrito();\r\n+  } else if (e.target.textContent === \"-\") {\r\n+    carrito[index].cantidad--;\r\n+    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+    mostrarCarrito();\r\n+  }\r\n+});\r\n+\r\n+document.addEventListener(\"click\", e => {\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n+    agregarAlCarrito(e.target.dataset.id);\r\n+  }\r\n+});\r\n+\r\n+document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+  window.location.href = \"carrito.html\";\r\n+});\r\n+\r\n+document.addEventListener(\"keydown\", e => {\r\n+  if (e.key === \"Escape\" && sidebar.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n+\r\n+// =========================\r\n+// INICIALIZAR\r\n+// =========================\r\n+mostrarCarrito();\r\n+actualizarContador();\r\n+\r\n+// =========================\r\n+// FORZAR CERRAR SIDEBAR AL VOLVER DE carrito.html\r\n+// =========================\r\n+window.addEventListener(\"DOMContentLoaded\", () => {\r\n+  if (sessionStorage.getItem(\"forzarCerrarSidebar\") === \"true\") {\r\n+    cerrarSidebar();\r\n+    sessionStorage.removeItem(\"forzarCerrarSidebar\");\r\n+  }\r\n+});\r\n"
                },
                {
                    "date": 1757624928986,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -13,9 +13,9 @@\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n-// Overlay din√°mico (evitar crearlo m√∫ltiples veces)\r\n+// Overlay din√°mico (evitar duplicados)\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n   overlay.id = \"overlay-carrito\";\r\n@@ -28,14 +28,14 @@\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n     catalogo = [...data.productos, ...(data.ofertas || [])];\r\n-    renderProductos(catalogo); // Renderizar productos cargados\r\n+    renderProductos(catalogo); // Renderizar al cargar\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDERIZAR PRODUCTOS EN LA TIENDA\r\n+// RENDERIZAR PRODUCTOS EN TIENDA\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n \r\n function renderProductos(lista) {\r\n@@ -70,32 +70,30 @@\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n }\r\n \r\n-// cerrar al clicar overlay\r\n+// Overlay\r\n overlay.addEventListener(\"click\", cerrarSidebar);\r\n \r\n-// Evitar que el click en el enlace <a href=\"#\"> cree un historial\r\n-abrirCarrito?.addEventListener(\"click\", (e) => {\r\n-  if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n+// Abrir carrito\r\n+abrirCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n   abrirSidebar();\r\n });\r\n \r\n-// cerrar con el bot√≥n X\r\n-cerrarCarrito?.addEventListener(\"click\", (e) => {\r\n-  if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n+// Cerrar con X\r\n+cerrarCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n   cerrarSidebar();\r\n });\r\n \r\n-// Si el usuario pulsa \"atr√°s\" y el sidebar est√° abierto, ci√©rralo\r\n+// Cerrar con bot√≥n atr√°s del navegador\r\n window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar && sidebar.classList.contains(\"activo\")) {\r\n-    cerrarSidebar();\r\n-  }\r\n+  if (sidebar.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n // =========================\r\n-// AGREGAR PRODUCTO AL CARRITO\r\n+// AGREGAR PRODUCTO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n@@ -106,14 +104,9 @@\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n   }\r\n \r\n-  try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar el carrito en localStorage\", e);\r\n-  }\r\n-\r\n+  guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n@@ -125,128 +118,114 @@\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n   if (carrito.length === 0) {\r\n-    const p = document.createElement(\"p\");\r\n-    p.textContent = \"Tu carrito est√° vac√≠o\";\r\n-    carritoItems.appendChild(p);\r\n-\r\n+    carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n     actualizarTotales();\r\n     actualizarContador();\r\n     return;\r\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n \r\n-  const encabezado = document.createElement(\"thead\");\r\n-  encabezado.innerHTML = `\r\n-    <tr>\r\n-      <th>Producto</th>\r\n-      <th>Cantidad</th>\r\n-      <th>Precio</th>\r\n-      <th>Acci√≥n</th>\r\n-    </tr>\r\n+  tabla.innerHTML = `\r\n+    <thead>\r\n+      <tr>\r\n+        <th>Producto</th>\r\n+        <th>Cantidad</th>\r\n+        <th>Precio</th>\r\n+        <th>Acci√≥n</th>\r\n+      </tr>\r\n+    </thead>\r\n+    <tbody>\r\n+      ${carrito.map((producto, index) => `\r\n+        <tr>\r\n+          <td>\r\n+            <div class=\"carrito-item-info\">\r\n+              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+              <div>\r\n+                <strong>${producto.nombre}</strong>\r\n+                <p>${producto.descripcion || \"\"}</p>\r\n+              </div>\r\n+            </div>\r\n+          </td>\r\n+          <td>\r\n+            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+            <span>${producto.cantidad}</span>\r\n+            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+          </td>\r\n+          <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n+          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+        </tr>\r\n+      `).join(\"\")}\r\n+    </tbody>\r\n   `;\r\n-  tabla.appendChild(encabezado);\r\n \r\n-  const cuerpo = document.createElement(\"tbody\");\r\n-\r\n-  carrito.forEach((producto, index) => {\r\n-    const fila = document.createElement(\"tr\");\r\n-\r\n-    const colProducto = document.createElement(\"td\");\r\n-    colProducto.innerHTML = `\r\n-      <div class=\"carrito-item-info\">\r\n-        <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width: 60px; height: 60px; object-fit: contain;\">\r\n-        <div>\r\n-          <strong>${producto.nombre}</strong>\r\n-          <p>${producto.descripcion || \"\"}</p>\r\n-        </div>\r\n-      </div>\r\n-    `;\r\n-    fila.appendChild(colProducto);\r\n-\r\n-    const colCantidad = document.createElement(\"td\");\r\n-    colCantidad.innerHTML = ` \r\n-      <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-      <span>${producto.cantidad}</span>\r\n-      <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-    `;\r\n-    fila.appendChild(colCantidad);\r\n-\r\n-    const colPrecio = document.createElement(\"td\");\r\n-    colPrecio.textContent = `S/ ${(producto.precio * producto.cantidad).toFixed(2)}`;\r\n-    fila.appendChild(colPrecio);\r\n-\r\n-    const colAccion = document.createElement(\"td\");\r\n-    colAccion.innerHTML = `<button class=\"carrito-item-close\" data-index=\"${index}\">X</button>`;\r\n-    fila.appendChild(colAccion);\r\n-\r\n-    cuerpo.appendChild(fila);\r\n-  });\r\n-\r\n-  tabla.appendChild(cuerpo);\r\n   carritoItems.appendChild(tabla);\r\n \r\n   actualizarTotales();\r\n   actualizarContador();\r\n+  guardarCarrito();\r\n+}\r\n \r\n+// =========================\r\n+// GUARDAR CARRITO EN LOCALSTORAGE\r\n+// =========================\r\n+function guardarCarrito() {\r\n   try {\r\n     localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n   } catch (e) {\r\n-    console.error(\"Error al guardar el carrito en localStorage\", e);\r\n+    console.error(\"Error al guardar carrito\", e);\r\n   }\r\n }\r\n \r\n // =========================\r\n-// ACTUALIZAR LA BARRA DE PROGRESO Y MENSAJE\r\n+// BARRA DE PROGRESO\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 65;\r\n \r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  const mensajeEl = document.getElementById(\"mensaje-envio\") || document.querySelector(\".progress-bar span\");\r\n+  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n-  if (totalCarrito <= 0) porcentaje = 0;\r\n-  if (porcentaje > 100) porcentaje = 100;\r\n+  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n       mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n     } else if (totalCarrito > 0) {\r\n-      const faltante = (ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2);\r\n-      mensajeEl.textContent = `Agrega S/ ${faltante} en productos y obt√©n env√≠o gratis`;\r\n+      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n     } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} en productos y obt√©n env√≠o gratis`;\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n     }\r\n   }\r\n }\r\n \r\n // =========================\r\n-// ACTUALIZAR TOTALES\r\n+// TOTALES\r\n // =========================\r\n function actualizarTotales() {\r\n   const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n   const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n   const total = subtotal - descuento;\r\n \r\n-  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (descuentoEl) descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n \r\n   actualizarBarra(subtotal);\r\n }\r\n \r\n // =========================\r\n-// ACTUALIZAR CONTADOR\r\n+// CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+  contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n // =========================\r\n // TOAST\r\n@@ -257,72 +236,64 @@\n     toast = document.createElement(\"div\");\r\n     toast.id = \"mensajeCarrito\";\r\n     document.body.appendChild(toast);\r\n   }\r\n-\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n \r\n   clearTimeout(toastTimeout);\r\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// FUNCIONALIDAD DE COMPRA POR WHATSAPP\r\n+// COMPRA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n-  const totalCompra = document.getElementById(\"total\").innerText;\r\n+  const totalCompra = totalEl.innerText;\r\n+  const productos = carrito.map(p =>\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n+  ).join(\", \");\r\n \r\n-  let productos = carrito.map(producto => {\r\n-    return `${producto.nombre} (Cantidad: ${producto.cantidad}) - S/ ${(producto.precio * producto.cantidad).toFixed(2)}`;\r\n-  }).join(\", \");\r\n-\r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nEl total es ${totalCompra}.`;\r\n-\r\n-  const telefono = '+51920165696';\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n+  const telefono = \"51920165696\";\r\n   const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-\r\n-  window.open(url, '_blank');\r\n+  window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n // EVENTOS\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n+\r\n   if (e.target.classList.contains(\"carrito-item-close\")) {\r\n     carrito.splice(index, 1);\r\n-    try {\r\n-      localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-    } catch (e) {\r\n-      console.error(\"Error al guardar el carrito en localStorage\", e);\r\n-    }\r\n-    mostrarCarrito();\r\n-  } else if (e.target.textContent === \"+\") {\r\n+  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n     carrito[index].cantidad++;\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-    mostrarCarrito();\r\n-  } else if (e.target.textContent === \"-\") {\r\n+  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n     carrito[index].cantidad--;\r\n     if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-    mostrarCarrito();\r\n   }\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n });\r\n \r\n+// Bot√≥n agregar producto\r\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n     agregarAlCarrito(e.target.dataset.id);\r\n   }\r\n });\r\n \r\n+// Ver carrito\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n \r\n+// Cerrar con ESC\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n"
                },
                {
                    "date": 1757631794397,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,21 +1,23 @@\n // =========================\r\n // VARIABLES PRINCIPALES\r\n // =========================\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n-const sidebar = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n-const carritoItems = document.getElementById(\"carrito-items\");\r\n-const subtotalEl = document.getElementById(\"subtotal\");\r\n-const descuentoEl = document.getElementById(\"descuento\");\r\n-const totalEl = document.getElementById(\"total\");\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\"); // bot√≥n o enlace carrito\r\n+const sidebar = document.getElementById(\"carrito-sidebar\");    // sidebar lateral\r\n+const cerrarCarrito = document.querySelector(\".cerrar-carrito\"); // bot√≥n X cerrar sidebar\r\n+const carritoItems = document.getElementById(\"carrito-items\"); // contenedor de productos\r\n+const subtotalEl = document.getElementById(\"subtotal\");        // subtotal\r\n+const descuentoEl = document.getElementById(\"descuento\");      // descuento\r\n+const totalEl = document.getElementById(\"total\");              // total\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\"); // contador badge carrito\r\n \r\n-let toastTimeout;\r\n-let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-let catalogo = [];\r\n+let toastTimeout; // controla tiempo del toast\r\n+let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || []; // lee carrito guardado\r\n+let catalogo = []; // cat√°logo de productos (desde JSON)\r\n \r\n-// Overlay din√°mico (evitar duplicados)\r\n+// =========================\r\n+// CREAR OVERLAY (fondo oscuro)\r\n+// =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n   overlay.id = \"overlay-carrito\";\r\n@@ -38,9 +40,9 @@\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n \r\n function renderProductos(lista) {\r\n-  if (!contenedorProductos) return;\r\n+  if (!contenedorProductos) return; // si no hay contenedor (ej: carrito.html) no hace nada\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n@@ -58,38 +60,34 @@\n // =========================\r\n // ABRIR / CERRAR SIDEBAR\r\n // =========================\r\n function abrirSidebar() {\r\n+  if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n }\r\n \r\n function cerrarSidebar() {\r\n+  if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n }\r\n \r\n-// Overlay\r\n-overlay.addEventListener(\"click\", cerrarSidebar);\r\n-\r\n-// Abrir carrito\r\n+// Eventos abrir/cerrar sidebar\r\n+overlay?.addEventListener(\"click\", cerrarSidebar);\r\n abrirCarrito?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   abrirSidebar();\r\n });\r\n-\r\n-// Cerrar con X\r\n cerrarCarrito?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n });\r\n-\r\n-// Cerrar con bot√≥n atr√°s del navegador\r\n window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar.classList.contains(\"activo\")) cerrarSidebar();\r\n+  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n // =========================\r\n // AGREGAR PRODUCTO\r\n@@ -111,9 +109,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO\r\n+// MOSTRAR CARRITO (tabla)\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -179,9 +177,9 @@\n   }\r\n }\r\n \r\n // =========================\r\n-// BARRA DE PROGRESO\r\n+// BARRA DE PROGRESO ENV√çO GRATIS\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 65;\r\n \r\n function actualizarBarra(totalCarrito) {\r\n@@ -219,17 +217,17 @@\n   actualizarBarra(subtotal);\r\n }\r\n \r\n // =========================\r\n-// CONTADOR\r\n+// CONTADOR (badge carrito)\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-  contadorCarrito.textContent = totalItems;\r\n+  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n // =========================\r\n-// TOAST\r\n+// TOAST (mensaje emergente)\r\n // =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n@@ -253,15 +251,15 @@\n     `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n   ).join(\", \");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-  const telefono = \"51920165696\";\r\n+  const telefono = \"51920165696\"; // <-- tu n√∫mero\r\n   const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n-// EVENTOS\r\n+// EVENTOS DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n@@ -277,25 +275,25 @@\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n-// Bot√≥n agregar producto\r\n+// Bot√≥n \"Agregar al carrito\"\r\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n     agregarAlCarrito(e.target.dataset.id);\r\n   }\r\n });\r\n \r\n-// Ver carrito\r\n+// Bot√≥n \"Ver carrito\" ‚Üí va a carrito.html\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n \r\n-// Cerrar con ESC\r\n+// Cerrar con tecla ESC\r\n document.addEventListener(\"keydown\", e => {\r\n-  if (e.key === \"Escape\" && sidebar.classList.contains(\"activo\")) cerrarSidebar();\r\n+  if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n // =========================\r\n // INICIALIZAR\r\n"
                },
                {
                    "date": 1757635925248,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -210,10 +210,15 @@\n   const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n   const total = subtotal - descuento;\r\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  subtotalEl.classList.add('naranja');  // Aplicamos la clase naranja al subtotal\r\n+\r\n   descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+  descuentoEl.classList.add('naranja');  // Aplicamos la clase naranja al descuento\r\n+\r\n   totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  totalEl.classList.add('naranja');  // Aplicamos la clase naranja al total\r\n \r\n   actualizarBarra(subtotal);\r\n }\r\n \r\n@@ -251,10 +256,13 @@\n     `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n   ).join(\", \");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-  const telefono = \"51920165696\"; // <-- tu n√∫mero\r\n+  \r\n+  const telefono = \"51920165696\"; // Aseg√∫rate de usar el n√∫mero completo (sin +)\r\n   const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+\r\n+  // Intentar abrir el enlace de WhatsApp\r\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n@@ -299,14 +307,4 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n-\r\n-// =========================\r\n-// FORZAR CERRAR SIDEBAR AL VOLVER DE carrito.html\r\n-// =========================\r\n-window.addEventListener(\"DOMContentLoaded\", () => {\r\n-  if (sessionStorage.getItem(\"forzarCerrarSidebar\") === \"true\") {\r\n-    cerrarSidebar();\r\n-    sessionStorage.removeItem(\"forzarCerrarSidebar\");\r\n-  }\r\n-});\r\n"
                },
                {
                    "date": 1757653076801,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -160,12 +160,12 @@\n   `;\r\n \r\n   carritoItems.appendChild(tabla);\r\n \r\n-  actualizarTotales();\r\n-  actualizarContador();\r\n-  guardarCarrito();\r\n-}\r\n+  // Activar el scroll despu√©s de agregar el segundo producto\r\n+  if (carrito.length >= 2) {\r\n+    carritoItems.style.overflowY = 'auto'; // Activar el scroll vertical\r\n+  }\r\n \r\n // =========================\r\n // GUARDAR CARRITO EN LOCALSTORAGE\r\n // =========================\r\n"
                },
                {
                    "date": 1757653435982,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -162,11 +162,18 @@\n   carritoItems.appendChild(tabla);\r\n \r\n   // Activar el scroll despu√©s de agregar el segundo producto\r\n   if (carrito.length >= 2) {\r\n-    carritoItems.style.overflowY = 'auto'; // Activar el scroll vertical\r\n+    carritoItems.style.overflowY = 'auto'; // Habilitar el scroll vertical\r\n+  } else {\r\n+    carritoItems.style.overflowY = 'hidden'; // Desactivar el scroll si no hay suficientes productos\r\n   }\r\n \r\n+  actualizarTotales();\r\n+  actualizarContador();\r\n+  guardarCarrito();\r\n+}\r\n+\r\n // =========================\r\n // GUARDAR CARRITO EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n"
                },
                {
                    "date": 1757655221506,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -65,15 +65,17 @@\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n+  localStorage.setItem(\"sidebarAbierto\", \"true\"); // üîπ NUEVO: guardar estado\r\n }\r\n \r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n+  localStorage.removeItem(\"sidebarAbierto\"); // üîπ NUEVO: limpiar estado\r\n }\r\n \r\n // Eventos abrir/cerrar sidebar\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n@@ -162,11 +164,11 @@\n   carritoItems.appendChild(tabla);\r\n \r\n   // Activar el scroll despu√©s de agregar el segundo producto\r\n   if (carrito.length >= 2) {\r\n-    carritoItems.style.overflowY = 'auto'; // Habilitar el scroll vertical\r\n+    carritoItems.style.overflowY = 'auto';\r\n   } else {\r\n-    carritoItems.style.overflowY = 'hidden'; // Desactivar el scroll si no hay suficientes productos\r\n+    carritoItems.style.overflowY = 'hidden';\r\n   }\r\n \r\n   actualizarTotales();\r\n   actualizarContador();\r\n@@ -217,15 +219,15 @@\n   const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n   const total = subtotal - descuento;\r\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  subtotalEl.classList.add('naranja');  // Aplicamos la clase naranja al subtotal\r\n+  subtotalEl.classList.add('naranja');\r\n \r\n   descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-  descuentoEl.classList.add('naranja');  // Aplicamos la clase naranja al descuento\r\n+  descuentoEl.classList.add('naranja');\r\n \r\n   totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n-  totalEl.classList.add('naranja');  // Aplicamos la clase naranja al total\r\n+  totalEl.classList.add('naranja');\r\n \r\n   actualizarBarra(subtotal);\r\n }\r\n \r\n@@ -263,13 +265,11 @@\n     `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n   ).join(\", \");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-  \r\n-  const telefono = \"51920165696\"; // Aseg√∫rate de usar el n√∫mero completo (sin +)\r\n+\r\n+  const telefono = \"51920165696\";\r\n   const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-\r\n-  // Intentar abrir el enlace de WhatsApp\r\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n@@ -314,4 +314,9 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n+\r\n+// üîπ NUEVO: cerrar sidebar si qued√≥ abierto al volver de carrito.html\r\n+if (localStorage.getItem(\"sidebarAbierto\")) {\r\n+  cerrarSidebar();\r\n+}\r\n"
                },
                {
                    "date": 1757655534113,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,9 +40,9 @@\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n \r\n function renderProductos(lista) {\r\n-  if (!contenedorProductos) return; // si no hay contenedor (ej: carrito.html) no hace nada\r\n+  if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n@@ -57,25 +57,29 @@\n   });\r\n }\r\n \r\n // =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n+// ABRIR / CERRAR SIDEBAR CON HISTORIAL\r\n // =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n-  localStorage.setItem(\"sidebarAbierto\", \"true\"); // üîπ NUEVO: guardar estado\r\n+\r\n+  // üîπ Agregar un estado al historial para detectar Atr√°s\r\n+  history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n \r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n-  localStorage.removeItem(\"sidebarAbierto\"); // üîπ NUEVO: limpiar estado\r\n+\r\n+  // üîπ Limpiar estado del historial actual\r\n+  history.replaceState({}, \"\");\r\n }\r\n \r\n // Eventos abrir/cerrar sidebar\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n@@ -86,10 +90,14 @@\n cerrarCarrito?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n });\r\n-window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+\r\n+// üîπ Escuchar popstate para cerrar sidebar si estaba abierto\r\n+window.addEventListener(\"popstate\", (event) => {\r\n+  if (sidebar?.classList.contains(\"activo\")) {\r\n+    cerrarSidebar();\r\n+  }\r\n });\r\n \r\n // =========================\r\n // AGREGAR PRODUCTO\r\n@@ -162,14 +170,9 @@\n   `;\r\n \r\n   carritoItems.appendChild(tabla);\r\n \r\n-  // Activar el scroll despu√©s de agregar el segundo producto\r\n-  if (carrito.length >= 2) {\r\n-    carritoItems.style.overflowY = 'auto';\r\n-  } else {\r\n-    carritoItems.style.overflowY = 'hidden';\r\n-  }\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n \r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n@@ -265,11 +268,12 @@\n     `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n   ).join(\", \");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-\r\n+  \r\n   const telefono = \"51920165696\";\r\n   const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+\r\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n@@ -314,9 +318,4 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n-\r\n-// üîπ NUEVO: cerrar sidebar si qued√≥ abierto al volver de carrito.html\r\n-if (localStorage.getItem(\"sidebarAbierto\")) {\r\n-  cerrarSidebar();\r\n-}\r\n"
                },
                {
                    "date": 1757655732755,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,19 +1,19 @@\n // =========================\r\n // VARIABLES PRINCIPALES\r\n // =========================\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\"); // bot√≥n o enlace carrito\r\n-const sidebar = document.getElementById(\"carrito-sidebar\");    // sidebar lateral\r\n-const cerrarCarrito = document.querySelector(\".cerrar-carrito\"); // bot√≥n X cerrar sidebar\r\n-const carritoItems = document.getElementById(\"carrito-items\"); // contenedor de productos\r\n-const subtotalEl = document.getElementById(\"subtotal\");        // subtotal\r\n-const descuentoEl = document.getElementById(\"descuento\");      // descuento\r\n-const totalEl = document.getElementById(\"total\");              // total\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\"); // contador badge carrito\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n+const sidebar = document.getElementById(\"carrito-sidebar\");\r\n+const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n+const carritoItems = document.getElementById(\"carrito-items\");\r\n+const subtotalEl = document.getElementById(\"subtotal\");\r\n+const descuentoEl = document.getElementById(\"descuento\");\r\n+const totalEl = document.getElementById(\"total\");\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n-let toastTimeout; // controla tiempo del toast\r\n-let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || []; // lee carrito guardado\r\n-let catalogo = []; // cat√°logo de productos (desde JSON)\r\n+let toastTimeout;\r\n+let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+let catalogo = [];\r\n \r\n // =========================\r\n // CREAR OVERLAY (fondo oscuro)\r\n // =========================\r\n@@ -30,9 +30,9 @@\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n     catalogo = [...data.productos, ...(data.ofertas || [])];\r\n-    renderProductos(catalogo); // Renderizar al cargar\r\n+    renderProductos(catalogo);\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n@@ -65,24 +65,19 @@\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n-\r\n-  // üîπ Agregar un estado al historial para detectar Atr√°s\r\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n \r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n-\r\n-  // üîπ Limpiar estado del historial actual\r\n   history.replaceState({}, \"\");\r\n }\r\n \r\n-// Eventos abrir/cerrar sidebar\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n abrirCarrito?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   abrirSidebar();\r\n@@ -91,12 +86,18 @@\n   e.preventDefault();\r\n   cerrarSidebar();\r\n });\r\n \r\n-// üîπ Escuchar popstate para cerrar sidebar si estaba abierto\r\n-window.addEventListener(\"popstate\", (event) => {\r\n-  if (sidebar?.classList.contains(\"activo\")) {\r\n+// üîπ Manejo de historial y bfcache (Atr√°s)\r\n+window.addEventListener(\"popstate\", () => {\r\n+  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n+\r\n+// üîπ Manejar back-forward cache para cerrar sidebar al volver\r\n+window.addEventListener(\"pageshow\", (event) => {\r\n+  if (event.persisted) {\r\n     cerrarSidebar();\r\n+    mostrarCarrito();\r\n   }\r\n });\r\n \r\n // =========================\r\n@@ -169,11 +170,9 @@\n     </tbody>\r\n   `;\r\n \r\n   carritoItems.appendChild(tabla);\r\n-\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n-\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n@@ -189,9 +188,9 @@\n   }\r\n }\r\n \r\n // =========================\r\n-// BARRA DE PROGRESO ENV√çO GRATIS\r\n+// TOTALES, BARRA, CONTADOR Y TOAST\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 65;\r\n \r\n function actualizarBarra(totalCarrito) {\r\n@@ -213,11 +212,8 @@\n     }\r\n   }\r\n }\r\n \r\n-// =========================\r\n-// TOTALES\r\n-// =========================\r\n function actualizarTotales() {\r\n   const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n   const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n   const total = subtotal - descuento;\r\n@@ -233,19 +229,13 @@\n \r\n   actualizarBarra(subtotal);\r\n }\r\n \r\n-// =========================\r\n-// CONTADOR (badge carrito)\r\n-// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n-// =========================\r\n-// TOAST (mensaje emergente)\r\n-// =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n@@ -268,12 +258,10 @@\n     `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n   ).join(\", \");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-  \r\n   const telefono = \"51920165696\";\r\n   const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-\r\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n@@ -294,23 +282,20 @@\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n-// Bot√≥n \"Agregar al carrito\"\r\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n     agregarAlCarrito(e.target.dataset.id);\r\n   }\r\n });\r\n \r\n-// Bot√≥n \"Ver carrito\" ‚Üí va a carrito.html\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n \r\n-// Cerrar con tecla ESC\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n"
                },
                {
                    "date": 1757691403186,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -251,17 +251,20 @@\n \r\n // =========================\r\n // COMPRA POR WHATSAPP\r\n // =========================\r\n-function comprarAhora() {\r\n+function redirigirWhatsApp() {\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n     `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n   ).join(\", \");\r\n-\r\n+  \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n   const telefono = \"51920165696\";\r\n-  const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+  const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n+    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n+    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+\r\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n"
                },
                {
                    "date": 1757691502002,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -258,9 +258,9 @@\n     `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n   ).join(\", \");\r\n   \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-  const telefono = \"51920165696\";\r\n+  const telefono = \"920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n"
                },
                {
                    "date": 1757691681416,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -258,9 +258,9 @@\n     `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n   ).join(\", \");\r\n   \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-  const telefono = \"920165696\";\r\n+  const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n"
                },
                {
                    "date": 1757703454535,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -41,19 +41,34 @@\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n \r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n-  contenedorProductos.innerHTML = \"\";\r\n+  contenedorProductos.innerHTML = \"\"; // Limpiar el contenedor antes de agregar los productos\r\n+\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n+    \r\n+    // Aqu√≠ vamos a mostrar el precio regular, precio con descuento, porcentaje de descuento y ahorro\r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      <span>S/ ${producto.precio.toFixed(2)}</span>\r\n+      \r\n+      <!-- Mostrar precio regular con tachado y precio con descuento -->\r\n+      <div class=\"precio\">\r\n+        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span> \r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+      </div>\r\n+      \r\n+      <!-- Mostrar el descuento y el ahorro -->\r\n+      <div class=\"descuento\">${producto.descuento}% OFF</div>\r\n+      <div class=\"ahorro\">Ahorro: S/ ${producto.ahorro.toFixed(2)}</div>\r\n+      \r\n+      <!-- Bot√≥n para agregar al carrito -->\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n+    \r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n@@ -124,9 +139,9 @@\n // MOSTRAR CARRITO (tabla)\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n-  carritoItems.innerHTML = \"\";\r\n+  carritoItems.innerHTML = \"\";  // Limpiar el carrito si est√° vac√≠o\r\n \r\n   if (carrito.length === 0) {\r\n     carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n     actualizarTotales();\r\n@@ -162,9 +177,10 @@\n             <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n             <span>${producto.cantidad}</span>\r\n             <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n           </td>\r\n-          <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n+          <!-- Mostrar el precio con descuento y cantidad -->\r\n+          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n           <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n         </tr>\r\n       `).join(\"\")}\r\n     </tbody>\r\n@@ -213,9 +229,12 @@\n   }\r\n }\r\n \r\n function actualizarTotales() {\r\n-  const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n+  // Calculamos el subtotal utilizando el precio con descuento\r\n+  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n+  \r\n+  // Si el total supera un cierto umbral, aplicamos un descuento adicional\r\n   const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n   const total = subtotal - descuento;\r\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n"
                },
                {
                    "date": 1757703674964,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -41,23 +41,20 @@\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n \r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n-  contenedorProductos.innerHTML = \"\"; // Limpiar el contenedor antes de agregar los productos\r\n-\r\n+  contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n-    \r\n-    // Aqu√≠ vamos a mostrar el precio regular, precio con descuento, porcentaje de descuento y ahorro\r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n       \r\n       <!-- Mostrar precio regular con tachado y precio con descuento -->\r\n       <div class=\"precio\">\r\n-        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span> \r\n+        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n         <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n       </div>\r\n       \r\n       <!-- Mostrar el descuento y el ahorro -->\r\n@@ -139,9 +136,9 @@\n // MOSTRAR CARRITO (tabla)\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n-  carritoItems.innerHTML = \"\";  // Limpiar el carrito si est√° vac√≠o\r\n+  carritoItems.innerHTML = \"\";\r\n \r\n   if (carrito.length === 0) {\r\n     carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n     actualizarTotales();\r\n@@ -325,4 +322,5 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n+\r\n"
                },
                {
                    "date": 1757966156597,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,29 +50,61 @@\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n       \r\n-      <!-- Mostrar precio regular con tachado y precio con descuento -->\r\n       <div class=\"precio\">\r\n         <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n       </div>\r\n       \r\n-      <!-- Mostrar el descuento y el ahorro -->\r\n-      <div class=\"descuento\">${producto.descuento}% OFF</div>\r\n-      <div class=\"ahorro\">Ahorro: S/ ${producto.ahorro.toFixed(2)}</div>\r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       \r\n-      <!-- Bot√≥n para agregar al carrito -->\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n     \r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// ABRIR / CERRAR SIDEBAR CON HISTORIAL\r\n+// FUNCIONES DE DESCUENTO POR VOLUMEN\r\n // =========================\r\n+function calcularTotalProducto(producto) {\r\n+  let total = 0;\r\n+  const cantidad = producto.cantidad;\r\n+\r\n+  if (producto.descuentoVolumen) {\r\n+    const promo = producto.descuentoVolumen;\r\n+\r\n+    if (promo.tipo === \"2da50\") {\r\n+      // üëâ Ejemplo: compra 1 y la 2da al 50%\r\n+      const pares = Math.floor(cantidad / 2);\r\n+      const resto = cantidad % 2;\r\n+      total = (pares * (producto.precio + producto.precio * promo.promo)) + (resto * producto.precio);\r\n+\r\n+    } else if (promo.tipo === \"3ra50\") {\r\n+      // üëâ Ejemplo: compra 2 y la 3ra al 50%\r\n+      const grupos = Math.floor(cantidad / 3);\r\n+      const resto = cantidad % 3;\r\n+      total = (grupos * ((2 * producto.precio) + (producto.precio * promo.promo))) + (resto * producto.precio);\r\n+    }\r\n+\r\n+  } else {\r\n+    // Si no tiene promo volumen usamos el precio con descuento normal\r\n+    if (producto.precio_con_descuento) {\r\n+      total = producto.precio_con_descuento * cantidad;\r\n+    } else {\r\n+      total = producto.precio * cantidad;\r\n+    }\r\n+  }\r\n+\r\n+  return total;\r\n+}\r\n+\r\n+// =========================\r\n+// ABRIR / CERRAR SIDEBAR\r\n+// =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n@@ -98,14 +130,12 @@\n   e.preventDefault();\r\n   cerrarSidebar();\r\n });\r\n \r\n-// üîπ Manejo de historial y bfcache (Atr√°s)\r\n window.addEventListener(\"popstate\", () => {\r\n   if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n-// üîπ Manejar back-forward cache para cerrar sidebar al volver\r\n window.addEventListener(\"pageshow\", (event) => {\r\n   if (event.persisted) {\r\n     cerrarSidebar();\r\n     mostrarCarrito();\r\n@@ -132,9 +162,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO (tabla)\r\n+// MOSTRAR CARRITO\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -174,10 +204,9 @@\n             <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n             <span>${producto.cantidad}</span>\r\n             <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n           </td>\r\n-          <!-- Mostrar el precio con descuento y cantidad -->\r\n-          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n+          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n           <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n         </tr>\r\n       `).join(\"\")}\r\n     </tbody>\r\n@@ -190,9 +219,9 @@\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// GUARDAR CARRITO EN LOCALSTORAGE\r\n+// GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n   try {\r\n     localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n@@ -201,9 +230,9 @@\n   }\r\n }\r\n \r\n // =========================\r\n-// TOTALES, BARRA, CONTADOR Y TOAST\r\n+// TOTALES\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 65;\r\n \r\n function actualizarBarra(totalCarrito) {\r\n@@ -226,12 +255,9 @@\n   }\r\n }\r\n \r\n function actualizarTotales() {\r\n-  // Calculamos el subtotal utilizando el precio con descuento\r\n-  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n-  \r\n-  // Si el total supera un cierto umbral, aplicamos un descuento adicional\r\n+  const subtotal = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n   const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n   const total = subtotal - descuento;\r\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n@@ -250,8 +276,11 @@\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n+// =========================\r\n+// TOAST\r\n+// =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n@@ -270,9 +299,9 @@\n // =========================\r\n function redirigirWhatsApp() {\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n   ).join(\", \");\r\n   \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n@@ -322,5 +351,4 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n-\r\n"
                },
                {
                    "date": 1757966543401,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,143 +9,26 @@\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n-let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n // =========================\r\n-// CREAR OVERLAY (fondo oscuro)\r\n-// =========================\r\n-let overlay = document.getElementById(\"overlay-carrito\");\r\n-if (!overlay) {\r\n-  overlay = document.createElement(\"div\");\r\n-  overlay.id = \"overlay-carrito\";\r\n-  document.body.appendChild(overlay);\r\n-}\r\n-\r\n-// =========================\r\n // CARGAR JSON DE PRODUCTOS\r\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n     catalogo = [...data.productos, ...(data.ofertas || [])];\r\n-    renderProductos(catalogo);\r\n+    mostrarCarrito(); // refresca el carrito al inicio\r\n+    actualizarContador();\r\n   })\r\n-  .catch(err => console.error(\"Error cargando productos:\", err));\r\n+  .catch(err => console.error(\"‚ùå Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDERIZAR PRODUCTOS EN TIENDA\r\n+// AGREGAR PRODUCTO AL CARRITO\r\n // =========================\r\n-const contenedorProductos = document.getElementById(\"productos-container\");\r\n-\r\n-function renderProductos(lista) {\r\n-  if (!contenedorProductos) return;\r\n-  contenedorProductos.innerHTML = \"\";\r\n-  lista.forEach(producto => {\r\n-    const div = document.createElement(\"div\");\r\n-    div.classList.add(\"producto\");\r\n-    div.innerHTML = `\r\n-      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n-      <h4>${producto.nombre}</h4>\r\n-      <p>${producto.descripcion || \"\"}</p>\r\n-      \r\n-      <div class=\"precio\">\r\n-        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n-      </div>\r\n-      \r\n-      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n-      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n-      \r\n-      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n-    `;\r\n-    \r\n-    contenedorProductos.appendChild(div);\r\n-  });\r\n-}\r\n-\r\n-// =========================\r\n-// FUNCIONES DE DESCUENTO POR VOLUMEN\r\n-// =========================\r\n-function calcularTotalProducto(producto) {\r\n-  let total = 0;\r\n-  const cantidad = producto.cantidad;\r\n-\r\n-  if (producto.descuentoVolumen) {\r\n-    const promo = producto.descuentoVolumen;\r\n-\r\n-    if (promo.tipo === \"2da50\") {\r\n-      // üëâ Ejemplo: compra 1 y la 2da al 50%\r\n-      const pares = Math.floor(cantidad / 2);\r\n-      const resto = cantidad % 2;\r\n-      total = (pares * (producto.precio + producto.precio * promo.promo)) + (resto * producto.precio);\r\n-\r\n-    } else if (promo.tipo === \"3ra50\") {\r\n-      // üëâ Ejemplo: compra 2 y la 3ra al 50%\r\n-      const grupos = Math.floor(cantidad / 3);\r\n-      const resto = cantidad % 3;\r\n-      total = (grupos * ((2 * producto.precio) + (producto.precio * promo.promo))) + (resto * producto.precio);\r\n-    }\r\n-\r\n-  } else {\r\n-    // Si no tiene promo volumen usamos el precio con descuento normal\r\n-    if (producto.precio_con_descuento) {\r\n-      total = producto.precio_con_descuento * cantidad;\r\n-    } else {\r\n-      total = producto.precio * cantidad;\r\n-    }\r\n-  }\r\n-\r\n-  return total;\r\n-}\r\n-\r\n-// =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n-// =========================\r\n-function abrirSidebar() {\r\n-  if (!sidebar) return;\r\n-  sidebar.classList.add(\"activo\");\r\n-  overlay.classList.add(\"show\");\r\n-  document.body.style.overflow = \"hidden\";\r\n-  mostrarCarrito();\r\n-  history.pushState({ carritoAbierto: true }, \"\");\r\n-}\r\n-\r\n-function cerrarSidebar() {\r\n-  if (!sidebar) return;\r\n-  sidebar.classList.remove(\"activo\");\r\n-  overlay.classList.remove(\"show\");\r\n-  document.body.style.overflow = \"auto\";\r\n-  history.replaceState({}, \"\");\r\n-}\r\n-\r\n-overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  abrirSidebar();\r\n-});\r\n-cerrarCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-});\r\n-\r\n-window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n-\r\n-window.addEventListener(\"pageshow\", (event) => {\r\n-  if (event.persisted) {\r\n-    cerrarSidebar();\r\n-    mostrarCarrito();\r\n-  }\r\n-});\r\n-\r\n-// =========================\r\n-// AGREGAR PRODUCTO\r\n-// =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n@@ -204,17 +87,16 @@\n             <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n             <span>${producto.cantidad}</span>\r\n             <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n           </td>\r\n-          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n           <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n         </tr>\r\n       `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n \r\n   carritoItems.appendChild(tabla);\r\n-  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n@@ -222,65 +104,36 @@\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n-  try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar carrito\", e);\r\n-  }\r\n+  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n }\r\n \r\n // =========================\r\n // TOTALES\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 65;\r\n-\r\n-function actualizarBarra(totalCarrito) {\r\n-  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n-\r\n-  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n-  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n-\r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n-\r\n-  if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n-    } else if (totalCarrito > 0) {\r\n-      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-    } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-    }\r\n-  }\r\n-}\r\n-\r\n function actualizarTotales() {\r\n-  const subtotal = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n-  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n+  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n+  const descuento = subtotal > 100 ? subtotal * 0.05 : 0; // 5% extra si pasa 100\r\n   const total = subtotal - descuento;\r\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  subtotalEl.classList.add('naranja');\r\n-\r\n   descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-  descuentoEl.classList.add('naranja');\r\n-\r\n   totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n-  totalEl.classList.add('naranja');\r\n-\r\n-  actualizarBarra(subtotal);\r\n }\r\n \r\n+// =========================\r\n+// CONTADOR\r\n+// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n // =========================\r\n // TOAST\r\n // =========================\r\n+let toastTimeout;\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n@@ -299,13 +152,13 @@\n // =========================\r\n function redirigirWhatsApp() {\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio_con_descuento * p.cantidad).toFixed(2)}`\r\n   ).join(\", \");\r\n-  \r\n+\r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-  const telefono = \"+51920165696\";\r\n+  const telefono = \"+51920165696\"; // tu n√∫mero\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n@@ -330,24 +183,23 @@\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n-document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n-    agregarAlCarrito(e.target.dataset.id);\r\n-  }\r\n-});\r\n+// =========================\r\n+// ABRIR / CERRAR SIDEBAR\r\n+// =========================\r\n+function abrirSidebar() {\r\n+  sidebar.classList.add(\"activo\");\r\n+  document.body.style.overflow = \"hidden\";\r\n+  mostrarCarrito();\r\n+}\r\n+function cerrarSidebar() {\r\n+  sidebar.classList.remove(\"activo\");\r\n+  document.body.style.overflow = \"auto\";\r\n+}\r\n+abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n+cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n \r\n-document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-  window.location.href = \"carrito.html\";\r\n-});\r\n-\r\n-document.addEventListener(\"keydown\", e => {\r\n-  if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n-\r\n // =========================\r\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n"
                },
                {
                    "date": 1757966580092,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,26 +9,143 @@\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n+let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n // =========================\r\n+// CREAR OVERLAY (fondo oscuro)\r\n+// =========================\r\n+let overlay = document.getElementById(\"overlay-carrito\");\r\n+if (!overlay) {\r\n+  overlay = document.createElement(\"div\");\r\n+  overlay.id = \"overlay-carrito\";\r\n+  document.body.appendChild(overlay);\r\n+}\r\n+\r\n+// =========================\r\n // CARGAR JSON DE PRODUCTOS\r\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n     catalogo = [...data.productos, ...(data.ofertas || [])];\r\n-    mostrarCarrito(); // refresca el carrito al inicio\r\n-    actualizarContador();\r\n+    renderProductos(catalogo);\r\n   })\r\n-  .catch(err => console.error(\"‚ùå Error cargando productos:\", err));\r\n+  .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// AGREGAR PRODUCTO AL CARRITO\r\n+// RENDERIZAR PRODUCTOS EN TIENDA\r\n // =========================\r\n+const contenedorProductos = document.getElementById(\"productos-container\");\r\n+\r\n+function renderProductos(lista) {\r\n+  if (!contenedorProductos) return;\r\n+  contenedorProductos.innerHTML = \"\";\r\n+  lista.forEach(producto => {\r\n+    const div = document.createElement(\"div\");\r\n+    div.classList.add(\"producto\");\r\n+    div.innerHTML = `\r\n+      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n+      <h4>${producto.nombre}</h4>\r\n+      <p>${producto.descripcion || \"\"}</p>\r\n+      \r\n+      <div class=\"precio\">\r\n+        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n+      </div>\r\n+      \r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n+      \r\n+      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n+    `;\r\n+    \r\n+    contenedorProductos.appendChild(div);\r\n+  });\r\n+}\r\n+\r\n+// =========================\r\n+// FUNCIONES DE DESCUENTO POR VOLUMEN\r\n+// =========================\r\n+function calcularTotalProducto(producto) {\r\n+  let total = 0;\r\n+  const cantidad = producto.cantidad;\r\n+\r\n+  if (producto.descuentoVolumen) {\r\n+    const promo = producto.descuentoVolumen;\r\n+\r\n+    if (promo.tipo === \"2da50\") {\r\n+      // üëâ Ejemplo: compra 1 y la 2da al 50%\r\n+      const pares = Math.floor(cantidad / 2);\r\n+      const resto = cantidad % 2;\r\n+      total = (pares * (producto.precio + producto.precio * promo.promo)) + (resto * producto.precio);\r\n+\r\n+    } else if (promo.tipo === \"3ra50\") {\r\n+      // üëâ Ejemplo: compra 2 y la 3ra al 50%\r\n+      const grupos = Math.floor(cantidad / 3);\r\n+      const resto = cantidad % 3;\r\n+      total = (grupos * ((2 * producto.precio) + (producto.precio * promo.promo))) + (resto * producto.precio);\r\n+    }\r\n+\r\n+  } else {\r\n+    // Si no tiene promo volumen usamos el precio con descuento normal\r\n+    if (producto.precio_con_descuento) {\r\n+      total = producto.precio_con_descuento * cantidad;\r\n+    } else {\r\n+      total = producto.precio * cantidad;\r\n+    }\r\n+  }\r\n+\r\n+  return total;\r\n+}\r\n+\r\n+// =========================\r\n+// ABRIR / CERRAR SIDEBAR\r\n+// =========================\r\n+function abrirSidebar() {\r\n+  if (!sidebar) return;\r\n+  sidebar.classList.add(\"activo\");\r\n+  overlay.classList.add(\"show\");\r\n+  document.body.style.overflow = \"hidden\";\r\n+  mostrarCarrito();\r\n+  history.pushState({ carritoAbierto: true }, \"\");\r\n+}\r\n+\r\n+function cerrarSidebar() {\r\n+  if (!sidebar) return;\r\n+  sidebar.classList.remove(\"activo\");\r\n+  overlay.classList.remove(\"show\");\r\n+  document.body.style.overflow = \"auto\";\r\n+  history.replaceState({}, \"\");\r\n+}\r\n+\r\n+overlay?.addEventListener(\"click\", cerrarSidebar);\r\n+abrirCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  abrirSidebar();\r\n+});\r\n+cerrarCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+});\r\n+\r\n+window.addEventListener(\"popstate\", () => {\r\n+  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n+\r\n+window.addEventListener(\"pageshow\", (event) => {\r\n+  if (event.persisted) {\r\n+    cerrarSidebar();\r\n+    mostrarCarrito();\r\n+  }\r\n+});\r\n+\r\n+// =========================\r\n+// AGREGAR PRODUCTO\r\n+// =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n@@ -87,16 +204,17 @@\n             <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n             <span>${producto.cantidad}</span>\r\n             <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n           </td>\r\n-          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n+          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n           <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n         </tr>\r\n       `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n \r\n   carritoItems.appendChild(tabla);\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n@@ -104,36 +222,65 @@\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n-  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  try {\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  } catch (e) {\r\n+    console.error(\"Error al guardar carrito\", e);\r\n+  }\r\n }\r\n \r\n // =========================\r\n // TOTALES\r\n // =========================\r\n+const ENVIO_GRATIS_MINIMO = 65;\r\n+\r\n+function actualizarBarra(totalCarrito) {\r\n+  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n+  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n+\r\n+  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n+  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n+\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+\r\n+  if (mensajeEl) {\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+    } else if (totalCarrito > 0) {\r\n+      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+    } else {\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+    }\r\n+  }\r\n+}\r\n+\r\n function actualizarTotales() {\r\n-  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n-  const descuento = subtotal > 100 ? subtotal * 0.05 : 0; // 5% extra si pasa 100\r\n+  const subtotal = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n+  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n   const total = subtotal - descuento;\r\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  subtotalEl.classList.add('naranja');\r\n+\r\n   descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+  descuentoEl.classList.add('naranja');\r\n+\r\n   totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  totalEl.classList.add('naranja');\r\n+\r\n+  actualizarBarra(subtotal);\r\n }\r\n \r\n-// =========================\r\n-// CONTADOR\r\n-// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n // =========================\r\n // TOAST\r\n // =========================\r\n-let toastTimeout;\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n@@ -152,13 +299,13 @@\n // =========================\r\n function redirigirWhatsApp() {\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio_con_descuento * p.cantidad).toFixed(2)}`\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n   ).join(\", \");\r\n-\r\n+  \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-  const telefono = \"+51920165696\"; // tu n√∫mero\r\n+  const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n@@ -183,23 +330,24 @@\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n-// =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n-// =========================\r\n-function abrirSidebar() {\r\n-  sidebar.classList.add(\"activo\");\r\n-  document.body.style.overflow = \"hidden\";\r\n-  mostrarCarrito();\r\n-}\r\n-function cerrarSidebar() {\r\n-  sidebar.classList.remove(\"activo\");\r\n-  document.body.style.overflow = \"auto\";\r\n-}\r\n-abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n-cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n+document.addEventListener(\"click\", e => {\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n+    agregarAlCarrito(e.target.dataset.id);\r\n+  }\r\n+});\r\n \r\n+document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+  window.location.href = \"carrito.html\";\r\n+});\r\n+\r\n+document.addEventListener(\"keydown\", e => {\r\n+  if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n+\r\n // =========================\r\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n"
                },
                {
                    "date": 1757967262976,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -255,22 +255,27 @@\n   }\r\n }\r\n \r\n function actualizarTotales() {\r\n-  const subtotal = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n-  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n-  const total = subtotal - descuento;\r\n+  // üëâ Subtotal sin descuentos\r\n+  const subtotal = carrito.reduce((acc, p) => acc + (p.precio * p.cantidad), 0);\r\n \r\n+  // üëâ Total con descuentos aplicados\r\n+  const totalConDescuentos = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n+\r\n+  // üëâ Descuento aplicado\r\n+  const descuento = subtotal - totalConDescuentos;\r\n+\r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n \r\n   descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n   descuentoEl.classList.add('naranja');\r\n \r\n-  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n-  actualizarBarra(subtotal);\r\n+  actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n@@ -300,11 +305,11 @@\n function redirigirWhatsApp() {\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n     `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n-  ).join(\", \");\r\n+  ).join(\"\\n\");\r\n   \r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n"
                },
                {
                    "date": 1757972242153,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -76,15 +76,15 @@\n   if (producto.descuentoVolumen) {\r\n     const promo = producto.descuentoVolumen;\r\n \r\n     if (promo.tipo === \"2da50\") {\r\n-      // üëâ Ejemplo: compra 1 y la 2da al 50%\r\n+      // üëâ Ejemplo: compra 1 y la 2da al 5%\r\n       const pares = Math.floor(cantidad / 2);\r\n       const resto = cantidad % 2;\r\n       total = (pares * (producto.precio + producto.precio * promo.promo)) + (resto * producto.precio);\r\n \r\n     } else if (promo.tipo === \"3ra50\") {\r\n-      // üëâ Ejemplo: compra 2 y la 3ra al 50%\r\n+      // üëâ Ejemplo: compra 2 y la 3ra al 5%\r\n       const grupos = Math.floor(cantidad / 3);\r\n       const resto = cantidad % 3;\r\n       total = (grupos * ((2 * producto.precio) + (producto.precio * promo.promo))) + (resto * producto.precio);\r\n     }\r\n"
                },
                {
                    "date": 1757972924889,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,9 +14,9 @@\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n // =========================\r\n-// CREAR OVERLAY (fondo oscuro)\r\n+// CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -24,9 +24,9 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// CARGAR JSON DE PRODUCTOS\r\n+// CARGAR JSON\r\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n@@ -35,12 +35,11 @@\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDERIZAR PRODUCTOS EN TIENDA\r\n+// RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n-\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n@@ -49,54 +48,38 @@\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      \r\n       <div class=\"precio\">\r\n         <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n         <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n       </div>\r\n-      \r\n       <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n       <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n-      \r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n-    \r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// FUNCIONES DE DESCUENTO POR VOLUMEN\r\n+// CALCULAR TOTAL CON DESCUENTO POR VOLUMEN\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n   let total = 0;\r\n   const cantidad = producto.cantidad;\r\n \r\n   if (producto.descuentoVolumen) {\r\n     const promo = producto.descuentoVolumen;\r\n-\r\n-    if (promo.tipo === \"2da50\") {\r\n-      // üëâ Ejemplo: compra 1 y la 2da al 5%\r\n-      const pares = Math.floor(cantidad / 2);\r\n-      const resto = cantidad % 2;\r\n-      total = (pares * (producto.precio + producto.precio * promo.promo)) + (resto * producto.precio);\r\n-\r\n-    } else if (promo.tipo === \"3ra50\") {\r\n-      // üëâ Ejemplo: compra 2 y la 3ra al 5%\r\n-      const grupos = Math.floor(cantidad / 3);\r\n-      const resto = cantidad % 3;\r\n-      total = (grupos * ((2 * producto.precio) + (producto.precio * promo.promo))) + (resto * producto.precio);\r\n-    }\r\n-\r\n+    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+    const resto = cantidad % promo.aplicaA;\r\n+    // Total de las promociones aplicadas\r\n+    const totalPromo = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n+    // Total de resto sin promo\r\n+    const totalResto = resto * producto.precio;\r\n+    total = totalPromo + totalResto;\r\n   } else {\r\n-    // Si no tiene promo volumen usamos el precio con descuento normal\r\n-    if (producto.precio_con_descuento) {\r\n-      total = producto.precio_con_descuento * cantidad;\r\n-    } else {\r\n-      total = producto.precio * cantidad;\r\n-    }\r\n+    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n   }\r\n \r\n   return total;\r\n }\r\n@@ -111,46 +94,36 @@\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n-\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n-\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  abrirSidebar();\r\n-});\r\n-cerrarCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-});\r\n+abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n+cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n+window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n+window.addEventListener(\"pageshow\", (event) => { if (event.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n-window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n-\r\n-window.addEventListener(\"pageshow\", (event) => {\r\n-  if (event.persisted) {\r\n-    cerrarSidebar();\r\n-    mostrarCarrito();\r\n-  }\r\n-});\r\n-\r\n // =========================\r\n-// AGREGAR PRODUCTO\r\n+// AGREGAR AL CARRITO CON STOCK\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n+  const cantidadActual = existe ? existe.cantidad : 0;\r\n+\r\n+  if (cantidadActual + 1 > producto.stock) {\r\n+    mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+    return;\r\n+  }\r\n+\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -177,9 +150,8 @@\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n-\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n@@ -210,9 +182,8 @@\n         </tr>\r\n       `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n-\r\n   carritoItems.appendChild(tabla);\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n@@ -222,62 +193,43 @@\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n-  try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar carrito\", e);\r\n-  }\r\n+  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n+  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n }\r\n \r\n // =========================\r\n-// TOTALES\r\n+// TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 65;\r\n-\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n-\r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n-\r\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n-    } else if (totalCarrito > 0) {\r\n-      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-    } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-    }\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+    else if (totalCarrito > 0) mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+    else mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n   }\r\n }\r\n-\r\n function actualizarTotales() {\r\n-  // üëâ Subtotal sin descuentos\r\n   const subtotal = carrito.reduce((acc, p) => acc + (p.precio * p.cantidad), 0);\r\n-\r\n-  // üëâ Total con descuentos aplicados\r\n   const totalConDescuentos = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n-\r\n-  // üëâ Descuento aplicado\r\n   const descuento = subtotal - totalConDescuentos;\r\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n-\r\n   descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n   descuentoEl.classList.add('naranja');\r\n-\r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n-\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n@@ -286,24 +238,21 @@\n // TOAST\r\n // =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n-  if (!toast) {\r\n-    toast = document.createElement(\"div\");\r\n-    toast.id = \"mensajeCarrito\";\r\n-    document.body.appendChild(toast);\r\n-  }\r\n+  if (!toast) { toast = document.createElement(\"div\"); toast.id = \"mensajeCarrito\"; document.body.appendChild(toast); }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-\r\n   clearTimeout(toastTimeout);\r\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n // COMPRA POR WHATSAPP\r\n // =========================\r\n function redirigirWhatsApp() {\r\n+  if (carrito.length === 0) { mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\"); return; }\r\n+\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n     `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n   ).join(\"\\n\");\r\n@@ -312,9 +261,8 @@\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-\r\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n@@ -323,30 +271,24 @@\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    carrito[index].cantidad++;\r\n-  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n+  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n+  else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n     carrito[index].cantidad--;\r\n     if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n-    agregarAlCarrito(e.target.dataset.id);\r\n-  }\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n \r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-  window.location.href = \"carrito.html\";\r\n+  e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n });\r\n \r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n"
                },
                {
                    "date": 1757973703189,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,11 +71,9 @@\n   if (producto.descuentoVolumen) {\r\n     const promo = producto.descuentoVolumen;\r\n     const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n     const resto = cantidad % promo.aplicaA;\r\n-    // Total de las promociones aplicadas\r\n     const totalPromo = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n-    // Total de resto sin promo\r\n     const totalResto = resto * producto.precio;\r\n     total = totalPromo + totalResto;\r\n   } else {\r\n     total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n@@ -265,8 +263,14 @@\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n+// BOTONES DE COMPRA\r\n+// =========================\r\n+function comprarAhora() { redirigirWhatsApp(); } // Sidebar lateral\r\n+document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", redirigirWhatsApp); // Carrito completo\r\n+\r\n+// =========================\r\n // EVENTOS DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n"
                },
                {
                    "date": 1757974293725,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -263,22 +263,22 @@\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n-// BOTONES DE COMPRA\r\n-// =========================\r\n-function comprarAhora() { redirigirWhatsApp(); } // Sidebar lateral\r\n-document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", redirigirWhatsApp); // Carrito completo\r\n-\r\n-// =========================\r\n // EVENTOS DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n   if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n-  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n+  else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    if (carrito[index].cantidad + 1 > carrito[index].stock) {\r\n+      mostrarToast(`No hay suficiente stock de ${carrito[index].nombre} üõë`);\r\n+      return;\r\n+    }\r\n+    carrito[index].cantidad++;\r\n+  }\r\n   else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n     carrito[index].cantidad--;\r\n     if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n@@ -289,12 +289,19 @@\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n \r\n+// Sidebar ver carrito\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n });\r\n \r\n+// Comprar ahora por WhatsApp en carrito completo\r\n+document.addEventListener(\"DOMContentLoaded\", () => {\r\n+  const botonWhatsApp = document.getElementById(\"whatsapp-comprar\");\r\n+  botonWhatsApp?.addEventListener(\"click\", redirigirWhatsApp);\r\n+});\r\n+\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n"
                },
                {
                    "date": 1757974890889,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,22 +246,30 @@\n \r\n // =========================\r\n // COMPRA POR WHATSAPP\r\n // =========================\r\n-function redirigirWhatsApp() {\r\n+function comprarAhora() {\r\n   if (carrito.length === 0) { mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\"); return; }\r\n \r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n     `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n   ).join(\"\\n\");\r\n-  \r\n+\r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+\r\n   window.open(url, \"_blank\");\r\n+\r\n+  // Vaciar carrito tras enviar\r\n+  carrito = [];\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+  actualizarContador();\r\n+  mostrarToast(\"Carrito vaciado tras enviar el pedido üßæ\");\r\n }\r\n \r\n // =========================\r\n // EVENTOS DEL CARRITO\r\n@@ -270,15 +278,9 @@\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n   if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n-  else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    if (carrito[index].cantidad + 1 > carrito[index].stock) {\r\n-      mostrarToast(`No hay suficiente stock de ${carrito[index].nombre} üõë`);\r\n-      return;\r\n-    }\r\n-    carrito[index].cantidad++;\r\n-  }\r\n+  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n   else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n     carrito[index].cantidad--;\r\n     if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n@@ -289,18 +291,13 @@\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n \r\n-// Sidebar ver carrito\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n });\r\n \r\n-// Comprar ahora por WhatsApp en carrito completo\r\n-document.addEventListener(\"DOMContentLoaded\", () => {\r\n-  const botonWhatsApp = document.getElementById(\"whatsapp-comprar\");\r\n-  botonWhatsApp?.addEventListener(\"click\", redirigirWhatsApp);\r\n-});\r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n \r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n"
                },
                {
                    "date": 1757975371782,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -244,10 +244,9 @@\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRA POR WHATSAPP\r\n-// =========================\r\n+// COMPRAR AHORA POR WHATSAPP (sidebar + carrito)\r\n function comprarAhora() {\r\n   if (carrito.length === 0) { mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\"); return; }\r\n \r\n   const totalCompra = totalEl.innerText;\r\n@@ -255,21 +254,24 @@\n     `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n   ).join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n+\r\n+  if (!confirm(\"Se abrir√° WhatsApp con los productos seleccionados. ¬øDeseas continuar?\")) return;\r\n+\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n   window.open(url, \"_blank\");\r\n \r\n-  // Vaciar carrito tras enviar\r\n+  // Vaciar carrito despu√©s de enviar\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n-  mostrarToast(\"Carrito vaciado tras enviar el pedido üßæ\");\r\n+  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n }\r\n \r\n // =========================\r\n // EVENTOS DEL CARRITO\r\n@@ -295,9 +297,11 @@\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n });\r\n \r\n+// Bot√≥n ‚ÄúIr a pagar‚Äù sidebar y bot√≥n ‚ÄúComprar ahora‚Äù carrito\r\n document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n \r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n"
                },
                {
                    "date": 1757975689911,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -245,20 +245,22 @@\n }\r\n \r\n // =========================\r\n // COMPRAR AHORA POR WHATSAPP (sidebar + carrito)\r\n+// =========================\r\n+\r\n function comprarAhora() {\r\n-  if (carrito.length === 0) { mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\"); return; }\r\n+  if (carrito.length === 0) {\r\n+    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n+    return;\r\n+  }\r\n \r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n     `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n   ).join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-\r\n-  if (!confirm(\"Se abrir√° WhatsApp con los productos seleccionados. ¬øDeseas continuar?\")) return;\r\n-\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n@@ -273,8 +275,14 @@\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n }\r\n \r\n // =========================\r\n+// LISTENER PARA EL BOT√ìN\r\n+// =========================\r\n+document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n+\r\n+\r\n+// =========================\r\n // EVENTOS DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n"
                },
                {
                    "date": 1757987218906,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -154,32 +154,45 @@\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n+        <th>Descuento aplicado</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => `\r\n-        <tr>\r\n-          <td>\r\n-            <div class=\"carrito-item-info\">\r\n-              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-              <div>\r\n-                <strong>${producto.nombre}</strong>\r\n-                <p>${producto.descripcion || \"\"}</p>\r\n+      ${carrito.map((producto, index) => {\r\n+        // Verificar si aplica descuento\r\n+        let descuentoAplicado = false;\r\n+        if(producto.descuentoVolumen) {\r\n+          const { compra, aplicaA } = producto.descuentoVolumen;\r\n+          if(producto.cantidad >= aplicaA) descuentoAplicado = true;\r\n+        } else if(producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) {\r\n+          descuentoAplicado = true;\r\n+        }\r\n+\r\n+        return `\r\n+          <tr>\r\n+            <td>\r\n+              <div class=\"carrito-item-info\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <div>\r\n+                  <strong>${producto.nombre}</strong>\r\n+                  <p>${producto.descripcion || \"\"}</p>\r\n+                </div>\r\n               </div>\r\n-            </div>\r\n-          </td>\r\n-          <td>\r\n-            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-            <span>${producto.cantidad}</span>\r\n-            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-          </td>\r\n-          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-        </tr>\r\n-      `).join(\"\")}\r\n+            </td>\r\n+            <td>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+            </td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+          </tr>\r\n+        `;\r\n+      }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n   carritoItems.appendChild(tabla);\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n@@ -244,11 +257,10 @@\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRAR AHORA POR WHATSAPP (sidebar + carrito)\r\n+// COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n-\r\n function comprarAhora() {\r\n   if (carrito.length === 0) {\r\n     mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n     return;\r\n@@ -266,25 +278,20 @@\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n   window.open(url, \"_blank\");\r\n \r\n-  // Vaciar carrito despu√©s de enviar\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n }\r\n \r\n // =========================\r\n-// LISTENER PARA EL BOT√ìN\r\n+// LISTENERS\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n \r\n-\r\n-// =========================\r\n-// EVENTOS DEL CARRITO\r\n-// =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n@@ -305,9 +312,8 @@\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n });\r\n \r\n-// Bot√≥n ‚ÄúIr a pagar‚Äù sidebar y bot√≥n ‚ÄúComprar ahora‚Äù carrito\r\n document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n \r\n document.addEventListener(\"keydown\", e => {\r\n"
                },
                {
                    "date": 1757988360115,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -160,16 +160,11 @@\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n       ${carrito.map((producto, index) => {\r\n-        // Verificar si aplica descuento\r\n         let descuentoAplicado = false;\r\n-        if(producto.descuentoVolumen) {\r\n-          const { compra, aplicaA } = producto.descuentoVolumen;\r\n-          if(producto.cantidad >= aplicaA) descuentoAplicado = true;\r\n-        } else if(producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) {\r\n-          descuentoAplicado = true;\r\n-        }\r\n+        if(producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if(producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n \r\n         return `\r\n           <tr>\r\n             <td>\r\n@@ -224,23 +219,45 @@\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n     else if (totalCarrito > 0) mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n     else mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n   }\r\n+\r\n+  const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n+\r\n function actualizarTotales() {\r\n-  const subtotal = carrito.reduce((acc, p) => acc + (p.precio * p.cantidad), 0);\r\n-  const totalConDescuentos = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n-  const descuento = subtotal - totalConDescuentos;\r\n+  let subtotal = 0;\r\n+  let descuentoVolumenTotal = 0;\r\n+  let descuentoDirectoTotal = 0;\r\n \r\n+  carrito.forEach(p => {\r\n+    const precioNormal = p.precio * p.cantidad;\r\n+    const precioConDescuento = calcularTotalProducto(p);\r\n+    subtotal += precioNormal;\r\n+\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n+      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n+      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+    }\r\n+  });\r\n+\r\n+  const totalConDescuentos = subtotal - descuentoVolumenTotal - descuentoDirectoTotal;\r\n+\r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n-  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-  descuentoEl.classList.add('naranja');\r\n+\r\n+  const descuentoTotalEl = descuentoEl;\r\n+  descuentoTotalEl.textContent = `S/ ${(descuentoVolumenTotal + descuentoDirectoTotal).toFixed(2)}`;\r\n+  descuentoTotalEl.classList.add('naranja');\r\n+\r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n+\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n"
                },
                {
                    "date": 1757989249144,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,8 +9,13 @@\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n+// üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n+const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n+const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n+const ahorroTotalEl = document.getElementById(\"ahorro-total\");\r\n+\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n@@ -241,17 +246,32 @@\n       descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n     }\r\n   });\r\n \r\n-  const totalConDescuentos = subtotal - descuentoVolumenTotal - descuentoDirectoTotal;\r\n+  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n+  const totalConDescuentos = subtotal - ahorroTotal;\r\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n \r\n-  const descuentoTotalEl = descuentoEl;\r\n-  descuentoTotalEl.textContent = `S/ ${(descuentoVolumenTotal + descuentoDirectoTotal).toFixed(2)}`;\r\n-  descuentoTotalEl.classList.add('naranja');\r\n+  // üëá Mostrar desglose de descuentos\r\n+  if (descuentoVolumenEl) {\r\n+    descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+    descuentoVolumenEl.classList.add('naranja');\r\n+  }\r\n+  if (descuentoDirectoEl) {\r\n+    descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+    descuentoDirectoEl.classList.add('naranja');\r\n+  }\r\n+  if (ahorroTotalEl) {\r\n+    ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+    ahorroTotalEl.classList.add('naranja');\r\n+  }\r\n \r\n+  // üëá Este sigue siendo el total de descuentos\r\n+  descuentoEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  descuentoEl.classList.add('naranja');\r\n+\r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n   actualizarBarra(totalConDescuentos);\r\n"
                },
                {
                    "date": 1757990068377,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -211,18 +211,18 @@\n \r\n // =========================\r\n // TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 65;\r\n+const ENVIO_GRATIS_MINIMO = 99;\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n     else if (totalCarrito > 0) mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n     else mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n   }\r\n \r\n@@ -266,9 +266,8 @@\n     ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n     ahorroTotalEl.classList.add('naranja');\r\n   }\r\n \r\n-  // üëá Este sigue siendo el total de descuentos\r\n   descuentoEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n   descuentoEl.classList.add('naranja');\r\n \r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n"
                },
                {
                    "date": 1757991073978,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,23 +212,37 @@\n // =========================\r\n // TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 99;\r\n+\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n+\r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n+  if (barraProgreso) {\r\n+    barraProgreso.style.width = `${porcentaje}%`;\r\n+  }\r\n+\r\n   if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n-    else if (totalCarrito > 0) mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-    else mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n+      mensajeEl.classList.add(\"gratis\");\r\n+    } else if (totalCarrito > 0) {\r\n+      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n+    } else {\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n+    }\r\n   }\r\n \r\n   const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n-  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+  if (costoEnvioEl) {\r\n+    costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+  }\r\n }\r\n \r\n function actualizarTotales() {\r\n   let subtotal = 0;\r\n@@ -252,9 +266,8 @@\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n \r\n-  // üëá Mostrar desglose de descuentos\r\n   if (descuentoVolumenEl) {\r\n     descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n     descuentoVolumenEl.classList.add('naranja');\r\n   }\r\n@@ -275,8 +288,11 @@\n \r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n+// =========================\r\n+// CONTADOR\r\n+// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n"
                },
                {
                    "date": 1757992159942,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -211,38 +211,24 @@\n \r\n // =========================\r\n // TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 99;\r\n-\r\n+const ENVIO_GRATIS_MINIMO = 65;\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n-\r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n-  if (barraProgreso) {\r\n-    barraProgreso.style.width = `${porcentaje}%`;\r\n-  }\r\n-\r\n   if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n-      mensajeEl.classList.add(\"gratis\");\r\n-    } else if (totalCarrito > 0) {\r\n-      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    }\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+    else if (totalCarrito > 0) mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+    else mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n   }\r\n \r\n   const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n-  if (costoEnvioEl) {\r\n-    costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n-  }\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n \r\n function actualizarTotales() {\r\n   let subtotal = 0;\r\n@@ -266,8 +252,9 @@\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n \r\n+  // üëá Mostrar desglose de descuentos\r\n   if (descuentoVolumenEl) {\r\n     descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n     descuentoVolumenEl.classList.add('naranja');\r\n   }\r\n@@ -279,8 +266,9 @@\n     ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n     ahorroTotalEl.classList.add('naranja');\r\n   }\r\n \r\n+  // üëá Este sigue siendo el total de descuentos\r\n   descuentoEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n   descuentoEl.classList.add('naranja');\r\n \r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n@@ -288,11 +276,8 @@\n \r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n-// =========================\r\n-// CONTADOR\r\n-// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n"
                },
                {
                    "date": 1757992272854,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,13 +9,8 @@\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n-// üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n-const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n-const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n-const ahorroTotalEl = document.getElementById(\"ahorro-total\");\r\n-\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n@@ -159,40 +154,32 @@\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n-        <th>Descuento aplicado</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => {\r\n-        let descuentoAplicado = false;\r\n-        if(producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if(producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n-\r\n-        return `\r\n-          <tr>\r\n-            <td>\r\n-              <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-                <div>\r\n-                  <strong>${producto.nombre}</strong>\r\n-                  <p>${producto.descripcion || \"\"}</p>\r\n-                </div>\r\n+      ${carrito.map((producto, index) => `\r\n+        <tr>\r\n+          <td>\r\n+            <div class=\"carrito-item-info\">\r\n+              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+              <div>\r\n+                <strong>${producto.nombre}</strong>\r\n+                <p>${producto.descripcion || \"\"}</p>\r\n               </div>\r\n-            </td>\r\n-            <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-            </td>\r\n-            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-          </tr>\r\n-        `;\r\n-      }).join(\"\")}\r\n+            </div>\r\n+          </td>\r\n+          <td>\r\n+            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+            <span>${producto.cantidad}</span>\r\n+            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+          </td>\r\n+          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+        </tr>\r\n+      `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n   carritoItems.appendChild(tabla);\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n@@ -224,60 +211,23 @@\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n     else if (totalCarrito > 0) mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n     else mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n   }\r\n-\r\n-  const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n-  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n-\r\n function actualizarTotales() {\r\n-  let subtotal = 0;\r\n-  let descuentoVolumenTotal = 0;\r\n-  let descuentoDirectoTotal = 0;\r\n+  const subtotal = carrito.reduce((acc, p) => acc + (p.precio * p.cantidad), 0);\r\n+  const totalConDescuentos = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n+  const descuento = subtotal - totalConDescuentos;\r\n \r\n-  carrito.forEach(p => {\r\n-    const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = calcularTotalProducto(p);\r\n-    subtotal += precioNormal;\r\n-\r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n-      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n-      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-    }\r\n-  });\r\n-\r\n-  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n-  const totalConDescuentos = subtotal - ahorroTotal;\r\n-\r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n-\r\n-  // üëá Mostrar desglose de descuentos\r\n-  if (descuentoVolumenEl) {\r\n-    descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-    descuentoVolumenEl.classList.add('naranja');\r\n-  }\r\n-  if (descuentoDirectoEl) {\r\n-    descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-    descuentoDirectoEl.classList.add('naranja');\r\n-  }\r\n-  if (ahorroTotalEl) {\r\n-    ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-    ahorroTotalEl.classList.add('naranja');\r\n-  }\r\n-\r\n-  // üëá Este sigue siendo el total de descuentos\r\n-  descuentoEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n   descuentoEl.classList.add('naranja');\r\n-\r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n-\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n@@ -294,47 +244,41 @@\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRAR AHORA POR WHATSAPP\r\n+// COMPRA POR WHATSAPP\r\n // =========================\r\n-function comprarAhora() {\r\n-  if (carrito.length === 0) {\r\n-    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n-    return;\r\n-  }\r\n+function redirigirWhatsApp() {\r\n+  if (carrito.length === 0) { mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\"); return; }\r\n \r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n     `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n   ).join(\"\\n\");\r\n-\r\n+  \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-\r\n   window.open(url, \"_blank\");\r\n-\r\n-  carrito = [];\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-  actualizarContador();\r\n-  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n }\r\n \r\n // =========================\r\n-// LISTENERS\r\n+// EVENTOS DEL CARRITO\r\n // =========================\r\n-document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n-\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n   if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n-  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n+  else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    if (carrito[index].cantidad + 1 > carrito[index].stock) {\r\n+      mostrarToast(`No hay suficiente stock de ${carrito[index].nombre} üõë`);\r\n+      return;\r\n+    }\r\n+    carrito[index].cantidad++;\r\n+  }\r\n   else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n     carrito[index].cantidad--;\r\n     if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n@@ -345,14 +289,18 @@\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n \r\n+// Sidebar ver carrito\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n });\r\n \r\n-document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n+// Comprar ahora por WhatsApp en carrito completo\r\n+document.addEventListener(\"DOMContentLoaded\", () => {\r\n+  const botonWhatsApp = document.getElementById(\"whatsapp-comprar\");\r\n+  botonWhatsApp?.addEventListener(\"click\", redirigirWhatsApp);\r\n+});\r\n \r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n"
                },
                {
                    "date": 1757992359490,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,9 +14,9 @@\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n // =========================\r\n-// CREAR OVERLAY\r\n+// CREAR OVERLAY (fondo oscuro)\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -24,9 +24,9 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// CARGAR JSON\r\n+// CARGAR JSON DE PRODUCTOS\r\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n@@ -35,11 +35,12 @@\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDER PRODUCTOS\r\n+// RENDERIZAR PRODUCTOS EN TIENDA\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n+\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n@@ -48,80 +49,78 @@\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n+      \r\n+      <!-- Mostrar precio regular con tachado y precio con descuento -->\r\n       <div class=\"precio\">\r\n         <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n       </div>\r\n-      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n-      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n+      \r\n+      <!-- Mostrar el descuento y el ahorro -->\r\n+      <div class=\"descuento\">${producto.descuento}% OFF</div>\r\n+      <div class=\"ahorro\">Ahorro: S/ ${producto.ahorro.toFixed(2)}</div>\r\n+      \r\n+      <!-- Bot√≥n para agregar al carrito -->\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n+    \r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// CALCULAR TOTAL CON DESCUENTO POR VOLUMEN\r\n+// ABRIR / CERRAR SIDEBAR CON HISTORIAL\r\n // =========================\r\n-function calcularTotalProducto(producto) {\r\n-  let total = 0;\r\n-  const cantidad = producto.cantidad;\r\n-\r\n-  if (producto.descuentoVolumen) {\r\n-    const promo = producto.descuentoVolumen;\r\n-    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n-    const resto = cantidad % promo.aplicaA;\r\n-    const totalPromo = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n-    const totalResto = resto * producto.precio;\r\n-    total = totalPromo + totalResto;\r\n-  } else {\r\n-    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n-  }\r\n-\r\n-  return total;\r\n-}\r\n-\r\n-// =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n-// =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n+\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n+\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n-cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n-window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n-window.addEventListener(\"pageshow\", (event) => { if (event.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n+abrirCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  abrirSidebar();\r\n+});\r\n+cerrarCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+});\r\n \r\n+// üîπ Manejo de historial y bfcache (Atr√°s)\r\n+window.addEventListener(\"popstate\", () => {\r\n+  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n+\r\n+// üîπ Manejar back-forward cache para cerrar sidebar al volver\r\n+window.addEventListener(\"pageshow\", (event) => {\r\n+  if (event.persisted) {\r\n+    cerrarSidebar();\r\n+    mostrarCarrito();\r\n+  }\r\n+});\r\n+\r\n // =========================\r\n-// AGREGAR AL CARRITO CON STOCK\r\n+// AGREGAR PRODUCTO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n-  const cantidadActual = existe ? existe.cantidad : 0;\r\n-\r\n-  if (cantidadActual + 1 > producto.stock) {\r\n-    mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n-    return;\r\n-  }\r\n-\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -133,9 +132,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO\r\n+// MOSTRAR CARRITO (tabla)\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -148,8 +147,9 @@\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n+\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n@@ -174,93 +174,113 @@\n             <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n             <span>${producto.cantidad}</span>\r\n             <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n           </td>\r\n-          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+          <!-- Mostrar el precio con descuento y cantidad -->\r\n+          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n           <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n         </tr>\r\n       `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n+\r\n   carritoItems.appendChild(tabla);\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// GUARDAR EN LOCALSTORAGE\r\n+// GUARDAR CARRITO EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n-  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n-  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n+  try {\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  } catch (e) {\r\n+    console.error(\"Error al guardar carrito\", e);\r\n+  }\r\n }\r\n \r\n // =========================\r\n-// TOTALES Y BARRA DE ENV√çO\r\n+// TOTALES, BARRA, CONTADOR Y TOAST\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 65;\r\n+\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n+\r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n+\r\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n-    else if (totalCarrito > 0) mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-    else mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+    } else if (totalCarrito > 0) {\r\n+      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+    } else {\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+    }\r\n   }\r\n }\r\n+\r\n function actualizarTotales() {\r\n-  const subtotal = carrito.reduce((acc, p) => acc + (p.precio * p.cantidad), 0);\r\n-  const totalConDescuentos = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n-  const descuento = subtotal - totalConDescuentos;\r\n+  // Calculamos el subtotal utilizando el precio con descuento\r\n+  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n+  \r\n+  // Si el total supera un cierto umbral, aplicamos un descuento adicional\r\n+  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n+  const total = subtotal - descuento;\r\n \r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n+\r\n   descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n   descuentoEl.classList.add('naranja');\r\n-  totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n+\r\n+  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n-  actualizarBarra(totalConDescuentos);\r\n+  actualizarBarra(subtotal);\r\n }\r\n+\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n-// =========================\r\n-// TOAST\r\n-// =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n-  if (!toast) { toast = document.createElement(\"div\"); toast.id = \"mensajeCarrito\"; document.body.appendChild(toast); }\r\n+  if (!toast) {\r\n+    toast = document.createElement(\"div\");\r\n+    toast.id = \"mensajeCarrito\";\r\n+    document.body.appendChild(toast);\r\n+  }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n+\r\n   clearTimeout(toastTimeout);\r\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n // COMPRA POR WHATSAPP\r\n // =========================\r\n function redirigirWhatsApp() {\r\n-  if (carrito.length === 0) { mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\"); return; }\r\n-\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n-  ).join(\"\\n\");\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n+  ).join(\", \");\r\n   \r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+\r\n   window.open(url, \"_blank\");\r\n }\r\n \r\n // =========================\r\n@@ -269,39 +289,32 @@\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n-  else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    if (carrito[index].cantidad + 1 > carrito[index].stock) {\r\n-      mostrarToast(`No hay suficiente stock de ${carrito[index].nombre} üõë`);\r\n-      return;\r\n-    }\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n     carrito[index].cantidad++;\r\n-  }\r\n-  else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n     carrito[index].cantidad--;\r\n     if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n+    agregarAlCarrito(e.target.dataset.id);\r\n+  }\r\n });\r\n \r\n-// Sidebar ver carrito\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+  window.location.href = \"carrito.html\";\r\n });\r\n \r\n-// Comprar ahora por WhatsApp en carrito completo\r\n-document.addEventListener(\"DOMContentLoaded\", () => {\r\n-  const botonWhatsApp = document.getElementById(\"whatsapp-comprar\");\r\n-  botonWhatsApp?.addEventListener(\"click\", redirigirWhatsApp);\r\n-});\r\n-\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n@@ -309,4 +322,5 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n+\r\n"
                },
                {
                    "date": 1757992637111,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,14 +9,19 @@\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n+// üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n+const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n+const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n+const ahorroTotalEl = document.getElementById(\"ahorro-total\");\r\n+\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n // =========================\r\n-// CREAR OVERLAY (fondo oscuro)\r\n+// CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -24,9 +29,9 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// CARGAR JSON DE PRODUCTOS\r\n+// CARGAR JSON\r\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n@@ -35,12 +40,11 @@\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDERIZAR PRODUCTOS EN TIENDA\r\n+// RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n-\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n@@ -49,78 +53,80 @@\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      \r\n-      <!-- Mostrar precio regular con tachado y precio con descuento -->\r\n       <div class=\"precio\">\r\n         <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n       </div>\r\n-      \r\n-      <!-- Mostrar el descuento y el ahorro -->\r\n-      <div class=\"descuento\">${producto.descuento}% OFF</div>\r\n-      <div class=\"ahorro\">Ahorro: S/ ${producto.ahorro.toFixed(2)}</div>\r\n-      \r\n-      <!-- Bot√≥n para agregar al carrito -->\r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n-    \r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// ABRIR / CERRAR SIDEBAR CON HISTORIAL\r\n+// CALCULAR TOTAL CON DESCUENTO POR VOLUMEN\r\n // =========================\r\n+function calcularTotalProducto(producto) {\r\n+  let total = 0;\r\n+  const cantidad = producto.cantidad;\r\n+\r\n+  if (producto.descuentoVolumen) {\r\n+    const promo = producto.descuentoVolumen;\r\n+    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+    const resto = cantidad % promo.aplicaA;\r\n+    const totalPromo = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n+    const totalResto = resto * producto.precio;\r\n+    total = totalPromo + totalResto;\r\n+  } else {\r\n+    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n+  }\r\n+\r\n+  return total;\r\n+}\r\n+\r\n+// =========================\r\n+// ABRIR / CERRAR SIDEBAR\r\n+// =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n-\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n-\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  abrirSidebar();\r\n-});\r\n-cerrarCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-});\r\n+abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n+cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n+window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n+window.addEventListener(\"pageshow\", (event) => { if (event.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n-// üîπ Manejo de historial y bfcache (Atr√°s)\r\n-window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n-\r\n-// üîπ Manejar back-forward cache para cerrar sidebar al volver\r\n-window.addEventListener(\"pageshow\", (event) => {\r\n-  if (event.persisted) {\r\n-    cerrarSidebar();\r\n-    mostrarCarrito();\r\n-  }\r\n-});\r\n-\r\n // =========================\r\n-// AGREGAR PRODUCTO\r\n+// AGREGAR AL CARRITO CON STOCK\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n+  const cantidadActual = existe ? existe.cantidad : 0;\r\n+\r\n+  if (cantidadActual + 1 > producto.stock) {\r\n+    mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+    return;\r\n+  }\r\n+\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -132,9 +138,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO (tabla)\r\n+// MOSTRAR CARRITO\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -147,174 +153,222 @@\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n-\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n+        <th>Descuento aplicado</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => `\r\n-        <tr>\r\n-          <td>\r\n-            <div class=\"carrito-item-info\">\r\n-              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-              <div>\r\n-                <strong>${producto.nombre}</strong>\r\n-                <p>${producto.descripcion || \"\"}</p>\r\n+      ${carrito.map((producto, index) => {\r\n+        let descuentoAplicado = false;\r\n+        if(producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if(producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n+\r\n+        return `\r\n+          <tr>\r\n+            <td>\r\n+              <div class=\"carrito-item-info\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <div>\r\n+                  <strong>${producto.nombre}</strong>\r\n+                  <p>${producto.descripcion || \"\"}</p>\r\n+                </div>\r\n               </div>\r\n-            </div>\r\n-          </td>\r\n-          <td>\r\n-            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-            <span>${producto.cantidad}</span>\r\n-            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-          </td>\r\n-          <!-- Mostrar el precio con descuento y cantidad -->\r\n-          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n-          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-        </tr>\r\n-      `).join(\"\")}\r\n+            </td>\r\n+            <td>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+            </td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+          </tr>\r\n+        `;\r\n+      }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n-\r\n   carritoItems.appendChild(tabla);\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// GUARDAR CARRITO EN LOCALSTORAGE\r\n+// GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n-  try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar carrito\", e);\r\n-  }\r\n+  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n+  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n }\r\n \r\n // =========================\r\n-// TOTALES, BARRA, CONTADOR Y TOAST\r\n+// TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 65;\r\n+const ENVIO_GRATIS_MINIMO = 99;\r\n \r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+  if (barraProgreso) {\r\n+    barraProgreso.style.width = `${porcentaje}%`;\r\n+  }\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n+      mensajeEl.classList.add(\"gratis\");\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     } else {\r\n       mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n+\r\n+  const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n+  if (costoEnvioEl) {\r\n+    costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+  }\r\n }\r\n \r\n function actualizarTotales() {\r\n-  // Calculamos el subtotal utilizando el precio con descuento\r\n-  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n-  \r\n-  // Si el total supera un cierto umbral, aplicamos un descuento adicional\r\n-  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n-  const total = subtotal - descuento;\r\n+  let subtotal = 0;\r\n+  let descuentoVolumenTotal = 0;\r\n+  let descuentoDirectoTotal = 0;\r\n \r\n+  carrito.forEach(p => {\r\n+    const precioNormal = p.precio * p.cantidad;\r\n+    const precioConDescuento = calcularTotalProducto(p);\r\n+    subtotal += precioNormal;\r\n+\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n+      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n+      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+    }\r\n+  });\r\n+\r\n+  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n+  const totalConDescuentos = subtotal - ahorroTotal;\r\n+\r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n \r\n-  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+  if (descuentoVolumenEl) {\r\n+    descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+    descuentoVolumenEl.classList.add('naranja');\r\n+  }\r\n+  if (descuentoDirectoEl) {\r\n+    descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+    descuentoDirectoEl.classList.add('naranja');\r\n+  }\r\n+  if (ahorroTotalEl) {\r\n+    ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+    ahorroTotalEl.classList.add('naranja');\r\n+  }\r\n+\r\n+  descuentoEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n   descuentoEl.classList.add('naranja');\r\n \r\n-  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n-  actualizarBarra(subtotal);\r\n+  actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n+// =========================\r\n+// CONTADOR\r\n+// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n+// =========================\r\n+// TOAST\r\n+// =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n-  if (!toast) {\r\n-    toast = document.createElement(\"div\");\r\n-    toast.id = \"mensajeCarrito\";\r\n-    document.body.appendChild(toast);\r\n-  }\r\n+  if (!toast) { toast = document.createElement(\"div\"); toast.id = \"mensajeCarrito\"; document.body.appendChild(toast); }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-\r\n   clearTimeout(toastTimeout);\r\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRA POR WHATSAPP\r\n+// COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n-function redirigirWhatsApp() {\r\n+function comprarAhora() {\r\n+  if (carrito.length === 0) {\r\n+    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n+    return;\r\n+  }\r\n+\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n-  ).join(\", \");\r\n-  \r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n+  ).join(\"\\n\");\r\n+\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n   window.open(url, \"_blank\");\r\n+\r\n+  carrito = [];\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+  actualizarContador();\r\n+  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n }\r\n \r\n // =========================\r\n-// EVENTOS DEL CARRITO\r\n+// LISTENERS\r\n // =========================\r\n+document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n+\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    carrito[index].cantidad++;\r\n-  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n+  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n+  else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n     carrito[index].cantidad--;\r\n     if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n-    agregarAlCarrito(e.target.dataset.id);\r\n-  }\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n \r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-  window.location.href = \"carrito.html\";\r\n+  e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n });\r\n \r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n+\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n@@ -322,5 +376,4 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n-\r\n"
                },
                {
                    "date": 1757993646614,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -221,9 +221,10 @@\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n   if (barraProgreso) {\r\n-    barraProgreso.style.width = `${porcentaje}%`;\r\n+    barraProgreso.style.display = \"block\";       // ‚úÖ Asegura que la barra siempre se vea\r\n+    barraProgreso.style.width = `${porcentaje}%`; // Actualiza el ancho seg√∫n el total\r\n   }\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n@@ -285,11 +286,13 @@\n \r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n+  // ‚úÖ Llamada a la barra para que se actualice visualmente\r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n+\r\n // =========================\r\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n"
                },
                {
                    "date": 1757993710472,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -221,10 +221,9 @@\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n   if (barraProgreso) {\r\n-    barraProgreso.style.display = \"block\";       // ‚úÖ Asegura que la barra siempre se vea\r\n-    barraProgreso.style.width = `${porcentaje}%`; // Actualiza el ancho seg√∫n el total\r\n+    barraProgreso.style.width = `${porcentaje}%`;\r\n   }\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n@@ -286,13 +285,11 @@\n \r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n-  // ‚úÖ Llamada a la barra para que se actualice visualmente\r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n-\r\n // =========================\r\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n"
                },
                {
                    "date": 1757993788997,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,19 +9,14 @@\n const descuentoEl = document.getElementById(\"descuento\");\r\n const totalEl = document.getElementById(\"total\");\r\n const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n-// üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n-const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n-const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n-const ahorroTotalEl = document.getElementById(\"ahorro-total\");\r\n-\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n // =========================\r\n-// CREAR OVERLAY\r\n+// CREAR OVERLAY (fondo oscuro)\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -29,9 +24,9 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// CARGAR JSON\r\n+// CARGAR JSON DE PRODUCTOS\r\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n@@ -40,11 +35,12 @@\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDER PRODUCTOS\r\n+// RENDERIZAR PRODUCTOS EN TIENDA\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n+\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n@@ -53,80 +49,78 @@\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n+      \r\n+      <!-- Mostrar precio regular con tachado y precio con descuento -->\r\n       <div class=\"precio\">\r\n         <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n       </div>\r\n-      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n-      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n+      \r\n+      <!-- Mostrar el descuento y el ahorro -->\r\n+      <div class=\"descuento\">${producto.descuento}% OFF</div>\r\n+      <div class=\"ahorro\">Ahorro: S/ ${producto.ahorro.toFixed(2)}</div>\r\n+      \r\n+      <!-- Bot√≥n para agregar al carrito -->\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n+    \r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// CALCULAR TOTAL CON DESCUENTO POR VOLUMEN\r\n+// ABRIR / CERRAR SIDEBAR CON HISTORIAL\r\n // =========================\r\n-function calcularTotalProducto(producto) {\r\n-  let total = 0;\r\n-  const cantidad = producto.cantidad;\r\n-\r\n-  if (producto.descuentoVolumen) {\r\n-    const promo = producto.descuentoVolumen;\r\n-    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n-    const resto = cantidad % promo.aplicaA;\r\n-    const totalPromo = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n-    const totalResto = resto * producto.precio;\r\n-    total = totalPromo + totalResto;\r\n-  } else {\r\n-    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n-  }\r\n-\r\n-  return total;\r\n-}\r\n-\r\n-// =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n-// =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n+\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n+\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n-cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n-window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n-window.addEventListener(\"pageshow\", (event) => { if (event.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n+abrirCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  abrirSidebar();\r\n+});\r\n+cerrarCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+});\r\n \r\n+// üîπ Manejo de historial y bfcache (Atr√°s)\r\n+window.addEventListener(\"popstate\", () => {\r\n+  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n+\r\n+// üîπ Manejar back-forward cache para cerrar sidebar al volver\r\n+window.addEventListener(\"pageshow\", (event) => {\r\n+  if (event.persisted) {\r\n+    cerrarSidebar();\r\n+    mostrarCarrito();\r\n+  }\r\n+});\r\n+\r\n // =========================\r\n-// AGREGAR AL CARRITO CON STOCK\r\n+// AGREGAR PRODUCTO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n-  const cantidadActual = existe ? existe.cantidad : 0;\r\n-\r\n-  if (cantidadActual + 1 > producto.stock) {\r\n-    mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n-    return;\r\n-  }\r\n-\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -138,9 +132,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO\r\n+// MOSTRAR CARRITO (tabla)\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -153,222 +147,174 @@\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n+\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n-        <th>Descuento aplicado</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => {\r\n-        let descuentoAplicado = false;\r\n-        if(producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if(producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n-\r\n-        return `\r\n-          <tr>\r\n-            <td>\r\n-              <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-                <div>\r\n-                  <strong>${producto.nombre}</strong>\r\n-                  <p>${producto.descripcion || \"\"}</p>\r\n-                </div>\r\n+      ${carrito.map((producto, index) => `\r\n+        <tr>\r\n+          <td>\r\n+            <div class=\"carrito-item-info\">\r\n+              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+              <div>\r\n+                <strong>${producto.nombre}</strong>\r\n+                <p>${producto.descripcion || \"\"}</p>\r\n               </div>\r\n-            </td>\r\n-            <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-            </td>\r\n-            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-          </tr>\r\n-        `;\r\n-      }).join(\"\")}\r\n+            </div>\r\n+          </td>\r\n+          <td>\r\n+            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+            <span>${producto.cantidad}</span>\r\n+            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+          </td>\r\n+          <!-- Mostrar el precio con descuento y cantidad -->\r\n+          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n+          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+        </tr>\r\n+      `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n+\r\n   carritoItems.appendChild(tabla);\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// GUARDAR EN LOCALSTORAGE\r\n+// GUARDAR CARRITO EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n-  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n-  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n+  try {\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  } catch (e) {\r\n+    console.error(\"Error al guardar carrito\", e);\r\n+  }\r\n }\r\n \r\n // =========================\r\n-// TOTALES Y BARRA DE ENV√çO\r\n+// TOTALES, BARRA, CONTADOR Y TOAST\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 99;\r\n+const ENVIO_GRATIS_MINIMO = 65;\r\n \r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n-  if (barraProgreso) {\r\n-    barraProgreso.style.width = `${porcentaje}%`;\r\n-  }\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n-      mensajeEl.classList.add(\"gratis\");\r\n+      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n     } else {\r\n       mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n-\r\n-  const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n-  if (costoEnvioEl) {\r\n-    costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n-  }\r\n }\r\n \r\n function actualizarTotales() {\r\n-  let subtotal = 0;\r\n-  let descuentoVolumenTotal = 0;\r\n-  let descuentoDirectoTotal = 0;\r\n+  // Calculamos el subtotal utilizando el precio con descuento\r\n+  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n+  \r\n+  // Si el total supera un cierto umbral, aplicamos un descuento adicional\r\n+  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n+  const total = subtotal - descuento;\r\n \r\n-  carrito.forEach(p => {\r\n-    const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = calcularTotalProducto(p);\r\n-    subtotal += precioNormal;\r\n-\r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n-      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n-      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-    }\r\n-  });\r\n-\r\n-  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n-  const totalConDescuentos = subtotal - ahorroTotal;\r\n-\r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n \r\n-  if (descuentoVolumenEl) {\r\n-    descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-    descuentoVolumenEl.classList.add('naranja');\r\n-  }\r\n-  if (descuentoDirectoEl) {\r\n-    descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-    descuentoDirectoEl.classList.add('naranja');\r\n-  }\r\n-  if (ahorroTotalEl) {\r\n-    ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-    ahorroTotalEl.classList.add('naranja');\r\n-  }\r\n-\r\n-  descuentoEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n   descuentoEl.classList.add('naranja');\r\n \r\n-  totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n+  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n-  actualizarBarra(totalConDescuentos);\r\n+  actualizarBarra(subtotal);\r\n }\r\n \r\n-// =========================\r\n-// CONTADOR\r\n-// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n-// =========================\r\n-// TOAST\r\n-// =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n-  if (!toast) { toast = document.createElement(\"div\"); toast.id = \"mensajeCarrito\"; document.body.appendChild(toast); }\r\n+  if (!toast) {\r\n+    toast = document.createElement(\"div\");\r\n+    toast.id = \"mensajeCarrito\";\r\n+    document.body.appendChild(toast);\r\n+  }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n+\r\n   clearTimeout(toastTimeout);\r\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRAR AHORA POR WHATSAPP\r\n+// COMPRA POR WHATSAPP\r\n // =========================\r\n-function comprarAhora() {\r\n-  if (carrito.length === 0) {\r\n-    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n-    return;\r\n-  }\r\n-\r\n+function redirigirWhatsApp() {\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n-  ).join(\"\\n\");\r\n-\r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n+  ).join(\", \");\r\n+  \r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n   window.open(url, \"_blank\");\r\n-\r\n-  carrito = [];\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-  actualizarContador();\r\n-  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n }\r\n \r\n // =========================\r\n-// LISTENERS\r\n+// EVENTOS DEL CARRITO\r\n // =========================\r\n-document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n-\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n-  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n-  else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    carrito[index].cantidad++;\r\n+  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n     carrito[index].cantidad--;\r\n     if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n+    agregarAlCarrito(e.target.dataset.id);\r\n+  }\r\n });\r\n \r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+  window.location.href = \"carrito.html\";\r\n });\r\n \r\n-document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n-\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n@@ -376,4 +322,5 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n+\r\n"
                },
                {
                    "date": 1757994542051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,12 +5,16 @@\n const sidebar = document.getElementById(\"carrito-sidebar\");\r\n const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n const carritoItems = document.getElementById(\"carrito-items\");\r\n const subtotalEl = document.getElementById(\"subtotal\");\r\n-const descuentoEl = document.getElementById(\"descuento\");\r\n+const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n+const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n+const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n+const ahorroTotalEl = document.getElementById(\"ahorro-total\");\r\n const totalEl = document.getElementById(\"total\");\r\n const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n+\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n"
                },
                {
                    "date": 1757994850228,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -230,25 +230,50 @@\n   }\r\n }\r\n \r\n function actualizarTotales() {\r\n-  // Calculamos el subtotal utilizando el precio con descuento\r\n-  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n-  \r\n-  // Si el total supera un cierto umbral, aplicamos un descuento adicional\r\n-  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n-  const total = subtotal - descuento;\r\n+  let subtotal = 0;\r\n+  let descuentoVolumenTotal = 0;\r\n+  let descuentoDirectoTotal = 0;\r\n \r\n+  carrito.forEach(p => {\r\n+    const precioNormal = p.precio * p.cantidad;\r\n+    const precioConDescuento = p.precio_con_descuento;\r\n+    subtotal += precioNormal;\r\n+\r\n+    // Descuento por volumen o directo\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n+      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n+      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+    }\r\n+  });\r\n+\r\n+  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n+  const totalConDescuentos = subtotal - ahorroTotal;\r\n+\r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n \r\n-  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-  descuentoEl.classList.add('naranja');\r\n+  if (descuentoVolumenEl) {\r\n+    descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+    descuentoVolumenEl.classList.add('naranja');\r\n+  }\r\n \r\n-  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  if (descuentoDirectoEl) {\r\n+    descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+    descuentoDirectoEl.classList.add('naranja');\r\n+  }\r\n+\r\n+  if (ahorroTotalEl) {\r\n+    ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+    ahorroTotalEl.classList.add('naranja');\r\n+  }\r\n+\r\n+  totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n-  actualizarBarra(subtotal);\r\n+  actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n"
                },
                {
                    "date": 1757995490656,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,22 +5,23 @@\n const sidebar = document.getElementById(\"carrito-sidebar\");\r\n const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n const carritoItems = document.getElementById(\"carrito-items\");\r\n const subtotalEl = document.getElementById(\"subtotal\");\r\n-const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n+const descuentoEl = document.getElementById(\"descuento\");\r\n+const totalEl = document.getElementById(\"total\");\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n+\r\n+// üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n const ahorroTotalEl = document.getElementById(\"ahorro-total\");\r\n-const totalEl = document.getElementById(\"total\");\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n-\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n // =========================\r\n-// CREAR OVERLAY (fondo oscuro)\r\n+// CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -28,9 +29,9 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// CARGAR JSON DE PRODUCTOS\r\n+// CARGAR JSON\r\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n@@ -39,12 +40,11 @@\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDERIZAR PRODUCTOS EN TIENDA\r\n+// RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n-\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n@@ -53,78 +53,80 @@\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      \r\n-      <!-- Mostrar precio regular con tachado y precio con descuento -->\r\n       <div class=\"precio\">\r\n         <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n       </div>\r\n-      \r\n-      <!-- Mostrar el descuento y el ahorro -->\r\n-      <div class=\"descuento\">${producto.descuento}% OFF</div>\r\n-      <div class=\"ahorro\">Ahorro: S/ ${producto.ahorro.toFixed(2)}</div>\r\n-      \r\n-      <!-- Bot√≥n para agregar al carrito -->\r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n-    \r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// ABRIR / CERRAR SIDEBAR CON HISTORIAL\r\n+// CALCULAR TOTAL CON DESCUENTO POR VOLUMEN\r\n // =========================\r\n+function calcularTotalProducto(producto) {\r\n+  let total = 0;\r\n+  const cantidad = producto.cantidad;\r\n+\r\n+  if (producto.descuentoVolumen) {\r\n+    const promo = producto.descuentoVolumen;\r\n+    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+    const resto = cantidad % promo.aplicaA;\r\n+    const totalPromo = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n+    const totalResto = resto * producto.precio;\r\n+    total = totalPromo + totalResto;\r\n+  } else {\r\n+    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n+  }\r\n+\r\n+  return total;\r\n+}\r\n+\r\n+// =========================\r\n+// ABRIR / CERRAR SIDEBAR\r\n+// =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n-\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n-\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  abrirSidebar();\r\n-});\r\n-cerrarCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-});\r\n+abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n+cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n+window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n+window.addEventListener(\"pageshow\", (event) => { if (event.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n-// üîπ Manejo de historial y bfcache (Atr√°s)\r\n-window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n-\r\n-// üîπ Manejar back-forward cache para cerrar sidebar al volver\r\n-window.addEventListener(\"pageshow\", (event) => {\r\n-  if (event.persisted) {\r\n-    cerrarSidebar();\r\n-    mostrarCarrito();\r\n-  }\r\n-});\r\n-\r\n // =========================\r\n-// AGREGAR PRODUCTO\r\n+// AGREGAR AL CARRITO CON STOCK\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n+  const cantidadActual = existe ? existe.cantidad : 0;\r\n+\r\n+  if (cantidadActual + 1 > producto.stock) {\r\n+    mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+    return;\r\n+  }\r\n+\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -136,9 +138,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO (tabla)\r\n+// MOSTRAR CARRITO\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -151,84 +153,97 @@\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n-\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n+        <th>Descuento aplicado</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => `\r\n-        <tr>\r\n-          <td>\r\n-            <div class=\"carrito-item-info\">\r\n-              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-              <div>\r\n-                <strong>${producto.nombre}</strong>\r\n-                <p>${producto.descripcion || \"\"}</p>\r\n+      ${carrito.map((producto, index) => {\r\n+        let descuentoAplicado = false;\r\n+        if(producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if(producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n+\r\n+        return `\r\n+          <tr>\r\n+            <td>\r\n+              <div class=\"carrito-item-info\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <div>\r\n+                  <strong>${producto.nombre}</strong>\r\n+                  <p>${producto.descripcion || \"\"}</p>\r\n+                </div>\r\n               </div>\r\n-            </div>\r\n-          </td>\r\n-          <td>\r\n-            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-            <span>${producto.cantidad}</span>\r\n-            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-          </td>\r\n-          <!-- Mostrar el precio con descuento y cantidad -->\r\n-          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n-          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-        </tr>\r\n-      `).join(\"\")}\r\n+            </td>\r\n+            <td>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+            </td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+          </tr>\r\n+        `;\r\n+      }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n-\r\n   carritoItems.appendChild(tabla);\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// GUARDAR CARRITO EN LOCALSTORAGE\r\n+// GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n-  try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar carrito\", e);\r\n-  }\r\n+  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n+  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n }\r\n \r\n // =========================\r\n-// TOTALES, BARRA, CONTADOR Y TOAST\r\n+// TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 65;\r\n+const ENVIO_GRATIS_MINIMO = 99;\r\n \r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+  if (barraProgreso) {\r\n+    barraProgreso.style.display = \"block\";       // ‚úÖ Asegura que la barra siempre se vea\r\n+    barraProgreso.style.width = `${porcentaje}%`; // Actualiza el ancho seg√∫n el total\r\n+  }\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n+      mensajeEl.classList.add(\"gratis\");\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     } else {\r\n       mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n+\r\n+  const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n+  if (costoEnvioEl) {\r\n+    costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+  }\r\n }\r\n \r\n function actualizarTotales() {\r\n   let subtotal = 0;\r\n@@ -236,12 +251,11 @@\n   let descuentoDirectoTotal = 0;\r\n \r\n   carrito.forEach(p => {\r\n     const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = p.precio_con_descuento;\r\n+    const precioConDescuento = calcularTotalProducto(p);\r\n     subtotal += precioNormal;\r\n \r\n-    // Descuento por volumen o directo\r\n     if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n       descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n     } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n       descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n@@ -257,93 +271,107 @@\n   if (descuentoVolumenEl) {\r\n     descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n     descuentoVolumenEl.classList.add('naranja');\r\n   }\r\n-\r\n   if (descuentoDirectoEl) {\r\n     descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n     descuentoDirectoEl.classList.add('naranja');\r\n   }\r\n-\r\n   if (ahorroTotalEl) {\r\n     ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n     ahorroTotalEl.classList.add('naranja');\r\n   }\r\n \r\n+  descuentoEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  descuentoEl.classList.add('naranja');\r\n+\r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n+  // ‚úÖ Llamada a la barra para que se actualice visualmente\r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n+\r\n+// =========================\r\n+// CONTADOR\r\n+// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n+// =========================\r\n+// TOAST\r\n+// =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n-  if (!toast) {\r\n-    toast = document.createElement(\"div\");\r\n-    toast.id = \"mensajeCarrito\";\r\n-    document.body.appendChild(toast);\r\n-  }\r\n+  if (!toast) { toast = document.createElement(\"div\"); toast.id = \"mensajeCarrito\"; document.body.appendChild(toast); }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-\r\n   clearTimeout(toastTimeout);\r\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRA POR WHATSAPP\r\n+// COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n-function redirigirWhatsApp() {\r\n+function comprarAhora() {\r\n+  if (carrito.length === 0) {\r\n+    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n+    return;\r\n+  }\r\n+\r\n   const totalCompra = totalEl.innerText;\r\n   const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n-  ).join(\", \");\r\n-  \r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n+  ).join(\"\\n\");\r\n+\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n   window.open(url, \"_blank\");\r\n+\r\n+  carrito = [];\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+  actualizarContador();\r\n+  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n }\r\n \r\n // =========================\r\n-// EVENTOS DEL CARRITO\r\n+// LISTENERS\r\n // =========================\r\n+document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n+\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    carrito[index].cantidad++;\r\n-  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n+  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n+  else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n     carrito[index].cantidad--;\r\n     if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n-    agregarAlCarrito(e.target.dataset.id);\r\n-  }\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n \r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-  window.location.href = \"carrito.html\";\r\n+  e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n });\r\n \r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n+\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n@@ -351,5 +379,4 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n-\r\n"
                },
                {
                    "date": 1757995609940,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -221,10 +221,9 @@\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n   if (barraProgreso) {\r\n-    barraProgreso.style.display = \"block\";       // ‚úÖ Asegura que la barra siempre se vea\r\n-    barraProgreso.style.width = `${porcentaje}%`; // Actualiza el ancho seg√∫n el total\r\n+    barraProgreso.style.width = `${porcentaje}%`;\r\n   }\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n@@ -286,13 +285,11 @@\n \r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n-  // ‚úÖ Llamada a la barra para que se actualice visualmente\r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n-\r\n // =========================\r\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n"
                },
                {
                    "date": 1757995724823,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -221,9 +221,10 @@\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n   if (barraProgreso) {\r\n-    barraProgreso.style.width = `${porcentaje}%`;\r\n+    barraProgreso.style.display = \"block\";       // ‚úÖ Asegura que la barra siempre se vea\r\n+    barraProgreso.style.width = `${porcentaje}%`; // Actualiza el ancho seg√∫n el total\r\n   }\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n@@ -285,11 +286,13 @@\n \r\n   totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n+  // ‚úÖ Llamada a la barra para que se actualice visualmente\r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n+\r\n // =========================\r\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n"
                },
                {
                    "date": 1757997289775,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,21 +1,26 @@\n // =========================\r\n // VARIABLES PRINCIPALES\r\n // =========================\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n-const sidebar = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n-const carritoItems = document.getElementById(\"carrito-items\");\r\n-const subtotalEl = document.getElementById(\"subtotal\");\r\n-const descuentoEl = document.getElementById(\"descuento\");\r\n-const totalEl = document.getElementById(\"total\");\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n+// =========================\r\n+// ELEMENTOS DEL CARRITO\r\n+// =========================\r\n+const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n+const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n+const cerrarCarrito      = document.querySelector(\".cerrar-carrito\");\r\n+const carritoItems       = document.getElementById(\"carrito-items\");\r\n \r\n+const subtotalEl         = document.getElementById(\"subtotal\");\r\n+const totalEl            = document.getElementById(\"total\");\r\n+const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n+\r\n // üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n-const ahorroTotalEl = document.getElementById(\"ahorro-total\");\r\n+const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n+const costoEnvioEl       = document.getElementById(\"costo-envio\"); // üëà tambi√©n lo tienes en tu HTML\r\n \r\n+\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n"
                },
                {
                    "date": 1757997488660,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -226,9 +226,9 @@\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n   if (barraProgreso) {\r\n-    barraProgreso.style.display = \"block\";       // ‚úÖ Asegura que la barra siempre se vea\r\n+    barraProgreso.style.display = \"block\";        // ‚úÖ Asegura que la barra siempre se vea\r\n     barraProgreso.style.width = `${porcentaje}%`; // Actualiza el ancho seg√∫n el total\r\n   }\r\n \r\n   if (mensajeEl) {\r\n@@ -269,30 +269,33 @@\n \r\n   const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n   const totalConDescuentos = subtotal - ahorroTotal;\r\n \r\n-  subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  subtotalEl.classList.add('naranja');\r\n+  if (subtotalEl) {\r\n+    subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+    subtotalEl.classList.add('naranja');\r\n+  }\r\n \r\n   if (descuentoVolumenEl) {\r\n     descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n     descuentoVolumenEl.classList.add('naranja');\r\n   }\r\n+\r\n   if (descuentoDirectoEl) {\r\n     descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n     descuentoDirectoEl.classList.add('naranja');\r\n   }\r\n+\r\n   if (ahorroTotalEl) {\r\n     ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n     ahorroTotalEl.classList.add('naranja');\r\n   }\r\n \r\n-  descuentoEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-  descuentoEl.classList.add('naranja');\r\n+  if (totalEl) {\r\n+    totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n+    totalEl.classList.add('naranja');\r\n+  }\r\n \r\n-  totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n-  totalEl.classList.add('naranja');\r\n-\r\n   // ‚úÖ Llamada a la barra para que se actualice visualmente\r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n"
                },
                {
                    "date": 1757998773667,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,6 @@\n+\r\n // =========================\r\n-// VARIABLES PRINCIPALES\r\n-// =========================\r\n-// =========================\r\n // ELEMENTOS DEL CARRITO\r\n // =========================\r\n const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n"
                },
                {
                    "date": 1757999367744,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n \r\n-// =========================\r\n+/// =========================\r\n // ELEMENTOS DEL CARRITO\r\n // =========================\r\n const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n@@ -14,11 +14,10 @@\n // üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n-const costoEnvioEl       = document.getElementById(\"costo-envio\"); // üëà tambi√©n lo tienes en tu HTML\r\n+const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n-\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n@@ -32,9 +31,9 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// CARGAR JSON\r\n+// CARGAR JSON DE PRODUCTOS\r\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n@@ -111,9 +110,9 @@\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n-window.addEventListener(\"pageshow\", (event) => { if (event.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n+window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n // =========================\r\n // AGREGAR AL CARRITO CON STOCK\r\n // =========================\r\n@@ -169,10 +168,10 @@\n     </thead>\r\n     <tbody>\r\n       ${carrito.map((producto, index) => {\r\n         let descuentoAplicado = false;\r\n-        if(producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if(producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n+        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n \r\n         return `\r\n           <tr>\r\n             <td>\r\n@@ -224,10 +223,10 @@\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n   if (barraProgreso) {\r\n-    barraProgreso.style.display = \"block\";        // ‚úÖ Asegura que la barra siempre se vea\r\n-    barraProgreso.style.width = `${porcentaje}%`; // Actualiza el ancho seg√∫n el total\r\n+    barraProgreso.style.display = \"block\";\r\n+    barraProgreso.style.width = `${porcentaje}%`;\r\n   }\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n@@ -241,9 +240,8 @@\n       mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n \r\n-  const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n   if (costoEnvioEl) {\r\n     costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n   }\r\n }\r\n@@ -269,36 +267,30 @@\n   const totalConDescuentos = subtotal - ahorroTotal;\r\n \r\n   if (subtotalEl) {\r\n     subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-    subtotalEl.classList.add('naranja');\r\n+    subtotalEl.classList.add(\"naranja\");\r\n   }\r\n-\r\n   if (descuentoVolumenEl) {\r\n     descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-    descuentoVolumenEl.classList.add('naranja');\r\n+    descuentoVolumenEl.classList.add(\"naranja\");\r\n   }\r\n-\r\n   if (descuentoDirectoEl) {\r\n     descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-    descuentoDirectoEl.classList.add('naranja');\r\n+    descuentoDirectoEl.classList.add(\"naranja\");\r\n   }\r\n-\r\n   if (ahorroTotalEl) {\r\n     ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-    ahorroTotalEl.classList.add('naranja');\r\n+    ahorroTotalEl.classList.add(\"naranja\");\r\n   }\r\n-\r\n   if (totalEl) {\r\n     totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n-    totalEl.classList.add('naranja');\r\n+    totalEl.classList.add(\"naranja\");\r\n   }\r\n \r\n-  // ‚úÖ Llamada a la barra para que se actualice visualmente\r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n-\r\n // =========================\r\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n@@ -310,9 +302,13 @@\n // TOAST\r\n // =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n-  if (!toast) { toast = document.createElement(\"div\"); toast.id = \"mensajeCarrito\"; document.body.appendChild(toast); }\r\n+  if (!toast) {\r\n+    toast = document.createElement(\"div\");\r\n+    toast.id = \"mensajeCarrito\";\r\n+    document.body.appendChild(toast);\r\n+  }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n   clearTimeout(toastTimeout);\r\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n@@ -326,9 +322,9 @@\n     mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n     return;\r\n   }\r\n \r\n-  const totalCompra = totalEl.innerText;\r\n+  const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n   const productos = carrito.map(p =>\r\n     `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n   ).join(\"\\n\");\r\n \r\n@@ -370,9 +366,11 @@\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n \r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\";\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+  window.location.href = \"carrito.html\";\r\n });\r\n \r\n document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n"
                },
                {
                    "date": 1758000247506,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,5 @@\n-\r\n-/// =========================\r\n+// =========================\r\n // ELEMENTOS DEL CARRITO\r\n // =========================\r\n const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n@@ -78,9 +77,12 @@\n   if (producto.descuentoVolumen) {\r\n     const promo = producto.descuentoVolumen;\r\n     const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n     const resto = cantidad % promo.aplicaA;\r\n-    const totalPromo = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n+    const totalPromo = vecesPromo * (\r\n+      (promo.compra * producto.precio) +\r\n+      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n+    );\r\n     const totalResto = resto * producto.precio;\r\n     total = totalPromo + totalResto;\r\n   } else {\r\n     total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n@@ -196,9 +198,12 @@\n       }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n   carritoItems.appendChild(tabla);\r\n+\r\n+  // scroll si hay muchos\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n+\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n@@ -265,28 +270,13 @@\n \r\n   const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n   const totalConDescuentos = subtotal - ahorroTotal;\r\n \r\n-  if (subtotalEl) {\r\n-    subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-    subtotalEl.classList.add(\"naranja\");\r\n-  }\r\n-  if (descuentoVolumenEl) {\r\n-    descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-    descuentoVolumenEl.classList.add(\"naranja\");\r\n-  }\r\n-  if (descuentoDirectoEl) {\r\n-    descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-    descuentoDirectoEl.classList.add(\"naranja\");\r\n-  }\r\n-  if (ahorroTotalEl) {\r\n-    ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-    ahorroTotalEl.classList.add(\"naranja\");\r\n-  }\r\n-  if (totalEl) {\r\n-    totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n-    totalEl.classList.add(\"naranja\");\r\n-  }\r\n+  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n \r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n"
                },
                {
                    "date": 1758001852970,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,11 +121,18 @@\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n+  // Verificar si hay stock disponible\r\n+  if (producto.stock <= 0) {\r\n+    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n+    return;\r\n+  }\r\n+\r\n   const existe = carrito.find(p => p.id == idProducto);\r\n   const cantidadActual = existe ? existe.cantidad : 0;\r\n \r\n+  // Validar stock antes de agregar\r\n   if (cantidadActual + 1 > producto.stock) {\r\n     mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n     return;\r\n   }\r\n"
                },
                {
                    "date": 1758002043754,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -128,22 +128,23 @@\n     return;\r\n   }\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n-  const cantidadActual = existe ? existe.cantidad : 0;\r\n \r\n-  // Validar stock antes de agregar\r\n-  if (cantidadActual + 1 > producto.stock) {\r\n-    mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n-    return;\r\n-  }\r\n-\r\n   if (existe) {\r\n+    // Validar stock antes de incrementar\r\n+    if (existe.cantidad + 1 > producto.stock) {\r\n+      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+      return;\r\n+    }\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n   }\r\n \r\n+  // Reducir stock real en el cat√°logo\r\n+  producto.stock--;\r\n+\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n"
                },
                {
                    "date": 1758002317169,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,30 +121,25 @@\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n-  // Verificar si hay stock disponible\r\n-  if (producto.stock <= 0) {\r\n+  const existe = carrito.find(p => p.id == idProducto);\r\n+  const cantidadActual = existe ? existe.cantidad : 0;\r\n+\r\n+  // Stock real disponible\r\n+  const stockDisponible = producto.stock - cantidadActual;\r\n+\r\n+  if (stockDisponible <= 0) {\r\n     mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n     return;\r\n   }\r\n \r\n-  const existe = carrito.find(p => p.id == idProducto);\r\n-\r\n   if (existe) {\r\n-    // Validar stock antes de incrementar\r\n-    if (existe.cantidad + 1 > producto.stock) {\r\n-      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n-      return;\r\n-    }\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n   }\r\n \r\n-  // Reducir stock real en el cat√°logo\r\n-  producto.stock--;\r\n-\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n"
                },
                {
                    "date": 1758002917037,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -143,9 +143,33 @@\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const index = e.target.dataset.index;\r\n+  if (index === undefined) return;\r\n \r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    const producto = carrito[index];\r\n+    const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n+\r\n+    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n+      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+      return;\r\n+    }\r\n+\r\n+    producto.cantidad++;\r\n+  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+    carrito[index].cantidad--;\r\n+    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n+  }\r\n+\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+});\r\n+\r\n // =========================\r\n // MOSTRAR CARRITO\r\n // =========================\r\n function mostrarCarrito() {\r\n"
                },
                {
                    "date": 1758003181423,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -143,33 +143,9 @@\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const index = e.target.dataset.index;\r\n-  if (index === undefined) return;\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    const producto = carrito[index];\r\n-    const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n-\r\n-    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n-      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n-      return;\r\n-    }\r\n-\r\n-    producto.cantidad++;\r\n-  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    carrito[index].cantidad--;\r\n-    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n-  }\r\n-\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n-\r\n // =========================\r\n // MOSTRAR CARRITO\r\n // =========================\r\n function mostrarCarrito() {\r\n"
                },
                {
                    "date": 1758003362408,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,9 +9,9 @@\n const subtotalEl         = document.getElementById(\"subtotal\");\r\n const totalEl            = document.getElementById(\"total\");\r\n const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n \r\n-// üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n+// Campos para descuentos y env√≠o\r\n const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n@@ -67,9 +67,9 @@\n   });\r\n }\r\n \r\n // =========================\r\n-// CALCULAR TOTAL CON DESCUENTO POR VOLUMEN\r\n+// CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n   let total = 0;\r\n   const cantidad = producto.cantidad;\r\n@@ -124,11 +124,9 @@\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n   const cantidadActual = existe ? existe.cantidad : 0;\r\n \r\n-  // Stock real disponible\r\n   const stockDisponible = producto.stock - cantidadActual;\r\n-\r\n   if (stockDisponible <= 0) {\r\n     mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n     return;\r\n   }\r\n@@ -202,17 +200,42 @@\n     </tbody>\r\n   `;\r\n   carritoItems.appendChild(tabla);\r\n \r\n-  // scroll si hay muchos\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n-\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n+// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n+// =========================\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const index = e.target.dataset.index;\r\n+  if (index === undefined) return;\r\n+\r\n+  const producto = carrito[index];\r\n+  const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n+\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n+      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+      return;\r\n+    }\r\n+    producto.cantidad++;\r\n+  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+    producto.cantidad--;\r\n+    if (producto.cantidad <= 0) carrito.splice(index, 1);\r\n+  }\r\n+\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+});\r\n+\r\n+// =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n   try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n@@ -222,20 +245,16 @@\n // =========================\r\n // TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 99;\r\n-\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n-  if (barraProgreso) {\r\n-    barraProgreso.style.display = \"block\";\r\n-    barraProgreso.style.width = `${porcentaje}%`;\r\n-  }\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n       mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n@@ -248,11 +267,9 @@\n       mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n \r\n-  if (costoEnvioEl) {\r\n-    costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n-  }\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n \r\n function actualizarTotales() {\r\n   let subtotal = 0;\r\n@@ -263,13 +280,10 @@\n     const precioNormal = p.precio * p.cantidad;\r\n     const precioConDescuento = calcularTotalProducto(p);\r\n     subtotal += precioNormal;\r\n \r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n-      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n-      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-    }\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n   });\r\n \r\n   const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n   const totalConDescuentos = subtotal - ahorroTotal;\r\n@@ -316,12 +330,9 @@\n     return;\r\n   }\r\n \r\n   const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n-  ).join(\"\\n\");\r\n-\r\n+  const productos = carrito.map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`).join(\"\\n\");\r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n@@ -336,39 +347,21 @@\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n }\r\n \r\n // =========================\r\n-// LISTENERS\r\n+// LISTENERS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n-\r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const index = e.target.dataset.index;\r\n-  if (index === undefined) return;\r\n-\r\n-  if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n-  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n-  else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    carrito[index].cantidad--;\r\n-    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n-  }\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n-\r\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n-\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n-\r\n document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n-\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n"
                },
                {
                    "date": 1758003845754,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -330,22 +330,34 @@\n     return;\r\n   }\r\n \r\n   const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito.map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`).join(\"\\n\");\r\n+  const productos = carrito\r\n+    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n+    .join(\"\\n\");\r\n+\r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"+51920165696\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n+  // Abrir WhatsApp\r\n   window.open(url, \"_blank\");\r\n \r\n+  // Vaciar carrito\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n+\r\n+  // Mostrar toast\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n+\r\n+  // ‚úÖ Cerrar sidebar si estaba abierto\r\n+  if (sidebar?.classList.contains(\"activo\")) {\r\n+    cerrarSidebar();\r\n+  }\r\n }\r\n \r\n // =========================\r\n // LISTENERS GENERALES\r\n"
                },
                {
                    "date": 1758151041949,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -335,9 +335,9 @@\n     .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n     .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"+51920165696\";\r\n+  const telefono = \"+51929261925\";\r\n   const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n     ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n     : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n"
                },
                {
                    "date": 1758660104934,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -256,9 +256,9 @@\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n+      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n       mensajeEl.classList.add(\"gratis\");\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n       mensajeEl.classList.remove(\"gratis\");\r\n"
                },
                {
                    "date": 1758660489751,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -301,11 +301,18 @@\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+\r\n+  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+\r\n+  // contador dentro del carrito (en el h2)\r\n+  const contadorInline = document.getElementById(\"contador-inline\");\r\n+  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n+\r\n // =========================\r\n // TOAST\r\n // =========================\r\n function mostrarToast(mensaje) {\r\n"
                },
                {
                    "date": 1759006831850,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -342,13 +342,21 @@\n     .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n     .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"+51929261925\";\r\n-  const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n-    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n-    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+  const telefono = \"51929261925\"; // ‚úÖ sin el \"+\" para wa.me\r\n \r\n+  let url = \"\";\r\n+\r\n+  // Detectar si es m√≥vil\r\n+  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n+    // En m√≥vil abre directamente la app de WhatsApp\r\n+    url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+  } else {\r\n+    // En PC abre WhatsApp Web\r\n+    url = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+  }\r\n+\r\n   // Abrir WhatsApp\r\n   window.open(url, \"_blank\");\r\n \r\n   // Vaciar carrito\r\n@@ -365,8 +373,9 @@\n     cerrarSidebar();\r\n   }\r\n }\r\n \r\n+\r\n // =========================\r\n // LISTENERS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n"
                },
                {
                    "date": 1759007830024,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -346,30 +346,27 @@\n   const telefono = \"51929261925\"; // ‚úÖ sin el \"+\" para wa.me\r\n \r\n   let url = \"\";\r\n \r\n-  // Detectar si es m√≥vil\r\n   if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // En m√≥vil abre directamente la app de WhatsApp\r\n+    // ‚úÖ En m√≥vil redirige a la app de WhatsApp\r\n     url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n   } else {\r\n-    // En PC abre WhatsApp Web\r\n+    // ‚úÖ En PC abre WhatsApp Web\r\n     url = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n   }\r\n \r\n-  // Abrir WhatsApp\r\n-  window.open(url, \"_blank\");\r\n+  // üëâ Usar location.href para que funcione en m√≥vil\r\n+  window.location.href = url;\r\n \r\n   // Vaciar carrito\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n \r\n-  // Mostrar toast\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n \r\n-  // ‚úÖ Cerrar sidebar si estaba abierto\r\n   if (sidebar?.classList.contains(\"activo\")) {\r\n     cerrarSidebar();\r\n   }\r\n }\r\n"
                },
                {
                    "date": 1759007951044,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -342,21 +342,26 @@\n     .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n     .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\"; // ‚úÖ sin el \"+\" para wa.me\r\n+  const telefono = \"51929261925\"; // sin el \"+\"\r\n \r\n   let url = \"\";\r\n \r\n   if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ En m√≥vil redirige a la app de WhatsApp\r\n-    url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+    // ‚úÖ En m√≥vil intentamos abrir directo la app de WhatsApp\r\n+    url = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+\r\n+    // ‚è≥ Fallback: si no abre en 1 segundo, redirige a wa.me\r\n+    setTimeout(() => {\r\n+      window.location.href = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+    }, 1000);\r\n   } else {\r\n     // ‚úÖ En PC abre WhatsApp Web\r\n     url = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n   }\r\n \r\n-  // üëâ Usar location.href para que funcione en m√≥vil\r\n+  // üëâ Redirigir\r\n   window.location.href = url;\r\n \r\n   // Vaciar carrito\r\n   carrito = [];\r\n"
                },
                {
                    "date": 1759008091345,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -344,26 +344,26 @@\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"51929261925\"; // sin el \"+\"\r\n \r\n-  let url = \"\";\r\n-\r\n   if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ En m√≥vil intentamos abrir directo la app de WhatsApp\r\n-    url = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    // ‚úÖ En m√≥vil: intentar abrir directo la app\r\n+    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n \r\n-    // ‚è≥ Fallback: si no abre en 1 segundo, redirige a wa.me\r\n+    // Intentar abrir la app\r\n+    window.location.href = appUrl;\r\n+\r\n+    // Si no funciona en 1s, abrir wa.me\r\n     setTimeout(() => {\r\n-      window.location.href = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+      window.location.href = fallbackUrl;\r\n     }, 1000);\r\n   } else {\r\n-    // ‚úÖ En PC abre WhatsApp Web\r\n-    url = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    // ‚úÖ En PC: abrir WhatsApp Web\r\n+    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    window.open(webUrl, \"_blank\");\r\n   }\r\n \r\n-  // üëâ Redirigir\r\n-  window.location.href = url;\r\n-\r\n   // Vaciar carrito\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n"
                },
                {
                    "date": 1759008413408,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -342,28 +342,17 @@\n     .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n     .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\"; // sin el \"+\"\r\n+  const telefono = \"51929261925\"; // ‚úÖ sin el \"+\"\r\n \r\n-  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ En m√≥vil: intentar abrir directo la app\r\n-    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+  const url = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)\r\n+    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n+    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n-    // Intentar abrir la app\r\n-    window.location.href = appUrl;\r\n+  // üëâ Usar location.href para mayor compatibilidad en m√≥vil\r\n+  window.location.href = url;\r\n \r\n-    // Si no funciona en 1s, abrir wa.me\r\n-    setTimeout(() => {\r\n-      window.location.href = fallbackUrl;\r\n-    }, 1000);\r\n-  } else {\r\n-    // ‚úÖ En PC: abrir WhatsApp Web\r\n-    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    window.open(webUrl, \"_blank\");\r\n-  }\r\n-\r\n   // Vaciar carrito\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n"
                },
                {
                    "date": 1759008491981,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -344,15 +344,26 @@\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"51929261925\"; // ‚úÖ sin el \"+\"\r\n \r\n-  const url = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)\r\n-    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n-    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+  let url = \"\";\r\n \r\n-  // üëâ Usar location.href para mayor compatibilidad en m√≥vil\r\n-  window.location.href = url;\r\n+  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n+    // ‚úÖ En m√≥vil: abrir directamente la app\r\n+    url = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n+    // üëâ Fallback: si no abre, redirige a wa.me en 1s\r\n+    setTimeout(() => {\r\n+      window.location.href = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+    }, 1000);\r\n+\r\n+    window.location.href = url;\r\n+  } else {\r\n+    // ‚úÖ En PC: abrir WhatsApp Web\r\n+    url = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    window.open(url, \"_blank\");\r\n+  }\r\n+\r\n   // Vaciar carrito\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n"
                },
                {
                    "date": 1759008668186,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -342,34 +342,44 @@\n     .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n     .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\"; // ‚úÖ sin el \"+\"\r\n+  const telefono = \"51929261925\"; // sin el \"+\"\r\n \r\n-  let url = \"\";\r\n-\r\n   if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ En m√≥vil: abrir directamente la app\r\n-    url = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    // ‚úÖ Intentar abrir directo la app\r\n+    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n \r\n-    // üëâ Fallback: si no abre, redirige a wa.me en 1s\r\n+    // Intento directo\r\n+    window.location.href = appUrl;\r\n+\r\n+    // ‚è≥ Fallback en 1200ms\r\n     setTimeout(() => {\r\n-      window.location.href = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-    }, 1000);\r\n+      // Redirige al fallback solo si sigue en la misma p√°gina\r\n+      if (document.visibilityState === \"visible\") {\r\n+        window.location.href = fallbackUrl;\r\n+      }\r\n+      // Aqu√≠ reci√©n vaciamos el carrito\r\n+      vaciarCarritoDespuesEnvio();\r\n+    }, 1200);\r\n \r\n-    window.location.href = url;\r\n   } else {\r\n-    // ‚úÖ En PC: abrir WhatsApp Web\r\n-    url = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    window.open(url, \"_blank\");\r\n+    // ‚úÖ En PC: usar WhatsApp Web\r\n+    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    window.open(webUrl, \"_blank\");\r\n+\r\n+    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n+    vaciarCarritoDespuesEnvio();\r\n   }\r\n+}\r\n \r\n-  // Vaciar carrito\r\n+// Funci√≥n auxiliar\r\n+function vaciarCarritoDespuesEnvio() {\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n-\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n \r\n   if (sidebar?.classList.contains(\"activo\")) {\r\n     cerrarSidebar();\r\n"
                },
                {
                    "date": 1759010963143,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -217,24 +217,33 @@\n   const producto = carrito[index];\r\n   const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n \r\n   if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    // ‚ùå Eliminar solo con la X\r\n     carrito.splice(index, 1);\r\n+\r\n   } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    // ‚ûï Aumentar cantidad, respetando stock\r\n     if (producto.cantidad + 1 > catalogoProd.stock) {\r\n       mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n       return;\r\n     }\r\n     producto.cantidad++;\r\n+\r\n   } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    producto.cantidad--;\r\n-    if (producto.cantidad <= 0) carrito.splice(index, 1);\r\n+    // ‚ûñ No permitir menos de 1\r\n+    if (producto.cantidad > 1) {\r\n+      producto.cantidad--;\r\n+    } else {\r\n+      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+    }\r\n   }\r\n \r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n+\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n"
                },
                {
                    "date": 1759018080795,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,24 +50,41 @@\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n+\r\n+    // ‚úÖ Mostrar precios correctamente\r\n+    let precioHTML = \"\";\r\n+    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n+          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    } else {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    }\r\n+\r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      <div class=\"precio\">\r\n-        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n-      </div>\r\n+      ${precioHTML}\r\n       <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n       <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n+\r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n+\r\n // =========================\r\n // CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n"
                },
                {
                    "date": 1759018169587,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,51 +40,9 @@\n     renderProductos(catalogo);\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n-// =========================\r\n-// RENDER PRODUCTOS\r\n-// =========================\r\n-const contenedorProductos = document.getElementById(\"productos-container\");\r\n-function renderProductos(lista) {\r\n-  if (!contenedorProductos) return;\r\n-  contenedorProductos.innerHTML = \"\";\r\n-  lista.forEach(producto => {\r\n-    const div = document.createElement(\"div\");\r\n-    div.classList.add(\"producto\");\r\n \r\n-    // ‚úÖ Mostrar precios correctamente\r\n-    let precioHTML = \"\";\r\n-    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n-          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    } else {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    }\r\n-\r\n-    div.innerHTML = `\r\n-      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n-      <h4>${producto.nombre}</h4>\r\n-      <p>${producto.descripcion || \"\"}</p>\r\n-      ${precioHTML}\r\n-      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n-      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n-      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n-    `;\r\n-\r\n-    contenedorProductos.appendChild(div);\r\n-  });\r\n-}\r\n-\r\n-\r\n // =========================\r\n // CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n"
                },
                {
                    "date": 1759018238977,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,9 +40,51 @@\n     renderProductos(catalogo);\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n+// =========================\r\n+// RENDER PRODUCTOS\r\n+// =========================\r\n+const contenedorProductos = document.getElementById(\"productos-container\");\r\n+function renderProductos(lista) {\r\n+  if (!contenedorProductos) return;\r\n+  contenedorProductos.innerHTML = \"\";\r\n+  lista.forEach(producto => {\r\n+    const div = document.createElement(\"div\");\r\n+    div.classList.add(\"producto\");\r\n \r\n+    // ‚úÖ Mostrar precios correctamente\r\n+    let precioHTML = \"\";\r\n+    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n+          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    } else {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    }\r\n+\r\n+    div.innerHTML = `\r\n+      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n+      <h4>${producto.nombre}</h4>\r\n+      <p>${producto.descripcion || \"\"}</p>\r\n+      ${precioHTML}\r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n+      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n+    `;\r\n+\r\n+    contenedorProductos.appendChild(div);\r\n+  });\r\n+}\r\n+\r\n+\r\n // =========================\r\n // CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n"
                },
                {
                    "date": 1759188541454,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -337,11 +337,9 @@\n   if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n \r\n-// =========================\r\n-// TOAST\r\n-// =========================\r\n+let toastTimeout; // Declaraci√≥n global\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n@@ -350,11 +348,12 @@\n   }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n   clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000); // 1 segundo\r\n }\r\n \r\n+\r\n // =========================\r\n // COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n"
                },
                {
                    "date": 1759188802353,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -337,20 +337,27 @@\n   if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n \r\n-let toastTimeout; // Declaraci√≥n global\r\n+// =========================\r\n+// TOAST\r\n+// =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n     toast.id = \"mensajeCarrito\";\r\n     document.body.appendChild(toast);\r\n   }\r\n+  \r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n+  \r\n+  // Limpiar cualquier timeout anterior\r\n   clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000); // 1 segundo\r\n+  \r\n+  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000);\r\n }\r\n \r\n \r\n // =========================\r\n"
                },
                {
                    "date": 1759188859051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -355,9 +355,9 @@\n   // Limpiar cualquier timeout anterior\r\n   clearTimeout(toastTimeout);\r\n   \r\n   // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n }\r\n \r\n \r\n // =========================\r\n"
                },
                {
                    "date": 1760126225141,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -260,8 +260,22 @@\n });\r\n \r\n \r\n // =========================\r\n+// ESCUCHAR CLIC EN ‚ÄúAGREGAR AL CARRITO‚Äù (CAT√ÅLOGO)\r\n+// =========================\r\n+document.addEventListener(\"click\", e => {\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n+    const idProducto = e.target.dataset.id;\r\n+    if (idProducto) {\r\n+      agregarAlCarrito(idProducto);\r\n+    } else {\r\n+      console.warn(\"‚ö†Ô∏è El bot√≥n no tiene data-id asignado\");\r\n+    }\r\n+  }\r\n+});\r\n+\r\n+// =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n   try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n"
                },
                {
                    "date": 1760126457372,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -258,24 +258,9 @@\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n-\r\n // =========================\r\n-// ESCUCHAR CLIC EN ‚ÄúAGREGAR AL CARRITO‚Äù (CAT√ÅLOGO)\r\n-// =========================\r\n-document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n-    const idProducto = e.target.dataset.id;\r\n-    if (idProducto) {\r\n-      agregarAlCarrito(idProducto);\r\n-    } else {\r\n-      console.warn(\"‚ö†Ô∏è El bot√≥n no tiene data-id asignado\");\r\n-    }\r\n-  }\r\n-});\r\n-\r\n-// =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n   try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n"
                },
                {
                    "date": 1760126578738,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -37,11 +37,20 @@\n   .then(res => res.json())\r\n   .then(data => {\r\n     catalogo = [...data.productos, ...(data.ofertas || [])];\r\n     renderProductos(catalogo);\r\n+\r\n+    // üîπ Activar botones \"Agregar al carrito\" DESPU√âS de renderizar\r\n+    document.querySelectorAll(\".btn-agregar-carrito\").forEach(boton => {\r\n+      boton.addEventListener(\"click\", e => {\r\n+        const id = e.target.dataset.id;\r\n+        agregarAlCarrito(id);\r\n+      });\r\n+    });\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n+\r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n"
                },
                {
                    "date": 1760126813779,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,22 +35,42 @@\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n+    // üîπ Mezclar productos normales y ofertas\r\n     catalogo = [...data.productos, ...(data.ofertas || [])];\r\n+\r\n+    // üîπ Renderizar cat√°logo\r\n     renderProductos(catalogo);\r\n \r\n     // üîπ Activar botones \"Agregar al carrito\" DESPU√âS de renderizar\r\n     document.querySelectorAll(\".btn-agregar-carrito\").forEach(boton => {\r\n       boton.addEventListener(\"click\", e => {\r\n         const id = e.target.dataset.id;\r\n+\r\n+        // Validar producto\r\n+        const producto = catalogo.find(p => p.id == id);\r\n+        if (!producto) {\r\n+          console.warn(\"‚ö†Ô∏è Producto no encontrado o sin ID v√°lido\");\r\n+          return;\r\n+        }\r\n+\r\n         agregarAlCarrito(id);\r\n+\r\n+        // üí¨ Efecto visual temporal (opcional)\r\n+        boton.textContent = \"‚úÖ Agregado\";\r\n+        boton.disabled = true;\r\n+        setTimeout(() => {\r\n+          boton.textContent = \"Agregar al carrito\";\r\n+          boton.disabled = false;\r\n+        }, 1500);\r\n       });\r\n     });\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n \r\n+\r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n"
                },
                {
                    "date": 1760127082548,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -55,9 +55,9 @@\n         }\r\n \r\n         agregarAlCarrito(id);\r\n \r\n-        // üí¨ Efecto visual temporal (opcional)\r\n+        // üí¨ Efecto visual temporal\r\n         boton.textContent = \"‚úÖ Agregado\";\r\n         boton.disabled = true;\r\n         setTimeout(() => {\r\n           boton.textContent = \"Agregar al carrito\";\r\n@@ -67,10 +67,8 @@\n     });\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n-\r\n-\r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n@@ -111,9 +109,8 @@\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n-\r\n // =========================\r\n // CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n@@ -210,40 +207,34 @@\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n-        <th>Descuento aplicado</th>\r\n+        <th>Descuento</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => {\r\n-        let descuentoAplicado = false;\r\n-        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n-\r\n-        return `\r\n-          <tr>\r\n-            <td>\r\n-              <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-                <div>\r\n-                  <strong>${producto.nombre}</strong>\r\n-                  <p>${producto.descripcion || \"\"}</p>\r\n-                </div>\r\n+      ${carrito.map((producto, index) => `\r\n+        <tr>\r\n+          <td>\r\n+            <div class=\"carrito-item-info\">\r\n+              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+              <div>\r\n+                <strong>${producto.nombre}</strong>\r\n+                <p>${producto.descripcion || \"\"}</p>\r\n               </div>\r\n-            </td>\r\n-            <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-            </td>\r\n-            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-          </tr>\r\n-        `;\r\n-      }).join(\"\")}\r\n+            </div>\r\n+          </td>\r\n+          <td>\r\n+            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+            <span>${producto.cantidad}</span>\r\n+            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+          </td>\r\n+          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+          <td>${producto.precio_con_descuento ? \"S√≠\" : \"No\"}</td>\r\n+          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+        </tr>\r\n+      `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n   carritoItems.appendChild(tabla);\r\n \r\n@@ -253,9 +244,9 @@\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n+// BOTONES DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n@@ -263,21 +254,16 @@\n   const producto = carrito[index];\r\n   const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n \r\n   if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    // ‚ùå Eliminar solo con la X\r\n     carrito.splice(index, 1);\r\n-\r\n   } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    // ‚ûï Aumentar cantidad, respetando stock\r\n     if (producto.cantidad + 1 > catalogoProd.stock) {\r\n       mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n       return;\r\n     }\r\n     producto.cantidad++;\r\n-\r\n   } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    // ‚ûñ No permitir menos de 1\r\n     if (producto.cantidad > 1) {\r\n       producto.cantidad--;\r\n     } else {\r\n       mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n@@ -296,77 +282,26 @@\n   catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n }\r\n \r\n // =========================\r\n-// TOTALES Y BARRA DE ENV√çO\r\n+// TOTALES\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 99;\r\n-function actualizarBarra(totalCarrito) {\r\n-  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n-\r\n-  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n-  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n-\r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n-\r\n-  if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n-      mensajeEl.classList.add(\"gratis\");\r\n-    } else if (totalCarrito > 0) {\r\n-      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    }\r\n-  }\r\n-\r\n-  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n-}\r\n-\r\n function actualizarTotales() {\r\n   let subtotal = 0;\r\n-  let descuentoVolumenTotal = 0;\r\n-  let descuentoDirectoTotal = 0;\r\n+  carrito.forEach(p => subtotal += calcularTotalProducto(p));\r\n \r\n-  carrito.forEach(p => {\r\n-    const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = calcularTotalProducto(p);\r\n-    subtotal += precioNormal;\r\n-\r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-  });\r\n-\r\n-  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n-  const totalConDescuentos = subtotal - ahorroTotal;\r\n-\r\n   if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n-\r\n-  actualizarBarra(totalConDescuentos);\r\n+  if (totalEl) totalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n }\r\n \r\n // =========================\r\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-\r\n-  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n-\r\n-  // contador dentro del carrito (en el h2)\r\n-  const contadorInline = document.getElementById(\"contador-inline\");\r\n-  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n-\r\n // =========================\r\n // TOAST\r\n // =========================\r\n function mostrarToast(mensaje) {\r\n@@ -375,20 +310,14 @@\n     toast = document.createElement(\"div\");\r\n     toast.id = \"mensajeCarrito\";\r\n     document.body.appendChild(toast);\r\n   }\r\n-  \r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-  \r\n-  // Limpiar cualquier timeout anterior\r\n   clearTimeout(toastTimeout);\r\n-  \r\n-  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000);\r\n }\r\n \r\n-\r\n // =========================\r\n // COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n@@ -402,66 +331,29 @@\n     .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n     .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\"; // sin el \"+\"\r\n+  const telefono = \"51929261925\";\r\n+  window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, \"_blank\");\r\n \r\n-  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ Intentar abrir directo la app\r\n-    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-\r\n-    // Intento directo\r\n-    window.location.href = appUrl;\r\n-\r\n-    // ‚è≥ Fallback en 1200ms\r\n-    setTimeout(() => {\r\n-      // Redirige al fallback solo si sigue en la misma p√°gina\r\n-      if (document.visibilityState === \"visible\") {\r\n-        window.location.href = fallbackUrl;\r\n-      }\r\n-      // Aqu√≠ reci√©n vaciamos el carrito\r\n-      vaciarCarritoDespuesEnvio();\r\n-    }, 1200);\r\n-\r\n-  } else {\r\n-    // ‚úÖ En PC: usar WhatsApp Web\r\n-    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    window.open(webUrl, \"_blank\");\r\n-\r\n-    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n-    vaciarCarritoDespuesEnvio();\r\n-  }\r\n-}\r\n-\r\n-// Funci√≥n auxiliar\r\n-function vaciarCarritoDespuesEnvio() {\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n-  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n-\r\n-  if (sidebar?.classList.contains(\"activo\")) {\r\n-    cerrarSidebar();\r\n-  }\r\n+  mostrarToast(\"Pedido enviado por WhatsApp üßæ\");\r\n }\r\n \r\n-\r\n // =========================\r\n // LISTENERS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n-});\r\n+document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n-document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n"
                },
                {
                    "date": 1760129663918,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,40 +35,60 @@\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n-    // üîπ Mezclar productos normales y ofertas\r\n-    catalogo = [...data.productos, ...(data.ofertas || [])];\r\n+    // üîπ Mezclar productos normales y ofertas (si existen)\r\n+    catalogo = [...(data.productos || []), ...(data.ofertas || [])];\r\n+    console.log(\"üì¶ Cat√°logo cargado:\", catalogo.length, \"productos\");\r\n \r\n-    // üîπ Renderizar cat√°logo\r\n+    // üîπ Renderizar cat√°logo en pantalla\r\n     renderProductos(catalogo);\r\n \r\n     // üîπ Activar botones \"Agregar al carrito\" DESPU√âS de renderizar\r\n-    document.querySelectorAll(\".btn-agregar-carrito\").forEach(boton => {\r\n+    const botones = document.querySelectorAll(\".btn-agregar-carrito\");\r\n+    console.log(\"üß© Botones detectados:\", botones.length);\r\n+\r\n+    if (botones.length === 0) {\r\n+      console.warn(\"‚ö†Ô∏è No se encontraron botones .btn-agregar-carrito en el DOM\");\r\n+    }\r\n+\r\n+    botones.forEach(boton => {\r\n       boton.addEventListener(\"click\", e => {\r\n         const id = e.target.dataset.id;\r\n+        console.log(\"üÜî ID clickeado:\", id);\r\n \r\n-        // Validar producto\r\n+        if (!id) {\r\n+          console.warn(\"‚ö†Ô∏è El bot√≥n no tiene data-id asignado:\", e.target);\r\n+          return;\r\n+        }\r\n+\r\n         const producto = catalogo.find(p => p.id == id);\r\n         if (!producto) {\r\n-          console.warn(\"‚ö†Ô∏è Producto no encontrado o sin ID v√°lido\");\r\n+          console.warn(\"‚ö†Ô∏è Producto con id\", id, \"no encontrado en cat√°logo\");\r\n           return;\r\n         }\r\n \r\n-        agregarAlCarrito(id);\r\n+        try {\r\n+          agregarAlCarrito(id);\r\n+          console.log(\"‚úÖ Producto agregado correctamente:\", producto.nombre);\r\n \r\n-        // üí¨ Efecto visual temporal\r\n-        boton.textContent = \"‚úÖ Agregado\";\r\n-        boton.disabled = true;\r\n-        setTimeout(() => {\r\n-          boton.textContent = \"Agregar al carrito\";\r\n-          boton.disabled = false;\r\n-        }, 1500);\r\n+          // üí¨ Efecto visual temporal\r\n+          boton.textContent = \"‚úÖ Agregado\";\r\n+          boton.disabled = true;\r\n+          setTimeout(() => {\r\n+            boton.textContent = \"Agregar al carrito\";\r\n+            boton.disabled = false;\r\n+          }, 1500);\r\n+\r\n+        } catch (error) {\r\n+          console.error(\"‚ùå Error al agregar al carrito:\", error);\r\n+        }\r\n       });\r\n     });\r\n   })\r\n-  .catch(err => console.error(\"Error cargando productos:\", err));\r\n+  .catch(err => console.error(\"‚ùå Error cargando productos:\", err));\r\n \r\n+\r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n"
                },
                {
                    "date": 1760129982763,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,65 +30,72 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// CARGAR JSON DE PRODUCTOS\r\n+// CARGAR JSON DE PRODUCTOS (VERSI√ìN MEJORADA)\r\n // =========================\r\n-fetch(\"productos.json\")\r\n-  .then(res => res.json())\r\n-  .then(data => {\r\n-    // üîπ Mezclar productos normales y ofertas (si existen)\r\n-    catalogo = [...(data.productos || []), ...(data.ofertas || [])];\r\n-    console.log(\"üì¶ Cat√°logo cargado:\", catalogo.length, \"productos\");\r\n+document.addEventListener(\"DOMContentLoaded\", () => {\r\n+  console.log(\"üöÄ DOM listo, iniciando carga de productos...\");\r\n \r\n-    // üîπ Renderizar cat√°logo en pantalla\r\n-    renderProductos(catalogo);\r\n+  fetch(\"productos.json\")\r\n+    .then(res => res.json())\r\n+    .then(data => {\r\n+      // üîπ Mezclar productos normales y ofertas (si existen)\r\n+      catalogo = [...(data.productos || []), ...(data.ofertas || [])];\r\n+      console.log(\"üì¶ Cat√°logo cargado:\", catalogo.length, \"productos\");\r\n \r\n-    // üîπ Activar botones \"Agregar al carrito\" DESPU√âS de renderizar\r\n-    const botones = document.querySelectorAll(\".btn-agregar-carrito\");\r\n-    console.log(\"üß© Botones detectados:\", botones.length);\r\n+      // üîπ Renderizar cat√°logo en pantalla\r\n+      renderProductos(catalogo);\r\n \r\n-    if (botones.length === 0) {\r\n-      console.warn(\"‚ö†Ô∏è No se encontraron botones .btn-agregar-carrito en el DOM\");\r\n-    }\r\n+      // üîπ Activar botones \"Agregar al carrito\" DESPU√âS del render\r\n+      setTimeout(() => {\r\n+        const botones = document.querySelectorAll(\".btn-agregar-carrito\");\r\n+        console.log(\"üß© Botones detectados:\", botones.length);\r\n \r\n-    botones.forEach(boton => {\r\n-      boton.addEventListener(\"click\", e => {\r\n-        const id = e.target.dataset.id;\r\n-        console.log(\"üÜî ID clickeado:\", id);\r\n-\r\n-        if (!id) {\r\n-          console.warn(\"‚ö†Ô∏è El bot√≥n no tiene data-id asignado:\", e.target);\r\n+        if (botones.length === 0) {\r\n+          console.warn(\"‚ö†Ô∏è No se encontraron botones .btn-agregar-carrito en el DOM\");\r\n           return;\r\n         }\r\n \r\n-        const producto = catalogo.find(p => p.id == id);\r\n-        if (!producto) {\r\n-          console.warn(\"‚ö†Ô∏è Producto con id\", id, \"no encontrado en cat√°logo\");\r\n-          return;\r\n-        }\r\n+        botones.forEach(boton => {\r\n+          boton.addEventListener(\"click\", e => {\r\n+            const id = e.target.dataset.id;\r\n+            console.log(\"üÜî ID clickeado:\", id);\r\n \r\n-        try {\r\n-          agregarAlCarrito(id);\r\n-          console.log(\"‚úÖ Producto agregado correctamente:\", producto.nombre);\r\n+            if (!id) {\r\n+              console.warn(\"‚ö†Ô∏è El bot√≥n no tiene data-id asignado:\", e.target);\r\n+              return;\r\n+            }\r\n \r\n-          // üí¨ Efecto visual temporal\r\n-          boton.textContent = \"‚úÖ Agregado\";\r\n-          boton.disabled = true;\r\n-          setTimeout(() => {\r\n-            boton.textContent = \"Agregar al carrito\";\r\n-            boton.disabled = false;\r\n-          }, 1500);\r\n+            const producto = catalogo.find(p => p.id == id);\r\n+            if (!producto) {\r\n+              console.warn(\"‚ö†Ô∏è Producto con id\", id, \"no encontrado en cat√°logo\");\r\n+              return;\r\n+            }\r\n \r\n-        } catch (error) {\r\n-          console.error(\"‚ùå Error al agregar al carrito:\", error);\r\n-        }\r\n-      });\r\n-    });\r\n-  })\r\n-  .catch(err => console.error(\"‚ùå Error cargando productos:\", err));\r\n+            try {\r\n+              agregarAlCarrito(id);\r\n+              console.log(\"‚úÖ Producto agregado correctamente:\", producto.nombre);\r\n \r\n+              // üí¨ Efecto visual temporal\r\n+              boton.textContent = \"‚úÖ Agregado\";\r\n+              boton.disabled = true;\r\n+              setTimeout(() => {\r\n+                boton.textContent = \"Agregar al carrito\";\r\n+                boton.disabled = false;\r\n+              }, 1500);\r\n \r\n+            } catch (error) {\r\n+              console.error(\"‚ùå Error al agregar al carrito:\", error);\r\n+            }\r\n+          });\r\n+        });\r\n+      }, 300); // üïí Espera un peque√±o margen para asegurar renderizado completo\r\n+    })\r\n+    .catch(err => console.error(\"‚ùå Error cargando productos:\", err));\r\n+});\r\n+\r\n+\r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n"
                },
                {
                    "date": 1760130284425,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,178 +30,120 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// CARGAR JSON DE PRODUCTOS (VERSI√ìN MEJORADA)\r\n+// CARGAR JSON DE PRODUCTOS\r\n // =========================\r\n document.addEventListener(\"DOMContentLoaded\", () => {\r\n   console.log(\"üöÄ DOM listo, iniciando carga de productos...\");\r\n \r\n   fetch(\"productos.json\")\r\n     .then(res => res.json())\r\n     .then(data => {\r\n-      // üîπ Mezclar productos normales y ofertas (si existen)\r\n       catalogo = [...(data.productos || []), ...(data.ofertas || [])];\r\n       console.log(\"üì¶ Cat√°logo cargado:\", catalogo.length, \"productos\");\r\n \r\n-      // üîπ Renderizar cat√°logo en pantalla\r\n       renderProductos(catalogo);\r\n+      activarBotonesCarrito();\r\n+    })\r\n+    .catch(err => console.error(\"‚ùå Error cargando productos:\", err));\r\n+});\r\n \r\n-      // üîπ Activar botones \"Agregar al carrito\" DESPU√âS del render\r\n-      setTimeout(() => {\r\n-        const botones = document.querySelectorAll(\".btn-agregar-carrito\");\r\n-        console.log(\"üß© Botones detectados:\", botones.length);\r\n+// =========================\r\n+// ACTIVAR BOTONES DE CARRITO\r\n+// =========================\r\n+function activarBotonesCarrito() {\r\n+  const botones = document.querySelectorAll(\".btn-agregar-carrito\");\r\n+  console.log(\"üß© Botones detectados:\", botones.length);\r\n \r\n-        if (botones.length === 0) {\r\n-          console.warn(\"‚ö†Ô∏è No se encontraron botones .btn-agregar-carrito en el DOM\");\r\n-          return;\r\n-        }\r\n+  botones.forEach(boton => {\r\n+    boton.addEventListener(\"click\", e => {\r\n+      const id = e.target.dataset.id;\r\n+      const producto = catalogo.find(p => p.id == id);\r\n+      if (!producto) return;\r\n \r\n-        botones.forEach(boton => {\r\n-          boton.addEventListener(\"click\", e => {\r\n-            const id = e.target.dataset.id;\r\n-            console.log(\"üÜî ID clickeado:\", id);\r\n+      agregarAlCarrito(id);\r\n \r\n-            if (!id) {\r\n-              console.warn(\"‚ö†Ô∏è El bot√≥n no tiene data-id asignado:\", e.target);\r\n-              return;\r\n-            }\r\n+      boton.textContent = \"‚úÖ Agregado\";\r\n+      boton.disabled = true;\r\n+      setTimeout(() => {\r\n+        boton.textContent = \"Agregar al carrito\";\r\n+        boton.disabled = false;\r\n+      }, 1200);\r\n+    });\r\n+  });\r\n+}\r\n \r\n-            const producto = catalogo.find(p => p.id == id);\r\n-            if (!producto) {\r\n-              console.warn(\"‚ö†Ô∏è Producto con id\", id, \"no encontrado en cat√°logo\");\r\n-              return;\r\n-            }\r\n-\r\n-            try {\r\n-              agregarAlCarrito(id);\r\n-              console.log(\"‚úÖ Producto agregado correctamente:\", producto.nombre);\r\n-\r\n-              // üí¨ Efecto visual temporal\r\n-              boton.textContent = \"‚úÖ Agregado\";\r\n-              boton.disabled = true;\r\n-              setTimeout(() => {\r\n-                boton.textContent = \"Agregar al carrito\";\r\n-                boton.disabled = false;\r\n-              }, 1500);\r\n-\r\n-            } catch (error) {\r\n-              console.error(\"‚ùå Error al agregar al carrito:\", error);\r\n-            }\r\n-          });\r\n-        });\r\n-      }, 300); // üïí Espera un peque√±o margen para asegurar renderizado completo\r\n-    })\r\n-    .catch(err => console.error(\"‚ùå Error cargando productos:\", err));\r\n-});\r\n-\r\n-\r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n+\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n \r\n-    // ‚úÖ Mostrar precios correctamente\r\n     let precioHTML = \"\";\r\n-    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n+    if (producto.precio_con_descuento) {\r\n       precioHTML = `\r\n         <div class=\"precio\">\r\n           <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n           <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n         </div>\r\n       `;\r\n     } else {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n+      precioHTML = `<div class=\"precio\">S/ ${producto.precio.toFixed(2)}</div>`;\r\n     }\r\n \r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n       ${precioHTML}\r\n-      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n-      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n \r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// CALCULAR TOTAL POR PRODUCTO\r\n+// CALCULAR TOTAL PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n-  let total = 0;\r\n-  const cantidad = producto.cantidad;\r\n-\r\n-  if (producto.descuentoVolumen) {\r\n-    const promo = producto.descuentoVolumen;\r\n-    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n-    const resto = cantidad % promo.aplicaA;\r\n-    const totalPromo = vecesPromo * (\r\n-      (promo.compra * producto.precio) +\r\n-      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n-    );\r\n-    const totalResto = resto * producto.precio;\r\n-    total = totalPromo + totalResto;\r\n-  } else {\r\n-    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n-  }\r\n-\r\n-  return total;\r\n+  const precio = producto.precio_con_descuento || producto.precio;\r\n+  return precio * producto.cantidad;\r\n }\r\n \r\n // =========================\r\n // ABRIR / CERRAR SIDEBAR\r\n // =========================\r\n function abrirSidebar() {\r\n-  if (!sidebar) return;\r\n-  sidebar.classList.add(\"activo\");\r\n-  overlay.classList.add(\"show\");\r\n+  sidebar?.classList.add(\"activo\");\r\n+  overlay?.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n-  history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n function cerrarSidebar() {\r\n-  if (!sidebar) return;\r\n-  sidebar.classList.remove(\"activo\");\r\n-  overlay.classList.remove(\"show\");\r\n+  sidebar?.classList.remove(\"activo\");\r\n+  overlay?.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n-  history.replaceState({}, \"\");\r\n }\r\n-overlay?.addEventListener(\"click\", cerrarSidebar);\r\n abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n-window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n-window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n+overlay?.addEventListener(\"click\", cerrarSidebar);\r\n \r\n // =========================\r\n-// AGREGAR AL CARRITO CON STOCK\r\n+// AGREGAR AL CARRITO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n-  const cantidadActual = existe ? existe.cantidad : 0;\r\n-\r\n-  const stockDisponible = producto.stock - cantidadActual;\r\n-  if (stockDisponible <= 0) {\r\n-    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n-    return;\r\n-  }\r\n-\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -220,53 +162,38 @@\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n   if (carrito.length === 0) {\r\n-    carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n+    carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o üõçÔ∏è</p>`;\r\n     actualizarTotales();\r\n     actualizarContador();\r\n     return;\r\n   }\r\n \r\n-  const tabla = document.createElement(\"table\");\r\n-  tabla.classList.add(\"tabla-carrito\");\r\n-  tabla.innerHTML = `\r\n-    <thead>\r\n-      <tr>\r\n-        <th>Producto</th>\r\n-        <th>Cantidad</th>\r\n-        <th>Precio</th>\r\n-        <th>Descuento</th>\r\n-        <th>Acci√≥n</th>\r\n-      </tr>\r\n-    </thead>\r\n-    <tbody>\r\n-      ${carrito.map((producto, index) => `\r\n-        <tr>\r\n-          <td>\r\n-            <div class=\"carrito-item-info\">\r\n-              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-              <div>\r\n-                <strong>${producto.nombre}</strong>\r\n-                <p>${producto.descripcion || \"\"}</p>\r\n-              </div>\r\n-            </div>\r\n-          </td>\r\n-          <td>\r\n-            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-            <span>${producto.cantidad}</span>\r\n-            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-          </td>\r\n-          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-          <td>${producto.precio_con_descuento ? \"S√≠\" : \"No\"}</td>\r\n-          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-        </tr>\r\n-      `).join(\"\")}\r\n-    </tbody>\r\n-  `;\r\n-  carritoItems.appendChild(tabla);\r\n+  carrito.forEach((producto, index) => {\r\n+    const item = document.createElement(\"div\");\r\n+    item.classList.add(\"carrito-item\");\r\n+    item.innerHTML = `\r\n+      <div class=\"carrito-item-info\">\r\n+        <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+        <div>\r\n+          <strong>${producto.nombre}</strong>\r\n+          <p>${producto.descripcion || \"\"}</p>\r\n+        </div>\r\n+      </div>\r\n+      <div class=\"carrito-item-controles\">\r\n+        <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+        <span>${producto.cantidad}</span>\r\n+        <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+      </div>\r\n+      <div class=\"carrito-item-precio\">\r\n+        S/ ${(calcularTotalProducto(producto)).toFixed(2)}\r\n+      </div>\r\n+      <button class=\"carrito-item-close\" data-index=\"${index}\">X</button>\r\n+    `;\r\n+    carritoItems.appendChild(item);\r\n+  });\r\n \r\n-  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n@@ -277,46 +204,32 @@\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n-  const producto = carrito[index];\r\n-  const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n-\r\n   if (e.target.classList.contains(\"carrito-item-close\")) {\r\n     carrito.splice(index, 1);\r\n   } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n-      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n-      return;\r\n-    }\r\n-    producto.cantidad++;\r\n+    carrito[index].cantidad++;\r\n   } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    if (producto.cantidad > 1) {\r\n-      producto.cantidad--;\r\n-    } else {\r\n-      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n-    }\r\n+    if (carrito[index].cantidad > 1) carrito[index].cantidad--;\r\n   }\r\n \r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n // =========================\r\n-// GUARDAR EN LOCALSTORAGE\r\n+// LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n-  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n-  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n+  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n }\r\n \r\n // =========================\r\n // TOTALES\r\n // =========================\r\n function actualizarTotales() {\r\n-  let subtotal = 0;\r\n-  carrito.forEach(p => subtotal += calcularTotalProducto(p));\r\n-\r\n+  let subtotal = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n   if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   if (totalEl) totalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n }\r\n \r\n@@ -340,24 +253,22 @@\n   }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n   clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1200);\r\n }\r\n \r\n // =========================\r\n-// COMPRAR AHORA POR WHATSAPP\r\n+// COMPRAR POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n   if (carrito.length === 0) {\r\n     mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n     return;\r\n   }\r\n \r\n   const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito\r\n-    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n-    .join(\"\\n\");\r\n+  const productos = carrito.map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`).join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"51929261925\";\r\n   window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, \"_blank\");\r\n@@ -369,21 +280,13 @@\n   mostrarToast(\"Pedido enviado por WhatsApp üßæ\");\r\n }\r\n \r\n // =========================\r\n-// LISTENERS GENERALES\r\n+// EVENTOS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-  window.location.href = \"carrito.html\";\r\n-});\r\n-document.addEventListener(\"keydown\", e => {\r\n-  if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n \r\n // =========================\r\n // INICIALIZAR\r\n // =========================\r\n"
                },
                {
                    "date": 1760130365425,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,118 +32,106 @@\n \r\n // =========================\r\n // CARGAR JSON DE PRODUCTOS\r\n // =========================\r\n-document.addEventListener(\"DOMContentLoaded\", () => {\r\n-  console.log(\"üöÄ DOM listo, iniciando carga de productos...\");\r\n+fetch(\"productos.json\")\r\n+  .then(res => res.json())\r\n+  .then(data => {\r\n+    catalogo = [...data.productos, ...(data.ofertas || [])];\r\n+    renderProductos(catalogo);\r\n+  })\r\n+  .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n-  fetch(\"productos.json\")\r\n-    .then(res => res.json())\r\n-    .then(data => {\r\n-      catalogo = [...(data.productos || []), ...(data.ofertas || [])];\r\n-      console.log(\"üì¶ Cat√°logo cargado:\", catalogo.length, \"productos\");\r\n-\r\n-      renderProductos(catalogo);\r\n-      activarBotonesCarrito();\r\n-    })\r\n-    .catch(err => console.error(\"‚ùå Error cargando productos:\", err));\r\n-});\r\n-\r\n // =========================\r\n-// ACTIVAR BOTONES DE CARRITO\r\n-// =========================\r\n-function activarBotonesCarrito() {\r\n-  const botones = document.querySelectorAll(\".btn-agregar-carrito\");\r\n-  console.log(\"üß© Botones detectados:\", botones.length);\r\n-\r\n-  botones.forEach(boton => {\r\n-    boton.addEventListener(\"click\", e => {\r\n-      const id = e.target.dataset.id;\r\n-      const producto = catalogo.find(p => p.id == id);\r\n-      if (!producto) return;\r\n-\r\n-      agregarAlCarrito(id);\r\n-\r\n-      boton.textContent = \"‚úÖ Agregado\";\r\n-      boton.disabled = true;\r\n-      setTimeout(() => {\r\n-        boton.textContent = \"Agregar al carrito\";\r\n-        boton.disabled = false;\r\n-      }, 1200);\r\n-    });\r\n-  });\r\n-}\r\n-\r\n-// =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n-\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n-\r\n-    let precioHTML = \"\";\r\n-    if (producto.precio_con_descuento) {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n-          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    } else {\r\n-      precioHTML = `<div class=\"precio\">S/ ${producto.precio.toFixed(2)}</div>`;\r\n-    }\r\n-\r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      ${precioHTML}\r\n+      <div class=\"precio\">\r\n+        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n+      </div>\r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n-\r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// CALCULAR TOTAL PRODUCTO\r\n+// CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n-  const precio = producto.precio_con_descuento || producto.precio;\r\n-  return precio * producto.cantidad;\r\n+  let total = 0;\r\n+  const cantidad = producto.cantidad;\r\n+\r\n+  if (producto.descuentoVolumen) {\r\n+    const promo = producto.descuentoVolumen;\r\n+    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+    const resto = cantidad % promo.aplicaA;\r\n+    const totalPromo = vecesPromo * (\r\n+      (promo.compra * producto.precio) +\r\n+      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n+    );\r\n+    const totalResto = resto * producto.precio;\r\n+    total = totalPromo + totalResto;\r\n+  } else {\r\n+    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n+  }\r\n+\r\n+  return total;\r\n }\r\n \r\n // =========================\r\n // ABRIR / CERRAR SIDEBAR\r\n // =========================\r\n function abrirSidebar() {\r\n-  sidebar?.classList.add(\"activo\");\r\n-  overlay?.classList.add(\"show\");\r\n+  if (!sidebar) return;\r\n+  sidebar.classList.add(\"activo\");\r\n+  overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n+  history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n function cerrarSidebar() {\r\n-  sidebar?.classList.remove(\"activo\");\r\n-  overlay?.classList.remove(\"show\");\r\n+  if (!sidebar) return;\r\n+  sidebar.classList.remove(\"activo\");\r\n+  overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n+  history.replaceState({}, \"\");\r\n }\r\n+overlay?.addEventListener(\"click\", cerrarSidebar);\r\n abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n-overlay?.addEventListener(\"click\", cerrarSidebar);\r\n+window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n+window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n // =========================\r\n-// AGREGAR AL CARRITO\r\n+// AGREGAR AL CARRITO CON STOCK\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n+  const cantidadActual = existe ? existe.cantidad : 0;\r\n+\r\n+  const stockDisponible = producto.stock - cantidadActual;\r\n+  if (stockDisponible <= 0) {\r\n+    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n+    return;\r\n+  }\r\n+\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -162,76 +150,152 @@\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n   if (carrito.length === 0) {\r\n-    carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o üõçÔ∏è</p>`;\r\n+    carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n     actualizarTotales();\r\n     actualizarContador();\r\n     return;\r\n   }\r\n \r\n-  carrito.forEach((producto, index) => {\r\n-    const item = document.createElement(\"div\");\r\n-    item.classList.add(\"carrito-item\");\r\n-    item.innerHTML = `\r\n-      <div class=\"carrito-item-info\">\r\n-        <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-        <div>\r\n-          <strong>${producto.nombre}</strong>\r\n-          <p>${producto.descripcion || \"\"}</p>\r\n-        </div>\r\n-      </div>\r\n-      <div class=\"carrito-item-controles\">\r\n-        <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-        <span>${producto.cantidad}</span>\r\n-        <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-      </div>\r\n-      <div class=\"carrito-item-precio\">\r\n-        S/ ${(calcularTotalProducto(producto)).toFixed(2)}\r\n-      </div>\r\n-      <button class=\"carrito-item-close\" data-index=\"${index}\">X</button>\r\n-    `;\r\n-    carritoItems.appendChild(item);\r\n-  });\r\n+  const tabla = document.createElement(\"table\");\r\n+  tabla.classList.add(\"tabla-carrito\");\r\n+  tabla.innerHTML = `\r\n+    <thead>\r\n+      <tr>\r\n+        <th>Producto</th>\r\n+        <th>Cantidad</th>\r\n+        <th>Precio</th>\r\n+        <th>Descuento aplicado</th>\r\n+        <th>Acci√≥n</th>\r\n+      </tr>\r\n+    </thead>\r\n+    <tbody>\r\n+      ${carrito.map((producto, index) => {\r\n+        let descuentoAplicado = false;\r\n+        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n \r\n+        return `\r\n+          <tr>\r\n+            <td>\r\n+              <div class=\"carrito-item-info\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <div>\r\n+                  <strong>${producto.nombre}</strong>\r\n+                  <p>${producto.descripcion || \"\"}</p>\r\n+                </div>\r\n+              </div>\r\n+            </td>\r\n+            <td>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+            </td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+          </tr>\r\n+        `;\r\n+      }).join(\"\")}\r\n+    </tbody>\r\n+  `;\r\n+  carritoItems.appendChild(tabla);\r\n+\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// BOTONES DEL CARRITO\r\n+// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n+  const producto = carrito[index];\r\n+  const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n+\r\n   if (e.target.classList.contains(\"carrito-item-close\")) {\r\n     carrito.splice(index, 1);\r\n   } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    carrito[index].cantidad++;\r\n+    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n+      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+      return;\r\n+    }\r\n+    producto.cantidad++;\r\n   } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    if (carrito[index].cantidad > 1) carrito[index].cantidad--;\r\n+    producto.cantidad--;\r\n+    if (producto.cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n \r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n // =========================\r\n-// LOCALSTORAGE\r\n+// GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n-  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n+  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n }\r\n \r\n // =========================\r\n-// TOTALES\r\n+// TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n+const ENVIO_GRATIS_MINIMO = 99;\r\n+function actualizarBarra(totalCarrito) {\r\n+  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n+  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n+\r\n+  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n+  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n+\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+\r\n+  if (mensajeEl) {\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n+      mensajeEl.classList.add(\"gratis\");\r\n+    } else if (totalCarrito > 0) {\r\n+      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n+    } else {\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n+    }\r\n+  }\r\n+\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+}\r\n+\r\n function actualizarTotales() {\r\n-  let subtotal = carrito.reduce((acc, p) => acc + calcularTotalProducto(p), 0);\r\n+  let subtotal = 0;\r\n+  let descuentoVolumenTotal = 0;\r\n+  let descuentoDirectoTotal = 0;\r\n+\r\n+  carrito.forEach(p => {\r\n+    const precioNormal = p.precio * p.cantidad;\r\n+    const precioConDescuento = calcularTotalProducto(p);\r\n+    subtotal += precioNormal;\r\n+\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+  });\r\n+\r\n+  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n+  const totalConDescuentos = subtotal - ahorroTotal;\r\n+\r\n   if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n+\r\n+  actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n // =========================\r\n // CONTADOR\r\n@@ -253,40 +317,66 @@\n   }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n   clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1200);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRAR POR WHATSAPP\r\n+// COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n   if (carrito.length === 0) {\r\n     mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n     return;\r\n   }\r\n \r\n   const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito.map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`).join(\"\\n\");\r\n+  const productos = carrito\r\n+    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n+    .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\";\r\n-  window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, \"_blank\");\r\n+  const telefono = \"+51920165696\";\r\n+  const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n+    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n+    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n+  // Abrir WhatsApp\r\n+  window.open(url, \"_blank\");\r\n+\r\n+  // Vaciar carrito\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n-  mostrarToast(\"Pedido enviado por WhatsApp üßæ\");\r\n+\r\n+  // Mostrar toast\r\n+  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n+\r\n+  // ‚úÖ Cerrar sidebar si estaba abierto\r\n+  if (sidebar?.classList.contains(\"activo\")) {\r\n+    cerrarSidebar();\r\n+  }\r\n }\r\n \r\n // =========================\r\n-// EVENTOS GENERALES\r\n+// LISTENERS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.addEventListener(\"click\", e => {\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n+});\r\n+document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+  window.location.href = \"carrito.html\";\r\n+});\r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.addEventListener(\"keydown\", e => {\r\n+  if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n \r\n // =========================\r\n // INICIALIZAR\r\n // =========================\r\n"
                },
                {
                    "date": 1760130401383,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -256,9 +256,9 @@\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n+      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n       mensajeEl.classList.add(\"gratis\");\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n       mensajeEl.classList.remove(\"gratis\");\r\n@@ -301,11 +301,18 @@\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+\r\n+  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+\r\n+  // contador dentro del carrito (en el h2)\r\n+  const contadorInline = document.getElementById(\"contador-inline\");\r\n+  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n+\r\n // =========================\r\n // TOAST\r\n // =========================\r\n function mostrarToast(mensaje) {\r\n@@ -335,31 +342,42 @@\n     .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n     .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"+51920165696\";\r\n-  const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n-    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n-    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+  const telefono = \"51929261925\"; // sin el \"+\"\r\n \r\n-  // Abrir WhatsApp\r\n-  window.open(url, \"_blank\");\r\n+  let url = \"\";\r\n \r\n+  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n+    // ‚úÖ En m√≥vil intentamos abrir directo la app de WhatsApp\r\n+    url = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+\r\n+    // ‚è≥ Fallback: si no abre en 1 segundo, redirige a wa.me\r\n+    setTimeout(() => {\r\n+      window.location.href = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+    }, 1000);\r\n+  } else {\r\n+    // ‚úÖ En PC abre WhatsApp Web\r\n+    url = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+  }\r\n+\r\n+  // üëâ Redirigir\r\n+  window.location.href = url;\r\n+\r\n   // Vaciar carrito\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n \r\n-  // Mostrar toast\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n \r\n-  // ‚úÖ Cerrar sidebar si estaba abierto\r\n   if (sidebar?.classList.contains(\"activo\")) {\r\n     cerrarSidebar();\r\n   }\r\n }\r\n \r\n+\r\n // =========================\r\n // LISTENERS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n"
                },
                {
                    "date": 1760130446365,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,28 +1,22 @@\n // =========================\r\n-// ELEMENTOS DEL CARRITO\r\n+// VARIABLES PRINCIPALES\r\n // =========================\r\n-const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n-const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito      = document.querySelector(\".cerrar-carrito\");\r\n-const carritoItems       = document.getElementById(\"carrito-items\");\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n+const sidebar = document.getElementById(\"carrito-sidebar\");\r\n+const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n+const carritoItems = document.getElementById(\"carrito-items\");\r\n+const subtotalEl = document.getElementById(\"subtotal\");\r\n+const descuentoEl = document.getElementById(\"descuento\");\r\n+const totalEl = document.getElementById(\"total\");\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n-const subtotalEl         = document.getElementById(\"subtotal\");\r\n-const totalEl            = document.getElementById(\"total\");\r\n-const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n-\r\n-// Campos para descuentos y env√≠o\r\n-const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n-const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n-const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n-const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n-\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n // =========================\r\n-// CREAR OVERLAY\r\n+// CREAR OVERLAY (fondo oscuro)\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -41,11 +35,12 @@\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDER PRODUCTOS\r\n+// RENDERIZAR PRODUCTOS EN TIENDA\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n+\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n@@ -54,84 +49,78 @@\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n+      \r\n+      <!-- Mostrar precio regular con tachado y precio con descuento -->\r\n       <div class=\"precio\">\r\n         <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n       </div>\r\n-      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n-      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n+      \r\n+      <!-- Mostrar el descuento y el ahorro -->\r\n+      <div class=\"descuento\">${producto.descuento}% OFF</div>\r\n+      <div class=\"ahorro\">Ahorro: S/ ${producto.ahorro.toFixed(2)}</div>\r\n+      \r\n+      <!-- Bot√≥n para agregar al carrito -->\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n+    \r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// CALCULAR TOTAL POR PRODUCTO\r\n+// ABRIR / CERRAR SIDEBAR CON HISTORIAL\r\n // =========================\r\n-function calcularTotalProducto(producto) {\r\n-  let total = 0;\r\n-  const cantidad = producto.cantidad;\r\n-\r\n-  if (producto.descuentoVolumen) {\r\n-    const promo = producto.descuentoVolumen;\r\n-    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n-    const resto = cantidad % promo.aplicaA;\r\n-    const totalPromo = vecesPromo * (\r\n-      (promo.compra * producto.precio) +\r\n-      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n-    );\r\n-    const totalResto = resto * producto.precio;\r\n-    total = totalPromo + totalResto;\r\n-  } else {\r\n-    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n-  }\r\n-\r\n-  return total;\r\n-}\r\n-\r\n-// =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n-// =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n+\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n+\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n-cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n-window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n-window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n+abrirCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  abrirSidebar();\r\n+});\r\n+cerrarCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+});\r\n \r\n+// üîπ Manejo de historial y bfcache (Atr√°s)\r\n+window.addEventListener(\"popstate\", () => {\r\n+  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n+\r\n+// üîπ Manejar back-forward cache para cerrar sidebar al volver\r\n+window.addEventListener(\"pageshow\", (event) => {\r\n+  if (event.persisted) {\r\n+    cerrarSidebar();\r\n+    mostrarCarrito();\r\n+  }\r\n+});\r\n+\r\n // =========================\r\n-// AGREGAR AL CARRITO CON STOCK\r\n+// AGREGAR PRODUCTO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n-  const cantidadActual = existe ? existe.cantidad : 0;\r\n-\r\n-  const stockDisponible = producto.stock - cantidadActual;\r\n-  if (stockDisponible <= 0) {\r\n-    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n-    return;\r\n-  }\r\n-\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -143,9 +132,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO\r\n+// MOSTRAR CARRITO (tabla)\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -158,95 +147,66 @@\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n+\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n-        <th>Descuento aplicado</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => {\r\n-        let descuentoAplicado = false;\r\n-        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n-\r\n-        return `\r\n-          <tr>\r\n-            <td>\r\n-              <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-                <div>\r\n-                  <strong>${producto.nombre}</strong>\r\n-                  <p>${producto.descripcion || \"\"}</p>\r\n-                </div>\r\n+      ${carrito.map((producto, index) => `\r\n+        <tr>\r\n+          <td>\r\n+            <div class=\"carrito-item-info\">\r\n+              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+              <div>\r\n+                <strong>${producto.nombre}</strong>\r\n+                <p>${producto.descripcion || \"\"}</p>\r\n               </div>\r\n-            </td>\r\n-            <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-            </td>\r\n-            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-          </tr>\r\n-        `;\r\n-      }).join(\"\")}\r\n+            </div>\r\n+          </td>\r\n+          <td>\r\n+            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+            <span>${producto.cantidad}</span>\r\n+            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+          </td>\r\n+          <!-- Mostrar el precio con descuento y cantidad -->\r\n+          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n+          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+        </tr>\r\n+      `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n+\r\n   carritoItems.appendChild(tabla);\r\n-\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n+// GUARDAR CARRITO EN LOCALSTORAGE\r\n // =========================\r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const index = e.target.dataset.index;\r\n-  if (index === undefined) return;\r\n-\r\n-  const producto = carrito[index];\r\n-  const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n-\r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n-      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n-      return;\r\n-    }\r\n-    producto.cantidad++;\r\n-  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    producto.cantidad--;\r\n-    if (producto.cantidad <= 0) carrito.splice(index, 1);\r\n+function guardarCarrito() {\r\n+  try {\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  } catch (e) {\r\n+    console.error(\"Error al guardar carrito\", e);\r\n   }\r\n+}\r\n \r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n-\r\n // =========================\r\n-// GUARDAR EN LOCALSTORAGE\r\n+// TOTALES, BARRA, CONTADOR Y TOAST\r\n // =========================\r\n-function guardarCarrito() {\r\n-  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n-  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n-}\r\n+const ENVIO_GRATIS_MINIMO = 65;\r\n \r\n-// =========================\r\n-// TOTALES Y BARRA DE ENV√çO\r\n-// =========================\r\n-const ENVIO_GRATIS_MINIMO = 99;\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n@@ -256,66 +216,42 @@\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n-      mensajeEl.classList.add(\"gratis\");\r\n+      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n     } else {\r\n       mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n-\r\n-  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n \r\n function actualizarTotales() {\r\n-  let subtotal = 0;\r\n-  let descuentoVolumenTotal = 0;\r\n-  let descuentoDirectoTotal = 0;\r\n+  // Calculamos el subtotal utilizando el precio con descuento\r\n+  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n+  \r\n+  // Si el total supera un cierto umbral, aplicamos un descuento adicional\r\n+  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n+  const total = subtotal - descuento;\r\n \r\n-  carrito.forEach(p => {\r\n-    const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = calcularTotalProducto(p);\r\n-    subtotal += precioNormal;\r\n+  subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  subtotalEl.classList.add('naranja');\r\n \r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-  });\r\n+  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+  descuentoEl.classList.add('naranja');\r\n \r\n-  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n-  const totalConDescuentos = subtotal - ahorroTotal;\r\n+  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  totalEl.classList.add('naranja');\r\n \r\n-  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n-\r\n-  actualizarBarra(totalConDescuentos);\r\n+  actualizarBarra(subtotal);\r\n }\r\n \r\n-// =========================\r\n-// CONTADOR\r\n-// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-\r\n-  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n-\r\n-  // contador dentro del carrito (en el h2)\r\n-  const contadorInline = document.getElementById(\"contador-inline\");\r\n-  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n-\r\n-// =========================\r\n-// TOAST\r\n-// =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n@@ -323,75 +259,62 @@\n     document.body.appendChild(toast);\r\n   }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n+\r\n   clearTimeout(toastTimeout);\r\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRAR AHORA POR WHATSAPP\r\n+// COMPRA POR WHATSAPP\r\n // =========================\r\n-function comprarAhora() {\r\n-  if (carrito.length === 0) {\r\n-    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n-    return;\r\n-  }\r\n+function redirigirWhatsApp() {\r\n+  const totalCompra = totalEl.innerText;\r\n+  const productos = carrito.map(p =>\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n+  ).join(\", \");\r\n+  \r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n+  const telefono = \"+51920165696\";\r\n+  const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n+    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n+    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n-  const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito\r\n-    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n-    .join(\"\\n\");\r\n+  window.open(url, \"_blank\");\r\n+}\r\n \r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\"; // sin el \"+\"\r\n+// =========================\r\n+// EVENTOS DEL CARRITO\r\n+// =========================\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const index = e.target.dataset.index;\r\n+  if (index === undefined) return;\r\n \r\n-  let url = \"\";\r\n-\r\n-  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ En m√≥vil intentamos abrir directo la app de WhatsApp\r\n-    url = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-\r\n-    // ‚è≥ Fallback: si no abre en 1 segundo, redirige a wa.me\r\n-    setTimeout(() => {\r\n-      window.location.href = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-    }, 1000);\r\n-  } else {\r\n-    // ‚úÖ En PC abre WhatsApp Web\r\n-    url = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    carrito[index].cantidad++;\r\n+  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+    carrito[index].cantidad--;\r\n+    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n   }\r\n-\r\n-  // üëâ Redirigir\r\n-  window.location.href = url;\r\n-\r\n-  // Vaciar carrito\r\n-  carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n-  actualizarContador();\r\n+});\r\n \r\n-  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n-\r\n-  if (sidebar?.classList.contains(\"activo\")) {\r\n-    cerrarSidebar();\r\n+document.addEventListener(\"click\", e => {\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n+    agregarAlCarrito(e.target.dataset.id);\r\n   }\r\n-}\r\n+});\r\n \r\n-\r\n-// =========================\r\n-// LISTENERS GENERALES\r\n-// =========================\r\n-document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n-});\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n-document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n+\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n@@ -399,4 +322,5 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n+\r\n"
                },
                {
                    "date": 1760130480233,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,12 +5,16 @@\n const sidebar = document.getElementById(\"carrito-sidebar\");\r\n const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n const carritoItems = document.getElementById(\"carrito-items\");\r\n const subtotalEl = document.getElementById(\"subtotal\");\r\n-const descuentoEl = document.getElementById(\"descuento\");\r\n+const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n+const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n+const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n+const ahorroTotalEl = document.getElementById(\"ahorro-total\");\r\n const totalEl = document.getElementById(\"total\");\r\n const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n+\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n@@ -226,25 +230,50 @@\n   }\r\n }\r\n \r\n function actualizarTotales() {\r\n-  // Calculamos el subtotal utilizando el precio con descuento\r\n-  const subtotal = carrito.reduce((acc, p) => acc + p.precio_con_descuento * p.cantidad, 0);\r\n-  \r\n-  // Si el total supera un cierto umbral, aplicamos un descuento adicional\r\n-  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n-  const total = subtotal - descuento;\r\n+  let subtotal = 0;\r\n+  let descuentoVolumenTotal = 0;\r\n+  let descuentoDirectoTotal = 0;\r\n \r\n+  carrito.forEach(p => {\r\n+    const precioNormal = p.precio * p.cantidad;\r\n+    const precioConDescuento = p.precio_con_descuento;\r\n+    subtotal += precioNormal;\r\n+\r\n+    // Descuento por volumen o directo\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n+      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n+      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+    }\r\n+  });\r\n+\r\n+  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n+  const totalConDescuentos = subtotal - ahorroTotal;\r\n+\r\n   subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n   subtotalEl.classList.add('naranja');\r\n \r\n-  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-  descuentoEl.classList.add('naranja');\r\n+  if (descuentoVolumenEl) {\r\n+    descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+    descuentoVolumenEl.classList.add('naranja');\r\n+  }\r\n \r\n-  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  if (descuentoDirectoEl) {\r\n+    descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+    descuentoDirectoEl.classList.add('naranja');\r\n+  }\r\n+\r\n+  if (ahorroTotalEl) {\r\n+    ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+    ahorroTotalEl.classList.add('naranja');\r\n+  }\r\n+\r\n+  totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n   totalEl.classList.add('naranja');\r\n \r\n-  actualizarBarra(subtotal);\r\n+  actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n"
                },
                {
                    "date": 1760130544495,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,26 +1,28 @@\n // =========================\r\n-// VARIABLES PRINCIPALES\r\n+// ELEMENTOS DEL CARRITO\r\n // =========================\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\");\r\n-const sidebar = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito = document.querySelector(\".cerrar-carrito\");\r\n-const carritoItems = document.getElementById(\"carrito-items\");\r\n-const subtotalEl = document.getElementById(\"subtotal\");\r\n-const costoEnvioEl = document.getElementById(\"costo-envio\");\r\n+const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n+const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n+const cerrarCarrito      = document.querySelector(\".cerrar-carrito\");\r\n+const carritoItems       = document.getElementById(\"carrito-items\");\r\n+\r\n+const subtotalEl         = document.getElementById(\"subtotal\");\r\n+const totalEl            = document.getElementById(\"total\");\r\n+const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n+\r\n+// Campos para descuentos y env√≠o\r\n const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n-const ahorroTotalEl = document.getElementById(\"ahorro-total\");\r\n-const totalEl = document.getElementById(\"total\");\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n+const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n+const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n-\r\n let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n let catalogo = [];\r\n \r\n // =========================\r\n-// CREAR OVERLAY (fondo oscuro)\r\n+// CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -39,92 +41,114 @@\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDERIZAR PRODUCTOS EN TIENDA\r\n+// RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n-\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n+\r\n+    // ‚úÖ Mostrar precios correctamente\r\n+    let precioHTML = \"\";\r\n+    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n+          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    } else {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    }\r\n+\r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      \r\n-      <!-- Mostrar precio regular con tachado y precio con descuento -->\r\n-      <div class=\"precio\">\r\n-        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n-      </div>\r\n-      \r\n-      <!-- Mostrar el descuento y el ahorro -->\r\n-      <div class=\"descuento\">${producto.descuento}% OFF</div>\r\n-      <div class=\"ahorro\">Ahorro: S/ ${producto.ahorro.toFixed(2)}</div>\r\n-      \r\n-      <!-- Bot√≥n para agregar al carrito -->\r\n+      ${precioHTML}\r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n-    \r\n+\r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n+\r\n // =========================\r\n-// ABRIR / CERRAR SIDEBAR CON HISTORIAL\r\n+// CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n+function calcularTotalProducto(producto) {\r\n+  let total = 0;\r\n+  const cantidad = producto.cantidad;\r\n+\r\n+  if (producto.descuentoVolumen) {\r\n+    const promo = producto.descuentoVolumen;\r\n+    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+    const resto = cantidad % promo.aplicaA;\r\n+    const totalPromo = vecesPromo * (\r\n+      (promo.compra * producto.precio) +\r\n+      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n+    );\r\n+    const totalResto = resto * producto.precio;\r\n+    total = totalPromo + totalResto;\r\n+  } else {\r\n+    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n+  }\r\n+\r\n+  return total;\r\n+}\r\n+\r\n+// =========================\r\n+// ABRIR / CERRAR SIDEBAR\r\n+// =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n-\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n-\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  abrirSidebar();\r\n-});\r\n-cerrarCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-});\r\n+abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n+cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n+window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n+window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n-// üîπ Manejo de historial y bfcache (Atr√°s)\r\n-window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n-\r\n-// üîπ Manejar back-forward cache para cerrar sidebar al volver\r\n-window.addEventListener(\"pageshow\", (event) => {\r\n-  if (event.persisted) {\r\n-    cerrarSidebar();\r\n-    mostrarCarrito();\r\n-  }\r\n-});\r\n-\r\n // =========================\r\n-// AGREGAR PRODUCTO\r\n+// AGREGAR AL CARRITO CON STOCK\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n+  const cantidadActual = existe ? existe.cantidad : 0;\r\n+\r\n+  const stockDisponible = producto.stock - cantidadActual;\r\n+  if (stockDisponible <= 0) {\r\n+    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n+    return;\r\n+  }\r\n+\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -136,9 +160,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO (tabla)\r\n+// MOSTRAR CARRITO\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -151,66 +175,104 @@\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n-\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n+        <th>Descuento aplicado</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => `\r\n-        <tr>\r\n-          <td>\r\n-            <div class=\"carrito-item-info\">\r\n-              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-              <div>\r\n-                <strong>${producto.nombre}</strong>\r\n-                <p>${producto.descripcion || \"\"}</p>\r\n+      ${carrito.map((producto, index) => {\r\n+        let descuentoAplicado = false;\r\n+        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n+\r\n+        return `\r\n+          <tr>\r\n+            <td>\r\n+              <div class=\"carrito-item-info\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <div>\r\n+                  <strong>${producto.nombre}</strong>\r\n+                  <p>${producto.descripcion || \"\"}</p>\r\n+                </div>\r\n               </div>\r\n-            </div>\r\n-          </td>\r\n-          <td>\r\n-            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-            <span>${producto.cantidad}</span>\r\n-            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-          </td>\r\n-          <!-- Mostrar el precio con descuento y cantidad -->\r\n-          <td>S/ ${(producto.precio_con_descuento * producto.cantidad).toFixed(2)}</td>\r\n-          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-        </tr>\r\n-      `).join(\"\")}\r\n+            </td>\r\n+            <td>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+            </td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+          </tr>\r\n+        `;\r\n+      }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n+  carritoItems.appendChild(tabla);\r\n \r\n-  carritoItems.appendChild(tabla);\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// GUARDAR CARRITO EN LOCALSTORAGE\r\n+// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n // =========================\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const index = e.target.dataset.index;\r\n+  if (index === undefined) return;\r\n+\r\n+  const producto = carrito[index];\r\n+  const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n+\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    // ‚ùå Eliminar solo con la X\r\n+    carrito.splice(index, 1);\r\n+\r\n+  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    // ‚ûï Aumentar cantidad, respetando stock\r\n+    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n+      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+      return;\r\n+    }\r\n+    producto.cantidad++;\r\n+\r\n+  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+    // ‚ûñ No permitir menos de 1\r\n+    if (producto.cantidad > 1) {\r\n+      producto.cantidad--;\r\n+    } else {\r\n+      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+    }\r\n+  }\r\n+\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+});\r\n+\r\n+\r\n+// =========================\r\n+// GUARDAR EN LOCALSTORAGE\r\n+// =========================\r\n function guardarCarrito() {\r\n-  try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar carrito\", e);\r\n-  }\r\n+  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n+  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n }\r\n \r\n // =========================\r\n-// TOTALES, BARRA, CONTADOR Y TOAST\r\n+// TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 65;\r\n-\r\n+const ENVIO_GRATIS_MINIMO = 99;\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n@@ -220,15 +282,20 @@\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n+      mensajeEl.classList.add(\"gratis\");\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     } else {\r\n       mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n+\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n \r\n function actualizarTotales() {\r\n   let subtotal = 0;\r\n@@ -236,51 +303,45 @@\n   let descuentoDirectoTotal = 0;\r\n \r\n   carrito.forEach(p => {\r\n     const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = p.precio_con_descuento;\r\n+    const precioConDescuento = calcularTotalProducto(p);\r\n     subtotal += precioNormal;\r\n \r\n-    // Descuento por volumen o directo\r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n-      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n-      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-    }\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n   });\r\n \r\n   const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n   const totalConDescuentos = subtotal - ahorroTotal;\r\n \r\n-  subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  subtotalEl.classList.add('naranja');\r\n+  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n \r\n-  if (descuentoVolumenEl) {\r\n-    descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-    descuentoVolumenEl.classList.add('naranja');\r\n-  }\r\n-\r\n-  if (descuentoDirectoEl) {\r\n-    descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-    descuentoDirectoEl.classList.add('naranja');\r\n-  }\r\n-\r\n-  if (ahorroTotalEl) {\r\n-    ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-    ahorroTotalEl.classList.add('naranja');\r\n-  }\r\n-\r\n-  totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n-  totalEl.classList.add('naranja');\r\n-\r\n   actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n+// =========================\r\n+// CONTADOR\r\n+// =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+\r\n+  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+\r\n+  // contador dentro del carrito (en el h2)\r\n+  const contadorInline = document.getElementById(\"contador-inline\");\r\n+  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n+\r\n+// =========================\r\n+// TOAST\r\n+// =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n@@ -288,62 +349,85 @@\n     document.body.appendChild(toast);\r\n   }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-\r\n   clearTimeout(toastTimeout);\r\n   toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRA POR WHATSAPP\r\n+// COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n-function redirigirWhatsApp() {\r\n-  const totalCompra = totalEl.innerText;\r\n-  const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n-  ).join(\", \");\r\n-  \r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n-  const telefono = \"+51920165696\";\r\n-  const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n-    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n-    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+function comprarAhora() {\r\n+  if (carrito.length === 0) {\r\n+    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n+    return;\r\n+  }\r\n \r\n-  window.open(url, \"_blank\");\r\n-}\r\n+  const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n+  const productos = carrito\r\n+    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n+    .join(\"\\n\");\r\n \r\n-// =========================\r\n-// EVENTOS DEL CARRITO\r\n-// =========================\r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const index = e.target.dataset.index;\r\n-  if (index === undefined) return;\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n+  const telefono = \"51929261925\"; // sin el \"+\"\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    carrito[index].cantidad++;\r\n-  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    carrito[index].cantidad--;\r\n-    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n+  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n+    // ‚úÖ Intentar abrir directo la app\r\n+    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+\r\n+    // Intento directo\r\n+    window.location.href = appUrl;\r\n+\r\n+    // ‚è≥ Fallback en 1200ms\r\n+    setTimeout(() => {\r\n+      // Redirige al fallback solo si sigue en la misma p√°gina\r\n+      if (document.visibilityState === \"visible\") {\r\n+        window.location.href = fallbackUrl;\r\n+      }\r\n+      // Aqu√≠ reci√©n vaciamos el carrito\r\n+      vaciarCarritoDespuesEnvio();\r\n+    }, 1200);\r\n+\r\n+  } else {\r\n+    // ‚úÖ En PC: usar WhatsApp Web\r\n+    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    window.open(webUrl, \"_blank\");\r\n+\r\n+    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n+    vaciarCarritoDespuesEnvio();\r\n   }\r\n+}\r\n+\r\n+// Funci√≥n auxiliar\r\n+function vaciarCarritoDespuesEnvio() {\r\n+  carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n-});\r\n+  actualizarContador();\r\n+  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n \r\n+  if (sidebar?.classList.contains(\"activo\")) {\r\n+    cerrarSidebar();\r\n+  }\r\n+}\r\n+\r\n+\r\n+// =========================\r\n+// LISTENERS GENERALES\r\n+// =========================\r\n+document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n-    agregarAlCarrito(e.target.dataset.id);\r\n-  }\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n-\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n-\r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n@@ -351,5 +435,4 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n-\r\n"
                },
                {
                    "date": 1760130601954,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,10 +35,37 @@\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n+    // üîπ Mezclar productos normales y ofertas\r\n     catalogo = [...data.productos, ...(data.ofertas || [])];\r\n+\r\n+    // üîπ Renderizar cat√°logo\r\n     renderProductos(catalogo);\r\n+\r\n+    // üîπ Activar botones \"Agregar al carrito\" DESPU√âS de renderizar\r\n+    document.querySelectorAll(\".btn-agregar-carrito\").forEach(boton => {\r\n+      boton.addEventListener(\"click\", e => {\r\n+        const id = e.target.dataset.id;\r\n+\r\n+        // Validar producto\r\n+        const producto = catalogo.find(p => p.id == id);\r\n+        if (!producto) {\r\n+          console.warn(\"‚ö†Ô∏è Producto no encontrado o sin ID v√°lido\");\r\n+          return;\r\n+        }\r\n+\r\n+        agregarAlCarrito(id);\r\n+\r\n+        // üí¨ Efecto visual temporal\r\n+        boton.textContent = \"‚úÖ Agregado\";\r\n+        boton.disabled = true;\r\n+        setTimeout(() => {\r\n+          boton.textContent = \"Agregar al carrito\";\r\n+          boton.disabled = false;\r\n+        }, 1500);\r\n+      });\r\n+    });\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n@@ -82,9 +109,8 @@\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n-\r\n // =========================\r\n // CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n@@ -181,40 +207,34 @@\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n-        <th>Descuento aplicado</th>\r\n+        <th>Descuento</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => {\r\n-        let descuentoAplicado = false;\r\n-        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n-\r\n-        return `\r\n-          <tr>\r\n-            <td>\r\n-              <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-                <div>\r\n-                  <strong>${producto.nombre}</strong>\r\n-                  <p>${producto.descripcion || \"\"}</p>\r\n-                </div>\r\n+      ${carrito.map((producto, index) => `\r\n+        <tr>\r\n+          <td>\r\n+            <div class=\"carrito-item-info\">\r\n+              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+              <div>\r\n+                <strong>${producto.nombre}</strong>\r\n+                <p>${producto.descripcion || \"\"}</p>\r\n               </div>\r\n-            </td>\r\n-            <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-            </td>\r\n-            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-          </tr>\r\n-        `;\r\n-      }).join(\"\")}\r\n+            </div>\r\n+          </td>\r\n+          <td>\r\n+            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+            <span>${producto.cantidad}</span>\r\n+            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+          </td>\r\n+          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+          <td>${producto.precio_con_descuento ? \"S√≠\" : \"No\"}</td>\r\n+          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+        </tr>\r\n+      `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n   carritoItems.appendChild(tabla);\r\n \r\n@@ -224,9 +244,9 @@\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n+// BOTONES DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const index = e.target.dataset.index;\r\n   if (index === undefined) return;\r\n@@ -234,21 +254,16 @@\n   const producto = carrito[index];\r\n   const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n \r\n   if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    // ‚ùå Eliminar solo con la X\r\n     carrito.splice(index, 1);\r\n-\r\n   } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    // ‚ûï Aumentar cantidad, respetando stock\r\n     if (producto.cantidad + 1 > catalogoProd.stock) {\r\n       mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n       return;\r\n     }\r\n     producto.cantidad++;\r\n-\r\n   } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    // ‚ûñ No permitir menos de 1\r\n     if (producto.cantidad > 1) {\r\n       producto.cantidad--;\r\n     } else {\r\n       mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n@@ -258,9 +273,8 @@\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n-\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n@@ -268,77 +282,26 @@\n   catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n }\r\n \r\n // =========================\r\n-// TOTALES Y BARRA DE ENV√çO\r\n+// TOTALES\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 99;\r\n-function actualizarBarra(totalCarrito) {\r\n-  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n-\r\n-  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n-  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n-\r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n-\r\n-  if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n-      mensajeEl.classList.add(\"gratis\");\r\n-    } else if (totalCarrito > 0) {\r\n-      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    }\r\n-  }\r\n-\r\n-  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n-}\r\n-\r\n function actualizarTotales() {\r\n   let subtotal = 0;\r\n-  let descuentoVolumenTotal = 0;\r\n-  let descuentoDirectoTotal = 0;\r\n+  carrito.forEach(p => subtotal += calcularTotalProducto(p));\r\n \r\n-  carrito.forEach(p => {\r\n-    const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = calcularTotalProducto(p);\r\n-    subtotal += precioNormal;\r\n-\r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-  });\r\n-\r\n-  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n-  const totalConDescuentos = subtotal - ahorroTotal;\r\n-\r\n   if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n-\r\n-  actualizarBarra(totalConDescuentos);\r\n+  if (totalEl) totalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n }\r\n \r\n // =========================\r\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-\r\n-  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n-\r\n-  // contador dentro del carrito (en el h2)\r\n-  const contadorInline = document.getElementById(\"contador-inline\");\r\n-  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n-\r\n // =========================\r\n // TOAST\r\n // =========================\r\n function mostrarToast(mensaje) {\r\n@@ -350,9 +313,9 @@\n   }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n   clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000);\r\n }\r\n \r\n // =========================\r\n // COMPRAR AHORA POR WHATSAPP\r\n@@ -368,66 +331,29 @@\n     .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n     .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\"; // sin el \"+\"\r\n+  const telefono = \"51929261925\";\r\n+  window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, \"_blank\");\r\n \r\n-  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ Intentar abrir directo la app\r\n-    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-\r\n-    // Intento directo\r\n-    window.location.href = appUrl;\r\n-\r\n-    // ‚è≥ Fallback en 1200ms\r\n-    setTimeout(() => {\r\n-      // Redirige al fallback solo si sigue en la misma p√°gina\r\n-      if (document.visibilityState === \"visible\") {\r\n-        window.location.href = fallbackUrl;\r\n-      }\r\n-      // Aqu√≠ reci√©n vaciamos el carrito\r\n-      vaciarCarritoDespuesEnvio();\r\n-    }, 1200);\r\n-\r\n-  } else {\r\n-    // ‚úÖ En PC: usar WhatsApp Web\r\n-    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    window.open(webUrl, \"_blank\");\r\n-\r\n-    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n-    vaciarCarritoDespuesEnvio();\r\n-  }\r\n-}\r\n-\r\n-// Funci√≥n auxiliar\r\n-function vaciarCarritoDespuesEnvio() {\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n-  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n-\r\n-  if (sidebar?.classList.contains(\"activo\")) {\r\n-    cerrarSidebar();\r\n-  }\r\n+  mostrarToast(\"Pedido enviado por WhatsApp üßæ\");\r\n }\r\n \r\n-\r\n // =========================\r\n // LISTENERS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n-});\r\n+document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n-document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n"
                },
                {
                    "date": 1760130648572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,28 +1,22 @@\n // =========================\r\n-// ELEMENTOS DEL CARRITO\r\n+// VARIABLES PRINCIPALES\r\n // =========================\r\n-const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n-const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito      = document.querySelector(\".cerrar-carrito\");\r\n-const carritoItems       = document.getElementById(\"carrito-items\");\r\n+const abrirCarrito = document.getElementById(\"abrir-carrito\"); // bot√≥n o enlace carrito\r\n+const sidebar = document.getElementById(\"carrito-sidebar\");    // sidebar lateral\r\n+const cerrarCarrito = document.querySelector(\".cerrar-carrito\"); // bot√≥n X cerrar sidebar\r\n+const carritoItems = document.getElementById(\"carrito-items\"); // contenedor de productos\r\n+const subtotalEl = document.getElementById(\"subtotal\");        // subtotal\r\n+const descuentoEl = document.getElementById(\"descuento\");      // descuento\r\n+const totalEl = document.getElementById(\"total\");              // total\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\"); // contador badge carrito\r\n \r\n-const subtotalEl         = document.getElementById(\"subtotal\");\r\n-const totalEl            = document.getElementById(\"total\");\r\n-const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n+let toastTimeout; // controla tiempo del toast\r\n+let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || []; // lee carrito guardado\r\n+let catalogo = []; // cat√°logo de productos (desde JSON)\r\n \r\n-// Campos para descuentos y env√≠o\r\n-const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n-const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n-const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n-const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n-\r\n-let toastTimeout;\r\n-let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-let catalogo = [];\r\n-\r\n // =========================\r\n-// CREAR OVERLAY\r\n+// CREAR OVERLAY (fondo oscuro)\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -35,146 +29,77 @@\n // =========================\r\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n-    // üîπ Mezclar productos normales y ofertas\r\n     catalogo = [...data.productos, ...(data.ofertas || [])];\r\n-\r\n-    // üîπ Renderizar cat√°logo\r\n-    renderProductos(catalogo);\r\n-\r\n-    // üîπ Activar botones \"Agregar al carrito\" DESPU√âS de renderizar\r\n-    document.querySelectorAll(\".btn-agregar-carrito\").forEach(boton => {\r\n-      boton.addEventListener(\"click\", e => {\r\n-        const id = e.target.dataset.id;\r\n-\r\n-        // Validar producto\r\n-        const producto = catalogo.find(p => p.id == id);\r\n-        if (!producto) {\r\n-          console.warn(\"‚ö†Ô∏è Producto no encontrado o sin ID v√°lido\");\r\n-          return;\r\n-        }\r\n-\r\n-        agregarAlCarrito(id);\r\n-\r\n-        // üí¨ Efecto visual temporal\r\n-        boton.textContent = \"‚úÖ Agregado\";\r\n-        boton.disabled = true;\r\n-        setTimeout(() => {\r\n-          boton.textContent = \"Agregar al carrito\";\r\n-          boton.disabled = false;\r\n-        }, 1500);\r\n-      });\r\n-    });\r\n+    renderProductos(catalogo); // Renderizar al cargar\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDER PRODUCTOS\r\n+// RENDERIZAR PRODUCTOS EN TIENDA\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n+\r\n function renderProductos(lista) {\r\n-  if (!contenedorProductos) return;\r\n+  if (!contenedorProductos) return; // si no hay contenedor (ej: carrito.html) no hace nada\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n-\r\n-    // ‚úÖ Mostrar precios correctamente\r\n-    let precioHTML = \"\";\r\n-    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n-          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    } else {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    }\r\n-\r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      ${precioHTML}\r\n-      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n-      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n+      <span>S/ ${producto.precio.toFixed(2)}</span>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n-\r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n // =========================\r\n-// CALCULAR TOTAL POR PRODUCTO\r\n-// =========================\r\n-function calcularTotalProducto(producto) {\r\n-  let total = 0;\r\n-  const cantidad = producto.cantidad;\r\n-\r\n-  if (producto.descuentoVolumen) {\r\n-    const promo = producto.descuentoVolumen;\r\n-    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n-    const resto = cantidad % promo.aplicaA;\r\n-    const totalPromo = vecesPromo * (\r\n-      (promo.compra * producto.precio) +\r\n-      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n-    );\r\n-    const totalResto = resto * producto.precio;\r\n-    total = totalPromo + totalResto;\r\n-  } else {\r\n-    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n-  }\r\n-\r\n-  return total;\r\n-}\r\n-\r\n-// =========================\r\n // ABRIR / CERRAR SIDEBAR\r\n // =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n-  history.pushState({ carritoAbierto: true }, \"\");\r\n+  localStorage.setItem(\"sidebarAbierto\", \"true\"); // üîπ NUEVO: guardar estado\r\n }\r\n+\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n-  history.replaceState({}, \"\");\r\n+  localStorage.removeItem(\"sidebarAbierto\"); // üîπ NUEVO: limpiar estado\r\n }\r\n+\r\n+// Eventos abrir/cerrar sidebar\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n-cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n-window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n-window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n+abrirCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  abrirSidebar();\r\n+});\r\n+cerrarCarrito?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+});\r\n+window.addEventListener(\"popstate\", () => {\r\n+  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n \r\n // =========================\r\n-// AGREGAR AL CARRITO CON STOCK\r\n+// AGREGAR PRODUCTO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n-  const cantidadActual = existe ? existe.cantidad : 0;\r\n-\r\n-  const stockDisponible = producto.stock - cantidadActual;\r\n-  if (stockDisponible <= 0) {\r\n-    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n-    return;\r\n-  }\r\n-\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -186,9 +111,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO\r\n+// MOSTRAR CARRITO (tabla)\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -201,15 +126,15 @@\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n+\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n-        <th>Descuento</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n@@ -228,82 +153,95 @@\n             <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n             <span>${producto.cantidad}</span>\r\n             <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n           </td>\r\n-          <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-          <td>${producto.precio_con_descuento ? \"S√≠\" : \"No\"}</td>\r\n+          <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n           <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n         </tr>\r\n       `).join(\"\")}\r\n     </tbody>\r\n   `;\r\n+\r\n   carritoItems.appendChild(tabla);\r\n \r\n-  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n+  // Activar el scroll despu√©s de agregar el segundo producto\r\n+  if (carrito.length >= 2) {\r\n+    carritoItems.style.overflowY = 'auto';\r\n+  } else {\r\n+    carritoItems.style.overflowY = 'hidden';\r\n+  }\r\n+\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// BOTONES DEL CARRITO\r\n+// GUARDAR CARRITO EN LOCALSTORAGE\r\n // =========================\r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const index = e.target.dataset.index;\r\n-  if (index === undefined) return;\r\n+function guardarCarrito() {\r\n+  try {\r\n+    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+  } catch (e) {\r\n+    console.error(\"Error al guardar carrito\", e);\r\n+  }\r\n+}\r\n \r\n-  const producto = carrito[index];\r\n-  const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n+// =========================\r\n+// BARRA DE PROGRESO ENV√çO GRATIS\r\n+// =========================\r\n+const ENVIO_GRATIS_MINIMO = 65;\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n-      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n-      return;\r\n-    }\r\n-    producto.cantidad++;\r\n-  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    if (producto.cantidad > 1) {\r\n-      producto.cantidad--;\r\n+function actualizarBarra(totalCarrito) {\r\n+  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n+  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n+\r\n+  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n+  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n+\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+\r\n+  if (mensajeEl) {\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+    } else if (totalCarrito > 0) {\r\n+      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n     } else {\r\n-      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n     }\r\n   }\r\n-\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n-\r\n-// =========================\r\n-// GUARDAR EN LOCALSTORAGE\r\n-// =========================\r\n-function guardarCarrito() {\r\n-  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n-  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n }\r\n \r\n // =========================\r\n // TOTALES\r\n // =========================\r\n function actualizarTotales() {\r\n-  let subtotal = 0;\r\n-  carrito.forEach(p => subtotal += calcularTotalProducto(p));\r\n+  const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n+  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n+  const total = subtotal - descuento;\r\n \r\n-  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  subtotalEl.classList.add('naranja');\r\n+\r\n+  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n+  descuentoEl.classList.add('naranja');\r\n+\r\n+  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n+  totalEl.classList.add('naranja');\r\n+\r\n+  actualizarBarra(subtotal);\r\n }\r\n \r\n // =========================\r\n-// CONTADOR\r\n+// CONTADOR (badge carrito)\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n }\r\n \r\n // =========================\r\n-// TOAST\r\n+// TOAST (mensaje emergente)\r\n // =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n@@ -312,48 +250,63 @@\n     document.body.appendChild(toast);\r\n   }\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n+\r\n   clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n // =========================\r\n-// COMPRAR AHORA POR WHATSAPP\r\n+// COMPRA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n-  if (carrito.length === 0) {\r\n-    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n-    return;\r\n-  }\r\n+  const totalCompra = totalEl.innerText;\r\n+  const productos = carrito.map(p =>\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n+  ).join(\", \");\r\n \r\n-  const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito\r\n-    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n-    .join(\"\\n\");\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n \r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\";\r\n-  window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, \"_blank\");\r\n+  const telefono = \"51920165696\";\r\n+  const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+  window.open(url, \"_blank\");\r\n+}\r\n \r\n-  carrito = [];\r\n+// =========================\r\n+// EVENTOS DEL CARRITO\r\n+// =========================\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const index = e.target.dataset.index;\r\n+  if (index === undefined) return;\r\n+\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    carrito[index].cantidad++;\r\n+  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+    carrito[index].cantidad--;\r\n+    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n+  }\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n-  actualizarContador();\r\n-  mostrarToast(\"Pedido enviado por WhatsApp üßæ\");\r\n-}\r\n+});\r\n \r\n-// =========================\r\n-// LISTENERS GENERALES\r\n-// =========================\r\n-document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n+// Bot√≥n \"Agregar al carrito\"\r\n+document.addEventListener(\"click\", e => {\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n+    agregarAlCarrito(e.target.dataset.id);\r\n+  }\r\n+});\r\n+\r\n+// Bot√≥n \"Ver carrito\" ‚Üí va a carrito.html\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n+\r\n+// Cerrar con tecla ESC\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n@@ -361,4 +314,9 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n+\r\n+// üîπ NUEVO: cerrar sidebar si qued√≥ abierto al volver de carrito.html\r\n+if (localStorage.getItem(\"sidebarAbierto\")) {\r\n+  cerrarSidebar();\r\n+}\r\n"
                },
                {
                    "date": 1760130678260,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,22 +1,28 @@\n // =========================\r\n-// VARIABLES PRINCIPALES\r\n+// ELEMENTOS DEL CARRITO\r\n // =========================\r\n-const abrirCarrito = document.getElementById(\"abrir-carrito\"); // bot√≥n o enlace carrito\r\n-const sidebar = document.getElementById(\"carrito-sidebar\");    // sidebar lateral\r\n-const cerrarCarrito = document.querySelector(\".cerrar-carrito\"); // bot√≥n X cerrar sidebar\r\n-const carritoItems = document.getElementById(\"carrito-items\"); // contenedor de productos\r\n-const subtotalEl = document.getElementById(\"subtotal\");        // subtotal\r\n-const descuentoEl = document.getElementById(\"descuento\");      // descuento\r\n-const totalEl = document.getElementById(\"total\");              // total\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\"); // contador badge carrito\r\n+const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n+const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n+const cerrarCarrito      = document.querySelector(\".cerrar-carrito\");\r\n+const carritoItems       = document.getElementById(\"carrito-items\");\r\n \r\n-let toastTimeout; // controla tiempo del toast\r\n-let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || []; // lee carrito guardado\r\n-let catalogo = []; // cat√°logo de productos (desde JSON)\r\n+const subtotalEl         = document.getElementById(\"subtotal\");\r\n+const totalEl            = document.getElementById(\"total\");\r\n+const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n \r\n+// Campos para descuentos y env√≠o\r\n+const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n+const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n+const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n+const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n+\r\n+let toastTimeout;\r\n+let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+let catalogo = [];\r\n+\r\n // =========================\r\n-// CREAR OVERLAY (fondo oscuro)\r\n+// CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -30,76 +36,119 @@\n fetch(\"productos.json\")\r\n   .then(res => res.json())\r\n   .then(data => {\r\n     catalogo = [...data.productos, ...(data.ofertas || [])];\r\n-    renderProductos(catalogo); // Renderizar al cargar\r\n+    renderProductos(catalogo);\r\n   })\r\n   .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n-// RENDERIZAR PRODUCTOS EN TIENDA\r\n+// RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n-\r\n function renderProductos(lista) {\r\n-  if (!contenedorProductos) return; // si no hay contenedor (ej: carrito.html) no hace nada\r\n+  if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n+\r\n+    // ‚úÖ Mostrar precios correctamente\r\n+    let precioHTML = \"\";\r\n+    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n+          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    } else {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    }\r\n+\r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      <span>S/ ${producto.precio.toFixed(2)}</span>\r\n+      ${precioHTML}\r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n+\r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n+\r\n // =========================\r\n+// CALCULAR TOTAL POR PRODUCTO\r\n+// =========================\r\n+function calcularTotalProducto(producto) {\r\n+  let total = 0;\r\n+  const cantidad = producto.cantidad;\r\n+\r\n+  if (producto.descuentoVolumen) {\r\n+    const promo = producto.descuentoVolumen;\r\n+    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+    const resto = cantidad % promo.aplicaA;\r\n+    const totalPromo = vecesPromo * (\r\n+      (promo.compra * producto.precio) +\r\n+      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n+    );\r\n+    const totalResto = resto * producto.precio;\r\n+    total = totalPromo + totalResto;\r\n+  } else {\r\n+    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n+  }\r\n+\r\n+  return total;\r\n+}\r\n+\r\n+// =========================\r\n // ABRIR / CERRAR SIDEBAR\r\n // =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n   overlay.classList.add(\"show\");\r\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n-  localStorage.setItem(\"sidebarAbierto\", \"true\"); // üîπ NUEVO: guardar estado\r\n+  history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n-\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n-  localStorage.removeItem(\"sidebarAbierto\"); // üîπ NUEVO: limpiar estado\r\n+  history.replaceState({}, \"\");\r\n }\r\n-\r\n-// Eventos abrir/cerrar sidebar\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  abrirSidebar();\r\n-});\r\n-cerrarCarrito?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-});\r\n-window.addEventListener(\"popstate\", () => {\r\n-  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n+abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n+cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n+window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n+window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n // =========================\r\n-// AGREGAR PRODUCTO\r\n+// AGREGAR AL CARRITO CON STOCK\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n   if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n+  const cantidadActual = existe ? existe.cantidad : 0;\r\n+\r\n+  const stockDisponible = producto.stock - cantidadActual;\r\n+  if (stockDisponible <= 0) {\r\n+    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n+    return;\r\n+  }\r\n+\r\n   if (existe) {\r\n     existe.cantidad++;\r\n   } else {\r\n     carrito.push({ ...producto, cantidad: 1 });\r\n@@ -111,9 +160,9 @@\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO (tabla)\r\n+// MOSTRAR CARRITO\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n@@ -126,72 +175,104 @@\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n-\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n+        <th>Descuento aplicado</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => `\r\n-        <tr>\r\n-          <td>\r\n-            <div class=\"carrito-item-info\">\r\n-              <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-              <div>\r\n-                <strong>${producto.nombre}</strong>\r\n-                <p>${producto.descripcion || \"\"}</p>\r\n+      ${carrito.map((producto, index) => {\r\n+        let descuentoAplicado = false;\r\n+        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n+\r\n+        return `\r\n+          <tr>\r\n+            <td>\r\n+              <div class=\"carrito-item-info\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <div>\r\n+                  <strong>${producto.nombre}</strong>\r\n+                  <p>${producto.descripcion || \"\"}</p>\r\n+                </div>\r\n               </div>\r\n-            </div>\r\n-          </td>\r\n-          <td>\r\n-            <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-            <span>${producto.cantidad}</span>\r\n-            <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-          </td>\r\n-          <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n-          <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-        </tr>\r\n-      `).join(\"\")}\r\n+            </td>\r\n+            <td>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+            </td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+          </tr>\r\n+        `;\r\n+      }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n-\r\n   carritoItems.appendChild(tabla);\r\n \r\n-  // Activar el scroll despu√©s de agregar el segundo producto\r\n-  if (carrito.length >= 2) {\r\n-    carritoItems.style.overflowY = 'auto';\r\n-  } else {\r\n-    carritoItems.style.overflowY = 'hidden';\r\n-  }\r\n-\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// GUARDAR CARRITO EN LOCALSTORAGE\r\n+// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n // =========================\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const index = e.target.dataset.index;\r\n+  if (index === undefined) return;\r\n+\r\n+  const producto = carrito[index];\r\n+  const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n+\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n+    // ‚ùå Eliminar solo con la X\r\n+    carrito.splice(index, 1);\r\n+\r\n+  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+    // ‚ûï Aumentar cantidad, respetando stock\r\n+    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n+      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+      return;\r\n+    }\r\n+    producto.cantidad++;\r\n+\r\n+  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+    // ‚ûñ No permitir menos de 1\r\n+    if (producto.cantidad > 1) {\r\n+      producto.cantidad--;\r\n+    } else {\r\n+      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+    }\r\n+  }\r\n+\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+});\r\n+\r\n+\r\n+// =========================\r\n+// GUARDAR EN LOCALSTORAGE\r\n+// =========================\r\n function guardarCarrito() {\r\n-  try {\r\n-    localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-  } catch (e) {\r\n-    console.error(\"Error al guardar carrito\", e);\r\n-  }\r\n+  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n+  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n }\r\n \r\n // =========================\r\n-// BARRA DE PROGRESO ENV√çO GRATIS\r\n+// TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n-const ENVIO_GRATIS_MINIMO = 65;\r\n-\r\n+const ENVIO_GRATIS_MINIMO = 99;\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n@@ -201,112 +282,158 @@\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"¬°Felicidades! Tienes env√≠o gratis üéâ\";\r\n+      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n+      mensajeEl.classList.add(\"gratis\");\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     } else {\r\n       mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n+\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n \r\n-// =========================\r\n-// TOTALES\r\n-// =========================\r\n function actualizarTotales() {\r\n-  const subtotal = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);\r\n-  const descuento = subtotal > 100 ? subtotal * 0.05 : 0;\r\n-  const total = subtotal - descuento;\r\n+  let subtotal = 0;\r\n+  let descuentoVolumenTotal = 0;\r\n+  let descuentoDirectoTotal = 0;\r\n \r\n-  subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  subtotalEl.classList.add('naranja');\r\n+  carrito.forEach(p => {\r\n+    const precioNormal = p.precio * p.cantidad;\r\n+    const precioConDescuento = calcularTotalProducto(p);\r\n+    subtotal += precioNormal;\r\n \r\n-  descuentoEl.textContent = `S/ ${descuento.toFixed(2)}`;\r\n-  descuentoEl.classList.add('naranja');\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+  });\r\n \r\n-  totalEl.textContent = `S/ ${total.toFixed(2)}`;\r\n-  totalEl.classList.add('naranja');\r\n+  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n+  const totalConDescuentos = subtotal - ahorroTotal;\r\n \r\n-  actualizarBarra(subtotal);\r\n+  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n+\r\n+  actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n // =========================\r\n-// CONTADOR (badge carrito)\r\n+// CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+\r\n+  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+\r\n+  // contador dentro del carrito (en el h2)\r\n+  const contadorInline = document.getElementById(\"contador-inline\");\r\n+  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n+\r\n // =========================\r\n-// TOAST (mensaje emergente)\r\n+// TOAST\r\n // =========================\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n     toast.id = \"mensajeCarrito\";\r\n     document.body.appendChild(toast);\r\n   }\r\n+  \r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-\r\n+  \r\n+  // Limpiar cualquier timeout anterior\r\n   clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n+  \r\n+  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n }\r\n \r\n+\r\n // =========================\r\n-// COMPRA POR WHATSAPP\r\n+// COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n-  const totalCompra = totalEl.innerText;\r\n-  const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${(p.precio * p.cantidad).toFixed(2)}`\r\n-  ).join(\", \");\r\n+  if (carrito.length === 0) {\r\n+    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n+    return;\r\n+  }\r\n \r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\nTotal: ${totalCompra}`;\r\n+  const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n+  const productos = carrito\r\n+    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n+    .join(\"\\n\");\r\n \r\n-  const telefono = \"51920165696\";\r\n-  const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-  window.open(url, \"_blank\");\r\n-}\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n+  const telefono = \"51929261925\"; // sin el \"+\"\r\n \r\n-// =========================\r\n-// EVENTOS DEL CARRITO\r\n-// =========================\r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const index = e.target.dataset.index;\r\n-  if (index === undefined) return;\r\n+  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n+    // ‚úÖ Intentar abrir directo la app\r\n+    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n-    carrito[index].cantidad++;\r\n-  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    carrito[index].cantidad--;\r\n-    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n+    // Intento directo\r\n+    window.location.href = appUrl;\r\n+\r\n+    // ‚è≥ Fallback en 1200ms\r\n+    setTimeout(() => {\r\n+      // Redirige al fallback solo si sigue en la misma p√°gina\r\n+      if (document.visibilityState === \"visible\") {\r\n+        window.location.href = fallbackUrl;\r\n+      }\r\n+      // Aqu√≠ reci√©n vaciamos el carrito\r\n+      vaciarCarritoDespuesEnvio();\r\n+    }, 1200);\r\n+\r\n+  } else {\r\n+    // ‚úÖ En PC: usar WhatsApp Web\r\n+    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    window.open(webUrl, \"_blank\");\r\n+\r\n+    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n+    vaciarCarritoDespuesEnvio();\r\n   }\r\n+}\r\n+\r\n+// Funci√≥n auxiliar\r\n+function vaciarCarritoDespuesEnvio() {\r\n+  carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n-});\r\n+  actualizarContador();\r\n+  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n \r\n-// Bot√≥n \"Agregar al carrito\"\r\n+  if (sidebar?.classList.contains(\"activo\")) {\r\n+    cerrarSidebar();\r\n+  }\r\n+}\r\n+\r\n+\r\n+// =========================\r\n+// LISTENERS GENERALES\r\n+// =========================\r\n+document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) {\r\n-    agregarAlCarrito(e.target.dataset.id);\r\n-  }\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n-\r\n-// Bot√≥n \"Ver carrito\" ‚Üí va a carrito.html\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n-\r\n-// Cerrar con tecla ESC\r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n@@ -314,9 +441,4 @@\n // INICIALIZAR\r\n // =========================\r\n mostrarCarrito();\r\n actualizarContador();\r\n-\r\n-// üîπ NUEVO: cerrar sidebar si qued√≥ abierto al volver de carrito.html\r\n-if (localStorage.getItem(\"sidebarAbierto\")) {\r\n-  cerrarSidebar();\r\n-}\r\n"
                },
                {
                    "date": 1760131705657,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,18 +29,8 @@\n   overlay.id = \"overlay-carrito\";\r\n   document.body.appendChild(overlay);\r\n }\r\n \r\n-// =========================\r\n-// CARGAR JSON DE PRODUCTOS\r\n-// =========================\r\n-fetch(\"productos.json\")\r\n-  .then(res => res.json())\r\n-  .then(data => {\r\n-    catalogo = [...data.productos, ...(data.ofertas || [])];\r\n-    renderProductos(catalogo);\r\n-  })\r\n-  .catch(err => console.error(\"Error cargando productos:\", err));\r\n \r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n"
                },
                {
                    "date": 1760131722294,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -28,8 +28,20 @@\n   overlay = document.createElement(\"div\");\r\n   overlay.id = \"overlay-carrito\";\r\n   document.body.appendChild(overlay);\r\n }\r\n+// =========================\r\n+// CONECTAR CON EL CAT√ÅLOGO DEL RENDER\r\n+// =========================\r\n+document.addEventListener(\"DOMContentLoaded\", () => {\r\n+  const esperarCatalogo = setInterval(() => {\r\n+    if (window.catalogo && window.catalogo.length > 0) {\r\n+      catalogo = window.catalogo;\r\n+      clearInterval(esperarCatalogo);\r\n+      console.log(\"‚úÖ Cat√°logo conectado al carrito:\", catalogo.length, \"productos\");\r\n+    }\r\n+  }, 300);\r\n+});\r\n \r\n \r\n // =========================\r\n // RENDER PRODUCTOS\r\n"
                },
                {
                    "date": 1760132256949,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -28,22 +28,11 @@\n   overlay = document.createElement(\"div\");\r\n   overlay.id = \"overlay-carrito\";\r\n   document.body.appendChild(overlay);\r\n }\r\n-// =========================\r\n-// CONECTAR CON EL CAT√ÅLOGO DEL RENDER\r\n-// =========================\r\n-document.addEventListener(\"DOMContentLoaded\", () => {\r\n-  const esperarCatalogo = setInterval(() => {\r\n-    if (window.catalogo && window.catalogo.length > 0) {\r\n-      catalogo = window.catalogo;\r\n-      clearInterval(esperarCatalogo);\r\n-      console.log(\"‚úÖ Cat√°logo conectado al carrito:\", catalogo.length, \"productos\");\r\n-    }\r\n-  }, 300);\r\n-});\r\n \r\n \r\n+\r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-container\");\r\n"
                },
                {
                    "date": 1760200381285,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n   return total;\r\n }\r\n \r\n // =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n+// ABRIR / CERRAR CARRITO O SIDERBAR \r\n // =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n"
                },
                {
                    "date": 1760200529848,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -111,13 +111,15 @@\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n+  document.activeElement.blur(); // üëà evita el warning de aria-hidden\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n+\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n"
                },
                {
                    "date": 1760200913426,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,9 +34,9 @@\n \r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n-const contenedorProductos = document.getElementById(\"productos-container\");\r\n+const contenedorProductos = document.getElementById(\"productos-grit\");\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n"
                },
                {
                    "date": 1760202151185,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,11 +15,10 @@\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n-let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-let catalogo = [];\r\n+let catalogo = window.catalogo || [];\r\n \r\n // =========================\r\n // CREAR OVERLAY\r\n // =========================\r\n"
                },
                {
                    "date": 1760202245123,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,9 +16,9 @@\n const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-let catalogo = window.catalogo || [];\r\n+const catalogo = window.catalogo || [];\r\n \r\n // =========================\r\n // CREAR OVERLAY\r\n // =========================\r\n"
                },
                {
                    "date": 1760202663383,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,10 +16,22 @@\n const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-const catalogo = window.catalogo || [];\r\n \r\n+// ‚úÖ Usar el cat√°logo global\r\n+let catalogo = window.catalogo || [];\r\n+\r\n+// ‚úÖ Esperar a que render.js avise que ya carg√≥ el cat√°logo\r\n+document.addEventListener(\"catalogoListo\", () => {\r\n+  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n+    catalogo = window.catalogo;\r\n+    console.log(\"üì¶ Cat√°logo recibido en carrito.js:\", catalogo.length, \"productos\");\r\n+  } else {\r\n+    console.warn(\"‚ö†Ô∏è No se pudo cargar el cat√°logo correctamente.\");\r\n+  }\r\n+});\r\n+\r\n // =========================\r\n // CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n"
                },
                {
                    "date": 1760202877232,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,10 +40,8 @@\n   overlay.id = \"overlay-carrito\";\r\n   document.body.appendChild(overlay);\r\n }\r\n \r\n-\r\n-\r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n const contenedorProductos = document.getElementById(\"productos-grit\");\r\n@@ -344,24 +342,51 @@\n \r\n // =========================\r\n // TOAST\r\n // =========================\r\n+\r\n+// ‚úÖ Declaramos la variable global antes de usarla\r\n+let toastTimeout = null;\r\n+\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n+\r\n+  // Si no existe el contenedor, lo creamos din√°micamente\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n     toast.id = \"mensajeCarrito\";\r\n     document.body.appendChild(toast);\r\n+\r\n+    // Agregamos estilos b√°sicos si no los tienes en CSS\r\n+    toast.style.position = \"fixed\";\r\n+    toast.style.bottom = \"30px\";\r\n+    toast.style.left = \"50%\";\r\n+    toast.style.transform = \"translateX(-50%)\";\r\n+    toast.style.background = \"#28a745\";\r\n+    toast.style.color = \"#fff\";\r\n+    toast.style.padding = \"12px 24px\";\r\n+    toast.style.borderRadius = \"8px\";\r\n+    toast.style.boxShadow = \"0 2px 8px rgba(0,0,0,0.2)\";\r\n+    toast.style.fontSize = \"14px\";\r\n+    toast.style.fontFamily = \"Poppins, sans-serif\";\r\n+    toast.style.opacity = \"0\";\r\n+    toast.style.transition = \"opacity 0.3s ease-in-out\";\r\n+    toast.style.zIndex = \"9999\";\r\n   }\r\n-  \r\n+\r\n+  // Mostrar mensaje\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-  \r\n-  // Limpiar cualquier timeout anterior\r\n+  toast.style.opacity = \"1\";\r\n+\r\n+  // Limpiar timeout anterior si existe\r\n   clearTimeout(toastTimeout);\r\n-  \r\n-  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n+\r\n+  // Ocultar el toast despu√©s de 800ms (0.8 segundos)\r\n+  toastTimeout = setTimeout(() => {\r\n+    toast.style.opacity = \"0\";\r\n+    toast.classList.remove(\"mostrar\");\r\n+  }, 800);\r\n }\r\n \r\n \r\n // =========================\r\n"
                },
                {
                    "date": 1760203001138,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -349,47 +349,26 @@\n \r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n \r\n-  // Si no existe el contenedor, lo creamos din√°micamente\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n     toast.id = \"mensajeCarrito\";\r\n     document.body.appendChild(toast);\r\n-\r\n-    // Agregamos estilos b√°sicos si no los tienes en CSS\r\n-    toast.style.position = \"fixed\";\r\n-    toast.style.bottom = \"30px\";\r\n-    toast.style.left = \"50%\";\r\n-    toast.style.transform = \"translateX(-50%)\";\r\n-    toast.style.background = \"#28a745\";\r\n-    toast.style.color = \"#fff\";\r\n-    toast.style.padding = \"12px 24px\";\r\n-    toast.style.borderRadius = \"8px\";\r\n-    toast.style.boxShadow = \"0 2px 8px rgba(0,0,0,0.2)\";\r\n-    toast.style.fontSize = \"14px\";\r\n-    toast.style.fontFamily = \"Poppins, sans-serif\";\r\n-    toast.style.opacity = \"0\";\r\n-    toast.style.transition = \"opacity 0.3s ease-in-out\";\r\n-    toast.style.zIndex = \"9999\";\r\n   }\r\n \r\n-  // Mostrar mensaje\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-  toast.style.opacity = \"1\";\r\n \r\n-  // Limpiar timeout anterior si existe\r\n+  // Limpiar cualquier timeout anterior\r\n   clearTimeout(toastTimeout);\r\n \r\n-  // Ocultar el toast despu√©s de 800ms (0.8 segundos)\r\n-  toastTimeout = setTimeout(() => {\r\n-    toast.style.opacity = \"0\";\r\n-    toast.classList.remove(\"mostrar\");\r\n-  }, 800);\r\n+  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n }\r\n \r\n \r\n+\r\n // =========================\r\n // COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n"
                },
                {
                    "date": 1760203500288,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -161,67 +161,75 @@\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n-// =========================\r\n-// MOSTRAR CARRITO\r\n-// =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n   if (carrito.length === 0) {\r\n-    carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n+    carritoItems.innerHTML = `<p class=\"carrito-vacio\">üõí Tu carrito est√° vac√≠o</p>`;\r\n     actualizarTotales();\r\n     actualizarContador();\r\n     return;\r\n   }\r\n \r\n-  const tabla = document.createElement(\"table\");\r\n-  tabla.classList.add(\"tabla-carrito\");\r\n-  tabla.innerHTML = `\r\n-    <thead>\r\n-      <tr>\r\n-        <th>Producto</th>\r\n-        <th>Cantidad</th>\r\n-        <th>Precio</th>\r\n-        <th>Descuento aplicado</th>\r\n-        <th>Acci√≥n</th>\r\n-      </tr>\r\n-    </thead>\r\n-    <tbody>\r\n-      ${carrito.map((producto, index) => {\r\n-        let descuentoAplicado = false;\r\n-        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n+  carrito.forEach((producto, index) => {\r\n+    const precioUnitario = producto.precio_con_descuento || producto.precio;\r\n+    const totalProducto = calcularTotalProducto(producto);\r\n+    const descuentoAplicado =\r\n+      (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) ||\r\n+      (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio);\r\n \r\n-        return `\r\n-          <tr>\r\n-            <td>\r\n-              <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-                <div>\r\n-                  <strong>${producto.nombre}</strong>\r\n-                  <p>${producto.descripcion || \"\"}</p>\r\n-                </div>\r\n-              </div>\r\n-            </td>\r\n-            <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-            </td>\r\n-            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-          </tr>\r\n-        `;\r\n-      }).join(\"\")}\r\n-    </tbody>\r\n-  `;\r\n-  carritoItems.appendChild(tabla);\r\n+    const item = document.createElement(\"div\");\r\n+    item.classList.add(\"carrito-item\");\r\n \r\n-  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n+    item.innerHTML = `\r\n+      <div class=\"carrito-item-img\">\r\n+        <img src=\"${producto.img}\" alt=\"${producto.nombre}\">\r\n+      </div>\r\n+\r\n+      <div class=\"carrito-item-detalles\">\r\n+        <h4>${producto.nombre}</h4>\r\n+        <p class=\"descripcion\">${producto.descripcion || \"\"}</p>\r\n+\r\n+        <div class=\"precios\">\r\n+          ${\r\n+            producto.precio_con_descuento\r\n+              ? `\r\n+                <span class=\"precio-tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n+                <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+              `\r\n+              : `<span class=\"precio-normal\">S/ ${producto.precio.toFixed(2)}</span>`\r\n+          }\r\n+        </div>\r\n+\r\n+        ${\r\n+          descuentoAplicado\r\n+            ? `<p class=\"descuento-info\">üí∏ Descuento aplicado</p>`\r\n+            : \"\"\r\n+        }\r\n+\r\n+        <div class=\"carrito-controles\">\r\n+          <button class=\"btn-decrementar\" data-index=\"${index}\">‚àí</button>\r\n+          <span class=\"cantidad\">${producto.cantidad}</span>\r\n+          <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+        </div>\r\n+\r\n+        <div class=\"carrito-total-item\">\r\n+          <strong>Total:</strong> S/ ${totalProducto.toFixed(2)}\r\n+        </div>\r\n+\r\n+        <button class=\"carrito-item-close\" data-index=\"${index}\" title=\"Eliminar\">\r\n+          üóë Quitar\r\n+        </button>\r\n+      </div>\r\n+    `;\r\n+\r\n+    carritoItems.appendChild(item);\r\n+  });\r\n+\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? \"auto\" : \"hidden\";\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n"
                },
                {
                    "date": 1760204669856,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -161,75 +161,67 @@\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n+// =========================\r\n+// MOSTRAR CARRITO\r\n+// =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n   if (carrito.length === 0) {\r\n-    carritoItems.innerHTML = `<p class=\"carrito-vacio\">üõí Tu carrito est√° vac√≠o</p>`;\r\n+    carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n     actualizarTotales();\r\n     actualizarContador();\r\n     return;\r\n   }\r\n \r\n-  carrito.forEach((producto, index) => {\r\n-    const precioUnitario = producto.precio_con_descuento || producto.precio;\r\n-    const totalProducto = calcularTotalProducto(producto);\r\n-    const descuentoAplicado =\r\n-      (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) ||\r\n-      (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio);\r\n+  const tabla = document.createElement(\"table\");\r\n+  tabla.classList.add(\"tabla-carrito\");\r\n+  tabla.innerHTML = `\r\n+    <thead>\r\n+      <tr>\r\n+        <th>Producto</th>\r\n+        <th>Cantidad</th>\r\n+        <th>Precio</th>\r\n+        <th>Descuento aplicado</th>\r\n+        <th>Acci√≥n</th>\r\n+      </tr>\r\n+    </thead>\r\n+    <tbody>\r\n+      ${carrito.map((producto, index) => {\r\n+        let descuentoAplicado = false;\r\n+        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n \r\n-    const item = document.createElement(\"div\");\r\n-    item.classList.add(\"carrito-item\");\r\n+        return `\r\n+          <tr>\r\n+            <td>\r\n+              <div class=\"carrito-item-info\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <div>\r\n+                  <strong>${producto.nombre}</strong>\r\n+                  <p>${producto.descripcion || \"\"}</p>\r\n+                </div>\r\n+              </div>\r\n+            </td>\r\n+            <td>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+            </td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+          </tr>\r\n+        `;\r\n+      }).join(\"\")}\r\n+    </tbody>\r\n+  `;\r\n+  carritoItems.appendChild(tabla);\r\n \r\n-    item.innerHTML = `\r\n-      <div class=\"carrito-item-img\">\r\n-        <img src=\"${producto.img}\" alt=\"${producto.nombre}\">\r\n-      </div>\r\n-\r\n-      <div class=\"carrito-item-detalles\">\r\n-        <h4>${producto.nombre}</h4>\r\n-        <p class=\"descripcion\">${producto.descripcion || \"\"}</p>\r\n-\r\n-        <div class=\"precios\">\r\n-          ${\r\n-            producto.precio_con_descuento\r\n-              ? `\r\n-                <span class=\"precio-tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n-                <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n-              `\r\n-              : `<span class=\"precio-normal\">S/ ${producto.precio.toFixed(2)}</span>`\r\n-          }\r\n-        </div>\r\n-\r\n-        ${\r\n-          descuentoAplicado\r\n-            ? `<p class=\"descuento-info\">üí∏ Descuento aplicado</p>`\r\n-            : \"\"\r\n-        }\r\n-\r\n-        <div class=\"carrito-controles\">\r\n-          <button class=\"btn-decrementar\" data-index=\"${index}\">‚àí</button>\r\n-          <span class=\"cantidad\">${producto.cantidad}</span>\r\n-          <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-        </div>\r\n-\r\n-        <div class=\"carrito-total-item\">\r\n-          <strong>Total:</strong> S/ ${totalProducto.toFixed(2)}\r\n-        </div>\r\n-\r\n-        <button class=\"carrito-item-close\" data-index=\"${index}\" title=\"Eliminar\">\r\n-          üóë Quitar\r\n-        </button>\r\n-      </div>\r\n-    `;\r\n-\r\n-    carritoItems.appendChild(item);\r\n-  });\r\n-\r\n-  carritoItems.style.overflowY = carrito.length >= 2 ? \"auto\" : \"hidden\";\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n"
                },
                {
                    "date": 1760204932293,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -161,11 +161,8 @@\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n-// =========================\r\n-// MOSTRAR CARRITO\r\n-// =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n@@ -183,9 +180,9 @@\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n-        <th>Descuento aplicado</th>\r\n+        <th>Descuento</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n@@ -197,31 +194,34 @@\n         return `\r\n           <tr>\r\n             <td>\r\n               <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\">\r\n                 <div>\r\n                   <strong>${producto.nombre}</strong>\r\n                   <p>${producto.descripcion || \"\"}</p>\r\n                 </div>\r\n               </div>\r\n             </td>\r\n             <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+              <div class=\"qty-control\">\r\n+                <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+                <span>${producto.cantidad}</span>\r\n+                <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+              </div>\r\n             </td>\r\n-            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n             <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+            <td><button class=\"btn-remove\" data-index=\"${index}\">‚úï</button></td>\r\n           </tr>\r\n         `;\r\n       }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n+\r\n   carritoItems.appendChild(tabla);\r\n \r\n-  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? \"auto\" : \"hidden\";\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n"
                },
                {
                    "date": 1760204975479,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -161,8 +161,11 @@\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n+// =========================\r\n+// MOSTRAR CARRITO\r\n+// =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n@@ -180,9 +183,9 @@\n       <tr>\r\n         <th>Producto</th>\r\n         <th>Cantidad</th>\r\n         <th>Precio</th>\r\n-        <th>Descuento</th>\r\n+        <th>Descuento aplicado</th>\r\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n@@ -194,34 +197,31 @@\n         return `\r\n           <tr>\r\n             <td>\r\n               <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n                 <div>\r\n                   <strong>${producto.nombre}</strong>\r\n                   <p>${producto.descripcion || \"\"}</p>\r\n                 </div>\r\n               </div>\r\n             </td>\r\n             <td>\r\n-              <div class=\"qty-control\">\r\n-                <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-                <span>${producto.cantidad}</span>\r\n-                <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n-              </div>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n             </td>\r\n-            <td>S/ ${(producto.precio * producto.cantidad).toFixed(2)}</td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n             <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"btn-remove\" data-index=\"${index}\">‚úï</button></td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n           </tr>\r\n         `;\r\n       }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n-\r\n   carritoItems.appendChild(tabla);\r\n \r\n-  carritoItems.style.overflowY = carrito.length >= 2 ? \"auto\" : \"hidden\";\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n"
                },
                {
                    "date": 1760205534758,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -229,35 +229,40 @@\n // =========================\r\n // ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n-  const index = e.target.dataset.index;\r\n+  // ‚úÖ Captura el bot√≥n m√°s cercano al clic (para evitar problemas con spans o √≠conos internos)\r\n+  const boton = e.target.closest(\"button\");\r\n+  if (!boton) return;\r\n+\r\n+  const index = boton.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n   const producto = carrito[index];\r\n   const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n \r\n-  if (e.target.classList.contains(\"carrito-item-close\")) {\r\n-    // ‚ùå Eliminar solo con la X\r\n+  if (boton.classList.contains(\"carrito-item-close\")) {\r\n+    // ‚ùå Eliminar producto del carrito\r\n     carrito.splice(index, 1);\r\n \r\n-  } else if (e.target.classList.contains(\"btn-incrementar\")) {\r\n+  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n     // ‚ûï Aumentar cantidad, respetando stock\r\n     if (producto.cantidad + 1 > catalogoProd.stock) {\r\n       mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n       return;\r\n     }\r\n     producto.cantidad++;\r\n \r\n-  } else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    // ‚ûñ No permitir menos de 1\r\n+  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+    // ‚ûñ Reducir cantidad, sin permitir menos de 1\r\n     if (producto.cantidad > 1) {\r\n       producto.cantidad--;\r\n     } else {\r\n       mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n     }\r\n   }\r\n \r\n+  // ‚úÖ Guardar y actualizar todo\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n"
                },
                {
                    "date": 1760205623115,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -229,9 +229,8 @@\n // =========================\r\n // ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n-  // ‚úÖ Captura el bot√≥n m√°s cercano al clic (para evitar problemas con spans o √≠conos internos)\r\n   const boton = e.target.closest(\"button\");\r\n   if (!boton) return;\r\n \r\n   const index = boton.dataset.index;\r\n@@ -239,30 +238,31 @@\n \r\n   const producto = carrito[index];\r\n   const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n \r\n+  // üõë Si no se encuentra el producto en el cat√°logo\r\n+  if (!catalogoProd) {\r\n+    console.warn(`Producto con ID ${producto.id} no encontrado en cat√°logo`);\r\n+    mostrarToast(`Este producto ya no est√° disponible ‚ùå`);\r\n+    return;\r\n+  }\r\n+\r\n   if (boton.classList.contains(\"carrito-item-close\")) {\r\n-    // ‚ùå Eliminar producto del carrito\r\n     carrito.splice(index, 1);\r\n-\r\n   } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    // ‚ûï Aumentar cantidad, respetando stock\r\n     if (producto.cantidad + 1 > catalogoProd.stock) {\r\n       mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n       return;\r\n     }\r\n     producto.cantidad++;\r\n-\r\n   } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-    // ‚ûñ Reducir cantidad, sin permitir menos de 1\r\n     if (producto.cantidad > 1) {\r\n       producto.cantidad--;\r\n     } else {\r\n       mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n     }\r\n   }\r\n \r\n-  // ‚úÖ Guardar y actualizar todo\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n"
                },
                {
                    "date": 1760205858795,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -228,34 +228,43 @@\n \r\n // =========================\r\n // ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n // =========================\r\n+// =========================\r\n+// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n+// =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const boton = e.target.closest(\"button\");\r\n   if (!boton) return;\r\n \r\n   const index = boton.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n   const producto = carrito[index];\r\n-  const catalogoProd = catalogo.find(p => p.id == producto.id);\r\n \r\n-  // üõë Si no se encuentra el producto en el cat√°logo\r\n-  if (!catalogoProd) {\r\n-    console.warn(`Producto con ID ${producto.id} no encontrado en cat√°logo`);\r\n-    mostrarToast(`Este producto ya no est√° disponible ‚ùå`);\r\n-    return;\r\n-  }\r\n+  // üîç Buscar el producto en el cat√°logo sin importar si el ID es n√∫mero o string\r\n+  const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n \r\n   if (boton.classList.contains(\"carrito-item-close\")) {\r\n+    // ‚ùå Eliminar producto\r\n     carrito.splice(index, 1);\r\n+\r\n   } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    if (producto.cantidad + 1 > catalogoProd.stock) {\r\n-      mostrarToast(`No hay suficiente stock de ${producto.nombre} üõë`);\r\n+    // ‚ûï Incrementar cantidad, respetando stock\r\n+    if (!catalogoProd) {\r\n+      console.warn(`‚ö†Ô∏è Producto ID ${producto.id} no encontrado en cat√°logo`);\r\n+      mostrarToast(`Producto no encontrado en cat√°logo ‚ö†Ô∏è`);\r\n       return;\r\n     }\r\n-    producto.cantidad++;\r\n+\r\n+    if (producto.cantidad < catalogoProd.stock) {\r\n+      producto.cantidad++;\r\n+    } else {\r\n+      mostrarToast(`Solo hay ${catalogoProd.stock} unidades de ${producto.nombre} üõë`);\r\n+    }\r\n+\r\n   } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+    // ‚ûñ Reducir cantidad, m√≠nimo 1\r\n     if (producto.cantidad > 1) {\r\n       producto.cantidad--;\r\n     } else {\r\n       mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n"
                },
                {
                    "date": 1760206159795,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,21 +17,17 @@\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n \r\n-// ‚úÖ Usar el cat√°logo global\r\n-let catalogo = window.catalogo || [];\r\n \r\n-// ‚úÖ Esperar a que render.js avise que ya carg√≥ el cat√°logo\r\n-document.addEventListener(\"catalogoListo\", () => {\r\n-  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n-    catalogo = window.catalogo;\r\n-    console.log(\"üì¶ Cat√°logo recibido en carrito.js:\", catalogo.length, \"productos\");\r\n-  } else {\r\n-    console.warn(\"‚ö†Ô∏è No se pudo cargar el cat√°logo correctamente.\");\r\n-  }\r\n-});\r\n+let catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n \r\n+// üß© Si el cat√°logo todav√≠a no est√° cargado, intentar recuperarlo desde window.catalogo\r\n+if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n+  catalogo = window.catalogo;\r\n+  catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+}\r\n+\r\n // =========================\r\n // CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n"
                },
                {
                    "date": 1760206257401,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,17 +17,21 @@\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n \r\n+// ‚úÖ Usar el cat√°logo global\r\n+let catalogo = window.catalogo || [];\r\n \r\n-let catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+// ‚úÖ Esperar a que render.js avise que ya carg√≥ el cat√°logo\r\n+document.addEventListener(\"catalogoListo\", () => {\r\n+  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n+    catalogo = window.catalogo;\r\n+    console.log(\"üì¶ Cat√°logo recibido en carrito.js:\", catalogo.length, \"productos\");\r\n+  } else {\r\n+    console.warn(\"‚ö†Ô∏è No se pudo cargar el cat√°logo correctamente.\");\r\n+  }\r\n+});\r\n \r\n-// üß© Si el cat√°logo todav√≠a no est√° cargado, intentar recuperarlo desde window.catalogo\r\n-if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n-  catalogo = window.catalogo;\r\n-  catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-}\r\n-\r\n // =========================\r\n // CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n@@ -224,55 +228,66 @@\n \r\n // =========================\r\n // ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n // =========================\r\n-// =========================\r\n-// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n-// =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n+  // ‚úÖ Captura el bot√≥n m√°s cercano al clic (para evitar problemas con spans o √≠conos internos)\r\n   const boton = e.target.closest(\"button\");\r\n   if (!boton) return;\r\n \r\n   const index = boton.dataset.index;\r\n   if (index === undefined) return;\r\n \r\n   const producto = carrito[index];\r\n+  if (!producto) return;\r\n \r\n-  // üîç Buscar el producto en el cat√°logo sin importar si el ID es n√∫mero o string\r\n-  const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+  // ‚úÖ Buscar producto en el cat√°logo\r\n+  let catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n \r\n+  // üß© Si el cat√°logo todav√≠a no est√° cargado, intentar recuperarlo desde window.catalogo\r\n+  if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n+    catalogo = window.catalogo;\r\n+    catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+  }\r\n+\r\n+  // ‚ö†Ô∏è Si a√∫n no existe el producto en el cat√°logo, mostrar advertencia y salir\r\n+  if (!catalogoProd) {\r\n+    console.warn(`‚ö†Ô∏è Producto ID ${producto.id} no encontrado en cat√°logo`);\r\n+    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible actualmente üõë`);\r\n+    return;\r\n+  }\r\n+\r\n+  // =========================\r\n+  // ACCIONES DEL CARRITO\r\n+  // =========================\r\n   if (boton.classList.contains(\"carrito-item-close\")) {\r\n-    // ‚ùå Eliminar producto\r\n+    // ‚ùå Eliminar producto del carrito\r\n     carrito.splice(index, 1);\r\n \r\n   } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    // ‚ûï Incrementar cantidad, respetando stock\r\n-    if (!catalogoProd) {\r\n-      console.warn(`‚ö†Ô∏è Producto ID ${producto.id} no encontrado en cat√°logo`);\r\n-      mostrarToast(`Producto no encontrado en cat√°logo ‚ö†Ô∏è`);\r\n-      return;\r\n-    }\r\n-\r\n+    // ‚ûï Aumentar cantidad, respetando stock\r\n     if (producto.cantidad < catalogoProd.stock) {\r\n       producto.cantidad++;\r\n     } else {\r\n-      mostrarToast(`Solo hay ${catalogoProd.stock} unidades de ${producto.nombre} üõë`);\r\n+      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n     }\r\n \r\n   } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-    // ‚ûñ Reducir cantidad, m√≠nimo 1\r\n+    // ‚ûñ Reducir cantidad, sin permitir menos de 1\r\n     if (producto.cantidad > 1) {\r\n       producto.cantidad--;\r\n     } else {\r\n       mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n     }\r\n   }\r\n \r\n+  // ‚úÖ Guardar y actualizar todo\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n \r\n+\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n"
                },
                {
                    "date": 1760206513425,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -229,9 +229,8 @@\n // =========================\r\n // ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n-  // ‚úÖ Captura el bot√≥n m√°s cercano al clic (para evitar problemas con spans o √≠conos internos)\r\n   const boton = e.target.closest(\"button\");\r\n   if (!boton) return;\r\n \r\n   const index = boton.dataset.index;\r\n@@ -239,18 +238,17 @@\n \r\n   const producto = carrito[index];\r\n   if (!producto) return;\r\n \r\n-  // ‚úÖ Buscar producto en el cat√°logo\r\n+  // ‚úÖ Buscar producto original en cat√°logo\r\n   let catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n \r\n-  // üß© Si el cat√°logo todav√≠a no est√° cargado, intentar recuperarlo desde window.catalogo\r\n+  // üß© Si el cat√°logo no est√° cargado a√∫n, intentar recuperarlo\r\n   if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n     catalogo = window.catalogo;\r\n     catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n   }\r\n \r\n-  // ‚ö†Ô∏è Si a√∫n no existe el producto en el cat√°logo, mostrar advertencia y salir\r\n   if (!catalogoProd) {\r\n     console.warn(`‚ö†Ô∏è Producto ID ${producto.id} no encontrado en cat√°logo`);\r\n     mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible actualmente üõë`);\r\n     return;\r\n@@ -259,35 +257,35 @@\n   // =========================\r\n   // ACCIONES DEL CARRITO\r\n   // =========================\r\n   if (boton.classList.contains(\"carrito-item-close\")) {\r\n-    // ‚ùå Eliminar producto del carrito\r\n     carrito.splice(index, 1);\r\n \r\n   } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    // ‚ûï Aumentar cantidad, respetando stock\r\n+    // ‚ûï Aumentar cantidad respetando stock\r\n     if (producto.cantidad < catalogoProd.stock) {\r\n       producto.cantidad++;\r\n+      // ‚úÖ Asegurar precios actualizados desde el cat√°logo\r\n+      producto.precio = catalogoProd.precio;\r\n+      producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n+      producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n     } else {\r\n       mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n     }\r\n \r\n   } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-    // ‚ûñ Reducir cantidad, sin permitir menos de 1\r\n+    // ‚ûñ Reducir cantidad sin permitir menos de 1\r\n     if (producto.cantidad > 1) {\r\n       producto.cantidad--;\r\n     } else {\r\n       mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n     }\r\n   }\r\n \r\n-  // ‚úÖ Guardar y actualizar todo\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n-\r\n-\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n"
                },
                {
                    "date": 1760206583574,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -205,11 +205,12 @@\n                 </div>\r\n               </div>\r\n             </td>\r\n             <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">-</button>\r\n+<span>${producto.cantidad}</span>\r\n+<button class=\"btn-incrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">+</button>\r\n+\r\n             </td>\r\n             <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n             <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n             <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n"
                },
                {
                    "date": 1760207536239,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,17 +18,22 @@\n \r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n \r\n // ‚úÖ Usar el cat√°logo global\r\n-let catalogo = window.catalogo || [];\r\n+let catalogo = [];\r\n \r\n-// ‚úÖ Esperar a que render.js avise que ya carg√≥ el cat√°logo\r\n+// Si window.catalogo ya est√° listo, √∫salo\r\n+if (window.catalogo && Array.isArray(window.catalogo)) {\r\n+  catalogo = window.catalogo;\r\n+  console.log(\"üì¶ Cat√°logo inicial cargado:\", catalogo.length, \"productos\");\r\n+}\r\n+\r\n+// Escucha el evento por si se carga despu√©s\r\n document.addEventListener(\"catalogoListo\", () => {\r\n   if (window.catalogo && Array.isArray(window.catalogo)) {\r\n     catalogo = window.catalogo;\r\n-    console.log(\"üì¶ Cat√°logo recibido en carrito.js:\", catalogo.length, \"productos\");\r\n-  } else {\r\n-    console.warn(\"‚ö†Ô∏è No se pudo cargar el cat√°logo correctamente.\");\r\n+    console.log(\"üì¶ Cat√°logo actualizado en carrito.js:\", catalogo.length, \"productos\");\r\n+    mostrarCarrito(); // ‚úÖ actualizar carrito si ya hab√≠a productos\r\n   }\r\n });\r\n \r\n // =========================\r\n"
                },
                {
                    "date": 1760207688370,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -260,38 +260,49 @@\n     return;\r\n   }\r\n \r\n   // =========================\r\n-  // ACCIONES DEL CARRITO\r\n-  // =========================\r\n-  if (boton.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n+// ACCIONES DEL CARRITO\r\n+// =========================\r\n+if (boton.classList.contains(\"carrito-item-close\")) {\r\n+  carrito.splice(index, 1);\r\n \r\n-  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    // ‚ûï Aumentar cantidad respetando stock\r\n-    if (producto.cantidad < catalogoProd.stock) {\r\n-      producto.cantidad++;\r\n-      // ‚úÖ Asegurar precios actualizados desde el cat√°logo\r\n-      producto.precio = catalogoProd.precio;\r\n-      producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n-      producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n-    } else {\r\n-      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n-    }\r\n+} else if (boton.classList.contains(\"btn-incrementar\")) {\r\n+  // ‚ûï Aumentar cantidad respetando stock\r\n \r\n-  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-    // ‚ûñ Reducir cantidad sin permitir menos de 1\r\n-    if (producto.cantidad > 1) {\r\n-      producto.cantidad--;\r\n-    } else {\r\n-      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n-    }\r\n+  // üîÑ Intentar recuperar producto del cat√°logo si no existe\r\n+  if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n+    catalogo = window.catalogo;\r\n+    catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n   }\r\n \r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n+  if (!catalogoProd) {\r\n+    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible actualmente üõë`);\r\n+    return;\r\n+  }\r\n \r\n+  if (producto.cantidad < catalogoProd.stock) {\r\n+    producto.cantidad++;\r\n+    // ‚úÖ Asegurar precios actualizados desde el cat√°logo\r\n+    producto.precio = catalogoProd.precio;\r\n+    producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n+    producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n+  } else {\r\n+    mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n+  }\r\n+\r\n+} else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+  // ‚ûñ Reducir cantidad sin permitir menos de 1\r\n+  if (producto.cantidad > 1) {\r\n+    producto.cantidad--;\r\n+  } else {\r\n+    mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+  }\r\n+}\r\n+\r\n+guardarCarrito();\r\n+mostrarCarrito();\r\n+\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n"
                },
                {
                    "date": 1760207840438,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -138,14 +138,20 @@\n cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n-// =========================\r\n-// AGREGAR AL CARRITO CON STOCK\r\n-// =========================\r\n function agregarAlCarrito(idProducto) {\r\n+  // ‚úÖ Asegurarnos de que el cat√°logo exista\r\n+  if (!catalogo || catalogo.length === 0) {\r\n+    mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n+    return;\r\n+  }\r\n+\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n-  if (!producto) return;\r\n+  if (!producto) {\r\n+    mostrarToast(\"‚ö†Ô∏è Producto no encontrado en cat√°logo\");\r\n+    return;\r\n+  }\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n   const cantidadActual = existe ? existe.cantidad : 0;\r\n \r\n"
                },
                {
                    "date": 1760208233523,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -48,9 +48,10 @@\n \r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n-const contenedorProductos = document.getElementById(\"productos-grit\");\r\n+const contenedorProductos = document.getElementById(\"productos-grid\"); // cambiar \"productos-grit\" por \"productos-grid\"\r\n+\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n"
                },
                {
                    "date": 1760208362891,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -265,9 +265,9 @@\n     console.warn(`‚ö†Ô∏è Producto ID ${producto.id} no encontrado en cat√°logo`);\r\n     mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible actualmente üõë`);\r\n     return;\r\n   }\r\n-\r\n+});\r\n   // =========================\r\n // ACCIONES DEL CARRITO\r\n // =========================\r\n if (boton.classList.contains(\"carrito-item-close\")) {\r\n"
                },
                {
                    "date": 1760209269151,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -265,51 +265,40 @@\n     console.warn(`‚ö†Ô∏è Producto ID ${producto.id} no encontrado en cat√°logo`);\r\n     mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible actualmente üõë`);\r\n     return;\r\n   }\r\n-});\r\n+\r\n   // =========================\r\n-// ACCIONES DEL CARRITO\r\n-// =========================\r\n-if (boton.classList.contains(\"carrito-item-close\")) {\r\n-  carrito.splice(index, 1);\r\n+  // ACCIONES DEL CARRITO\r\n+  // =========================\r\n+  if (boton.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n \r\n-} else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-  // ‚ûï Aumentar cantidad respetando stock\r\n+  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n+    if (producto.cantidad < catalogoProd.stock) {\r\n+      producto.cantidad++;\r\n+      // Actualizar precios desde el cat√°logo\r\n+      producto.precio = catalogoProd.precio;\r\n+      producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n+      producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n+    } else {\r\n+      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n+    }\r\n \r\n-  // üîÑ Intentar recuperar producto del cat√°logo si no existe\r\n-  if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n-    catalogo = window.catalogo;\r\n-    catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+    if (producto.cantidad > 1) {\r\n+      producto.cantidad--;\r\n+    } else {\r\n+      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+    }\r\n   }\r\n \r\n-  if (!catalogoProd) {\r\n-    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible actualmente üõë`);\r\n-    return;\r\n-  }\r\n+  // ‚úÖ Actualizar carrito y totales\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+});\r\n \r\n-  if (producto.cantidad < catalogoProd.stock) {\r\n-    producto.cantidad++;\r\n-    // ‚úÖ Asegurar precios actualizados desde el cat√°logo\r\n-    producto.precio = catalogoProd.precio;\r\n-    producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n-    producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n-  } else {\r\n-    mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n-  }\r\n-\r\n-} else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-  // ‚ûñ Reducir cantidad sin permitir menos de 1\r\n-  if (producto.cantidad > 1) {\r\n-    producto.cantidad--;\r\n-  } else {\r\n-    mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n-  }\r\n-}\r\n-\r\n-guardarCarrito();\r\n-mostrarCarrito();\r\n-\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n"
                },
                {
                    "date": 1760209422752,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -251,54 +251,53 @@\n \r\n   const producto = carrito[index];\r\n   if (!producto) return;\r\n \r\n-  // ‚úÖ Buscar producto original en cat√°logo\r\n+  // Buscar producto original en cat√°logo\r\n   let catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-\r\n-  // üß© Si el cat√°logo no est√° cargado a√∫n, intentar recuperarlo\r\n   if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n     catalogo = window.catalogo;\r\n     catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n   }\r\n \r\n   if (!catalogoProd) {\r\n-    console.warn(`‚ö†Ô∏è Producto ID ${producto.id} no encontrado en cat√°logo`);\r\n     mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible actualmente üõë`);\r\n     return;\r\n   }\r\n \r\n-  // =========================\r\n-  // ACCIONES DEL CARRITO\r\n-  // =========================\r\n+  // ACCIONES\r\n   if (boton.classList.contains(\"carrito-item-close\")) {\r\n+    // Quitar producto del carrito\r\n     carrito.splice(index, 1);\r\n-    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n+    mostrarToast(`Producto \"${producto.nombre}\" eliminado del carrito üõí`);\r\n \r\n   } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n+    // Incrementar cantidad respetando stock\r\n     if (producto.cantidad < catalogoProd.stock) {\r\n       producto.cantidad++;\r\n-      // Actualizar precios desde el cat√°logo\r\n+      // Actualizar precios desde cat√°logo\r\n       producto.precio = catalogoProd.precio;\r\n       producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n       producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n     } else {\r\n       mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n     }\r\n \r\n   } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+    // Reducir cantidad sin permitir menos de 1\r\n     if (producto.cantidad > 1) {\r\n       producto.cantidad--;\r\n     } else {\r\n       mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n     }\r\n   }\r\n \r\n-  // ‚úÖ Actualizar carrito y totales\r\n+  // Guardar y actualizar carrito\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n+\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n"
                },
                {
                    "date": 1760209604327,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,487 @@\n+// =========================\r\n+// ELEMENTOS DEL CARRITO\r\n+// =========================\r\n+const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n+const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n+const cerrarCarrito      = document.querySelector(\".cerrar-carrito\");\r\n+const carritoItems       = document.getElementById(\"carrito-items\");\r\n+\r\n+const subtotalEl         = document.getElementById(\"subtotal\");\r\n+const totalEl            = document.getElementById(\"total\");\r\n+const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n+\r\n+// Campos para descuentos y env√≠o\r\n+const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n+const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n+const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n+const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n+\r\n+let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+\r\n+// ‚úÖ Usar el cat√°logo global\r\n+let catalogo = [];\r\n+\r\n+// Si window.catalogo ya est√° listo, √∫salo\r\n+if (window.catalogo && Array.isArray(window.catalogo)) {\r\n+  catalogo = window.catalogo;\r\n+  console.log(\"üì¶ Cat√°logo inicial cargado:\", catalogo.length, \"productos\");\r\n+}\r\n+\r\n+// Escucha el evento por si se carga despu√©s\r\n+document.addEventListener(\"catalogoListo\", () => {\r\n+  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n+    catalogo = window.catalogo;\r\n+    console.log(\"üì¶ Cat√°logo actualizado en carrito.js:\", catalogo.length, \"productos\");\r\n+    mostrarCarrito(); // ‚úÖ actualizar carrito si ya hab√≠a productos\r\n+  }\r\n+});\r\n+\r\n+// =========================\r\n+// CREAR OVERLAY\r\n+// =========================\r\n+let overlay = document.getElementById(\"overlay-carrito\");\r\n+if (!overlay) {\r\n+  overlay = document.createElement(\"div\");\r\n+  overlay.id = \"overlay-carrito\";\r\n+  document.body.appendChild(overlay);\r\n+}\r\n+\r\n+// =========================\r\n+// RENDER PRODUCTOS\r\n+// =========================\r\n+const contenedorProductos = document.getElementById(\"productos-grid\"); // cambiar \"productos-grit\" por \"productos-grid\"\r\n+\r\n+function renderProductos(lista) {\r\n+  if (!contenedorProductos) return;\r\n+  contenedorProductos.innerHTML = \"\";\r\n+  lista.forEach(producto => {\r\n+    const div = document.createElement(\"div\");\r\n+    div.classList.add(\"producto\");\r\n+\r\n+    // ‚úÖ Mostrar precios correctamente\r\n+    let precioHTML = \"\";\r\n+    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n+          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    } else {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    }\r\n+\r\n+    div.innerHTML = `\r\n+      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n+      <h4>${producto.nombre}</h4>\r\n+      <p>${producto.descripcion || \"\"}</p>\r\n+      ${precioHTML}\r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n+      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n+    `;\r\n+\r\n+    contenedorProductos.appendChild(div);\r\n+  });\r\n+}\r\n+\r\n+\r\n+// =========================\r\n+// CALCULAR TOTAL POR PRODUCTO\r\n+// =========================\r\n+function calcularTotalProducto(producto) {\r\n+  let total = 0;\r\n+  const cantidad = producto.cantidad;\r\n+\r\n+  if (producto.descuentoVolumen) {\r\n+    const promo = producto.descuentoVolumen;\r\n+    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+    const resto = cantidad % promo.aplicaA;\r\n+    const totalPromo = vecesPromo * (\r\n+      (promo.compra * producto.precio) +\r\n+      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n+    );\r\n+    const totalResto = resto * producto.precio;\r\n+    total = totalPromo + totalResto;\r\n+  } else {\r\n+    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n+  }\r\n+\r\n+  return total;\r\n+}\r\n+\r\n+// =========================\r\n+// ABRIR / CERRAR CARRITO O SIDERBAR \r\n+// =========================\r\n+function abrirSidebar() {\r\n+  if (!sidebar) return;\r\n+  sidebar.classList.add(\"activo\");\r\n+  overlay.classList.add(\"show\");\r\n+  document.body.style.overflow = \"hidden\";\r\n+  mostrarCarrito();\r\n+  history.pushState({ carritoAbierto: true }, \"\");\r\n+}\r\n+function cerrarSidebar() {\r\n+  if (!sidebar) return;\r\n+  document.activeElement.blur(); // üëà evita el warning de aria-hidden\r\n+  sidebar.classList.remove(\"activo\");\r\n+  overlay.classList.remove(\"show\");\r\n+  document.body.style.overflow = \"auto\";\r\n+  history.replaceState({}, \"\");\r\n+}\r\n+\r\n+overlay?.addEventListener(\"click\", cerrarSidebar);\r\n+abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n+cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n+window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n+window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n+\r\n+function agregarAlCarrito(idProducto) {\r\n+  // ‚úÖ Asegurarnos de que el cat√°logo exista\r\n+  if (!catalogo || catalogo.length === 0) {\r\n+    mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n+    return;\r\n+  }\r\n+\r\n+  const producto = catalogo.find(p => p.id == idProducto);\r\n+  if (!producto) {\r\n+    mostrarToast(\"‚ö†Ô∏è Producto no encontrado en cat√°logo\");\r\n+    return;\r\n+  }\r\n+\r\n+  const existe = carrito.find(p => p.id == idProducto);\r\n+  const cantidadActual = existe ? existe.cantidad : 0;\r\n+\r\n+  const stockDisponible = producto.stock - cantidadActual;\r\n+  if (stockDisponible <= 0) {\r\n+    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n+    return;\r\n+  }\r\n+\r\n+  if (existe) {\r\n+    existe.cantidad++;\r\n+  } else {\r\n+    carrito.push({ ...producto, cantidad: 1 });\r\n+  }\r\n+\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+  actualizarContador();\r\n+  mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n+}\r\n+\r\n+// =========================\r\n+// MOSTRAR CARRITO\r\n+// =========================\r\n+function mostrarCarrito() {\r\n+  if (!carritoItems) return;\r\n+  carritoItems.innerHTML = \"\";\r\n+\r\n+  if (carrito.length === 0) {\r\n+    carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n+    actualizarTotales();\r\n+    actualizarContador();\r\n+    return;\r\n+  }\r\n+\r\n+  const tabla = document.createElement(\"table\");\r\n+  tabla.classList.add(\"tabla-carrito\");\r\n+  tabla.innerHTML = `\r\n+    <thead>\r\n+      <tr>\r\n+        <th>Producto</th>\r\n+        <th>Cantidad</th>\r\n+        <th>Precio</th>\r\n+        <th>Descuento aplicado</th>\r\n+        <th>Acci√≥n</th>\r\n+      </tr>\r\n+    </thead>\r\n+    <tbody>\r\n+      ${carrito.map((producto, index) => {\r\n+        let descuentoAplicado = false;\r\n+        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n+\r\n+        return `\r\n+          <tr>\r\n+            <td>\r\n+              <div class=\"carrito-item-info\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <div>\r\n+                  <strong>${producto.nombre}</strong>\r\n+                  <p>${producto.descripcion || \"\"}</p>\r\n+                </div>\r\n+              </div>\r\n+            </td>\r\n+            <td>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">-</button>\r\n+<span>${producto.cantidad}</span>\r\n+<button class=\"btn-incrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">+</button>\r\n+\r\n+            </td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+          </tr>\r\n+        `;\r\n+      }).join(\"\")}\r\n+    </tbody>\r\n+  `;\r\n+  carritoItems.appendChild(tabla);\r\n+\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n+  actualizarTotales();\r\n+  actualizarContador();\r\n+  guardarCarrito();\r\n+}\r\n+\r\n+// =========================\r\n+// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n+// =========================\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const boton = e.target.closest(\"button\");\r\n+  if (!boton) return;\r\n+\r\n+  const index = boton.dataset.index;\r\n+  if (index === undefined) return;\r\n+\r\n+  const producto = carrito[index];\r\n+  if (!producto) return;\r\n+\r\n+  // Buscar producto original en cat√°logo\r\n+  let catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+  if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n+    catalogo = window.catalogo;\r\n+    catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+  }\r\n+\r\n+  if (!catalogoProd) {\r\n+    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n+    return;\r\n+  }\r\n+\r\n+  // =========================\r\n+  // ACCIONES DEL CARRITO\r\n+  // =========================\r\n+  if (boton.classList.contains(\"carrito-item-close\")) {\r\n+    // ‚ùå Eliminar producto\r\n+    carrito.splice(index, 1);\r\n+\r\n+  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n+    // ‚ûï Incrementar cantidad\r\n+    if (producto.cantidad < catalogoProd.stock) {\r\n+      producto.cantidad++;\r\n+      producto.precio = catalogoProd.precio;\r\n+      producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n+      producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n+    } else {\r\n+      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n+    }\r\n+\r\n+  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+    // ‚ûñ Decrementar cantidad (m√≠nimo 1)\r\n+    if (producto.cantidad > 1) {\r\n+      producto.cantidad--;\r\n+    } else {\r\n+      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+    }\r\n+  }\r\n+\r\n+  // Guardar y renderizar\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+});\r\n+\r\n+\r\n+// =========================\r\n+// GUARDAR EN LOCALSTORAGE\r\n+// =========================\r\n+function guardarCarrito() {\r\n+  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n+  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n+}\r\n+\r\n+// =========================\r\n+// TOTALES Y BARRA DE ENV√çO\r\n+// =========================\r\n+const ENVIO_GRATIS_MINIMO = 99;\r\n+function actualizarBarra(totalCarrito) {\r\n+  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n+  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n+\r\n+  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n+  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n+\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+\r\n+  if (mensajeEl) {\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n+      mensajeEl.classList.add(\"gratis\");\r\n+    } else if (totalCarrito > 0) {\r\n+      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n+    } else {\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n+    }\r\n+  }\r\n+\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+}\r\n+\r\n+function actualizarTotales() {\r\n+  let subtotal = 0;\r\n+  let descuentoVolumenTotal = 0;\r\n+  let descuentoDirectoTotal = 0;\r\n+\r\n+  carrito.forEach(p => {\r\n+    const precioNormal = p.precio * p.cantidad;\r\n+    const precioConDescuento = calcularTotalProducto(p);\r\n+    subtotal += precioNormal;\r\n+\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+  });\r\n+\r\n+  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n+  const totalConDescuentos = subtotal - ahorroTotal;\r\n+\r\n+  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n+\r\n+  actualizarBarra(totalConDescuentos);\r\n+}\r\n+\r\n+// =========================\r\n+// CONTADOR\r\n+// =========================\r\n+function actualizarContador() {\r\n+  const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+\r\n+  // contador en el icono/header\r\n+  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+\r\n+  // contador dentro del carrito (en el h2)\r\n+  const contadorInline = document.getElementById(\"contador-inline\");\r\n+  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n+}\r\n+\r\n+\r\n+// =========================\r\n+// TOAST\r\n+// =========================\r\n+\r\n+// ‚úÖ Declaramos la variable global antes de usarla\r\n+let toastTimeout = null;\r\n+\r\n+function mostrarToast(mensaje) {\r\n+  let toast = document.getElementById(\"mensajeCarrito\");\r\n+\r\n+  if (!toast) {\r\n+    toast = document.createElement(\"div\");\r\n+    toast.id = \"mensajeCarrito\";\r\n+    document.body.appendChild(toast);\r\n+  }\r\n+\r\n+  toast.textContent = mensaje;\r\n+  toast.classList.add(\"mostrar\");\r\n+\r\n+  // Limpiar cualquier timeout anterior\r\n+  clearTimeout(toastTimeout);\r\n+\r\n+  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n+}\r\n+\r\n+\r\n+\r\n+// =========================\r\n+// COMPRAR AHORA POR WHATSAPP\r\n+// =========================\r\n+function comprarAhora() {\r\n+  if (carrito.length === 0) {\r\n+    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n+    return;\r\n+  }\r\n+\r\n+  const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n+  const productos = carrito\r\n+    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n+    .join(\"\\n\");\r\n+\r\n+  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n+  const telefono = \"51929261925\"; // sin el \"+\"\r\n+\r\n+  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n+    // ‚úÖ Intentar abrir directo la app\r\n+    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+\r\n+    // Intento directo\r\n+    window.location.href = appUrl;\r\n+\r\n+    // ‚è≥ Fallback en 1200ms\r\n+    setTimeout(() => {\r\n+      // Redirige al fallback solo si sigue en la misma p√°gina\r\n+      if (document.visibilityState === \"visible\") {\r\n+        window.location.href = fallbackUrl;\r\n+      }\r\n+      // Aqu√≠ reci√©n vaciamos el carrito\r\n+      vaciarCarritoDespuesEnvio();\r\n+    }, 1200);\r\n+\r\n+  } else {\r\n+    // ‚úÖ En PC: usar WhatsApp Web\r\n+    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    window.open(webUrl, \"_blank\");\r\n+\r\n+    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n+    vaciarCarritoDespuesEnvio();\r\n+  }\r\n+}\r\n+\r\n+// Funci√≥n auxiliar\r\n+function vaciarCarritoDespuesEnvio() {\r\n+  carrito = [];\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+  actualizarContador();\r\n+  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n+\r\n+  if (sidebar?.classList.contains(\"activo\")) {\r\n+    cerrarSidebar();\r\n+  }\r\n+}\r\n+\r\n+\r\n+// =========================\r\n+// LISTENERS GENERALES\r\n+// =========================\r\n+document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.addEventListener(\"click\", e => {\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n+});\r\n+document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n+  e.preventDefault();\r\n+  cerrarSidebar();\r\n+  window.location.href = \"carrito.html\";\r\n+});\r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n+document.addEventListener(\"keydown\", e => {\r\n+  if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n+});\r\n+\r\n+// =========================\r\n+// INICIALIZAR\r\n+// =========================\r\n+mostrarCarrito();\r\n+actualizarContador();\r\n"
                },
                {
                    "date": 1760211745198,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -238,28 +238,29 @@\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n-// =========================\r\n-// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n-// =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const boton = e.target.closest(\"button\");\r\n   if (!boton) return;\r\n \r\n-  const index = boton.dataset.index;\r\n-  if (index === undefined) return;\r\n+  const index = Number(boton.dataset.index);\r\n+  if (isNaN(index)) return;\r\n \r\n   const producto = carrito[index];\r\n   if (!producto) return;\r\n \r\n-  // Buscar producto original en cat√°logo\r\n-  let catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-  if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n-    catalogo = window.catalogo;\r\n-    catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+  // Asegurarse de que el cat√°logo est√© cargado\r\n+  if (!catalogo || catalogo.length === 0) {\r\n+    if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n+    else {\r\n+      mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n+      return;\r\n+    }\r\n   }\r\n \r\n+  // Buscar producto original en cat√°logo\r\n+  const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n   if (!catalogoProd) {\r\n     mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n     return;\r\n   }\r\n@@ -267,525 +268,40 @@\n   // =========================\r\n   // ACCIONES DEL CARRITO\r\n   // =========================\r\n   if (boton.classList.contains(\"carrito-item-close\")) {\r\n-    // ‚ùå Eliminar producto\r\n     carrito.splice(index, 1);\r\n+    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n \r\n   } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    // ‚ûï Incrementar cantidad\r\n     if (producto.cantidad < catalogoProd.stock) {\r\n       producto.cantidad++;\r\n-      producto.precio = catalogoProd.precio;\r\n-      producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n-      producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n     } else {\r\n       mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n+      return;\r\n     }\r\n \r\n   } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-    // ‚ûñ Decrementar cantidad (m√≠nimo 1)\r\n     if (producto.cantidad > 1) {\r\n       producto.cantidad--;\r\n     } else {\r\n       mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+      return;\r\n     }\r\n   }\r\n \r\n-  // Guardar y renderizar\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n+  // Actualizar precios desde cat√°logo\r\n+  producto.precio = catalogoProd.precio;\r\n+  producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n+  producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n \r\n-\r\n-// =========================\r\n-// GUARDAR EN LOCALSTORAGE\r\n-// =========================\r\n-function guardarCarrito() {\r\n-  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n-  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n-}\r\n-\r\n-// =========================\r\n-// TOTALES Y BARRA DE ENV√çO\r\n-// =========================\r\n-const ENVIO_GRATIS_MINIMO = 99;\r\n-function actualizarBarra(totalCarrito) {\r\n-  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n-\r\n-  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n-  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n-\r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n-\r\n-  if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n-      mensajeEl.classList.add(\"gratis\");\r\n-    } else if (totalCarrito > 0) {\r\n-      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    }\r\n-  }\r\n-\r\n-  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n-}\r\n-\r\n-function actualizarTotales() {\r\n-  let subtotal = 0;\r\n-  let descuentoVolumenTotal = 0;\r\n-  let descuentoDirectoTotal = 0;\r\n-\r\n-  carrito.forEach(p => {\r\n-    const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = calcularTotalProducto(p);\r\n-    subtotal += precioNormal;\r\n-\r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-  });\r\n-\r\n-  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n-  const totalConDescuentos = subtotal - ahorroTotal;\r\n-\r\n-  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n-\r\n-  actualizarBarra(totalConDescuentos);\r\n-}\r\n-\r\n-// =========================\r\n-// CONTADOR\r\n-// =========================\r\n-function actualizarContador() {\r\n-  const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-\r\n-  // contador en el icono/header\r\n-  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n-\r\n-  // contador dentro del carrito (en el h2)\r\n-  const contadorInline = document.getElementById(\"contador-inline\");\r\n-  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n-}\r\n-\r\n-\r\n-// =========================\r\n-// TOAST\r\n-// =========================\r\n-\r\n-// ‚úÖ Declaramos la variable global antes de usarla\r\n-let toastTimeout = null;\r\n-\r\n-function mostrarToast(mensaje) {\r\n-  let toast = document.getElementById(\"mensajeCarrito\");\r\n-\r\n-  if (!toast) {\r\n-    toast = document.createElement(\"div\");\r\n-    toast.id = \"mensajeCarrito\";\r\n-    document.body.appendChild(toast);\r\n-  }\r\n-\r\n-  toast.textContent = mensaje;\r\n-  toast.classList.add(\"mostrar\");\r\n-\r\n-  // Limpiar cualquier timeout anterior\r\n-  clearTimeout(toastTimeout);\r\n-\r\n-  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n-}\r\n-\r\n-\r\n-\r\n-// =========================\r\n-// COMPRAR AHORA POR WHATSAPP\r\n-// =========================\r\n-function comprarAhora() {\r\n-  if (carrito.length === 0) {\r\n-    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n-    return;\r\n-  }\r\n-\r\n-  const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito\r\n-    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n-    .join(\"\\n\");\r\n-\r\n-  const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\"; // sin el \"+\"\r\n-\r\n-  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ Intentar abrir directo la app\r\n-    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-\r\n-    // Intento directo\r\n-    window.location.href = appUrl;\r\n-\r\n-    // ‚è≥ Fallback en 1200ms\r\n-    setTimeout(() => {\r\n-      // Redirige al fallback solo si sigue en la misma p√°gina\r\n-      if (document.visibilityState === \"visible\") {\r\n-        window.location.href = fallbackUrl;\r\n-      }\r\n-      // Aqu√≠ reci√©n vaciamos el carrito\r\n-      vaciarCarritoDespuesEnvio();\r\n-    }, 1200);\r\n-\r\n-  } else {\r\n-    // ‚úÖ En PC: usar WhatsApp Web\r\n-    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    window.open(webUrl, \"_blank\");\r\n-\r\n-    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n-    vaciarCarritoDespuesEnvio();\r\n-  }\r\n-}\r\n-\r\n-// Funci√≥n auxiliar\r\n-function vaciarCarritoDespuesEnvio() {\r\n-  carrito = [];\r\n+  // Guardar y actualizar UI\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n-  actualizarContador();\r\n-  mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n-\r\n-  if (sidebar?.classList.contains(\"activo\")) {\r\n-    cerrarSidebar();\r\n-  }\r\n-}\r\n-\r\n-\r\n-// =========================\r\n-// LISTENERS GENERALES\r\n-// =========================\r\n-document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n-document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-  window.location.href = \"carrito.html\";\r\n-});\r\n-document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n-document.addEventListener(\"keydown\", e => {\r\n-  if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n \r\n-// =========================\r\n-// INICIALIZAR\r\n-// =========================\r\n-mostrarCarrito();\r\n-actualizarContador();\r\n-// =========================\r\n-// ELEMENTOS DEL CARRITO\r\n-// =========================\r\n-const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n-const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito      = document.querySelector(\".cerrar-carrito\");\r\n-const carritoItems       = document.getElementById(\"carrito-items\");\r\n \r\n-const subtotalEl         = document.getElementById(\"subtotal\");\r\n-const totalEl            = document.getElementById(\"total\");\r\n-const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n-\r\n-// Campos para descuentos y env√≠o\r\n-const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n-const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n-const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n-const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n-\r\n-let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-\r\n-// ‚úÖ Usar el cat√°logo global\r\n-let catalogo = [];\r\n-\r\n-// Si window.catalogo ya est√° listo, √∫salo\r\n-if (window.catalogo && Array.isArray(window.catalogo)) {\r\n-  catalogo = window.catalogo;\r\n-  console.log(\"üì¶ Cat√°logo inicial cargado:\", catalogo.length, \"productos\");\r\n-}\r\n-\r\n-// Escucha el evento por si se carga despu√©s\r\n-document.addEventListener(\"catalogoListo\", () => {\r\n-  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n-    catalogo = window.catalogo;\r\n-    console.log(\"üì¶ Cat√°logo actualizado en carrito.js:\", catalogo.length, \"productos\");\r\n-    mostrarCarrito(); // ‚úÖ actualizar carrito si ya hab√≠a productos\r\n-  }\r\n-});\r\n-\r\n // =========================\r\n-// CREAR OVERLAY\r\n-// =========================\r\n-let overlay = document.getElementById(\"overlay-carrito\");\r\n-if (!overlay) {\r\n-  overlay = document.createElement(\"div\");\r\n-  overlay.id = \"overlay-carrito\";\r\n-  document.body.appendChild(overlay);\r\n-}\r\n-\r\n-// =========================\r\n-// RENDER PRODUCTOS\r\n-// =========================\r\n-const contenedorProductos = document.getElementById(\"productos-grid\"); // cambiar \"productos-grit\" por \"productos-grid\"\r\n-\r\n-function renderProductos(lista) {\r\n-  if (!contenedorProductos) return;\r\n-  contenedorProductos.innerHTML = \"\";\r\n-  lista.forEach(producto => {\r\n-    const div = document.createElement(\"div\");\r\n-    div.classList.add(\"producto\");\r\n-\r\n-    // ‚úÖ Mostrar precios correctamente\r\n-    let precioHTML = \"\";\r\n-    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n-          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    } else {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    }\r\n-\r\n-    div.innerHTML = `\r\n-      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n-      <h4>${producto.nombre}</h4>\r\n-      <p>${producto.descripcion || \"\"}</p>\r\n-      ${precioHTML}\r\n-      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n-      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n-      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n-    `;\r\n-\r\n-    contenedorProductos.appendChild(div);\r\n-  });\r\n-}\r\n-\r\n-\r\n-// =========================\r\n-// CALCULAR TOTAL POR PRODUCTO\r\n-// =========================\r\n-function calcularTotalProducto(producto) {\r\n-  let total = 0;\r\n-  const cantidad = producto.cantidad;\r\n-\r\n-  if (producto.descuentoVolumen) {\r\n-    const promo = producto.descuentoVolumen;\r\n-    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n-    const resto = cantidad % promo.aplicaA;\r\n-    const totalPromo = vecesPromo * (\r\n-      (promo.compra * producto.precio) +\r\n-      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n-    );\r\n-    const totalResto = resto * producto.precio;\r\n-    total = totalPromo + totalResto;\r\n-  } else {\r\n-    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n-  }\r\n-\r\n-  return total;\r\n-}\r\n-\r\n-// =========================\r\n-// ABRIR / CERRAR CARRITO O SIDERBAR \r\n-// =========================\r\n-function abrirSidebar() {\r\n-  if (!sidebar) return;\r\n-  sidebar.classList.add(\"activo\");\r\n-  overlay.classList.add(\"show\");\r\n-  document.body.style.overflow = \"hidden\";\r\n-  mostrarCarrito();\r\n-  history.pushState({ carritoAbierto: true }, \"\");\r\n-}\r\n-function cerrarSidebar() {\r\n-  if (!sidebar) return;\r\n-  document.activeElement.blur(); // üëà evita el warning de aria-hidden\r\n-  sidebar.classList.remove(\"activo\");\r\n-  overlay.classList.remove(\"show\");\r\n-  document.body.style.overflow = \"auto\";\r\n-  history.replaceState({}, \"\");\r\n-}\r\n-\r\n-overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n-cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n-window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n-window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n-\r\n-function agregarAlCarrito(idProducto) {\r\n-  // ‚úÖ Asegurarnos de que el cat√°logo exista\r\n-  if (!catalogo || catalogo.length === 0) {\r\n-    mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n-    return;\r\n-  }\r\n-\r\n-  const producto = catalogo.find(p => p.id == idProducto);\r\n-  if (!producto) {\r\n-    mostrarToast(\"‚ö†Ô∏è Producto no encontrado en cat√°logo\");\r\n-    return;\r\n-  }\r\n-\r\n-  const existe = carrito.find(p => p.id == idProducto);\r\n-  const cantidadActual = existe ? existe.cantidad : 0;\r\n-\r\n-  const stockDisponible = producto.stock - cantidadActual;\r\n-  if (stockDisponible <= 0) {\r\n-    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n-    return;\r\n-  }\r\n-\r\n-  if (existe) {\r\n-    existe.cantidad++;\r\n-  } else {\r\n-    carrito.push({ ...producto, cantidad: 1 });\r\n-  }\r\n-\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-  actualizarContador();\r\n-  mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n-}\r\n-\r\n-// =========================\r\n-// MOSTRAR CARRITO\r\n-// =========================\r\n-function mostrarCarrito() {\r\n-  if (!carritoItems) return;\r\n-  carritoItems.innerHTML = \"\";\r\n-\r\n-  if (carrito.length === 0) {\r\n-    carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n-    actualizarTotales();\r\n-    actualizarContador();\r\n-    return;\r\n-  }\r\n-\r\n-  const tabla = document.createElement(\"table\");\r\n-  tabla.classList.add(\"tabla-carrito\");\r\n-  tabla.innerHTML = `\r\n-    <thead>\r\n-      <tr>\r\n-        <th>Producto</th>\r\n-        <th>Cantidad</th>\r\n-        <th>Precio</th>\r\n-        <th>Descuento aplicado</th>\r\n-        <th>Acci√≥n</th>\r\n-      </tr>\r\n-    </thead>\r\n-    <tbody>\r\n-      ${carrito.map((producto, index) => {\r\n-        let descuentoAplicado = false;\r\n-        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n-\r\n-        return `\r\n-          <tr>\r\n-            <td>\r\n-              <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n-                <div>\r\n-                  <strong>${producto.nombre}</strong>\r\n-                  <p>${producto.descripcion || \"\"}</p>\r\n-                </div>\r\n-              </div>\r\n-            </td>\r\n-            <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">-</button>\r\n-<span>${producto.cantidad}</span>\r\n-<button class=\"btn-incrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">+</button>\r\n-\r\n-            </td>\r\n-            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n-            <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n-          </tr>\r\n-        `;\r\n-      }).join(\"\")}\r\n-    </tbody>\r\n-  `;\r\n-  carritoItems.appendChild(tabla);\r\n-\r\n-  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n-  actualizarTotales();\r\n-  actualizarContador();\r\n-  guardarCarrito();\r\n-}\r\n-\r\n-// =========================\r\n-// ESCUCHAR CLIC EN LOS BOTONES DEL CARRITO\r\n-// =========================\r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const boton = e.target.closest(\"button\");\r\n-  if (!boton) return;\r\n-\r\n-  const index = boton.dataset.index;\r\n-  if (index === undefined) return;\r\n-\r\n-  const producto = carrito[index];\r\n-  if (!producto) return;\r\n-\r\n-  // Buscar producto original en cat√°logo\r\n-  let catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-  if (!catalogoProd && window.catalogo && Array.isArray(window.catalogo)) {\r\n-    catalogo = window.catalogo;\r\n-    catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-  }\r\n-\r\n-  if (!catalogoProd) {\r\n-    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible actualmente üõë`);\r\n-    return;\r\n-  }\r\n-\r\n-  // ACCIONES\r\n-  if (boton.classList.contains(\"carrito-item-close\")) {\r\n-    // Quitar producto del carrito\r\n-    carrito.splice(index, 1);\r\n-    mostrarToast(`Producto \"${producto.nombre}\" eliminado del carrito üõí`);\r\n-\r\n-  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    // Incrementar cantidad respetando stock\r\n-    if (producto.cantidad < catalogoProd.stock) {\r\n-      producto.cantidad++;\r\n-      // Actualizar precios desde cat√°logo\r\n-      producto.precio = catalogoProd.precio;\r\n-      producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n-      producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n-    } else {\r\n-      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n-    }\r\n-\r\n-  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-    // Reducir cantidad sin permitir menos de 1\r\n-    if (producto.cantidad > 1) {\r\n-      producto.cantidad--;\r\n-    } else {\r\n-      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n-    }\r\n-  }\r\n-\r\n-  // Guardar y actualizar carrito\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n-\r\n-\r\n-// =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n   try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n"
                },
                {
                    "date": 1760211993179,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -140,11 +140,14 @@\n window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n function agregarAlCarrito(idProducto) {\r\n-  // ‚úÖ Asegurarnos de que el cat√°logo exista\r\n   if (!catalogo || catalogo.length === 0) {\r\n-    mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n+    // ‚ùå No mostrar error, sino esperar a que se cargue el cat√°logo\r\n+    document.addEventListener(\"catalogoListo\", function handler() {\r\n+      document.removeEventListener(\"catalogoListo\", handler);\r\n+      agregarAlCarrito(idProducto); // reintenta agregar\r\n+    });\r\n     return;\r\n   }\r\n \r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n"
                },
                {
                    "date": 1760212117915,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,34 +9,18 @@\n const subtotalEl         = document.getElementById(\"subtotal\");\r\n const totalEl            = document.getElementById(\"total\");\r\n const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n \r\n-// Campos para descuentos y env√≠o\r\n+// üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n+let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-\r\n-// ‚úÖ Usar el cat√°logo global\r\n let catalogo = [];\r\n \r\n-// Si window.catalogo ya est√° listo, √∫salo\r\n-if (window.catalogo && Array.isArray(window.catalogo)) {\r\n-  catalogo = window.catalogo;\r\n-  console.log(\"üì¶ Cat√°logo inicial cargado:\", catalogo.length, \"productos\");\r\n-}\r\n-\r\n-// Escucha el evento por si se carga despu√©s\r\n-document.addEventListener(\"catalogoListo\", () => {\r\n-  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n-    catalogo = window.catalogo;\r\n-    console.log(\"üì¶ Cat√°logo actualizado en carrito.js:\", catalogo.length, \"productos\");\r\n-    mostrarCarrito(); // ‚úÖ actualizar carrito si ya hab√≠a productos\r\n-  }\r\n-});\r\n-\r\n // =========================\r\n // CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n@@ -46,53 +30,46 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n+// CARGAR JSON DE PRODUCTOS\r\n+// =========================\r\n+fetch(\"productos.json\")\r\n+  .then(res => res.json())\r\n+  .then(data => {\r\n+    catalogo = [...data.productos, ...(data.ofertas || [])];\r\n+    renderProductos(catalogo);\r\n+  })\r\n+  .catch(err => console.error(\"Error cargando productos:\", err));\r\n+\r\n+// =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n-const contenedorProductos = document.getElementById(\"productos-grid\"); // cambiar \"productos-grit\" por \"productos-grid\"\r\n-\r\n+const contenedorProductos = document.getElementById(\"productos-container\");\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n-\r\n-    // ‚úÖ Mostrar precios correctamente\r\n-    let precioHTML = \"\";\r\n-    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n-          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    } else {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    }\r\n-\r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      ${precioHTML}\r\n+      <div class=\"precio\">\r\n+        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n+        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n+      </div>\r\n       <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n       <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n-\r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n-\r\n // =========================\r\n-// CALCULAR TOTAL POR PRODUCTO\r\n+// CALCULAR TOTAL CON DESCUENTO POR VOLUMEN\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n   let total = 0;\r\n   const cantidad = producto.cantidad;\r\n@@ -114,9 +91,9 @@\n   return total;\r\n }\r\n \r\n // =========================\r\n-// ABRIR / CERRAR CARRITO O SIDERBAR \r\n+// ABRIR / CERRAR SIDEBAR\r\n // =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n@@ -126,41 +103,32 @@\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n-  document.activeElement.blur(); // üëà evita el warning de aria-hidden\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n-\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n+// =========================\r\n+// AGREGAR AL CARRITO CON STOCK\r\n+// =========================\r\n function agregarAlCarrito(idProducto) {\r\n-  if (!catalogo || catalogo.length === 0) {\r\n-    // ‚ùå No mostrar error, sino esperar a que se cargue el cat√°logo\r\n-    document.addEventListener(\"catalogoListo\", function handler() {\r\n-      document.removeEventListener(\"catalogoListo\", handler);\r\n-      agregarAlCarrito(idProducto); // reintenta agregar\r\n-    });\r\n-    return;\r\n-  }\r\n-\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n-  if (!producto) {\r\n-    mostrarToast(\"‚ö†Ô∏è Producto no encontrado en cat√°logo\");\r\n-    return;\r\n-  }\r\n+  if (!producto) return;\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n   const cantidadActual = existe ? existe.cantidad : 0;\r\n \r\n+  // Stock real disponible\r\n   const stockDisponible = producto.stock - cantidadActual;\r\n+\r\n   if (stockDisponible <= 0) {\r\n     mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n     return;\r\n   }\r\n@@ -220,12 +188,11 @@\n                 </div>\r\n               </div>\r\n             </td>\r\n             <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">-</button>\r\n-<span>${producto.cantidad}</span>\r\n-<button class=\"btn-incrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">+</button>\r\n-\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n             </td>\r\n             <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n             <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n             <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n@@ -235,75 +202,16 @@\n     </tbody>\r\n   `;\r\n   carritoItems.appendChild(tabla);\r\n \r\n+  // scroll si hay muchos\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n+\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const boton = e.target.closest(\"button\");\r\n-  if (!boton) return;\r\n-\r\n-  const index = Number(boton.dataset.index);\r\n-  if (isNaN(index)) return;\r\n-\r\n-  const producto = carrito[index];\r\n-  if (!producto) return;\r\n-\r\n-  // Asegurarse de que el cat√°logo est√© cargado\r\n-  if (!catalogo || catalogo.length === 0) {\r\n-    if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n-    else {\r\n-      mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n-      return;\r\n-    }\r\n-  }\r\n-\r\n-  // Buscar producto original en cat√°logo\r\n-  const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-  if (!catalogoProd) {\r\n-    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n-    return;\r\n-  }\r\n-\r\n-  // =========================\r\n-  // ACCIONES DEL CARRITO\r\n-  // =========================\r\n-  if (boton.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n-\r\n-  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    if (producto.cantidad < catalogoProd.stock) {\r\n-      producto.cantidad++;\r\n-    } else {\r\n-      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n-      return;\r\n-    }\r\n-\r\n-  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-    if (producto.cantidad > 1) {\r\n-      producto.cantidad--;\r\n-    } else {\r\n-      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n-      return;\r\n-    }\r\n-  }\r\n-\r\n-  // Actualizar precios desde cat√°logo\r\n-  producto.precio = catalogoProd.precio;\r\n-  producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n-  producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n-\r\n-  // Guardar y actualizar UI\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n-\r\n-\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n@@ -314,20 +222,24 @@\n // =========================\r\n // TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 99;\r\n+\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+  if (barraProgreso) {\r\n+    barraProgreso.style.display = \"block\";\r\n+    barraProgreso.style.width = `${porcentaje}%`;\r\n+  }\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n+      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n       mensajeEl.classList.add(\"gratis\");\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n       mensajeEl.classList.remove(\"gratis\");\r\n@@ -336,9 +248,11 @@\n       mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n \r\n-  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+  if (costoEnvioEl) {\r\n+    costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+  }\r\n }\r\n \r\n function actualizarTotales() {\r\n   let subtotal = 0;\r\n@@ -349,10 +263,13 @@\n     const precioNormal = p.precio * p.cantidad;\r\n     const precioConDescuento = calcularTotalProducto(p);\r\n     subtotal += precioNormal;\r\n \r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n+      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n+      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+    }\r\n   });\r\n \r\n   const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n   const totalConDescuentos = subtotal - ahorroTotal;\r\n@@ -370,46 +287,27 @@\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-\r\n-  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n-\r\n-  // contador dentro del carrito (en el h2)\r\n-  const contadorInline = document.getElementById(\"contador-inline\");\r\n-  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n-\r\n // =========================\r\n // TOAST\r\n // =========================\r\n-\r\n-// ‚úÖ Declaramos la variable global antes de usarla\r\n-let toastTimeout = null;\r\n-\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n-\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n     toast.id = \"mensajeCarrito\";\r\n     document.body.appendChild(toast);\r\n   }\r\n-\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-\r\n-  // Limpiar cualquier timeout anterior\r\n   clearTimeout(toastTimeout);\r\n-\r\n-  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n }\r\n \r\n-\r\n-\r\n // =========================\r\n // COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n@@ -418,71 +316,59 @@\n     return;\r\n   }\r\n \r\n   const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito\r\n-    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n-    .join(\"\\n\");\r\n+  const productos = carrito.map(p =>\r\n+    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n+  ).join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\"; // sin el \"+\"\r\n+  const telefono = \"+51920165696\";\r\n+  const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n+    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n+    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n \r\n-  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ Intentar abrir directo la app\r\n-    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+  window.open(url, \"_blank\");\r\n \r\n-    // Intento directo\r\n-    window.location.href = appUrl;\r\n-\r\n-    // ‚è≥ Fallback en 1200ms\r\n-    setTimeout(() => {\r\n-      // Redirige al fallback solo si sigue en la misma p√°gina\r\n-      if (document.visibilityState === \"visible\") {\r\n-        window.location.href = fallbackUrl;\r\n-      }\r\n-      // Aqu√≠ reci√©n vaciamos el carrito\r\n-      vaciarCarritoDespuesEnvio();\r\n-    }, 1200);\r\n-\r\n-  } else {\r\n-    // ‚úÖ En PC: usar WhatsApp Web\r\n-    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    window.open(webUrl, \"_blank\");\r\n-\r\n-    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n-    vaciarCarritoDespuesEnvio();\r\n-  }\r\n-}\r\n-\r\n-// Funci√≥n auxiliar\r\n-function vaciarCarritoDespuesEnvio() {\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n-\r\n-  if (sidebar?.classList.contains(\"activo\")) {\r\n-    cerrarSidebar();\r\n-  }\r\n }\r\n \r\n-\r\n // =========================\r\n-// LISTENERS GENERALES\r\n+// LISTENERS\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n+\r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const index = e.target.dataset.index;\r\n+  if (index === undefined) return;\r\n+\r\n+  if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n+  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n+  else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n+    carrito[index].cantidad--;\r\n+    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n+  }\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+});\r\n+\r\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n+\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n+\r\n document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n+\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n"
                },
                {
                    "date": 1760212213149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,18 +9,34 @@\n const subtotalEl         = document.getElementById(\"subtotal\");\r\n const totalEl            = document.getElementById(\"total\");\r\n const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n \r\n-// üëá NUEVOS CAMPOS PARA EL DESGLOSE DE DESCUENTOS\r\n+// Campos para descuentos y env√≠o\r\n const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n-let toastTimeout;\r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+\r\n+// ‚úÖ Usar el cat√°logo global\r\n let catalogo = [];\r\n \r\n+// Si window.catalogo ya est√° listo, √∫salo\r\n+if (window.catalogo && Array.isArray(window.catalogo)) {\r\n+  catalogo = window.catalogo;\r\n+  console.log(\"üì¶ Cat√°logo inicial cargado:\", catalogo.length, \"productos\");\r\n+}\r\n+\r\n+// Escucha el evento por si se carga despu√©s\r\n+document.addEventListener(\"catalogoListo\", () => {\r\n+  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n+    catalogo = window.catalogo;\r\n+    console.log(\"üì¶ Cat√°logo actualizado en carrito.js:\", catalogo.length, \"productos\");\r\n+    mostrarCarrito(); // ‚úÖ actualizar carrito si ya hab√≠a productos\r\n+  }\r\n+});\r\n+\r\n // =========================\r\n // CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n@@ -30,46 +46,53 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// CARGAR JSON DE PRODUCTOS\r\n+// RENDER PRODUCTOS\r\n // =========================\r\n-fetch(\"productos.json\")\r\n-  .then(res => res.json())\r\n-  .then(data => {\r\n-    catalogo = [...data.productos, ...(data.ofertas || [])];\r\n-    renderProductos(catalogo);\r\n-  })\r\n-  .catch(err => console.error(\"Error cargando productos:\", err));\r\n+const contenedorProductos = document.getElementById(\"productos-grid\"); // cambiar \"productos-grit\" por \"productos-grid\"\r\n \r\n-// =========================\r\n-// RENDER PRODUCTOS\r\n-// =========================\r\n-const contenedorProductos = document.getElementById(\"productos-container\");\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n+\r\n+    // ‚úÖ Mostrar precios correctamente\r\n+    let precioHTML = \"\";\r\n+    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n+          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    } else {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    }\r\n+\r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n       <h4>${producto.nombre}</h4>\r\n       <p>${producto.descripcion || \"\"}</p>\r\n-      <div class=\"precio\">\r\n-        <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento?.toFixed(2) || producto.precio.toFixed(2)}</span>\r\n-      </div>\r\n+      ${precioHTML}\r\n       <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n       <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n       <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n     `;\r\n+\r\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n+\r\n // =========================\r\n-// CALCULAR TOTAL CON DESCUENTO POR VOLUMEN\r\n+// CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n   let total = 0;\r\n   const cantidad = producto.cantidad;\r\n@@ -91,9 +114,9 @@\n   return total;\r\n }\r\n \r\n // =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n+// ABRIR / CERRAR CARRITO O SIDERBAR \r\n // =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n@@ -103,32 +126,41 @@\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n+  document.activeElement.blur(); // üëà evita el warning de aria-hidden\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n }\r\n+\r\n overlay?.addEventListener(\"click\", cerrarSidebar);\r\n abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n-// =========================\r\n-// AGREGAR AL CARRITO CON STOCK\r\n-// =========================\r\n function agregarAlCarrito(idProducto) {\r\n+  if (!catalogo || catalogo.length === 0) {\r\n+    // ‚ùå No mostrar error, sino esperar a que se cargue el cat√°logo\r\n+    document.addEventListener(\"catalogoListo\", function handler() {\r\n+      document.removeEventListener(\"catalogoListo\", handler);\r\n+      agregarAlCarrito(idProducto); // reintenta agregar\r\n+    });\r\n+    return;\r\n+  }\r\n+\r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n-  if (!producto) return;\r\n+  if (!producto) {\r\n+    mostrarToast(\"‚ö†Ô∏è Producto no encontrado en cat√°logo\");\r\n+    return;\r\n+  }\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n   const cantidadActual = existe ? existe.cantidad : 0;\r\n \r\n-  // Stock real disponible\r\n   const stockDisponible = producto.stock - cantidadActual;\r\n-\r\n   if (stockDisponible <= 0) {\r\n     mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n     return;\r\n   }\r\n@@ -188,11 +220,12 @@\n                 </div>\r\n               </div>\r\n             </td>\r\n             <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\">+</button>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">-</button>\r\n+<span>${producto.cantidad}</span>\r\n+<button class=\"btn-incrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">+</button>\r\n+\r\n             </td>\r\n             <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n             <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n             <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n@@ -202,16 +235,75 @@\n     </tbody>\r\n   `;\r\n   carritoItems.appendChild(tabla);\r\n \r\n-  // scroll si hay muchos\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n-\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n+carritoItems?.addEventListener(\"click\", e => {\r\n+  const boton = e.target.closest(\"button\");\r\n+  if (!boton) return;\r\n+\r\n+  const index = Number(boton.dataset.index);\r\n+  if (isNaN(index)) return;\r\n+\r\n+  const producto = carrito[index];\r\n+  if (!producto) return;\r\n+\r\n+  // Asegurarse de que el cat√°logo est√© cargado\r\n+  if (!catalogo || catalogo.length === 0) {\r\n+    if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n+    else {\r\n+      mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n+      return;\r\n+    }\r\n+  }\r\n+\r\n+  // Buscar producto original en cat√°logo\r\n+  const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+  if (!catalogoProd) {\r\n+    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n+    return;\r\n+  }\r\n+\r\n+  // =========================\r\n+  // ACCIONES DEL CARRITO\r\n+  // =========================\r\n+  if (boton.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n+\r\n+  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n+    if (producto.cantidad < catalogoProd.stock) {\r\n+      producto.cantidad++;\r\n+    } else {\r\n+      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n+      return;\r\n+    }\r\n+\r\n+  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+    if (producto.cantidad > 1) {\r\n+      producto.cantidad--;\r\n+    } else {\r\n+      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+      return;\r\n+    }\r\n+  }\r\n+\r\n+  // Actualizar precios desde cat√°logo\r\n+  producto.precio = catalogoProd.precio;\r\n+  producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n+  producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n+\r\n+  // Guardar y actualizar UI\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+});\r\n+\r\n+\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n@@ -222,24 +314,20 @@\n // =========================\r\n // TOTALES Y BARRA DE ENV√çO\r\n // =========================\r\n const ENVIO_GRATIS_MINIMO = 99;\r\n-\r\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n   let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n   porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n \r\n-  if (barraProgreso) {\r\n-    barraProgreso.style.display = \"block\";\r\n-    barraProgreso.style.width = `${porcentaje}%`;\r\n-  }\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Ya tienes env√≠o gratis!\";\r\n+      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n       mensajeEl.classList.add(\"gratis\");\r\n     } else if (totalCarrito > 0) {\r\n       mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n       mensajeEl.classList.remove(\"gratis\");\r\n@@ -248,11 +336,9 @@\n       mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n   }\r\n \r\n-  if (costoEnvioEl) {\r\n-    costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n-  }\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n \r\n function actualizarTotales() {\r\n   let subtotal = 0;\r\n@@ -263,13 +349,10 @@\n     const precioNormal = p.precio * p.cantidad;\r\n     const precioConDescuento = calcularTotalProducto(p);\r\n     subtotal += precioNormal;\r\n \r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) {\r\n-      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    } else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) {\r\n-      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-    }\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n   });\r\n \r\n   const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n   const totalConDescuentos = subtotal - ahorroTotal;\r\n@@ -287,27 +370,46 @@\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+\r\n+  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+\r\n+  // contador dentro del carrito (en el h2)\r\n+  const contadorInline = document.getElementById(\"contador-inline\");\r\n+  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n+\r\n // =========================\r\n // TOAST\r\n // =========================\r\n+\r\n+// ‚úÖ Declaramos la variable global antes de usarla\r\n+let toastTimeout = null;\r\n+\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n+\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n     toast.id = \"mensajeCarrito\";\r\n     document.body.appendChild(toast);\r\n   }\r\n+\r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n+\r\n+  // Limpiar cualquier timeout anterior\r\n   clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 2500);\r\n+\r\n+  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n }\r\n \r\n+\r\n+\r\n // =========================\r\n // COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n@@ -316,59 +418,71 @@\n     return;\r\n   }\r\n \r\n   const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito.map(p =>\r\n-    `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`\r\n-  ).join(\"\\n\");\r\n+  const productos = carrito\r\n+    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n+    .join(\"\\n\");\r\n \r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"+51920165696\";\r\n-  const url = navigator.userAgent.match(/(iPhone|iPad|iPod|Android)/)\r\n-    ? `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`\r\n-    : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+  const telefono = \"51929261925\"; // sin el \"+\"\r\n \r\n-  window.open(url, \"_blank\");\r\n+  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n+    // ‚úÖ Intentar abrir directo la app\r\n+    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n \r\n+    // Intento directo\r\n+    window.location.href = appUrl;\r\n+\r\n+    // ‚è≥ Fallback en 1200ms\r\n+    setTimeout(() => {\r\n+      // Redirige al fallback solo si sigue en la misma p√°gina\r\n+      if (document.visibilityState === \"visible\") {\r\n+        window.location.href = fallbackUrl;\r\n+      }\r\n+      // Aqu√≠ reci√©n vaciamos el carrito\r\n+      vaciarCarritoDespuesEnvio();\r\n+    }, 1200);\r\n+\r\n+  } else {\r\n+    // ‚úÖ En PC: usar WhatsApp Web\r\n+    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    window.open(webUrl, \"_blank\");\r\n+\r\n+    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n+    vaciarCarritoDespuesEnvio();\r\n+  }\r\n+}\r\n+\r\n+// Funci√≥n auxiliar\r\n+function vaciarCarritoDespuesEnvio() {\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n+\r\n+  if (sidebar?.classList.contains(\"activo\")) {\r\n+    cerrarSidebar();\r\n+  }\r\n }\r\n \r\n+\r\n // =========================\r\n-// LISTENERS\r\n+// LISTENERS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n-\r\n-carritoItems?.addEventListener(\"click\", e => {\r\n-  const index = e.target.dataset.index;\r\n-  if (index === undefined) return;\r\n-\r\n-  if (e.target.classList.contains(\"carrito-item-close\")) carrito.splice(index, 1);\r\n-  else if (e.target.classList.contains(\"btn-incrementar\")) carrito[index].cantidad++;\r\n-  else if (e.target.classList.contains(\"btn-decrementar\")) {\r\n-    carrito[index].cantidad--;\r\n-    if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n-  }\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n-\r\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n-\r\n document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n   e.preventDefault();\r\n   cerrarSidebar();\r\n   window.location.href = \"carrito.html\";\r\n });\r\n-\r\n document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n-\r\n document.addEventListener(\"keydown\", e => {\r\n   if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n });\r\n \r\n"
                },
                {
                    "date": 1760212355175,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -93,10 +93,10 @@\n // =========================\r\n // CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n+  const cantidad = producto.cantidad;\r\n   let total = 0;\r\n-  const cantidad = producto.cantidad;\r\n \r\n   if (producto.descuentoVolumen) {\r\n     const promo = producto.descuentoVolumen;\r\n     const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n"
                },
                {
                    "date": 1760212382101,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -96,25 +96,27 @@\n function calcularTotalProducto(producto) {\r\n   const cantidad = producto.cantidad;\r\n   let total = 0;\r\n \r\n-  if (producto.descuentoVolumen) {\r\n-    const promo = producto.descuentoVolumen;\r\n-    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n-    const resto = cantidad % promo.aplicaA;\r\n-    const totalPromo = vecesPromo * (\r\n-      (promo.compra * producto.precio) +\r\n-      ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo))\r\n-    );\r\n-    const totalResto = resto * producto.precio;\r\n-    total = totalPromo + totalResto;\r\n+  if (Array.isArray(producto.descuentoVolumen) && producto.descuentoVolumen.length > 0) {\r\n+    // Aplicar solo la primera promo activa\r\n+    const promoActiva = producto.descuentoVolumen.find(d => d.activa);\r\n+    if (promoActiva) {\r\n+      const vecesPromo = Math.floor(cantidad / promoActiva.aplicaA);\r\n+      const resto = cantidad % promoActiva.aplicaA;\r\n+      total = vecesPromo * ((promoActiva.compra * producto.precio) + ((promoActiva.aplicaA - promoActiva.compra) * producto.precio * (1 - promoActiva.promo)));\r\n+      total += resto * producto.precio;\r\n+    } else {\r\n+      total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n+    }\r\n   } else {\r\n     total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n   }\r\n \r\n   return total;\r\n }\r\n \r\n+\r\n // =========================\r\n // ABRIR / CERRAR CARRITO O SIDERBAR \r\n // =========================\r\n function abrirSidebar() {\r\n"
                },
                {
                    "date": 1760212778467,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,41 +269,40 @@\n     mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n     return;\r\n   }\r\n \r\n-  // =========================\r\n-  // ACCIONES DEL CARRITO\r\n-  // =========================\r\n-  if (boton.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n+// =========================\r\n+// ACCIONES DEL CARRITO\r\n+// =========================\r\n+if (boton.classList.contains(\"carrito-item-close\")) {\r\n+  carrito.splice(index, 1);\r\n+  mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n \r\n-  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    if (producto.cantidad < catalogoProd.stock) {\r\n-      producto.cantidad++;\r\n-    } else {\r\n-      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n-      return;\r\n-    }\r\n+} else if (boton.classList.contains(\"btn-incrementar\")) {\r\n+  // ‚úÖ Usar la funci√≥n existente para agregar al carrito\r\n+  agregarAlCarrito(producto.id);\r\n+  return; // ‚ö†Ô∏è evitar doble render de mostrarCarrito()\r\n \r\n-  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-    if (producto.cantidad > 1) {\r\n-      producto.cantidad--;\r\n-    } else {\r\n-      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n-      return;\r\n-    }\r\n+} else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+  if (producto.cantidad > 1) {\r\n+    producto.cantidad--;\r\n+  } else {\r\n+    mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+    return;\r\n   }\r\n+}\r\n \r\n-  // Actualizar precios desde cat√°logo\r\n+// Actualizar precios desde cat√°logo\r\n+const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+if (catalogoProd) {\r\n   producto.precio = catalogoProd.precio;\r\n   producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n   producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n+}\r\n \r\n-  // Guardar y actualizar UI\r\n-  guardarCarrito();\r\n-  mostrarCarrito();\r\n-});\r\n+// Guardar y actualizar UI\r\n+guardarCarrito();\r\n+mostrarCarrito();\r\n \r\n \r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n"
                },
                {
                    "date": 1760212933899,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,24 +17,16 @@\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n \r\n-// ‚úÖ Usar el cat√°logo global\r\n+// Cat√°logo global\r\n let catalogo = [];\r\n+if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n \r\n-// Si window.catalogo ya est√° listo, √∫salo\r\n-if (window.catalogo && Array.isArray(window.catalogo)) {\r\n-  catalogo = window.catalogo;\r\n-  console.log(\"üì¶ Cat√°logo inicial cargado:\", catalogo.length, \"productos\");\r\n-}\r\n-\r\n-// Escucha el evento por si se carga despu√©s\r\n+// Escucha evento si cat√°logo se carga despu√©s\r\n document.addEventListener(\"catalogoListo\", () => {\r\n-  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n-    catalogo = window.catalogo;\r\n-    console.log(\"üì¶ Cat√°logo actualizado en carrito.js:\", catalogo.length, \"productos\");\r\n-    mostrarCarrito(); // ‚úÖ actualizar carrito si ya hab√≠a productos\r\n-  }\r\n+  if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n+  mostrarCarrito();\r\n });\r\n \r\n // =========================\r\n // CREAR OVERLAY\r\n@@ -48,32 +40,27 @@\n \r\n // =========================\r\n // RENDER PRODUCTOS\r\n // =========================\r\n-const contenedorProductos = document.getElementById(\"productos-grid\"); // cambiar \"productos-grit\" por \"productos-grid\"\r\n-\r\n+const contenedorProductos = document.getElementById(\"productos-grid\");\r\n function renderProductos(lista) {\r\n   if (!contenedorProductos) return;\r\n   contenedorProductos.innerHTML = \"\";\r\n+\r\n   lista.forEach(producto => {\r\n     const div = document.createElement(\"div\");\r\n     div.classList.add(\"producto\");\r\n \r\n-    // ‚úÖ Mostrar precios correctamente\r\n     let precioHTML = \"\";\r\n-    if (producto.precio_con_descuento !== null && producto.precio_con_descuento !== undefined) {\r\n+    if (producto.precio_con_descuento != null) {\r\n       precioHTML = `\r\n         <div class=\"precio\">\r\n           <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n           <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n         </div>\r\n       `;\r\n     } else {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n+      precioHTML = `<div class=\"precio\"><span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span></div>`;\r\n     }\r\n \r\n     div.innerHTML = `\r\n       <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n@@ -88,23 +75,24 @@\n     contenedorProductos.appendChild(div);\r\n   });\r\n }\r\n \r\n-\r\n // =========================\r\n // CALCULAR TOTAL POR PRODUCTO\r\n // =========================\r\n function calcularTotalProducto(producto) {\r\n   const cantidad = producto.cantidad;\r\n   let total = 0;\r\n \r\n-  if (Array.isArray(producto.descuentoVolumen) && producto.descuentoVolumen.length > 0) {\r\n-    // Aplicar solo la primera promo activa\r\n-    const promoActiva = producto.descuentoVolumen.find(d => d.activa);\r\n-    if (promoActiva) {\r\n-      const vecesPromo = Math.floor(cantidad / promoActiva.aplicaA);\r\n-      const resto = cantidad % promoActiva.aplicaA;\r\n-      total = vecesPromo * ((promoActiva.compra * producto.precio) + ((promoActiva.aplicaA - promoActiva.compra) * producto.precio * (1 - promoActiva.promo)));\r\n+  // Descuento por volumen\r\n+  if (producto.descuentoVolumen) {\r\n+    let promo = producto.descuentoVolumen;\r\n+    if (Array.isArray(promo)) promo = promo.find(d => d.activa) || null;\r\n+\r\n+    if (promo) {\r\n+      const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+      const resto = cantidad % promo.aplicaA;\r\n+      total = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n       total += resto * producto.precio;\r\n     } else {\r\n       total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n     }\r\n@@ -114,11 +102,10 @@\n \r\n   return total;\r\n }\r\n \r\n-\r\n // =========================\r\n-// ABRIR / CERRAR CARRITO O SIDERBAR \r\n+// ABRIR / CERRAR SIDEBAR\r\n // =========================\r\n function abrirSidebar() {\r\n   if (!sidebar) return;\r\n   sidebar.classList.add(\"activo\");\r\n@@ -126,11 +113,12 @@\n   document.body.style.overflow = \"hidden\";\r\n   mostrarCarrito();\r\n   history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n+\r\n function cerrarSidebar() {\r\n   if (!sidebar) return;\r\n-  document.activeElement.blur(); // üëà evita el warning de aria-hidden\r\n+  document.activeElement.blur();\r\n   sidebar.classList.remove(\"activo\");\r\n   overlay.classList.remove(\"show\");\r\n   document.body.style.overflow = \"auto\";\r\n   history.replaceState({}, \"\");\r\n@@ -141,38 +129,30 @@\n cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n \r\n+// =========================\r\n+// AGREGAR AL CARRITO\r\n+// =========================\r\n function agregarAlCarrito(idProducto) {\r\n-  if (!catalogo || catalogo.length === 0) {\r\n-    // ‚ùå No mostrar error, sino esperar a que se cargue el cat√°logo\r\n+  if (!catalogo.length) {\r\n     document.addEventListener(\"catalogoListo\", function handler() {\r\n       document.removeEventListener(\"catalogoListo\", handler);\r\n-      agregarAlCarrito(idProducto); // reintenta agregar\r\n+      agregarAlCarrito(idProducto);\r\n     });\r\n     return;\r\n   }\r\n \r\n   const producto = catalogo.find(p => p.id == idProducto);\r\n-  if (!producto) {\r\n-    mostrarToast(\"‚ö†Ô∏è Producto no encontrado en cat√°logo\");\r\n-    return;\r\n-  }\r\n+  if (!producto) return mostrarToast(\"‚ö†Ô∏è Producto no encontrado en cat√°logo\");\r\n \r\n   const existe = carrito.find(p => p.id == idProducto);\r\n-  const cantidadActual = existe ? existe.cantidad : 0;\r\n+  const stockDisponible = producto.stock - (existe ? existe.cantidad : 0);\r\n \r\n-  const stockDisponible = producto.stock - cantidadActual;\r\n-  if (stockDisponible <= 0) {\r\n-    mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n-    return;\r\n-  }\r\n+  if (stockDisponible <= 0) return mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n \r\n-  if (existe) {\r\n-    existe.cantidad++;\r\n-  } else {\r\n-    carrito.push({ ...producto, cantidad: 1 });\r\n-  }\r\n+  if (existe) existe.cantidad++;\r\n+  else carrito.push({ ...producto, cantidad: 1 });\r\n \r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n@@ -185,17 +165,18 @@\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n-  if (carrito.length === 0) {\r\n+  if (!carrito.length) {\r\n     carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n     actualizarTotales();\r\n     actualizarContador();\r\n     return;\r\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n+\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n@@ -207,10 +188,11 @@\n     </thead>\r\n     <tbody>\r\n       ${carrito.map((producto, index) => {\r\n         let descuentoAplicado = false;\r\n-        if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n+        if (producto.descuentoVolumen && ((Array.isArray(producto.descuentoVolumen) && producto.cantidad >= producto.descuentoVolumen[0]?.aplicaA) || (!Array.isArray(producto.descuentoVolumen) && producto.cantidad >= producto.descuentoVolumen.aplicaA))) {\r\n+          descuentoAplicado = true;\r\n+        } else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n \r\n         return `\r\n           <tr>\r\n             <td>\r\n@@ -223,11 +205,10 @@\n               </div>\r\n             </td>\r\n             <td>\r\n               <button class=\"btn-decrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">-</button>\r\n-<span>${producto.cantidad}</span>\r\n-<button class=\"btn-incrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">+</button>\r\n-\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">+</button>\r\n             </td>\r\n             <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n             <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n             <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n@@ -235,16 +216,19 @@\n         `;\r\n       }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n+\r\n   carritoItems.appendChild(tabla);\r\n-\r\n   carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n   guardarCarrito();\r\n }\r\n \r\n+// =========================\r\n+// EVENTO DE BOTONES EN CARRITO\r\n+// =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n   const boton = e.target.closest(\"button\");\r\n   if (!boton) return;\r\n \r\n@@ -253,58 +237,31 @@\n \r\n   const producto = carrito[index];\r\n   if (!producto) return;\r\n \r\n-  // Asegurarse de que el cat√°logo est√© cargado\r\n-  if (!catalogo || catalogo.length === 0) {\r\n-    if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n-    else {\r\n-      mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n-      return;\r\n-    }\r\n-  }\r\n-\r\n-  // Buscar producto original en cat√°logo\r\n   const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-  if (!catalogoProd) {\r\n-    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n-    return;\r\n-  }\r\n+  if (!catalogoProd) return mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n \r\n-// =========================\r\n-// ACCIONES DEL CARRITO\r\n-// =========================\r\n-if (boton.classList.contains(\"carrito-item-close\")) {\r\n-  carrito.splice(index, 1);\r\n-  mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n-\r\n-} else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-  // ‚úÖ Usar la funci√≥n existente para agregar al carrito\r\n-  agregarAlCarrito(producto.id);\r\n-  return; // ‚ö†Ô∏è evitar doble render de mostrarCarrito()\r\n-\r\n-} else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-  if (producto.cantidad > 1) {\r\n-    producto.cantidad--;\r\n-  } else {\r\n-    mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+  if (boton.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n+  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n+    agregarAlCarrito(producto.id);\r\n     return;\r\n+  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+    if (producto.cantidad > 1) producto.cantidad--;\r\n+    else return mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n   }\r\n-}\r\n \r\n-// Actualizar precios desde cat√°logo\r\n-const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-if (catalogoProd) {\r\n+  // Actualizar precios desde cat√°logo\r\n   producto.precio = catalogoProd.precio;\r\n   producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n   producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n-}\r\n \r\n-// Guardar y actualizar UI\r\n-guardarCarrito();\r\n-mostrarCarrito();\r\n+  guardarCarrito();\r\n+  mostrarCarrito();\r\n+});\r\n \r\n-\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n@@ -319,11 +276,9 @@\n function actualizarBarra(totalCarrito) {\r\n   const barraProgreso = document.getElementById(\"barra-progreso\");\r\n   const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n \r\n-  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n-  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n-\r\n+  let porcentaje = Math.min(Math.max((totalCarrito / ENVIO_GRATIS_MINIMO) * 100, 0), 100);\r\n   if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n   if (mensajeEl) {\r\n     if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n@@ -341,18 +296,16 @@\n   if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n \r\n function actualizarTotales() {\r\n-  let subtotal = 0;\r\n-  let descuentoVolumenTotal = 0;\r\n-  let descuentoDirectoTotal = 0;\r\n+  let subtotal = 0, descuentoVolumenTotal = 0, descuentoDirectoTotal = 0;\r\n \r\n   carrito.forEach(p => {\r\n     const precioNormal = p.precio * p.cantidad;\r\n     const precioConDescuento = calcularTotalProducto(p);\r\n     subtotal += precioNormal;\r\n \r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    if (p.descuentoVolumen && p.cantidad >= (p.descuentoVolumen.aplicaA || p.descuentoVolumen[0]?.aplicaA)) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n     else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n   });\r\n \r\n   const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n@@ -371,122 +324,74 @@\n // CONTADOR\r\n // =========================\r\n function actualizarContador() {\r\n   const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-\r\n-  // contador en el icono/header\r\n   if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n \r\n-  // contador dentro del carrito (en el h2)\r\n   const contadorInline = document.getElementById(\"contador-inline\");\r\n   if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n }\r\n \r\n-\r\n // =========================\r\n // TOAST\r\n // =========================\r\n-\r\n-// ‚úÖ Declaramos la variable global antes de usarla\r\n let toastTimeout = null;\r\n-\r\n function mostrarToast(mensaje) {\r\n   let toast = document.getElementById(\"mensajeCarrito\");\r\n-\r\n   if (!toast) {\r\n     toast = document.createElement(\"div\");\r\n     toast.id = \"mensajeCarrito\";\r\n     document.body.appendChild(toast);\r\n   }\r\n \r\n   toast.textContent = mensaje;\r\n   toast.classList.add(\"mostrar\");\r\n-\r\n-  // Limpiar cualquier timeout anterior\r\n   clearTimeout(toastTimeout);\r\n-\r\n-  // Reducir el tiempo a 1 segundo (1000ms) o menos\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000);\r\n }\r\n \r\n-\r\n-\r\n // =========================\r\n // COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n-  if (carrito.length === 0) {\r\n-    mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n-    return;\r\n-  }\r\n+  if (!carrito.length) return mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n \r\n   const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n-  const productos = carrito\r\n-    .map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`)\r\n-    .join(\"\\n\");\r\n-\r\n+  const productos = carrito.map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`).join(\"\\n\");\r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n-  const telefono = \"51929261925\"; // sin el \"+\"\r\n+  const telefono = \"51929261925\";\r\n \r\n   if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    // ‚úÖ Intentar abrir directo la app\r\n     const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n     const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-\r\n-    // Intento directo\r\n     window.location.href = appUrl;\r\n-\r\n-    // ‚è≥ Fallback en 1200ms\r\n-    setTimeout(() => {\r\n-      // Redirige al fallback solo si sigue en la misma p√°gina\r\n-      if (document.visibilityState === \"visible\") {\r\n-        window.location.href = fallbackUrl;\r\n-      }\r\n-      // Aqu√≠ reci√©n vaciamos el carrito\r\n-      vaciarCarritoDespuesEnvio();\r\n-    }, 1200);\r\n-\r\n+    setTimeout(() => { if (document.visibilityState === \"visible\") window.location.href = fallbackUrl; vaciarCarritoDespuesEnvio(); }, 1200);\r\n   } else {\r\n-    // ‚úÖ En PC: usar WhatsApp Web\r\n-    const webUrl = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    window.open(webUrl, \"_blank\");\r\n-\r\n-    // Aqu√≠ s√≠ podemos vaciar de inmediato\r\n+    window.open(`https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`, \"_blank\");\r\n     vaciarCarritoDespuesEnvio();\r\n   }\r\n }\r\n \r\n-// Funci√≥n auxiliar\r\n function vaciarCarritoDespuesEnvio() {\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n-\r\n-  if (sidebar?.classList.contains(\"activo\")) {\r\n-    cerrarSidebar();\r\n-  }\r\n+  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n }\r\n \r\n-\r\n // =========================\r\n // LISTENERS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n document.addEventListener(\"click\", e => {\r\n   if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n-document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => {\r\n-  e.preventDefault();\r\n-  cerrarSidebar();\r\n-  window.location.href = \"carrito.html\";\r\n-});\r\n+document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\"; });\r\n document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n-document.addEventListener(\"keydown\", e => {\r\n-  if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n-});\r\n+document.addEventListener(\"keydown\", e => { if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n \r\n // =========================\r\n // INICIALIZAR\r\n // =========================\r\n"
                },
                {
                    "date": 1760213629389,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,36 +1,42 @@\n // =========================\r\n // ELEMENTOS DEL CARRITO\r\n // =========================\r\n-const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n-const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n-const cerrarCarrito      = document.querySelector(\".cerrar-carrito\");\r\n-const carritoItems       = document.getElementById(\"carrito-items\");\r\n+const abrirCarrito    = document.getElementById(\"abrir-carrito\");\r\n+const sidebar         = document.getElementById(\"carrito-sidebar\"); // puede ser null en carrito.html\r\n+const cerrarCarrito   = document.querySelector(\".cerrar-carrito\");\r\n+const carritoItems    = document.getElementById(\"carrito-items\");\r\n \r\n-const subtotalEl         = document.getElementById(\"subtotal\");\r\n-const totalEl            = document.getElementById(\"total\");\r\n-const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n+const subtotalEl      = document.getElementById(\"subtotal\");\r\n+const totalEl         = document.getElementById(\"total\");\r\n+const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n \r\n-// Campos para descuentos y env√≠o\r\n const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n-\r\n-// Cat√°logo global\r\n let catalogo = [];\r\n-if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n \r\n-// Escucha evento si cat√°logo se carga despu√©s\r\n+// =========================\r\n+// CARGAR CATALOGO GLOBAL\r\n+// =========================\r\n+if (window.catalogo && Array.isArray(window.catalogo)) {\r\n+  catalogo = window.catalogo;\r\n+  console.log(\"üì¶ Cat√°logo cargado:\", catalogo.length, \"productos\");\r\n+}\r\n+\r\n document.addEventListener(\"catalogoListo\", () => {\r\n-  if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n-  mostrarCarrito();\r\n+  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n+    catalogo = window.catalogo;\r\n+    console.log(\"üì¶ Cat√°logo actualizado:\", catalogo.length, \"productos\");\r\n+    mostrarCarrito();\r\n+  }\r\n });\r\n \r\n // =========================\r\n-// CREAR OVERLAY\r\n+// OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -38,145 +44,149 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// RENDER PRODUCTOS\r\n+// FUNCIONES\r\n // =========================\r\n-const contenedorProductos = document.getElementById(\"productos-grid\");\r\n-function renderProductos(lista) {\r\n-  if (!contenedorProductos) return;\r\n-  contenedorProductos.innerHTML = \"\";\r\n+function calcularTotalProducto(producto) {\r\n+  const cantidad = producto.cantidad;\r\n+  let total = 0;\r\n \r\n-  lista.forEach(producto => {\r\n-    const div = document.createElement(\"div\");\r\n-    div.classList.add(\"producto\");\r\n+  if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) {\r\n+    const promo = producto.descuentoVolumen;\r\n+    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+    const resto = cantidad % promo.aplicaA;\r\n+    total = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n+    total += resto * producto.precio;\r\n+  } else {\r\n+    total = (producto.precio_con_descuento ?? producto.precio) * cantidad;\r\n+  }\r\n+  return total;\r\n+}\r\n \r\n-    let precioHTML = \"\";\r\n-    if (producto.precio_con_descuento != null) {\r\n-      precioHTML = `\r\n-        <div class=\"precio\">\r\n-          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n-          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n-        </div>\r\n-      `;\r\n-    } else {\r\n-      precioHTML = `<div class=\"precio\"><span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span></div>`;\r\n-    }\r\n+function guardarCarrito() {\r\n+  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n+}\r\n \r\n-    div.innerHTML = `\r\n-      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n-      <h4>${producto.nombre}</h4>\r\n-      <p>${producto.descripcion || \"\"}</p>\r\n-      ${precioHTML}\r\n-      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n-      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n-      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n-    `;\r\n+function actualizarContador() {\r\n+  const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+  const contadorInline = document.getElementById(\"contador-inline\");\r\n+  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n+}\r\n \r\n-    contenedorProductos.appendChild(div);\r\n+function actualizarTotales() {\r\n+  let subtotal = 0;\r\n+  let descuentoVolumenTotal = 0;\r\n+  let descuentoDirectoTotal = 0;\r\n+\r\n+  carrito.forEach(p => {\r\n+    const precioNormal = p.precio * p.cantidad;\r\n+    const precioConDescuento = calcularTotalProducto(p);\r\n+    subtotal += precioNormal;\r\n+\r\n+    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA)\r\n+      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio)\r\n+      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n   });\r\n+\r\n+  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n+  const totalConDescuentos = subtotal - ahorroTotal;\r\n+\r\n+  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n+\r\n+  actualizarBarra(totalConDescuentos);\r\n }\r\n \r\n-// =========================\r\n-// CALCULAR TOTAL POR PRODUCTO\r\n-// =========================\r\n-function calcularTotalProducto(producto) {\r\n-  const cantidad = producto.cantidad;\r\n-  let total = 0;\r\n+const ENVIO_GRATIS_MINIMO = 99;\r\n+function actualizarBarra(totalCarrito) {\r\n+  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n+  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n+  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n+  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n \r\n-  // Descuento por volumen\r\n-  if (producto.descuentoVolumen) {\r\n-    let promo = producto.descuentoVolumen;\r\n-    if (Array.isArray(promo)) promo = promo.find(d => d.activa) || null;\r\n-\r\n-    if (promo) {\r\n-      const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n-      const resto = cantidad % promo.aplicaA;\r\n-      total = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n-      total += resto * producto.precio;\r\n+  if (mensajeEl) {\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n+      mensajeEl.classList.add(\"gratis\");\r\n+    } else if (totalCarrito > 0) {\r\n+      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     } else {\r\n-      total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n     }\r\n-  } else {\r\n-    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n   }\r\n-\r\n-  return total;\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n }\r\n \r\n-// =========================\r\n-// ABRIR / CERRAR SIDEBAR\r\n-// =========================\r\n-function abrirSidebar() {\r\n-  if (!sidebar) return;\r\n-  sidebar.classList.add(\"activo\");\r\n-  overlay.classList.add(\"show\");\r\n-  document.body.style.overflow = \"hidden\";\r\n-  mostrarCarrito();\r\n-  history.pushState({ carritoAbierto: true }, \"\");\r\n+function mostrarToast(mensaje) {\r\n+  let toast = document.getElementById(\"mensajeCarrito\");\r\n+  if (!toast) {\r\n+    toast = document.createElement(\"div\");\r\n+    toast.id = \"mensajeCarrito\";\r\n+    document.body.appendChild(toast);\r\n+  }\r\n+  toast.textContent = mensaje;\r\n+  toast.classList.add(\"mostrar\");\r\n+  clearTimeout(toast.toastTimeout);\r\n+  toast.toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n }\r\n \r\n-function cerrarSidebar() {\r\n-  if (!sidebar) return;\r\n-  document.activeElement.blur();\r\n-  sidebar.classList.remove(\"activo\");\r\n-  overlay.classList.remove(\"show\");\r\n-  document.body.style.overflow = \"auto\";\r\n-  history.replaceState({}, \"\");\r\n-}\r\n-\r\n-overlay?.addEventListener(\"click\", cerrarSidebar);\r\n-abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n-cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n-window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n-window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n-\r\n // =========================\r\n // AGREGAR AL CARRITO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n-  if (!catalogo.length) {\r\n+  if (!catalogo || catalogo.length === 0) {\r\n     document.addEventListener(\"catalogoListo\", function handler() {\r\n       document.removeEventListener(\"catalogoListo\", handler);\r\n       agregarAlCarrito(idProducto);\r\n     });\r\n     return;\r\n   }\r\n \r\n-  const producto = catalogo.find(p => p.id == idProducto);\r\n-  if (!producto) return mostrarToast(\"‚ö†Ô∏è Producto no encontrado en cat√°logo\");\r\n+  const producto = catalogo.find(p => Number(p.id) === Number(idProducto));\r\n+  if (!producto) return mostrarToast(\"Producto no encontrado\");\r\n \r\n-  const existe = carrito.find(p => p.id == idProducto);\r\n-  const stockDisponible = producto.stock - (existe ? existe.cantidad : 0);\r\n+  const existe = carrito.find(p => Number(p.id) === Number(idProducto));\r\n+  if (existe) {\r\n+    if (existe.cantidad < producto.stock) {\r\n+      existe.cantidad++;\r\n+    } else {\r\n+      return mostrarToast(`Solo hay ${producto.stock} unidades disponibles`);\r\n+    }\r\n+  } else {\r\n+    carrito.push({ ...producto, cantidad: 1 });\r\n+  }\r\n \r\n-  if (stockDisponible <= 0) return mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n-\r\n-  if (existe) existe.cantidad++;\r\n-  else carrito.push({ ...producto, cantidad: 1 });\r\n-\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO\r\n+// MOSTRAR CARRITO (sidebar o tabla)\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n-  if (!carrito.length) {\r\n+  if (carrito.length === 0) {\r\n     carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n     actualizarTotales();\r\n     actualizarContador();\r\n     return;\r\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n-\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n@@ -186,212 +196,105 @@\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((producto, index) => {\r\n+      ${carrito.map((p, i) => {\r\n         let descuentoAplicado = false;\r\n-        if (producto.descuentoVolumen && ((Array.isArray(producto.descuentoVolumen) && producto.cantidad >= producto.descuentoVolumen[0]?.aplicaA) || (!Array.isArray(producto.descuentoVolumen) && producto.cantidad >= producto.descuentoVolumen.aplicaA))) {\r\n-          descuentoAplicado = true;\r\n-        } else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n+        if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n+        else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoAplicado = true;\r\n \r\n         return `\r\n           <tr>\r\n             <td>\r\n               <div class=\"carrito-item-info\">\r\n-                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <img src=\"${p.img}\" alt=\"${p.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n                 <div>\r\n-                  <strong>${producto.nombre}</strong>\r\n-                  <p>${producto.descripcion || \"\"}</p>\r\n+                  <strong>${p.nombre}</strong>\r\n+                  <p>${p.descripcion || \"\"}</p>\r\n                 </div>\r\n               </div>\r\n             </td>\r\n             <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">-</button>\r\n-              <span>${producto.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">+</button>\r\n+              <button class=\"btn-decrementar\" data-index=\"${i}\">-</button>\r\n+              <span>${p.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${i}\">+</button>\r\n             </td>\r\n-            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n+            <td>S/ ${calcularTotalProducto(p).toFixed(2)}</td>\r\n             <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${i}\">X</button></td>\r\n           </tr>\r\n         `;\r\n       }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n+  carritoItems.appendChild(tabla);\r\n \r\n-  carritoItems.appendChild(tabla);\r\n-  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n-  guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// EVENTO DE BOTONES EN CARRITO\r\n+// CLICK EN BOTONES DEL CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n-  const boton = e.target.closest(\"button\");\r\n-  if (!boton) return;\r\n-\r\n-  const index = Number(boton.dataset.index);\r\n+  const btn = e.target.closest(\"button\");\r\n+  if (!btn) return;\r\n+  const index = Number(btn.dataset.index);\r\n   if (isNaN(index)) return;\r\n-\r\n   const producto = carrito[index];\r\n   if (!producto) return;\r\n \r\n-  const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-  if (!catalogoProd) return mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n-\r\n-  if (boton.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n-  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n+  if (btn.classList.contains(\"btn-incrementar\")) {\r\n     agregarAlCarrito(producto.id);\r\n     return;\r\n-  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n+  }\r\n+\r\n+  if (btn.classList.contains(\"btn-decrementar\")) {\r\n     if (producto.cantidad > 1) producto.cantidad--;\r\n     else return mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n   }\r\n \r\n-  // Actualizar precios desde cat√°logo\r\n-  producto.precio = catalogoProd.precio;\r\n-  producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n-  producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n+  if (btn.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n+  }\r\n \r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n // =========================\r\n-// GUARDAR EN LOCALSTORAGE\r\n-// =========================\r\n-function guardarCarrito() {\r\n-  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n-  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n-}\r\n-\r\n-// =========================\r\n-// TOTALES Y BARRA DE ENV√çO\r\n-// =========================\r\n-const ENVIO_GRATIS_MINIMO = 99;\r\n-function actualizarBarra(totalCarrito) {\r\n-  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n-\r\n-  let porcentaje = Math.min(Math.max((totalCarrito / ENVIO_GRATIS_MINIMO) * 100, 0), 100);\r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n-\r\n-  if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n-      mensajeEl.classList.add(\"gratis\");\r\n-    } else if (totalCarrito > 0) {\r\n-      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n-    }\r\n-  }\r\n-\r\n-  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n-}\r\n-\r\n-function actualizarTotales() {\r\n-  let subtotal = 0, descuentoVolumenTotal = 0, descuentoDirectoTotal = 0;\r\n-\r\n-  carrito.forEach(p => {\r\n-    const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = calcularTotalProducto(p);\r\n-    subtotal += precioNormal;\r\n-\r\n-    if (p.descuentoVolumen && p.cantidad >= (p.descuentoVolumen.aplicaA || p.descuentoVolumen[0]?.aplicaA)) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n-  });\r\n-\r\n-  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n-  const totalConDescuentos = subtotal - ahorroTotal;\r\n-\r\n-  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n-\r\n-  actualizarBarra(totalConDescuentos);\r\n-}\r\n-\r\n-// =========================\r\n-// CONTADOR\r\n-// =========================\r\n-function actualizarContador() {\r\n-  const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n-\r\n-  const contadorInline = document.getElementById(\"contador-inline\");\r\n-  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n-}\r\n-\r\n-// =========================\r\n-// TOAST\r\n-// =========================\r\n-let toastTimeout = null;\r\n-function mostrarToast(mensaje) {\r\n-  let toast = document.getElementById(\"mensajeCarrito\");\r\n-  if (!toast) {\r\n-    toast = document.createElement(\"div\");\r\n-    toast.id = \"mensajeCarrito\";\r\n-    document.body.appendChild(toast);\r\n-  }\r\n-\r\n-  toast.textContent = mensaje;\r\n-  toast.classList.add(\"mostrar\");\r\n-  clearTimeout(toastTimeout);\r\n-  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000);\r\n-}\r\n-\r\n-// =========================\r\n // COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n-  if (!carrito.length) return mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n-\r\n+  if (carrito.length === 0) return mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n   const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n   const productos = carrito.map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`).join(\"\\n\");\r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"51929261925\";\r\n \r\n   if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n-    window.location.href = appUrl;\r\n-    setTimeout(() => { if (document.visibilityState === \"visible\") window.location.href = fallbackUrl; vaciarCarritoDespuesEnvio(); }, 1200);\r\n+    window.location.href = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    setTimeout(() => window.location.href = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, 1200);\r\n   } else {\r\n     window.open(`https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`, \"_blank\");\r\n-    vaciarCarritoDespuesEnvio();\r\n   }\r\n-}\r\n \r\n-function vaciarCarritoDespuesEnvio() {\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n-  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n }\r\n \r\n // =========================\r\n-// LISTENERS GENERALES\r\n+// LISTENERS\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\"))\r\n+    agregarAlCarrito(e.target.dataset.id);\r\n });\r\n-document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\"; });\r\n-document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n-document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n-document.addEventListener(\"keydown\", e => { if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n \r\n // =========================\r\n // INICIALIZAR\r\n // =========================\r\n"
                },
                {
                    "date": 1760213923162,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,42 +1,36 @@\n // =========================\r\n // ELEMENTOS DEL CARRITO\r\n // =========================\r\n-const abrirCarrito    = document.getElementById(\"abrir-carrito\");\r\n-const sidebar         = document.getElementById(\"carrito-sidebar\"); // puede ser null en carrito.html\r\n-const cerrarCarrito   = document.querySelector(\".cerrar-carrito\");\r\n-const carritoItems    = document.getElementById(\"carrito-items\");\r\n+const abrirCarrito       = document.getElementById(\"abrir-carrito\");\r\n+const sidebar            = document.getElementById(\"carrito-sidebar\");\r\n+const cerrarCarrito      = document.querySelector(\".cerrar-carrito\");\r\n+const carritoItems       = document.getElementById(\"carrito-items\");\r\n \r\n-const subtotalEl      = document.getElementById(\"subtotal\");\r\n-const totalEl         = document.getElementById(\"total\");\r\n-const contadorCarrito = document.getElementById(\"contador-carrito\");\r\n+const subtotalEl         = document.getElementById(\"subtotal\");\r\n+const totalEl            = document.getElementById(\"total\");\r\n+const contadorCarrito    = document.getElementById(\"contador-carrito\");\r\n \r\n+// Campos para descuentos y env√≠o\r\n const descuentoVolumenEl = document.getElementById(\"descuento-volumen\");\r\n const descuentoDirectoEl = document.getElementById(\"descuento-directo\");\r\n const ahorroTotalEl      = document.getElementById(\"ahorro-total\");\r\n const costoEnvioEl       = document.getElementById(\"costo-envio\");\r\n \r\n let carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n+\r\n+// Cat√°logo global\r\n let catalogo = [];\r\n+if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n \r\n-// =========================\r\n-// CARGAR CATALOGO GLOBAL\r\n-// =========================\r\n-if (window.catalogo && Array.isArray(window.catalogo)) {\r\n-  catalogo = window.catalogo;\r\n-  console.log(\"üì¶ Cat√°logo cargado:\", catalogo.length, \"productos\");\r\n-}\r\n-\r\n+// Escucha evento si cat√°logo se carga despu√©s\r\n document.addEventListener(\"catalogoListo\", () => {\r\n-  if (window.catalogo && Array.isArray(window.catalogo)) {\r\n-    catalogo = window.catalogo;\r\n-    console.log(\"üì¶ Cat√°logo actualizado:\", catalogo.length, \"productos\");\r\n-    mostrarCarrito();\r\n-  }\r\n+  if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n+  mostrarCarrito();\r\n });\r\n \r\n // =========================\r\n-// OVERLAY\r\n+// CREAR OVERLAY\r\n // =========================\r\n let overlay = document.getElementById(\"overlay-carrito\");\r\n if (!overlay) {\r\n   overlay = document.createElement(\"div\");\r\n@@ -44,149 +38,145 @@\n   document.body.appendChild(overlay);\r\n }\r\n \r\n // =========================\r\n-// FUNCIONES\r\n+// RENDER PRODUCTOS\r\n // =========================\r\n-function calcularTotalProducto(producto) {\r\n-  const cantidad = producto.cantidad;\r\n-  let total = 0;\r\n+const contenedorProductos = document.getElementById(\"productos-grid\");\r\n+function renderProductos(lista) {\r\n+  if (!contenedorProductos) return;\r\n+  contenedorProductos.innerHTML = \"\";\r\n \r\n-  if (producto.descuentoVolumen && producto.cantidad >= producto.descuentoVolumen.aplicaA) {\r\n-    const promo = producto.descuentoVolumen;\r\n-    const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n-    const resto = cantidad % promo.aplicaA;\r\n-    total = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n-    total += resto * producto.precio;\r\n-  } else {\r\n-    total = (producto.precio_con_descuento ?? producto.precio) * cantidad;\r\n-  }\r\n-  return total;\r\n-}\r\n+  lista.forEach(producto => {\r\n+    const div = document.createElement(\"div\");\r\n+    div.classList.add(\"producto\");\r\n \r\n-function guardarCarrito() {\r\n-  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n-}\r\n+    let precioHTML = \"\";\r\n+    if (producto.precio_con_descuento != null) {\r\n+      precioHTML = `\r\n+        <div class=\"precio\">\r\n+          <span class=\"precio-regular tachado\">S/ ${producto.precio.toFixed(2)}</span>\r\n+          <span class=\"precio-descuento\">S/ ${producto.precio_con_descuento.toFixed(2)}</span>\r\n+        </div>\r\n+      `;\r\n+    } else {\r\n+      precioHTML = `<div class=\"precio\"><span class=\"precio-regular\">S/ ${producto.precio.toFixed(2)}</span></div>`;\r\n+    }\r\n \r\n-function actualizarContador() {\r\n-  const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n-  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n-  const contadorInline = document.getElementById(\"contador-inline\");\r\n-  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n-}\r\n+    div.innerHTML = `\r\n+      <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:120px;height:120px;object-fit:contain;\">\r\n+      <h4>${producto.nombre}</h4>\r\n+      <p>${producto.descripcion || \"\"}</p>\r\n+      ${precioHTML}\r\n+      <div class=\"descuento\">${producto.descuento || \"\"}</div>\r\n+      <div class=\"ahorro\">${producto.ahorro ? `Ahorro: S/ ${producto.ahorro.toFixed(2)}` : \"\"}</div>\r\n+      <button class=\"btn-agregar-carrito\" data-id=\"${producto.id}\">Agregar al carrito</button>\r\n+    `;\r\n \r\n-function actualizarTotales() {\r\n-  let subtotal = 0;\r\n-  let descuentoVolumenTotal = 0;\r\n-  let descuentoDirectoTotal = 0;\r\n-\r\n-  carrito.forEach(p => {\r\n-    const precioNormal = p.precio * p.cantidad;\r\n-    const precioConDescuento = calcularTotalProducto(p);\r\n-    subtotal += precioNormal;\r\n-\r\n-    if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA)\r\n-      descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n-    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio)\r\n-      descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+    contenedorProductos.appendChild(div);\r\n   });\r\n+}\r\n \r\n-  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n-  const totalConDescuentos = subtotal - ahorroTotal;\r\n+// =========================\r\n+// CALCULAR TOTAL POR PRODUCTO\r\n+// =========================\r\n+function calcularTotalProducto(producto) {\r\n+  const cantidad = producto.cantidad;\r\n+  let total = 0;\r\n \r\n-  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n-  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n-  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n-  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n-  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n+  // Descuento por volumen\r\n+  if (producto.descuentoVolumen) {\r\n+    let promo = producto.descuentoVolumen;\r\n+    if (Array.isArray(promo)) promo = promo.find(d => d.activa) || null;\r\n \r\n-  actualizarBarra(totalConDescuentos);\r\n-}\r\n-\r\n-const ENVIO_GRATIS_MINIMO = 99;\r\n-function actualizarBarra(totalCarrito) {\r\n-  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n-  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n-  let porcentaje = (totalCarrito / ENVIO_GRATIS_MINIMO) * 100;\r\n-  porcentaje = Math.min(Math.max(porcentaje, 0), 100);\r\n-  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n-\r\n-  if (mensajeEl) {\r\n-    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n-      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n-      mensajeEl.classList.add(\"gratis\");\r\n-    } else if (totalCarrito > 0) {\r\n-      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n+    if (promo) {\r\n+      const vecesPromo = Math.floor(cantidad / promo.aplicaA);\r\n+      const resto = cantidad % promo.aplicaA;\r\n+      total = vecesPromo * ((promo.compra * producto.precio) + ((promo.aplicaA - promo.compra) * producto.precio * (1 - promo.promo)));\r\n+      total += resto * producto.precio;\r\n     } else {\r\n-      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n-      mensajeEl.classList.remove(\"gratis\");\r\n+      total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n     }\r\n+  } else {\r\n+    total = (producto.precio_con_descuento || producto.precio) * cantidad;\r\n   }\r\n-  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+\r\n+  return total;\r\n }\r\n \r\n-function mostrarToast(mensaje) {\r\n-  let toast = document.getElementById(\"mensajeCarrito\");\r\n-  if (!toast) {\r\n-    toast = document.createElement(\"div\");\r\n-    toast.id = \"mensajeCarrito\";\r\n-    document.body.appendChild(toast);\r\n-  }\r\n-  toast.textContent = mensaje;\r\n-  toast.classList.add(\"mostrar\");\r\n-  clearTimeout(toast.toastTimeout);\r\n-  toast.toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 800);\r\n+// =========================\r\n+// ABRIR / CERRAR SIDEBAR\r\n+// =========================\r\n+function abrirSidebar() {\r\n+  if (!sidebar) return;\r\n+  sidebar.classList.add(\"activo\");\r\n+  overlay.classList.add(\"show\");\r\n+  document.body.style.overflow = \"hidden\";\r\n+  mostrarCarrito();\r\n+  history.pushState({ carritoAbierto: true }, \"\");\r\n }\r\n \r\n+function cerrarSidebar() {\r\n+  if (!sidebar) return;\r\n+  document.activeElement.blur();\r\n+  sidebar.classList.remove(\"activo\");\r\n+  overlay.classList.remove(\"show\");\r\n+  document.body.style.overflow = \"auto\";\r\n+  history.replaceState({}, \"\");\r\n+}\r\n+\r\n+overlay?.addEventListener(\"click\", cerrarSidebar);\r\n+abrirCarrito?.addEventListener(\"click\", e => { e.preventDefault(); abrirSidebar(); });\r\n+cerrarCarrito?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); });\r\n+window.addEventListener(\"popstate\", () => { if (sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n+window.addEventListener(\"pageshow\", e => { if (e.persisted) { cerrarSidebar(); mostrarCarrito(); } });\r\n+\r\n // =========================\r\n // AGREGAR AL CARRITO\r\n // =========================\r\n function agregarAlCarrito(idProducto) {\r\n-  if (!catalogo || catalogo.length === 0) {\r\n+  if (!catalogo.length) {\r\n     document.addEventListener(\"catalogoListo\", function handler() {\r\n       document.removeEventListener(\"catalogoListo\", handler);\r\n       agregarAlCarrito(idProducto);\r\n     });\r\n     return;\r\n   }\r\n \r\n-  const producto = catalogo.find(p => Number(p.id) === Number(idProducto));\r\n-  if (!producto) return mostrarToast(\"Producto no encontrado\");\r\n+  const producto = catalogo.find(p => p.id == idProducto);\r\n+  if (!producto) return mostrarToast(\"‚ö†Ô∏è Producto no encontrado en cat√°logo\");\r\n \r\n-  const existe = carrito.find(p => Number(p.id) === Number(idProducto));\r\n-  if (existe) {\r\n-    if (existe.cantidad < producto.stock) {\r\n-      existe.cantidad++;\r\n-    } else {\r\n-      return mostrarToast(`Solo hay ${producto.stock} unidades disponibles`);\r\n-    }\r\n-  } else {\r\n-    carrito.push({ ...producto, cantidad: 1 });\r\n-  }\r\n+  const existe = carrito.find(p => p.id == idProducto);\r\n+  const stockDisponible = producto.stock - (existe ? existe.cantidad : 0);\r\n \r\n+  if (stockDisponible <= 0) return mostrarToast(`Lo sentimos, ${producto.nombre} est√° agotado üõë`);\r\n+\r\n+  if (existe) existe.cantidad++;\r\n+  else carrito.push({ ...producto, cantidad: 1 });\r\n+\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(`${producto.nombre} agregado al carrito üõí`);\r\n }\r\n \r\n // =========================\r\n-// MOSTRAR CARRITO (sidebar o tabla)\r\n+// MOSTRAR CARRITO\r\n // =========================\r\n function mostrarCarrito() {\r\n   if (!carritoItems) return;\r\n   carritoItems.innerHTML = \"\";\r\n \r\n-  if (carrito.length === 0) {\r\n+  if (!carrito.length) {\r\n     carritoItems.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n     actualizarTotales();\r\n     actualizarContador();\r\n     return;\r\n   }\r\n \r\n   const tabla = document.createElement(\"table\");\r\n   tabla.classList.add(\"tabla-carrito\");\r\n+\r\n   tabla.innerHTML = `\r\n     <thead>\r\n       <tr>\r\n         <th>Producto</th>\r\n@@ -196,105 +186,212 @@\n         <th>Acci√≥n</th>\r\n       </tr>\r\n     </thead>\r\n     <tbody>\r\n-      ${carrito.map((p, i) => {\r\n+      ${carrito.map((producto, index) => {\r\n         let descuentoAplicado = false;\r\n-        if (p.descuentoVolumen && p.cantidad >= p.descuentoVolumen.aplicaA) descuentoAplicado = true;\r\n-        else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoAplicado = true;\r\n+        if (producto.descuentoVolumen && ((Array.isArray(producto.descuentoVolumen) && producto.cantidad >= producto.descuentoVolumen[0]?.aplicaA) || (!Array.isArray(producto.descuentoVolumen) && producto.cantidad >= producto.descuentoVolumen.aplicaA))) {\r\n+          descuentoAplicado = true;\r\n+        } else if (producto.precio_con_descuento && producto.precio_con_descuento < producto.precio) descuentoAplicado = true;\r\n \r\n         return `\r\n           <tr>\r\n             <td>\r\n               <div class=\"carrito-item-info\">\r\n-                <img src=\"${p.img}\" alt=\"${p.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n+                <img src=\"${producto.img}\" alt=\"${producto.nombre}\" style=\"width:60px;height:60px;object-fit:contain;\">\r\n                 <div>\r\n-                  <strong>${p.nombre}</strong>\r\n-                  <p>${p.descripcion || \"\"}</p>\r\n+                  <strong>${producto.nombre}</strong>\r\n+                  <p>${producto.descripcion || \"\"}</p>\r\n                 </div>\r\n               </div>\r\n             </td>\r\n             <td>\r\n-              <button class=\"btn-decrementar\" data-index=\"${i}\">-</button>\r\n-              <span>${p.cantidad}</span>\r\n-              <button class=\"btn-incrementar\" data-index=\"${i}\">+</button>\r\n+              <button class=\"btn-decrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">-</button>\r\n+              <span>${producto.cantidad}</span>\r\n+              <button class=\"btn-incrementar\" data-index=\"${index}\" data-id=\"${producto.id}\">+</button>\r\n             </td>\r\n-            <td>S/ ${calcularTotalProducto(p).toFixed(2)}</td>\r\n+            <td>S/ ${calcularTotalProducto(producto).toFixed(2)}</td>\r\n             <td>${descuentoAplicado ? \"S√≠\" : \"No\"}</td>\r\n-            <td><button class=\"carrito-item-close\" data-index=\"${i}\">X</button></td>\r\n+            <td><button class=\"carrito-item-close\" data-index=\"${index}\">X</button></td>\r\n           </tr>\r\n         `;\r\n       }).join(\"\")}\r\n     </tbody>\r\n   `;\r\n+\r\n   carritoItems.appendChild(tabla);\r\n-\r\n+  carritoItems.style.overflowY = carrito.length >= 2 ? 'auto' : 'hidden';\r\n   actualizarTotales();\r\n   actualizarContador();\r\n+  guardarCarrito();\r\n }\r\n \r\n // =========================\r\n-// CLICK EN BOTONES DEL CARRITO\r\n+// EVENTO DE BOTONES EN CARRITO\r\n // =========================\r\n carritoItems?.addEventListener(\"click\", e => {\r\n-  const btn = e.target.closest(\"button\");\r\n-  if (!btn) return;\r\n-  const index = Number(btn.dataset.index);\r\n+  const boton = e.target.closest(\"button\");\r\n+  if (!boton) return;\r\n+\r\n+  const index = Number(boton.dataset.index);\r\n   if (isNaN(index)) return;\r\n+\r\n   const producto = carrito[index];\r\n   if (!producto) return;\r\n \r\n-  if (btn.classList.contains(\"btn-incrementar\")) {\r\n+  const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n+  if (!catalogoProd) return mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n+\r\n+  if (boton.classList.contains(\"carrito-item-close\")) {\r\n+    carrito.splice(index, 1);\r\n+    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n+  } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n     agregarAlCarrito(producto.id);\r\n     return;\r\n-  }\r\n-\r\n-  if (btn.classList.contains(\"btn-decrementar\")) {\r\n+  } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n     if (producto.cantidad > 1) producto.cantidad--;\r\n     else return mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n   }\r\n \r\n-  if (btn.classList.contains(\"carrito-item-close\")) {\r\n-    carrito.splice(index, 1);\r\n-    mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n-  }\r\n+  // Actualizar precios desde cat√°logo\r\n+  producto.precio = catalogoProd.precio;\r\n+  producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n+  producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n \r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n // =========================\r\n+// GUARDAR EN LOCALSTORAGE\r\n+// =========================\r\n+function guardarCarrito() {\r\n+  try { localStorage.setItem(\"carrito\", JSON.stringify(carrito)); }\r\n+  catch (e) { console.error(\"Error al guardar carrito\", e); }\r\n+}\r\n+\r\n+// =========================\r\n+// TOTALES Y BARRA DE ENV√çO\r\n+// =========================\r\n+const ENVIO_GRATIS_MINIMO = 99;\r\n+function actualizarBarra(totalCarrito) {\r\n+  const barraProgreso = document.getElementById(\"barra-progreso\");\r\n+  const mensajeEl = document.getElementById(\"mensaje-envio\");\r\n+\r\n+  let porcentaje = Math.min(Math.max((totalCarrito / ENVIO_GRATIS_MINIMO) * 100, 0), 100);\r\n+  if (barraProgreso) barraProgreso.style.width = `${porcentaje}%`;\r\n+\r\n+  if (mensajeEl) {\r\n+    if (totalCarrito >= ENVIO_GRATIS_MINIMO) {\r\n+      mensajeEl.textContent = \"üéâ ¬°Felicidades, tu compra califica para env√≠o gratis!\";\r\n+      mensajeEl.classList.add(\"gratis\");\r\n+    } else if (totalCarrito > 0) {\r\n+      mensajeEl.textContent = `Agrega S/ ${(ENVIO_GRATIS_MINIMO - totalCarrito).toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n+    } else {\r\n+      mensajeEl.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO.toFixed(2)} y obt√©n env√≠o gratis`;\r\n+      mensajeEl.classList.remove(\"gratis\");\r\n+    }\r\n+  }\r\n+\r\n+  if (costoEnvioEl) costoEnvioEl.textContent = totalCarrito >= ENVIO_GRATIS_MINIMO ? \"Gratis\" : \"--\";\r\n+}\r\n+\r\n+function actualizarTotales() {\r\n+  let subtotal = 0, descuentoVolumenTotal = 0, descuentoDirectoTotal = 0;\r\n+\r\n+  carrito.forEach(p => {\r\n+    const precioNormal = p.precio * p.cantidad;\r\n+    const precioConDescuento = calcularTotalProducto(p);\r\n+    subtotal += precioNormal;\r\n+\r\n+    if (p.descuentoVolumen && p.cantidad >= (p.descuentoVolumen.aplicaA || p.descuentoVolumen[0]?.aplicaA)) descuentoVolumenTotal += precioNormal - precioConDescuento;\r\n+    else if (p.precio_con_descuento && p.precio_con_descuento < p.precio) descuentoDirectoTotal += precioNormal - precioConDescuento;\r\n+  });\r\n+\r\n+  const ahorroTotal = descuentoVolumenTotal + descuentoDirectoTotal;\r\n+  const totalConDescuentos = subtotal - ahorroTotal;\r\n+\r\n+  if (subtotalEl) subtotalEl.textContent = `S/ ${subtotal.toFixed(2)}`;\r\n+  if (descuentoVolumenEl) descuentoVolumenEl.textContent = `S/ ${descuentoVolumenTotal.toFixed(2)}`;\r\n+  if (descuentoDirectoEl) descuentoDirectoEl.textContent = `S/ ${descuentoDirectoTotal.toFixed(2)}`;\r\n+  if (ahorroTotalEl) ahorroTotalEl.textContent = `S/ ${ahorroTotal.toFixed(2)}`;\r\n+  if (totalEl) totalEl.textContent = `S/ ${totalConDescuentos.toFixed(2)}`;\r\n+\r\n+  actualizarBarra(totalConDescuentos);\r\n+}\r\n+\r\n+// =========================\r\n+// CONTADOR\r\n+// =========================\r\n+function actualizarContador() {\r\n+  const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);\r\n+  if (contadorCarrito) contadorCarrito.textContent = totalItems;\r\n+\r\n+  const contadorInline = document.getElementById(\"contador-inline\");\r\n+  if (contadorInline) contadorInline.textContent = `(${totalItems})`;\r\n+}\r\n+\r\n+// =========================\r\n+// TOAST\r\n+// =========================\r\n+let toastTimeout = null;\r\n+function mostrarToast(mensaje) {\r\n+  let toast = document.getElementById(\"mensajeCarrito\");\r\n+  if (!toast) {\r\n+    toast = document.createElement(\"div\");\r\n+    toast.id = \"mensajeCarrito\";\r\n+    document.body.appendChild(toast);\r\n+  }\r\n+\r\n+  toast.textContent = mensaje;\r\n+  toast.classList.add(\"mostrar\");\r\n+  clearTimeout(toastTimeout);\r\n+  toastTimeout = setTimeout(() => toast.classList.remove(\"mostrar\"), 1000);\r\n+}\r\n+\r\n+// =========================\r\n // COMPRAR AHORA POR WHATSAPP\r\n // =========================\r\n function comprarAhora() {\r\n-  if (carrito.length === 0) return mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n+  if (!carrito.length) return mostrarToast(\"El carrito est√° vac√≠o ‚ö†Ô∏è\");\r\n+\r\n   const totalCompra = totalEl ? totalEl.innerText : \"\";\r\n   const productos = carrito.map(p => `${p.nombre} (x${p.cantidad}) - S/ ${calcularTotalProducto(p).toFixed(2)}`).join(\"\\n\");\r\n   const mensaje = `¬°Hola! Quiero comprar estos productos:\\n${productos}\\n\\nüí∞ Total: ${totalCompra}`;\r\n   const telefono = \"51929261925\";\r\n \r\n   if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {\r\n-    window.location.href = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n-    setTimeout(() => window.location.href = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, 1200);\r\n+    const appUrl = `whatsapp://send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;\r\n+    const fallbackUrl = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;\r\n+    window.location.href = appUrl;\r\n+    setTimeout(() => { if (document.visibilityState === \"visible\") window.location.href = fallbackUrl; vaciarCarritoDespuesEnvio(); }, 1200);\r\n   } else {\r\n     window.open(`https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`, \"_blank\");\r\n+    vaciarCarritoDespuesEnvio();\r\n   }\r\n+}\r\n \r\n+function vaciarCarritoDespuesEnvio() {\r\n   carrito = [];\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n   actualizarContador();\r\n   mostrarToast(\"Pedido enviado por WhatsApp y carrito vaciado üßæ\");\r\n+  if (sidebar?.classList.contains(\"activo\")) cerrarSidebar();\r\n }\r\n \r\n // =========================\r\n-// LISTENERS\r\n+// LISTENERS GENERALES\r\n // =========================\r\n document.getElementById(\"whatsapp-comprar\")?.addEventListener(\"click\", comprarAhora);\r\n document.addEventListener(\"click\", e => {\r\n-  if (e.target.classList.contains(\"btn-agregar-carrito\"))\r\n-    agregarAlCarrito(e.target.dataset.id);\r\n+  if (e.target.classList.contains(\"btn-agregar-carrito\")) agregarAlCarrito(e.target.dataset.id);\r\n });\r\n+document.querySelector(\".btn-ver-carrito\")?.addEventListener(\"click\", e => { e.preventDefault(); cerrarSidebar(); window.location.href = \"carrito.html\"; });\r\n+document.getElementById(\"ir-a-pagar\")?.addEventListener(\"click\", comprarAhora);\r\n+document.getElementById(\"btn-comprar-whatsapp\")?.addEventListener(\"click\", comprarAhora);\r\n+document.addEventListener(\"keydown\", e => { if (e.key === \"Escape\" && sidebar?.classList.contains(\"activo\")) cerrarSidebar(); });\r\n \r\n // =========================\r\n // INICIALIZAR\r\n // =========================\r\n"
                },
                {
                    "date": 1760214024993,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -237,31 +237,59 @@\n \r\n   const producto = carrito[index];\r\n   if (!producto) return;\r\n \r\n+  // Asegurarse de que el cat√°logo est√© cargado\r\n+  if (!catalogo || catalogo.length === 0) {\r\n+    if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n+    else {\r\n+      mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n+      return;\r\n+    }\r\n+  }\r\n+\r\n+  // Buscar producto original en cat√°logo\r\n   const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-  if (!catalogoProd) return mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n+  if (!catalogoProd) {\r\n+    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n+    return;\r\n+  }\r\n \r\n+  // =========================\r\n+  // ACCIONES DEL CARRITO\r\n+  // =========================\r\n   if (boton.classList.contains(\"carrito-item-close\")) {\r\n     carrito.splice(index, 1);\r\n     mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n+\r\n   } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    agregarAlCarrito(producto.id);\r\n-    return;\r\n+    if (producto.cantidad < catalogoProd.stock) {\r\n+      producto.cantidad++;\r\n+    } else {\r\n+      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n+      return;\r\n+    }\r\n+\r\n   } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n-    if (producto.cantidad > 1) producto.cantidad--;\r\n-    else return mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+    if (producto.cantidad > 1) {\r\n+      producto.cantidad--;\r\n+    } else {\r\n+      mostrarToast(\"La cantidad m√≠nima es 1 ‚ö†Ô∏è\");\r\n+      return;\r\n+    }\r\n   }\r\n \r\n   // Actualizar precios desde cat√°logo\r\n   producto.precio = catalogoProd.precio;\r\n   producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n   producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n \r\n+  // Guardar y actualizar UI\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n \r\n+\r\n // =========================\r\n // GUARDAR EN LOCALSTORAGE\r\n // =========================\r\n function guardarCarrito() {\r\n"
                },
                {
                    "date": 1760217927436,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -237,36 +237,20 @@\n \r\n   const producto = carrito[index];\r\n   if (!producto) return;\r\n \r\n-  // Asegurarse de que el cat√°logo est√© cargado\r\n-  if (!catalogo || catalogo.length === 0) {\r\n-    if (window.catalogo && Array.isArray(window.catalogo)) catalogo = window.catalogo;\r\n-    else {\r\n-      mostrarToast(\"‚è≥ Espera a que se cargue el cat√°logo...\");\r\n-      return;\r\n-    }\r\n-  }\r\n-\r\n-  // Buscar producto original en cat√°logo\r\n-  const catalogoProd = catalogo.find(p => Number(p.id) === Number(producto.id));\r\n-  if (!catalogoProd) {\r\n-    mostrarToast(`El producto \"${producto.nombre}\" no est√° disponible üõë`);\r\n-    return;\r\n-  }\r\n-\r\n   // =========================\r\n   // ACCIONES DEL CARRITO\r\n   // =========================\r\n   if (boton.classList.contains(\"carrito-item-close\")) {\r\n     carrito.splice(index, 1);\r\n     mostrarToast(`Se elimin√≥ ${producto.nombre} del carrito üóëÔ∏è`);\r\n \r\n   } else if (boton.classList.contains(\"btn-incrementar\")) {\r\n-    if (producto.cantidad < catalogoProd.stock) {\r\n+    if (producto.cantidad < (producto.stock || 9999)) { // usa stock si est√° disponible\r\n       producto.cantidad++;\r\n     } else {\r\n-      mostrarToast(`Solo hay ${catalogoProd.stock} unidades disponibles de ${producto.nombre} üõë`);\r\n+      mostrarToast(`Solo hay ${producto.stock || 0} unidades disponibles de ${producto.nombre} üõë`);\r\n       return;\r\n     }\r\n \r\n   } else if (boton.classList.contains(\"btn-decrementar\")) {\r\n@@ -277,13 +261,9 @@\n       return;\r\n     }\r\n   }\r\n \r\n-  // Actualizar precios desde cat√°logo\r\n-  producto.precio = catalogoProd.precio;\r\n-  producto.precio_con_descuento = catalogoProd.precio_con_descuento ?? null;\r\n-  producto.descuentoVolumen = catalogoProd.descuentoVolumen ?? null;\r\n-\r\n+  // ‚úÖ No necesitamos buscar el cat√°logo de nuevo\r\n   // Guardar y actualizar UI\r\n   guardarCarrito();\r\n   mostrarCarrito();\r\n });\r\n"
                }
            ],
            "date": 1756771257432,
            "name": "Commit-0",
            "content": "// Recuperamos carrito de localStorage o inicializamos vac√≠o\r\nlet carrito = JSON.parse(localStorage.getItem(\"carrito\")) || [];\r\n\r\n// Constante: monto m√≠nimo para aplicar env√≠o gratis\r\nconst ENVIO_GRATIS_MINIMO = 65;\r\n\r\n// ==== Funci√≥n para guardar el carrito en localStorage ====\r\nfunction guardarCarrito() {\r\n  localStorage.setItem(\"carrito\", JSON.stringify(carrito));\r\n}\r\n\r\n// ==== Funci√≥n para actualizar la barra de progreso ====\r\nfunction actualizarBarraEnvio() {\r\n  // Recalcular el subtotal desde el carrito\r\n  let subtotal = carrito.reduce((acc, producto) => acc + (producto.precio * producto.cantidad), 0);\r\n\r\n  // Seleccionamos la barra de progreso\r\n  const barraProgreso = document.getElementById('barra-progreso');\r\n  if (!barraProgreso) {\r\n    console.error(\"El elemento de la barra de progreso no se encuentra.\");\r\n    return;  // Asegurarnos de que el elemento existe\r\n  }\r\n\r\n  // Calcular el porcentaje de progreso\r\n  const porcentaje = Math.min((subtotal / ENVIO_GRATIS_MINIMO) * 100, 100);\r\n  barraProgreso.style.width = porcentaje + '%'; // Actualiza el ancho de la barra con el porcentaje\r\n\r\n  // Actualizamos el texto de la barra\r\n  const mensajeBarra = document.querySelector('.progress-bar span');\r\n  mensajeBarra.textContent = `Agrega S/ ${ENVIO_GRATIS_MINIMO - subtotal} en productos y obt√©n env√≠o gratis`;\r\n}\r\n\r\n// ==== Funci√≥n para renderizar el carrito en la p√°gina ====\r\nfunction renderCarrito() {\r\n  const tabla = document.getElementById(\"tabla-carrito\");\r\n  const vacio = document.getElementById(\"carrito-vacio\");\r\n  const items = document.getElementById(\"carrito-items\");\r\n  const contador = document.querySelectorAll(\"#contador-carrito\");\r\n  const subtotalEl = document.getElementById(\"subtotal\");\r\n  const totalEl = document.getElementById(\"total\");\r\n  const envioGratis = document.getElementById(\"envio-gratis\");\r\n  const faltanteEl = document.getElementById(\"faltante-envio\");\r\n  const barra = document.getElementById(\"barra-progreso\");\r\n\r\n  if (items) items.innerHTML = \"\";\r\n  let subtotal = 0;\r\n\r\n  // ==== Carrito vac√≠o ====\r\n  if (carrito.length === 0) {\r\n    if (tabla) tabla.classList.add(\"oculto\");\r\n    if (vacio) vacio.classList.remove(\"oculto\");\r\n    contador.forEach(c => c.innerText = \"0\");\r\n    if (subtotalEl) subtotalEl.innerText = \"S/ 0.00\";\r\n    if (totalEl) totalEl.innerText = \"S/ 0.00\";\r\n    if (envioGratis) envioGratis.classList.add(\"oculto\");\r\n    if (items) items.innerHTML = `<p>Tu carrito est√° vac√≠o</p>`;\r\n    localStorage.removeItem(\"carrito\");\r\n    actualizarBarraEnvio(); // Asegura que la barra se actualice cuando el carrito est√° vac√≠o\r\n    return;\r\n  }\r\n\r\n  // ==== Carrito con productos ====\r\n  carrito.forEach((p, i) => {\r\n    subtotal += p.precio * p.cantidad;\r\n\r\n    if (items && items.tagName === \"TBODY\") {\r\n      // Vista completa en tabla\r\n      items.innerHTML += `\r\n        <tr>\r\n          <td><img src=\"${p.img}\" alt=\"${p.nombre}\" width=\"50\"> ${p.nombre}</td>\r\n          <td>\r\n            <button onclick=\"cambiarCantidad(${i}, -1)\">-</button>\r\n            ${p.cantidad}\r\n            <button onclick=\"cambiarCantidad(${i}, 1)\">+</button>\r\n          </td>\r\n          <td>S/ ${(p.precio * p.cantidad).toFixed(2)}</td>\r\n          <td><button onclick=\"eliminarProducto(${i})\">üóëÔ∏è</button></td>\r\n        </tr>\r\n      `;\r\n    } else if (items) {\r\n      // Vista r√°pida en sidebar\r\n      items.innerHTML += `\r\n        <div class=\"item\">\r\n          <img src=\"${p.img}\" width=\"40\">\r\n          <span>${p.nombre} x${p.cantidad}</span>\r\n          <span>S/ ${(p.precio * p.cantidad).toFixed(2)}</span>\r\n        </div>\r\n      `;\r\n    }\r\n  });\r\n\r\n  // ==== Actualizar contadores y totales ====\r\n  if (tabla) tabla.classList.remove(\"oculto\");\r\n  if (vacio) vacio.classList.add(\"oculto\");\r\n  contador.forEach(c => c.innerText = carrito.reduce((acc, p) => acc + p.cantidad, 0));\r\n  if (subtotalEl) subtotalEl.innerText = `S/ ${subtotal.toFixed(2)}`;\r\n  if (totalEl) totalEl.innerText = `S/ ${subtotal.toFixed(2)}`;\r\n\r\n  // ==== Aviso de env√≠o gratis ====\r\n  if (subtotal >= ENVIO_GRATIS_MINIMO) {\r\n    if (envioGratis) {\r\n      envioGratis.querySelector(\"p\").innerHTML = `<b>¬°Felicidades! Obtienes env√≠o gratis üöö</b>`;\r\n      if (barra) barra.style.width = \"100%\";\r\n      envioGratis.classList.remove(\"oculto\");\r\n    }\r\n  } else {\r\n    let faltante = ENVIO_GRATIS_MINIMO - subtotal;\r\n    if (faltanteEl) faltanteEl.innerText = `S/ ${faltante.toFixed(2)}`;\r\n    if (barra) barra.style.width = `${(subtotal / ENVIO_GRATIS_MINIMO) * 100}%`;\r\n    if (envioGratis) envioGratis.classList.remove(\"oculto\");\r\n  }\r\n\r\n  guardarCarrito();\r\n  actualizarBarraEnvio(); // Llamamos a la funci√≥n para actualizar la barra despu√©s de renderizar el carrito\r\n}\r\n\r\n// ==== Cambiar cantidad de un producto ====\r\nfunction cambiarCantidad(index, cambio) {\r\n  carrito[index].cantidad += cambio;\r\n  if (carrito[index].cantidad <= 0) carrito.splice(index, 1);\r\n  renderCarrito();\r\n}\r\n\r\n// ==== Eliminar producto del carrito ====\r\nfunction eliminarProducto(index) {\r\n  carrito.splice(index, 1);\r\n  renderCarrito();\r\n}\r\n\r\n// ==== Agregar producto al carrito con mensaje flotante ====\r\nfunction agregarAlCarrito(producto) {\r\n  let item = carrito.find(p => p.id === producto.id);\r\n  if (item) {\r\n    item.cantidad++;\r\n  } else {\r\n    carrito.push({ ...producto, cantidad: 1 });\r\n  }\r\n\r\n  guardarCarrito();\r\n  renderCarrito();\r\n\r\n  // ==== Mensaje flotante moderno ====\r\n  const mensaje = document.getElementById(\"mensajeCarrito\");\r\n  mensaje.innerText = `${producto.nombre} agregado al carrito ‚úÖ`;\r\n  mensaje.style.display = \"block\";\r\n\r\n  setTimeout(() => {\r\n    mensaje.style.opacity = \"1\";\r\n    mensaje.style.transform = \"translateY(0)\";\r\n  }, 50);\r\n\r\n  setTimeout(() => {\r\n    mensaje.style.opacity = \"0\";\r\n    mensaje.style.transform = \"translateY(20px)\";\r\n  }, 2000);\r\n\r\n  setTimeout(() => {\r\n    mensaje.style.display = \"none\";\r\n  }, 2300);\r\n}\r\n\r\n// ==== Inicializar al cargar la p√°gina ====\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  renderCarrito();\r\n  actualizarBarraEnvio(); // Aseguramos que la barra se pinte correctamente al recargar la p√°gina\r\n});\r\n\r\n// ===============================\r\n// üéõÔ∏è PANEL LATERAL DEL CARRITO\r\n// ===============================\r\nconst abrirCarrito = document.getElementById(\"abrir-carrito\");\r\nconst cerrarCarrito = document.getElementById(\"cerrar-carrito\");\r\nconst carritoSidebar = document.getElementById(\"carrito-sidebar\");\r\n\r\n// Abrir el carrito lateral al hacer clic en el √≠cono del carrito\r\nif (abrirCarrito) {\r\n  abrirCarrito.addEventListener(\"click\", (e) => {\r\n    e.preventDefault(); // Evita la acci√≥n predeterminada del enlace\r\n    carritoSidebar.classList.add(\"activo\");  // Agrega la clase 'activo' al carrito lateral\r\n  });\r\n}\r\n\r\n// Cerrar el carrito lateral al hacer clic en la X\r\nif (cerrarCarrito) {\r\n  cerrarCarrito.addEventListener(\"click\", () => {\r\n    carritoSidebar.classList.remove(\"activo\");  // Elimina la clase 'activo' para ocultar el carrito lateral\r\n  });\r\n}\r\n\r\n// Cerrar el carrito lateral al hacer clic en el overlay\r\nif (overlay) {\r\n  overlay.addEventListener(\"click\", () => {\r\n    carritoSidebar.classList.remove(\"activo\");  // Elimina la clase 'activo' para ocultar el carrito lateral\r\n    overlay.classList.remove(\"activo\");         // Oculta el overlay\r\n  });\r\n}\r\n\r\n/* ======================\r\n   PAGO CON YAPE - QR MANUAL (sin pasarela)\r\n====================== */\r\n// === PAGO MANUAL CON YAPE (QR generado) ===\r\n\r\n// Referencias a los elementos de la interfaz\r\nconst btnYape = document.getElementById(\"btn-yape\");\r\nconst modalYape = document.getElementById(\"modal-yape\");\r\nconst montoYapeEl = document.getElementById(\"monto-yape\");\r\nconst btnYapeOk = document.getElementById(\"btn-yape-ok\");\r\nconst btnYapeCerrar = document.getElementById(\"btn-yape-cerrar\");\r\n\r\n// Funci√≥n para abrir el modal de Yape\r\nfunction abrirModalYape() {\r\n  if (!modalYape) return;  // Si el modal no existe, no hacemos nada\r\n\r\n  // Obtener el monto total del carrito\r\n  const monto = subtotalCarrito();\r\n\r\n  // Mostrar el monto en el modal\r\n  if (montoYapeEl) montoYapeEl.textContent = fmtSoles(monto); // Funci√≥n fmtSoles() para dar formato a los soles\r\n\r\n  // Mostrar el modal de Yape\r\n  modalYape.classList.remove(\"oculto\");\r\n  modalYape.style.display = \"flex\";\r\n}\r\n\r\n// Funci√≥n para cerrar el modal de Yape\r\nfunction cerrarModalYape() {\r\n  if (!modalYape) return;  // Si el modal no existe, no hacemos nada\r\n\r\n  // Ocultar el modal\r\n  modalYape.classList.add(\"oculto\");\r\n  modalYape.style.display = \"none\";\r\n}\r\n\r\n// Al hacer clic en el bot√≥n de Yape, se abre el modal\r\nbtnYape?.addEventListener(\"click\", (e) => {\r\n  e.preventDefault();  // Evitar la acci√≥n predeterminada del enlace\r\n\r\n  // Verificar que el carrito no est√© vac√≠o\r\n  if (subtotalCarrito() <= 0) return toast(\"Tu carrito est√° vac√≠o\");  // Funci√≥n toast() para mostrar mensajes\r\n\r\n  abrirModalYape();  // Llamar a la funci√≥n para abrir el modal\r\n});\r\n\r\n// Al hacer clic en el bot√≥n de cerrar del modal, lo cerramos\r\nbtnYapeCerrar?.addEventListener(\"click\", cerrarModalYape);\r\n\r\n// Al hacer clic en el bot√≥n de \"Confirmar pago manual\", se procesa el pago\r\nbtnYapeOk?.addEventListener(\"click\", async () => {\r\n  // Cerrar el modal de Yape\r\n  cerrarModalYape();\r\n\r\n  // Mostrar mensaje de agradecimiento\r\n  toast(\"Gracias. Verificaremos tu pago en Yape üëå\");\r\n\r\n  // Aqu√≠ se puede integrar la l√≥gica para guardar el pago o generar un pedido en tu sistema\r\n\r\n  try {\r\n    // Enviar la informaci√≥n del pedido al servidor (opcional: creamos una orden pendiente en tu backend)\r\n    await fetch(\"/api/orders/manual\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ items: carrito, amount: subtotalCarrito(), method: \"yape_manual\" })\r\n    });\r\n  } catch (e) {\r\n    console.error(\"Error al guardar la orden:\", e);\r\n  }\r\n});\r\n\r\n// === FUNCIONES AUXILIARES ===\r\n\r\n// Esta funci√≥n calcula el subtotal del carrito\r\nfunction subtotalCarrito() {\r\n  return carrito.reduce((total, producto) => total + (producto.precio * producto.cantidad), 0);\r\n}\r\n\r\n// Funci√≥n para dar formato a los soles (puedes modificar esto si necesitas otro formato)\r\nfunction fmtSoles(monto) {\r\n  return `S/ ${monto.toFixed(2)}`;\r\n}\r\n\r\n// Funci√≥n para mostrar un mensaje de toast (mensaje flotante)\r\nfunction toast(mensaje) {\r\n  const toast = document.createElement(\"div\");\r\n  toast.className = \"toast\";\r\n  toast.innerText = mensaje;\r\n  document.body.appendChild(toast);\r\n\r\n  // Desaparecer el mensaje despu√©s de unos segundos\r\n  setTimeout(() => {\r\n    toast.remove();\r\n  }, 3000);\r\n}\r\n"
        }
    ]
}